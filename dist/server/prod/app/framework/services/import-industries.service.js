"use strict";
var IndustryRepository = require("../dataaccess/repository/import-industries.repository");
var xlsxj = require('xlsx-to-json');
var CNextMessages = require("../shared/cnext-messages");
var ProjectAsset = require("../shared/projectasset");
var ImportIndustriesModel = require("../dataaccess/model/industry-class.model");
var IndustryService = require("./industry.service");
var RoleService = require("./role.service");
var CapabilityService = require("./capability.service");
var ComplexityService = require("./complexity.service");
var Messages = require("../shared/messages");
var RolesService = new RoleService();
var CapabilitiesService = new CapabilityService();
var ComplexitiesService = new ComplexityService();
var ImportIndustryService = (function () {
    function ImportIndustryService() {
        this.importIndustriesRepository = new IndustryRepository();
        this.APP_NAME = ProjectAsset.APP_NAME;
    }
    ImportIndustryService.prototype.create = function (item, callback) {
        var industryService;
        industryService = new IndustryService();
        industryService.create(item, function (errinCreate, response) {
            if (errinCreate) {
                callback(new Error(CNextMessages.PROBLEM_IN_CREATING_INDUSTRY), null);
            }
            else {
                if (response.length === 0) {
                    callback('Empty Response', null);
                }
                else {
                    callback(null, response);
                }
            }
        });
    };
    ImportIndustryService.prototype.readXlsx = function (filePath, callback) {
        xlsxj({
            input: filePath,
            output: null
        }, function (err, result) {
            var isSend = false;
            if (err) {
                console.error(err);
                callback(err, null);
            }
            else {
                var rolesArray = [];
                for (var i = 0; i < result.length - 1; i++) {
                    if (result[i].area_of_work_code === '') {
                        if (result[i].area_of_work_code === '' && result[i].capability === '' && result[i].complexity === '') {
                        }
                        else {
                            if (!isSend) {
                                isSend = true;
                                callback(new Error(Messages.MSG_ERROR_AREA_OF_WORK_CODE_MISSING + ' - ' + result[i].area_of_work), null);
                            }
                        }
                    }
                    rolesArray = RolesService.addRole(result[i], rolesArray);
                }
                for (var i = 0; i < rolesArray.length; i++) {
                    var capabilities = [];
                    for (var j = 1; j < result.length; j++) {
                        var currentRow = result[j];
                        if (rolesArray[i].name === currentRow.area_of_work) {
                            if (result[j].capability_code === '') {
                                if (result[j].area_of_work === '' && result[j].capability === '' && result[j].complexity === '') {
                                }
                                else {
                                    console.log(' role name ' + i + result[i].area_of_work);
                                    if (!isSend) {
                                        isSend = true;
                                        callback(new Error(Messages.MSG_ERROR_CAPABILITY_CODE_MISSING + ' - ' + result[j].capability), null);
                                    }
                                }
                            }
                            capabilities = CapabilitiesService.addCapabilities(result[j], capabilities);
                        }
                        else {
                            rolesArray[i].capabilities = capabilities;
                        }
                    }
                }
                for (var i = 0; i < rolesArray.length; i++) {
                    for (var capIndex = 0; capIndex < rolesArray[i].capabilities.length; capIndex++) {
                        var complexities = [];
                        for (var j = 0; j < result.length; j++) {
                            var currentRow_1 = result[j];
                            if (rolesArray[i].name === currentRow_1.area_of_work) {
                                if (rolesArray[i].capabilities[capIndex].name === currentRow_1.capability) {
                                    if (result[j].complexity_code === '') {
                                        if (result[j].area_of_work === '' && result[j].capability === '' && result[j].complexity === '') {
                                        }
                                        else {
                                            console.log(' role name ' + i + result[i].area_of_work);
                                            if (!isSend) {
                                                isSend = true;
                                                callback(new Error(Messages.MSG_ERROR_COMPLEXITY_CODE_MISSING + ' - ' + result[j].complexity), null);
                                            }
                                        }
                                    }
                                    complexities = ComplexitiesService.addComplexities(result[j], complexities);
                                }
                            }
                        }
                        rolesArray[i].capabilities[capIndex].complexities = complexities;
                    }
                }
                for (var i = 0; i < rolesArray.length; i++) {
                    rolesArray[i].default_complexities = new Array(0);
                    var temp = new Array(0);
                    for (var c in rolesArray[i].capabilities) {
                        if (rolesArray[i].capabilities[c].code.startsWith('d')) {
                            var tempCode = rolesArray[i].capabilities[c].code.split("d")[1];
                            rolesArray[i].capabilities[c].code = tempCode;
                            rolesArray[i].default_complexities.push(rolesArray[i].capabilities[c]);
                            temp.push(c);
                        }
                    }
                    if (temp.length > 0) {
                        for (var t = temp.length - 1; t >= 0; t--) {
                            rolesArray[i].capabilities.splice(temp[t], 1);
                        }
                    }
                    if (rolesArray[i].name === '') {
                        rolesArray.splice(i, 1);
                    }
                }
                var industry = new ImportIndustriesModel(result[0].industry, result[0].code, result[0].sort_order, rolesArray);
                if (!isSend) {
                    if (result[0].code === '' || result[0].sort_order === '' || result[0].code === undefined || result[0].sort_order === undefined) {
                        callback(new Error(Messages.MSG_ERROR_INDUSTRY_CODE_OR_SORT_NUMBER_MISSING + ' - ' + result[0].industry), null);
                    }
                    callback(null, industry);
                }
            }
        });
    };
    return ImportIndustryService;
}());
Object.seal(ImportIndustryService);
module.exports = ImportIndustryService;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9mcmFtZXdvcmsvc2VydmljZXMvaW1wb3J0LWluZHVzdHJpZXMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsMEZBQTZGO0FBSTdGLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUNwQyx3REFBMkQ7QUFDM0QscURBQXdEO0FBQ3hELGdGQUFtRjtBQUNuRixvREFBdUQ7QUFDdkQsNENBQStDO0FBQy9DLHdEQUEyRDtBQUMzRCx3REFBMkQ7QUFDM0QsNkNBQWdEO0FBRWhELElBQUksWUFBWSxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7QUFDckMsSUFBSSxtQkFBbUIsR0FBRyxJQUFJLGlCQUFpQixFQUFFLENBQUM7QUFDbEQsSUFBSSxtQkFBbUIsR0FBRyxJQUFJLGlCQUFpQixFQUFFLENBQUM7QUFFbEQ7SUFJRTtRQUNFLElBQUksQ0FBQywwQkFBMEIsR0FBRyxJQUFJLGtCQUFrQixFQUFFLENBQUM7UUFDM0QsSUFBSSxDQUFDLFFBQVEsR0FBRyxZQUFZLENBQUMsUUFBUSxDQUFDO0lBQ3hDLENBQUM7SUFFRCxzQ0FBTSxHQUFOLFVBQU8sSUFBUyxFQUFFLFFBQTJDO1FBRTNELElBQUksZUFBaUMsQ0FBQztRQUN0QyxlQUFlLEdBQUcsSUFBSSxlQUFlLEVBQUUsQ0FBQztRQUN4QyxlQUFlLENBQUMsTUFBTSxDQUFDLElBQUksRUFBQyxVQUFDLFdBQWdCLEVBQUUsUUFBYTtZQUMxRCxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO2dCQUNoQixRQUFRLENBQUMsSUFBSSxLQUFLLENBQUMsYUFBYSxDQUFDLDRCQUE0QixDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDeEUsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDMUIsUUFBUSxDQUFDLGdCQUFnQixFQUFF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Qyw4Q0FBOEMsR0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUNoSCxDQUFDO29CQUNELFFBQVEsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7Z0JBQzNCLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0gsNEJBQUM7QUFBRCxDQWxKQSxBQWtKQyxJQUFBO0FBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBQ25DLGlCQUFTLHFCQUFxQixDQUFDIiwiZmlsZSI6ImFwcC9mcmFtZXdvcmsvc2VydmljZXMvaW1wb3J0LWluZHVzdHJpZXMuc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBJbmR1c3RyeVJlcG9zaXRvcnkgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL3JlcG9zaXRvcnkvaW1wb3J0LWluZHVzdHJpZXMucmVwb3NpdG9yeScpO1xuLyoqXG4gKiBDcmVhdGVkIGJ5IHRlY2hwcmltZTAwMiBvbiA3LzExLzIwMTcuXG4gKi9cbnZhciB4bHN4aiA9IHJlcXVpcmUoJ3hsc3gtdG8tanNvbicpO1xuaW1wb3J0IENOZXh0TWVzc2FnZXMgPSByZXF1aXJlKCcuLi9zaGFyZWQvY25leHQtbWVzc2FnZXMnKTtcbmltcG9ydCBQcm9qZWN0QXNzZXQgPSByZXF1aXJlKCcuLi9zaGFyZWQvcHJvamVjdGFzc2V0Jyk7XG5pbXBvcnQgSW1wb3J0SW5kdXN0cmllc01vZGVsID0gcmVxdWlyZSgnLi4vZGF0YWFjY2Vzcy9tb2RlbC9pbmR1c3RyeS1jbGFzcy5tb2RlbCcpO1xuaW1wb3J0IEluZHVzdHJ5U2VydmljZSA9IHJlcXVpcmUoJy4vaW5kdXN0cnkuc2VydmljZScpO1xuaW1wb3J0IFJvbGVTZXJ2aWNlID0gcmVxdWlyZSgnLi9yb2xlLnNlcnZpY2UnKTtcbmltcG9ydCBDYXBhYmlsaXR5U2VydmljZSA9IHJlcXVpcmUoJy4vY2FwYWJpbGl0eS5zZXJ2aWNlJyk7XG5pbXBvcnQgQ29tcGxleGl0eVNlcnZpY2UgPSByZXF1aXJlKCcuL2NvbXBsZXhpdHkuc2VydmljZScpO1xuaW1wb3J0IE1lc3NhZ2VzID0gcmVxdWlyZSgnLi4vc2hhcmVkL21lc3NhZ2VzJyk7XG5cbmxldCBSb2xlc1NlcnZpY2UgPSBuZXcgUm9sZVNlcnZpY2UoKTtcbmxldCBDYXBhYmlsaXRpZXNTZXJ2aWNlID0gbmV3IENhcGFiaWxpdHlTZXJ2aWNlKCk7XG5sZXQgQ29tcGxleGl0aWVzU2VydmljZSA9IG5ldyBDb21wbGV4aXR5U2VydmljZSgpO1xuXG5jbGFzcyBJbXBvcnRJbmR1c3RyeVNlcnZpY2Uge1xuICBBUFBfTkFNRTogc3RyaW5nO1xuICBwcml2YXRlIGltcG9ydEluZHVzdHJpZXNSZXBvc2l0b3J5OiBJbmR1c3RyeVJlcG9zaXRvcnk7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5pbXBvcnRJbmR1c3RyaWVzUmVwb3NpdG9yeSA9IG5ldyBJbmR1c3RyeVJlcG9zaXRvcnkoKTtcbiAgICB0aGlzLkFQUF9OQU1FID0gUHJvamVjdEFzc2V0LkFQUF9OQU1FO1xuICB9XG5cbiAgY3JlYXRlKGl0ZW06IGFueSwgY2FsbGJhY2s6IChlcnJvcjogYW55LCByZXN1bHQ6IGFueSkgPT4gdm9pZCkge1xuXG4gICAgbGV0IGluZHVzdHJ5U2VydmljZSA6IEluZHVzdHJ5U2VydmljZTtcbiAgICBpbmR1c3RyeVNlcnZpY2UgPSBuZXcgSW5kdXN0cnlTZXJ2aWNlKCk7XG4gICAgaW5kdXN0cnlTZXJ2aWNlLmNyZWF0ZShpdGVtLChlcnJpbkNyZWF0ZTogYW55LCByZXNwb25zZTogYW55KSA9PiB7XG4gICAgICBpZiAoZXJyaW5DcmVhdGUpIHtcbiAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKENOZXh0TWVzc2FnZXMuUFJPQkxFTV9JTl9DUkVBVElOR19JTkRVU1RSWSksIG51bGwpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHJlc3BvbnNlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIGNhbGxiYWNrKCdFbXB0eSBSZXNwb25zZScsIG51bGwpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3BvbnNlKTtcbiAgICAgICAgICAvL3RoaXMuaW1wb3J0SW5kdXN0cmllc1JlcG9zaXRvcnkuZmluZE9uZUFuZFVwZGF0ZSh7J19pZCc6IHJlc3BvbnNlWzBdLl9pZH0sIGl0ZW0sIHtuZXc6IHRydWV9LCBjYWxsYmFjayk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHJlYWRYbHN4KGZpbGVQYXRoOnN0cmluZywgY2FsbGJhY2s6KGVycm9yOmFueSwgcmVzdWx0OmFueSkgPT4gdm9pZCkge1xuICAgIHhsc3hqKHtcbiAgICAgIGlucHV0OiBmaWxlUGF0aCxcbiAgICAgIG91dHB1dDogbnVsbFxuICAgIH0sIGZ1bmN0aW9uIChlcnI6YW55LCByZXN1bHQ6YW55KSB7XG4gICAgICBsZXQgaXNTZW5kIDogYm9vbGVhbiA9ZmFsc2U7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgICAgY2FsbGJhY2soZXJyLCBudWxsKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZhciByb2xlc0FycmF5OmFueSA9IFtdO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVzdWx0Lmxlbmd0aC0xOyBpKyspIHtcbiAgICAgICAgICBpZihyZXN1bHRbaV0uYXJlYV9vZl93b3JrX2NvZGUgPT09ICcnKSB7XG4gICAgICAgICAgICBpZihyZXN1bHRbaV0uYXJlYV9vZl93b3JrX2NvZGUgPT09ICcnICYmIHJlc3VsdFtpXS5jYXBhYmlsaXR5ID09PScnICYmIHJlc3VsdFtpXS5jb21wbGV4aXR5PT09JycpIHtcbiAgICAgICAgICAgIH1lbHNlIHtcbiAgICAgICAgICAgICAgaWYoIWlzU2VuZCkge1xuICAgICAgICAgICAgICAgIGlzU2VuZD10cnVlO1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcihNZXNzYWdlcy5NU0dfRVJST1JfQVJFQV9PRl9XT1JLX0NPREVfTUlTU0lORysnIC0gJytyZXN1bHRbaV0uYXJlYV9vZl93b3JrKSxudWxsKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICByb2xlc0FycmF5ID0gUm9sZXNTZXJ2aWNlLmFkZFJvbGUocmVzdWx0W2ldLCByb2xlc0FycmF5KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcm9sZXNBcnJheS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIHZhciBjYXBhYmlsaXRpZXM6IGFueSA9IFtdO1xuICAgICAgICAgIGZvciAobGV0IGogPSAxOyBqIDwgcmVzdWx0Lmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICB2YXIgY3VycmVudFJvdyA9IHJlc3VsdFtqXTtcbiAgICAgICAgICAgIGlmIChyb2xlc0FycmF5W2ldLm5hbWUgPT09IGN1cnJlbnRSb3cuYXJlYV9vZl93b3JrKSB7XG4gICAgICAgICAgICAgIGlmKHJlc3VsdFtqXS5jYXBhYmlsaXR5X2NvZGUgPT09ICcnKSB7XG4gICAgICAgICAgICAgICAgaWYocmVzdWx0W2pdLmFyZWFfb2Zfd29yayA9PT0gJycgJiYgcmVzdWx0W2pdLmNhcGFiaWxpdHkgPT09JycgJiYgcmVzdWx0W2pdLmNvbXBsZXhpdHk9PT0nJykge1xuICAgICAgICAgICAgICAgIH1lbHNlIHtcbiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCcgcm9sZSBuYW1lICcraStyZXN1bHRbaV0uYXJlYV9vZl93b3JrKTtcbiAgICAgICAgICAgICAgICAgIGlmKCFpc1NlbmQpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNTZW5kPXRydWU7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcihNZXNzYWdlcy5NU0dfRVJST1JfQ0FQQUJJTElUWV9DT0RFX01JU1NJTkcrJyAtICcrcmVzdWx0W2pdLmNhcGFiaWxpdHkpLG51bGwpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBjYXBhYmlsaXRpZXMgPSBDYXBhYmlsaXRpZXNTZXJ2aWNlLmFkZENhcGFiaWxpdGllcyhyZXN1bHRbal0sIGNhcGFiaWxpdGllcyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByb2xlc0FycmF5W2ldLmNhcGFiaWxpdGllcyA9IGNhcGFiaWxpdGllcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJvbGVzQXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBmb3IgKGxldCBjYXBJbmRleCA9IDA7IGNhcEluZGV4IDwgcm9sZXNBcnJheVtpXS5jYXBhYmlsaXRpZXMubGVuZ3RoOyBjYXBJbmRleCsrKSB7XG4gICAgICAgICAgICBsZXQgY29tcGxleGl0aWVzOmFueSA9IFtdO1xuICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCByZXN1bHQubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgbGV0IGN1cnJlbnRSb3cgPSByZXN1bHRbal07XG4gICAgICAgICAgICAgIGlmIChyb2xlc0FycmF5W2ldLm5hbWUgPT09IGN1cnJlbnRSb3cuYXJlYV9vZl93b3JrKSB7XG4gICAgICAgICAgICAgIGlmIChyb2xlc0FycmF5W2ldLmNhcGFiaWxpdGllc1tjYXBJbmRleF0ubmFtZSA9PT0gY3VycmVudFJvdy5jYXBhYmlsaXR5KSB7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdFtqXS5jb21wbGV4aXR5X2NvZGUgPT09ICcnKSB7XG4gICAgICAgICAgICAgICAgICBpZiAocmVzdWx0W2pdLmFyZWFfb2Zfd29yayA9PT0gJycgJiYgcmVzdWx0W2pdLmNhcGFiaWxpdHkgPT09ICcnICYmIHJlc3VsdFtqXS5jb21wbGV4aXR5ID09PSAnJykge1xuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJyByb2xlIG5hbWUgJyArIGkgKyByZXN1bHRbaV0uYXJlYV9vZl93b3JrKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc1NlbmQpIHtcbiAgICAgICAgICAgICAgICAgICAgICBpc1NlbmQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcihNZXNzYWdlcy5NU0dfRVJST1JfQ09NUExFWElUWV9DT0RFX01JU1NJTkcrJyAtICcgKyByZXN1bHRbal0uY29tcGxleGl0eSksIG51bGwpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbXBsZXhpdGllcyA9IENvbXBsZXhpdGllc1NlcnZpY2UuYWRkQ29tcGxleGl0aWVzKHJlc3VsdFtqXSwgY29tcGxleGl0aWVzKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcm9sZXNBcnJheVtpXS5jYXBhYmlsaXRpZXNbY2FwSW5kZXhdLmNvbXBsZXhpdGllcyA9IGNvbXBsZXhpdGllcztcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJvbGVzQXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICByb2xlc0FycmF5W2ldLmRlZmF1bHRfY29tcGxleGl0aWVzID0gbmV3IEFycmF5KDApO1xuICAgICAgICAgIGxldCB0ZW1wID0gbmV3IEFycmF5KDApO1xuICAgICAgICAgIGZvciAobGV0IGMgaW4gcm9sZXNBcnJheVtpXS5jYXBhYmlsaXRpZXMpIHtcbiAgICAgICAgICAgIC8vaWYocm9sZXNBcnJheVtpXS5uYW1lID09ICdJVCBTdXBwb3J0Jyl7XG4gICAgICAgICAgICBpZiAocm9sZXNBcnJheVtpXS5jYXBhYmlsaXRpZXNbY10uY29kZS5zdGFydHNXaXRoKCdkJykpIHtcbiAgICAgICAgICAgICAgbGV0IHRlbXBDb2RlID0gcm9sZXNBcnJheVtpXS5jYXBhYmlsaXRpZXNbY10uY29kZS5zcGxpdChcImRcIilbMV07XG4gICAgICAgICAgICAgIHJvbGVzQXJyYXlbaV0uY2FwYWJpbGl0aWVzW2NdLmNvZGUgPSB0ZW1wQ29kZTtcbiAgICAgICAgICAgICAgcm9sZXNBcnJheVtpXS5kZWZhdWx0X2NvbXBsZXhpdGllcy5wdXNoKHJvbGVzQXJyYXlbaV0uY2FwYWJpbGl0aWVzW2NdKTtcbiAgICAgICAgICAgICAgdGVtcC5wdXNoKGMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy99XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKHRlbXAubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgZm9yIChsZXQgdCA9IHRlbXAubGVuZ3RoIC0gMTsgdCA+PSAwOyB0LS0pIHtcbiAgICAgICAgICAgICAgcm9sZXNBcnJheVtpXS5jYXBhYmlsaXRpZXMuc3BsaWNlKHRlbXBbdF0sIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuXG4gICAgICAgICAgaWYgKHJvbGVzQXJyYXlbaV0ubmFtZSA9PT0gJycpIHtcbiAgICAgICAgICAgIHJvbGVzQXJyYXkuc3BsaWNlKGksIDEpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8qZm9yIChsZXQgaSA9IDA7IGkgPCByb2xlc0FycmF5Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICByb2xlc0FycmF5W2ldLmRlZmF1bHRfY29tcGxleGl0aWVzID0gbmV3IEFycmF5KDApO1xuICAgICAgICAgIGlmIChyb2xlc0FycmF5W2ldLmNhcGFiaWxpdGllc1swXS5uYW1lLnN0YXJ0c1dpdGgoJ0RlZmF1bHQnKSkge1xuICAgICAgICAgICAgcm9sZXNBcnJheVtpXS5kZWZhdWx0X2NvbXBsZXhpdGllcy5wdXNoKHJvbGVzQXJyYXlbaV0uY2FwYWJpbGl0aWVzWzBdKTtcbiAgICAgICAgICAgIHJvbGVzQXJyYXlbaV0uY2FwYWJpbGl0aWVzLnNoaWZ0KCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChyb2xlc0FycmF5W2ldLm5hbWUgPT09ICcnKSB7XG4gICAgICAgICAgICByb2xlc0FycmF5LnNwbGljZShpLCAxKTtcbiAgICAgICAgICB9XG4gICAgICAgICB9Ki9cblxuICAgICAgICBsZXQgaW5kdXN0cnkgPSBuZXcgSW1wb3J0SW5kdXN0cmllc01vZGVsKHJlc3VsdFswXS5pbmR1c3RyeSwgcmVzdWx0WzBdLmNvZGUscmVzdWx0WzBdLnNvcnRfb3JkZXIscm9sZXNBcnJheSk7XG4gICAgICAgIGlmKCFpc1NlbmQpIHtcbiAgICAgICAgICBpZihyZXN1bHRbMF0uY29kZT09PScnfHxyZXN1bHRbMF0uc29ydF9vcmRlcj09PScnfHxyZXN1bHRbMF0uY29kZT09PXVuZGVmaW5lZHx8cmVzdWx0WzBdLnNvcnRfb3JkZXI9PT11bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcihNZXNzYWdlcy5NU0dfRVJST1JfSU5EVVNUUllfQ09ERV9PUl9TT1JUX05VTUJFUl9NSVNTSU5HKycgLSAnICsgcmVzdWx0WzBdLmluZHVzdHJ5KSwgbnVsbCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGluZHVzdHJ5KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG59XG5cbk9iamVjdC5zZWFsKEltcG9ydEluZHVzdHJ5U2VydmljZSk7XG5leHBvcnQgPSBJbXBvcnRJbmR1c3RyeVNlcnZpY2U7XG4iXX0=
