"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var Messages = require("../shared/messages");
var JobProfileService = require("../services/jobprofile.service");
var CNextMessages = require("../shared/cnext-messages");
var SearchService = require("../search/services/search.service");
var sharedconstants_1 = require("../shared/sharedconstants");
var RecruiterService = require("../services/recruiter.service");
var usestracking = require('uses-tracking');
function searchCandidatesByJobProfile(req, res, next) {
    try {
        var jobProfile = req.body;
        var jobProfileService = new JobProfileService();
        jobProfileService.searchCandidatesByJobProfile(jobProfile, function (error, result) {
            if (error) {
                next({
                    reason: 'No candidates are present for this Job Profile',
                    message: Messages.MSG_ERROR_WRONG_TOKEN,
                    code: 401
                });
            }
            else {
                res.send({
                    'status': 'success',
                    'data': result
                });
            }
        });
    }
    catch (e) {
        res.status(403).send({ message: e.message });
    }
}
exports.searchCandidatesByJobProfile = searchCandidatesByJobProfile;
function retrieve(req, res, next) {
    try {
        var jobProfileService = new JobProfileService();
        var data = {
            'postedJob': req.params.id
        };
        jobProfileService.retrieve(data, function (error, result) {
            if (error) {
                next({
                    reason: CNextMessages.PROBLEM_IN_RETRIEVE_JOB_PROFILE,
                    message: CNextMessages.PROBLEM_IN_RETRIEVE_JOB_PROFILE,
                    code: 401
                });
            }
            else {
                var currentDate = Number(new Date());
                var expiringDate = Number(new Date(result.postedJobs[0].expiringDate));
                var daysRemainingForExpiring = Math.round(Number(new Date(expiringDate - currentDate)) / (1000 * 60 * 60 * 24));
                result.postedJobs[0].daysRemainingForExpiring = daysRemainingForExpiring;
                if (daysRemainingForExpiring <= 0) {
                    result.postedJobs[0].isJobPostExpired = true;
                }
                else {
                    result.postedJobs[0].isJobPostExpired = false;
                }
                res.status(200).send({
                    'data': {
                        'industry': result
                    }
                });
            }
        });
    }
    catch (e) {
        res.status(403).send({ message: e.message });
    }
}
exports.retrieve = retrieve;
function getCapabilityMatrix(req, res, next) {
    try {
        var jobProfileService = new JobProfileService();
        var data = {
            'postedJob': req.params.id
        };
        jobProfileService.getCapabilityValueKeyMatrix(req.params.id, function (error, result) {
            if (error) {
                next({
                    reason: CNextMessages.PROBLEM_IN_RETRIEVE_JOB_PROFILE,
                    message: CNextMessages.PROBLEM_IN_RETRIEVE_JOB_PROFILE,
                    code: 401
                });
            }
            else {
                res.status(200).send({
                    'data': result
                });
            }
        });
    }
    catch (e) {
        res.status(403).send({ message: e.message });
    }
}
exports.getCapabilityMatrix = getCapabilityMatrix;
function update(req, res, next) {
    try {
        var jobProfileService = new JobProfileService();
        var data = {
            'recruiterId': req.params.recruiterId,
            'profileId': req.params.profileId,
            'listName': req.params.listName,
            'candidateId': req.params.candidateId,
            'action': req.params.action
        };
        jobProfileService.update(data, function (err, result) {
            if (err) {
                next({
                    reason: Messages.MSG_ERROR_RSN_USER_NOT_FOUND,
                    message: Messages.MSG_ERROR_RSN_USER_NOT_FOUND,
                    code: 403
                });
            }
            else {
                res.status(200).send({
                    'status': Messages.STATUS_SUCCESS,
                    'data': result
                });
            }
        });
    }
    catch (e) {
        res.status(403).send({ message: e.message });
    }
}
exports.update = update;
function apply(req, res, next) {
    try {
        var jobProfileService = new JobProfileService();
        var data = {
            'candidateId': req.params.id,
            'profileId': req.params.profileId,
            'action': req.params.action,
            'listName': req.params.listName
        };
        jobProfileService.applyJob(data, function (err, result) {
            if (err) {
                next({
                    reason: Messages.MSG_ERROR_RSN_USER_NOT_FOUND,
                    message: Messages.MSG_ERROR_RSN_USER_NOT_FOUND,
                    code: 403
                });
            }
            else {
                res.status(200).send({
                    'status': Messages.STATUS_SUCCESS,
                    'data': result
                });
            }
        });
    }
    catch (e) {
        res.status(403).send({ message: e.message });
    }
}
exports.apply = apply;
function metchResultForJob(req, res, next) {
    try {
        var searchService = new SearchService();
        var jobId = req.params.jobId;
        var candidateId = req.params.candidateId;
        searchService.getMatchingResult(candidateId, jobId, false, function (error, result) {
            if (error) {
                next({
                    reason: 'Problem in Search Matching Result',
                    message: 'Problem in Search Matching Result',
                    code: 401
                });
            }
            else {
                res.send({
                    'status': 'success',
                    'data': result,
                });
            }
        });
    }
    catch (e) {
        res.status(403).send({ message: e.message });
    }
}
exports.metchResultForJob = metchResultForJob;
function createUsesTracking(req, res) {
    try {
        var data = void 0;
        data = req.body;
        data.timestamp = new Date();
        var obj = new usestracking.MyController();
        obj._controller.create(data);
        res.send({
            'status': 'success',
        });
    }
    catch (e) {
        res.status(403).send({ message: e.message });
    }
}
exports.createUsesTracking = createUsesTracking;
function getQCardDetails(req, res, next) {
    try {
        var jobProfileService = new JobProfileService();
        var data = {
            'jobId': req.params.id,
            'candidateIds': req.body.candidateIds
        };
        jobProfileService.getQCardDetails(data, function (error, result) {
            if (error) {
                res.status(304).send(error);
            }
            else {
                res.status(200).send(result);
            }
        });
    }
    catch (e) {
        res.status(403).send({ message: e.message });
    }
}
exports.getQCardDetails = getQCardDetails;
function cloneJob(req, res, next) {
    try {
        var newJobTitle = req.query.newJobTitle;
        var jobProfileService = new JobProfileService();
        var data = {
            'postedJob': req.params.id
        };
        jobProfileService.retrieve(data, function (error, result) {
            if (error) {
                next({
                    reason: CNextMessages.PROBLEM_IN_RETRIEVE_JOB_PROFILE,
                    message: CNextMessages.PROBLEM_IN_RETRIEVE_JOB_PROFILE,
                    code: 401
                });
            }
            else {
                var newJob = result.postedJobs[0];
                delete newJob._id;
                newJob.jobTitle = newJobTitle;
                newJob.isJobPosted = false;
                newJob.isJobShared = false;
                newJob.sharedLink = '';
                newJob.postingDate = new Date();
                newJob.candidate_list = [];
                newJob.isJobPostClosed = false;
                newJob.jobCloseReason = null;
                newJob.expiringDate = new Date((new Date().getTime() + sharedconstants_1.ConstVariables.JOB__EXPIRIY_PERIOD));
                var recruiterService = new RecruiterService();
                recruiterService.addCloneJob(result.userId, newJob, function (err, result) {
                    if (err) {
                        next({
                            reason: err,
                            message: err.message,
                            code: 403
                        });
                    }
                    else {
                        res.status(200).send({
                            'status': Messages.STATUS_SUCCESS,
                            'data': result.postedJobs[0]._id
                        });
                    }
                });
            }
        });
    }
    catch (e) {
        res.status(403).send({ message: e.message });
    }
}
exports.cloneJob = cloneJob;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9mcmFtZXdvcmsvY29udHJvbGxlcnMvam9iLXByb2ZpbGUuY29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDZDQUFnRDtBQUVoRCxrRUFBcUU7QUFDckUsd0RBQTJEO0FBQzNELGlFQUFvRTtBQUVwRSw2REFBa0U7QUFDbEUsZ0VBQW1FO0FBQ25FLElBQUksWUFBWSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUc1QyxzQ0FBNkMsR0FBb0IsRUFBRSxHQUFxQixFQUFFLElBQVM7SUFDakcsSUFBSSxDQUFDO1FBQ0gsSUFBSSxVQUFVLEdBQXFDLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDNUQsSUFBSSxpQkFBaUIsR0FBc0IsSUFBSSxpQkFBaUIsRUFBRSxDQUFDO1FBQ25FLGlCQUFpQixDQUFDLDRCQUE0QixDQUFDLFVBQVUsRUFBRSxVQUFDLEtBQUssRUFBRSxNQUFNO1lBQ3ZFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ1YsSUFBSSxDQUFDO29CQUNILE1BQU0sRUFBRSxnREFBZ0Q7b0JBQ3hELE9BQU8sRUFBRSxRQUFRLENBQUMscUJBQXFCO29CQUN2QyxJQUFJLEVBQUUsR0FBRztpQkFDVixDQUFDLENBQUM7WUFDTCxDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sR0FBRyxDQUFDLElBQUksQ0FBQztvQkFDUCxRQUFRLEVBQUUsU0FBUztvQkFDbkIsTUFBTSxFQUFFLE1BQU07aUJBQ2YsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO0lBRUwsQ0FBQztJQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDWCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFDLENBQUMsQ0FBQztJQUM3QyxDQUFDO0FBRUgsQ0FBQztBQXZCRCxv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Q0FBQyxDQUFDLENBQUMsR0FBRzt5QkFDakMsQ0FBQyxDQUFDO29CQUNMLENBQUM7Z0JBQ0gsQ0FBQyxDQUFDLENBQUM7WUFDUCxDQUFDO1FBRUgsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNYLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxPQUFPLEVBQUMsQ0FBQyxDQUFDO0lBQzdDLENBQUM7QUFDSCxDQUFDO0FBakRELDRCQWlEQyIsImZpbGUiOiJhcHAvZnJhbWV3b3JrL2NvbnRyb2xsZXJzL2pvYi1wcm9maWxlLmNvbnRyb2xsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgTWVzc2FnZXMgPSByZXF1aXJlKCcuLi9zaGFyZWQvbWVzc2FnZXMnKTtcclxuaW1wb3J0IEpvYlByb2ZpbGVNb2RlbCA9IHJlcXVpcmUoJy4uL2RhdGFhY2Nlc3MvbW9kZWwvam9icHJvZmlsZS5tb2RlbCcpO1xyXG5pbXBvcnQgSm9iUHJvZmlsZVNlcnZpY2UgPSByZXF1aXJlKCcuLi9zZXJ2aWNlcy9qb2Jwcm9maWxlLnNlcnZpY2UnKTtcclxuaW1wb3J0IENOZXh0TWVzc2FnZXMgPSByZXF1aXJlKCcuLi9zaGFyZWQvY25leHQtbWVzc2FnZXMnKTtcclxuaW1wb3J0IFNlYXJjaFNlcnZpY2UgPSByZXF1aXJlKCcuLi9zZWFyY2gvc2VydmljZXMvc2VhcmNoLnNlcnZpY2UnKTtcclxuaW1wb3J0IHsgVXNhZ2VUcmFja2luZyB9IGZyb20gJy4uL2RhdGFhY2Nlc3MvbW9kZWwvdXNhZ2UtdHJhY2tpbmcnO1xyXG5pbXBvcnQge0FjdGlvbnMsIENvbnN0VmFyaWFibGVzfSBmcm9tICcuLi9zaGFyZWQvc2hhcmVkY29uc3RhbnRzJztcclxuaW1wb3J0IFJlY3J1aXRlclNlcnZpY2UgPSByZXF1aXJlKCcuLi9zZXJ2aWNlcy9yZWNydWl0ZXIuc2VydmljZScpO1xyXG5sZXQgdXNlc3RyYWNraW5nID0gcmVxdWlyZSgndXNlcy10cmFja2luZycpO1xyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzZWFyY2hDYW5kaWRhdGVzQnlKb2JQcm9maWxlKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UsIG5leHQ6IGFueSkge1xyXG4gIHRyeSB7XHJcbiAgICBsZXQgam9iUHJvZmlsZTogSm9iUHJvZmlsZU1vZGVsID0gPEpvYlByb2ZpbGVNb2RlbD5yZXEuYm9keTtcclxuICAgIGxldCBqb2JQcm9maWxlU2VydmljZTogSm9iUHJvZmlsZVNlcnZpY2UgPSBuZXcgSm9iUHJvZmlsZVNlcnZpY2UoKTtcclxuICAgIGpvYlByb2ZpbGVTZXJ2aWNlLnNlYXJjaENhbmRpZGF0ZXNCeUpvYlByb2ZpbGUoam9iUHJvZmlsZSwgKGVycm9yLCByZXN1bHQpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgbmV4dCh7XHJcbiAgICAgICAgICByZWFzb246ICdObyBjYW5kaWRhdGVzIGFyZSBwcmVzZW50IGZvciB0aGlzIEpvYiBQcm9maWxlJywvL01lc3NhZ2VzLk1TR19FUlJPUl9SU05fSU5WQUxJRF9DUkVERU5USUFMUyxcclxuICAgICAgICAgIG1lc3NhZ2U6IE1lc3NhZ2VzLk1TR19FUlJPUl9XUk9OR19UT0tFTixcclxuICAgICAgICAgIGNvZGU6IDQwMVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlcy5zZW5kKHtcclxuICAgICAgICAgICdzdGF0dXMnOiAnc3VjY2VzcycsXHJcbiAgICAgICAgICAnZGF0YSc6IHJlc3VsdFxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgfSBjYXRjaCAoZSkge1xyXG4gICAgcmVzLnN0YXR1cyg0MDMpLnNlbmQoe21lc3NhZ2U6IGUubWVzc2FnZX0pO1xyXG4gIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiByZXRyaWV2ZShyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlLCBuZXh0OiBhbnkpIHtcclxuICB0cnkge1xyXG4gICAgdmFyIGpvYlByb2ZpbGVTZXJ2aWNlID0gbmV3IEpvYlByb2ZpbGVTZXJ2aWNlKCk7XHJcbiAgICBsZXQgZGF0YSA9IHtcclxuICAgICAgJ3Bvc3RlZEpvYic6IHJlcS5wYXJhbXMuaWRcclxuICAgIH07XHJcbiAgICBqb2JQcm9maWxlU2VydmljZS5yZXRyaWV2ZShkYXRhLCAoZXJyb3IsIHJlc3VsdCkgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBuZXh0KHtcclxuICAgICAgICAgIHJlYXNvbjogQ05leHRNZXNzYWdlcy5QUk9CTEVNX0lOX1JFVFJJRVZFX0pPQl9QUk9GSUxFLFxyXG4gICAgICAgICAgbWVzc2FnZTogQ05leHRNZXNzYWdlcy5QUk9CTEVNX0lOX1JFVFJJRVZFX0pPQl9QUk9GSUxFLFxyXG4gICAgICAgICAgY29kZTogNDAxXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgbGV0IGN1cnJlbnREYXRlID0gTnVtYmVyKG5ldyBEYXRlKCkpO1xyXG4gICAgICAgIGxldCBleHBpcmluZ0RhdGUgPSBOdW1iZXIobmV3IERhdGUocmVzdWx0LnBvc3RlZEpvYnNbMF0uZXhwaXJpbmdEYXRlKSk7XHJcbiAgICAgICAgbGV0IGRheXNSZW1haW5pbmdGb3JFeHBpcmluZyA9IE1hdGgucm91bmQoTnVtYmVyKG5ldyBEYXRlKGV4cGlyaW5nRGF0ZSAtIGN1cnJlbnREYXRlKSkvKDEwMDAqNjAqNjAqMjQpKTtcclxuICAgICAgICByZXN1bHQucG9zdGVkSm9ic1swXS5kYXlzUmVtYWluaW5nRm9yRXhwaXJpbmc9ZGF5c1JlbWFpbmluZ0ZvckV4cGlyaW5nO1xyXG4gICAgICAgIGlmIChkYXlzUmVtYWluaW5nRm9yRXhwaXJpbmcgPD0gMCkge1xyXG4gICAgICAgICAgcmVzdWx0LnBvc3RlZEpvYnNbMF0uaXNKb2JQb3N0RXhwaXJlZD10cnVlO1xyXG5cclxuICAgICAgICB9IGVsc2V7XHJcbiAgICAgICAgICByZXN1bHQucG9zdGVkSm9ic1swXS5pc0pvYlBvc3RFeHBpcmVkPWZhbHNlO1xyXG5cclxuICAgICAgICB9XHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLnNlbmQoe1xyXG4gICAgICAgICAgJ2RhdGEnOiB7XHJcbiAgICAgICAgICAgICdpbmR1c3RyeSc6IHJlc3VsdFxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcblxyXG5cclxuICAgIH0pO1xyXG4gIH0gY2F0Y2ggKGUpIHtcclxuICAgIHJlcy5zdGF0dXMoNDAzKS5zZW5kKHttZXNzYWdlOiBlLm1lc3NhZ2V9KTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRDYXBhYmlsaXR5TWF0cml4KHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UsIG5leHQ6IGFueSkge1xyXG4gIHRyeSB7XHJcbiAgICB2YXIgam9iUHJvZmlsZVNlcnZpY2UgPSBuZXcgSm9iUHJvZmlsZVNlcnZpY2UoKTtcclxuICAgIGxldCBkYXRhID0ge1xyXG4gICAgICAncG9zdGVkSm9iJzogcmVxLnBhcmFtcy5pZFxyXG4gICAgfTtcclxuICAgIGpvYlByb2ZpbGVTZXJ2aWNlLmdldENhcGFiaWxpdHlWYWx1ZUtleU1hdHJpeChyZXEucGFyYW1zLmlkLCAoZXJyb3IsIHJlc3VsdCkgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBuZXh0KHtcclxuICAgICAgICAgIHJlYXNvbjogQ05leHRNZXNzYWdlcy5QUk9CTEVNX0lOX1JFVFJJRVZFX0pPQl9QUk9GSUxFLFxyXG4gICAgICAgICAgbWVzc2FnZTogQ05leHRNZXNzYWdlcy5QUk9CTEVNX0lOX1JFVFJJRVZFX0pPQl9QUk9GSUxFLFxyXG4gICAgICAgICAgY29kZTogNDAxXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLnNlbmQoe1xyXG4gICAgICAgICAgJ2RhdGEnOiByZXN1bHRcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG5cclxuICAgIH0pO1xyXG4gIH0gY2F0Y2ggKGUpIHtcclxuICAgIHJlcy5zdGF0dXMoNDAzKS5zZW5kKHttZXNzYWdlOiBlLm1lc3NhZ2V9KTtcclxuICB9XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UsIG5leHQ6IGFueSkge1xyXG4gIHRyeSB7XHJcblxyXG4gICAgdmFyIGpvYlByb2ZpbGVTZXJ2aWNlID0gbmV3IEpvYlByb2ZpbGVTZXJ2aWNlKCk7XHJcbiAgICBsZXQgZGF0YSA9IHtcclxuICAgICAgJ3JlY3J1aXRlcklkJzogcmVxLnBhcmFtcy5yZWNydWl0ZXJJZCxcclxuICAgICAgJ3Byb2ZpbGVJZCc6IHJlcS5wYXJhbXMucHJvZmlsZUlkLFxyXG4gICAgICAnbGlzdE5hbWUnOiByZXEucGFyYW1zLmxpc3ROYW1lLFxyXG4gICAgICAnY2FuZGlkYXRlSWQnOiByZXEucGFyYW1zLmNhbmRpZGF0ZUlkLFxyXG4gICAgICAnYWN0aW9uJzogcmVxLnBhcmFtcy5hY3Rpb25cclxuICAgIH07XHJcblxyXG4gICAgam9iUHJvZmlsZVNlcnZpY2UudXBkYXRlKGRhdGEsIChlcnIsIHJlc3VsdCkgPT4ge1xyXG4gICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgbmV4dCh7XHJcbiAgICAgICAgICByZWFzb246IE1lc3NhZ2VzLk1TR19FUlJPUl9SU05fVVNFUl9OT1RfRk9VTkQsXHJcbiAgICAgICAgICBtZXNzYWdlOiBNZXNzYWdlcy5NU0dfRVJST1JfUlNOX1VTRVJfTk9UX0ZPVU5ELFxyXG4gICAgICAgICAgY29kZTogNDAzXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLnNlbmQoe1xyXG4gICAgICAgICAgJ3N0YXR1cyc6IE1lc3NhZ2VzLlNUQVRVU19TVUNDRVNTLFxyXG4gICAgICAgICAgJ2RhdGEnOiByZXN1bHRcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfSBjYXRjaCAoZSkge1xyXG4gICAgcmVzLnN0YXR1cyg0MDMpLnNlbmQoe21lc3NhZ2U6IGUubWVzc2FnZX0pO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGFwcGx5KHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UsIG5leHQ6IGFueSkge1xyXG4gIHRyeSB7XHJcbiAgICB2YXIgam9iUHJvZmlsZVNlcnZpY2UgPSBuZXcgSm9iUHJvZmlsZVNlcnZpY2UoKTtcclxuICAgIGxldCBkYXRhID0ge1xyXG4gICAgICAnY2FuZGlkYXRlSWQnOiByZXEucGFyYW1zLmlkLFxyXG4gICAgICAncHJvZmlsZUlkJzogcmVxLnBhcmFtcy5wcm9maWxlSWQsXHJcbiAgICAgICdhY3Rpb24nOiByZXEucGFyYW1zLmFjdGlvbixcclxuICAgICAgJ2xpc3ROYW1lJzogcmVxLnBhcmFtcy5saXN0TmFtZVxyXG4gICAgfTtcclxuICAgIGpvYlByb2ZpbGVTZXJ2aWNlLmFwcGx5Sm9iKGRhdGEsIChlcnIsIHJlc3VsdCkgPT4ge1xyXG4gICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgbmV4dCh7XHJcbiAgICAgICAgICByZWFzb246IE1lc3NhZ2VzLk1TR19FUlJPUl9SU05fVVNFUl9OT1RfRk9VTkQsXHJcbiAgICAgICAgICBtZXNzYWdlOiBNZXNzYWdlcy5NU0dfRVJST1JfUlNOX1VTRVJfTk9UX0ZPVU5ELFxyXG4gICAgICAgICAgY29kZTogNDAzXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLnNlbmQoe1xyXG4gICAgICAgICAgJ3N0YXR1cyc6IE1lc3NhZ2VzLlNUQVRVU19TVUNDRVNTLFxyXG4gICAgICAgICAgJ2RhdGEnOiByZXN1bHRcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gIH0gY2F0Y2ggKGUpIHtcclxuICAgIHJlcy5zdGF0dXMoNDAzKS5zZW5kKHttZXNzYWdlOiBlLm1lc3NhZ2V9KTtcclxuICB9XHJcblxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbWV0Y2hSZXN1bHRGb3JKb2IocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSwgbmV4dDogYW55KSB7XHJcbiAgdHJ5IHtcclxuICAgIHZhciBzZWFyY2hTZXJ2aWNlID0gbmV3IFNlYXJjaFNlcnZpY2UoKTtcclxuICAgIGxldCBqb2JJZCA9IHJlcS5wYXJhbXMuam9iSWQ7XHJcbiAgICBsZXQgY2FuZGlkYXRlSWQgPSByZXEucGFyYW1zLmNhbmRpZGF0ZUlkO1xyXG4gICAgc2VhcmNoU2VydmljZS5nZXRNYXRjaGluZ1Jlc3VsdChjYW5kaWRhdGVJZCwgam9iSWQsIGZhbHNlLChlcnJvcjogYW55LCByZXN1bHQ6IGFueSkgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBuZXh0KHtcclxuICAgICAgICAgIHJlYXNvbjogJ1Byb2JsZW0gaW4gU2VhcmNoIE1hdGNoaW5nIFJlc3VsdCcsLy9NZXNzYWdlcy5NU0dfRVJST1JfUlNOX0lOVkFMSURfQ1JFREVOVElBTFMsXHJcbiAgICAgICAgICBtZXNzYWdlOiAnUHJvYmxlbSBpbiBTZWFyY2ggTWF0Y2hpbmcgUmVzdWx0JywvL01lc3NhZ2VzLk1TR19FUlJPUl9XUk9OR19UT0tFTixcclxuICAgICAgICAgIGNvZGU6IDQwMVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlcy5zZW5kKHtcclxuICAgICAgICAgICdzdGF0dXMnOiAnc3VjY2VzcycsXHJcbiAgICAgICAgICAnZGF0YSc6IHJlc3VsdCxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICB9IGNhdGNoIChlKSB7XHJcbiAgICByZXMuc3RhdHVzKDQwMykuc2VuZCh7bWVzc2FnZTogZS5tZXNzYWdlfSk7XHJcbiAgfVxyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVVc2VzVHJhY2tpbmcocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkge1xyXG4gIHRyeSB7XHJcbiAgICBsZXQgZGF0YSA6IFVzYWdlVHJhY2tpbmc7XHJcbiAgICBkYXRhID0gcmVxLmJvZHk7XHJcbiAgICBkYXRhLnRpbWVzdGFtcCA9IG5ldyBEYXRlKCk7XHJcbiAgICBsZXQgb2JqOiBhbnkgPSBuZXcgdXNlc3RyYWNraW5nLk15Q29udHJvbGxlcigpO1xyXG4gICAgb2JqLl9jb250cm9sbGVyLmNyZWF0ZShkYXRhKTtcclxuICAgIHJlcy5zZW5kKHtcclxuICAgICAgJ3N0YXR1cyc6ICdzdWNjZXNzJyxcclxuICAgIH0pO1xyXG4gIH0gY2F0Y2ggKGUpIHtcclxuICAgIHJlcy5zdGF0dXMoNDAzKS5zZW5kKHttZXNzYWdlOiBlLm1lc3NhZ2V9KTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRRQ2FyZERldGFpbHMocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSwgbmV4dDogYW55KSB7XHJcbiAgdHJ5IHtcclxuICAgIHZhciBqb2JQcm9maWxlU2VydmljZSA9IG5ldyBKb2JQcm9maWxlU2VydmljZSgpO1xyXG4gICAgbGV0IGRhdGEgPSB7XHJcbiAgICAgICdqb2JJZCc6IHJlcS5wYXJhbXMuaWQsXHJcbiAgICAgICdjYW5kaWRhdGVJZHMnOiByZXEuYm9keS5jYW5kaWRhdGVJZHNcclxuICAgIH07XHJcbiAgICBqb2JQcm9maWxlU2VydmljZS5nZXRRQ2FyZERldGFpbHMoZGF0YSwgKGVycm9yOiBFcnJvciwgcmVzdWx0OiBhbnkpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgcmVzLnN0YXR1cygzMDQpLnNlbmQoZXJyb3IpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5zZW5kKHJlc3VsdCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH0gY2F0Y2ggKGUpIHtcclxuICAgIHJlcy5zdGF0dXMoNDAzKS5zZW5kKHttZXNzYWdlOiBlLm1lc3NhZ2V9KTtcclxuICB9XHJcbn1cclxuZXhwb3J0IGZ1bmN0aW9uIGNsb25lSm9iKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UsIG5leHQ6IGFueSkge1xyXG4gIHRyeSB7XHJcbiAgICB2YXIgbmV3Sm9iVGl0bGUgPSByZXEucXVlcnkubmV3Sm9iVGl0bGU7XHJcbiAgICB2YXIgam9iUHJvZmlsZVNlcnZpY2UgPSBuZXcgSm9iUHJvZmlsZVNlcnZpY2UoKTtcclxuICAgIGxldCBkYXRhID0ge1xyXG4gICAgICAncG9zdGVkSm9iJzpyZXEucGFyYW1zLmlkXHJcbiAgICB9O1xyXG4gICAgam9iUHJvZmlsZVNlcnZpY2UucmV0cmlldmUoZGF0YSwgKGVycm9yLCByZXN1bHQpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgbmV4dCh7XHJcbiAgICAgICAgICByZWFzb246IENOZXh0TWVzc2FnZXMuUFJPQkxFTV9JTl9SRVRSSUVWRV9KT0JfUFJPRklMRSxcclxuICAgICAgICAgIG1lc3NhZ2U6IENOZXh0TWVzc2FnZXMuUFJPQkxFTV9JTl9SRVRSSUVWRV9KT0JfUFJPRklMRSxcclxuICAgICAgICAgIGNvZGU6IDQwMVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHZhciBuZXdKb2I6YW55PXJlc3VsdC5wb3N0ZWRKb2JzWzBdO1xyXG5cclxuICAgICAgICBkZWxldGUgbmV3Sm9iLl9pZDtcclxuICAgICAgICBuZXdKb2Iuam9iVGl0bGU9bmV3Sm9iVGl0bGU7XHJcbiAgICAgICAgbmV3Sm9iLmlzSm9iUG9zdGVkPWZhbHNlO1xyXG4gICAgICAgIG5ld0pvYi5pc0pvYlNoYXJlZD1mYWxzZTtcclxuICAgICAgICBuZXdKb2Iuc2hhcmVkTGluaz0nJztcclxuICAgICAgICBuZXdKb2IucG9zdGluZ0RhdGUgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgIG5ld0pvYi5jYW5kaWRhdGVfbGlzdD1bXTtcclxuICAgICAgICBuZXdKb2IuaXNKb2JQb3N0Q2xvc2VkID0gZmFsc2U7XHJcbiAgICAgICAgbmV3Sm9iLmpvYkNsb3NlUmVhc29uID0gbnVsbDtcclxuXHJcbiAgICAgICAgbmV3Sm9iLmV4cGlyaW5nRGF0ZSA9IG5ldyBEYXRlKChuZXcgRGF0ZSgpLmdldFRpbWUoKSArIENvbnN0VmFyaWFibGVzLkpPQl9fRVhQSVJJWV9QRVJJT0QpKTtcclxuICAgICAgICB2YXIgcmVjcnVpdGVyU2VydmljZSA9IG5ldyBSZWNydWl0ZXJTZXJ2aWNlKCk7XHJcbiAgICAgICAgcmVjcnVpdGVyU2VydmljZS5hZGRDbG9uZUpvYiggcmVzdWx0LnVzZXJJZCwgbmV3Sm9iLCAoZXJyLCByZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgIG5leHQoe1xyXG4gICAgICAgICAgICAgICAgcmVhc29uOmVycixcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxyXG4gICAgICAgICAgICAgICAgY29kZTogNDAzXHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgcmVzLnN0YXR1cygyMDApLnNlbmQoe1xyXG4gICAgICAgICAgICAgICAgJ3N0YXR1cyc6IE1lc3NhZ2VzLlNUQVRVU19TVUNDRVNTLFxyXG4gICAgICAgICAgICAgICAgJ2RhdGEnOiByZXN1bHQucG9zdGVkSm9ic1swXS5faWRcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICB9KTtcclxuICB9IGNhdGNoIChlKSB7XHJcbiAgICByZXMuc3RhdHVzKDQwMykuc2VuZCh7bWVzc2FnZTogZS5tZXNzYWdlfSk7XHJcbiAgfVxyXG59XHJcblxyXG4iXX0=
