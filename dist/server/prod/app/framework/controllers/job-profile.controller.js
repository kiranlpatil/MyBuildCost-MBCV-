"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var sharedconstants_1 = require("../shared/sharedconstants");
var Messages = require("../shared/messages");
var JobProfileService = require("../services/jobprofile.service");
var CNextMessages = require("../shared/cnext-messages");
var SearchService = require("../search/services/search.service");
var RecruiterService = require("../services/recruiter.service");
var usestracking = require('uses-tracking');
function searchCandidatesByJobProfile(req, res, next) {
    try {
        var jobProfile = req.body;
        var jobProfileService = new JobProfileService();
        jobProfileService.searchCandidatesByJobProfile(jobProfile, function (error, result) {
            if (error) {
                next({
                    reason: 'No candidates are present for this Job Profile',
                    message: 'No candidates are present for this Job Profile',
                    stackTrace: new Error(),
                    code: 401
                });
            }
            else {
                res.send({
                    'status': 'success',
                    'data': result
                });
            }
        });
    }
    catch (e) {
        next({
            reason: e.message,
            message: e.message,
            stackTrace: new Error(),
            code: 500
        });
    }
}
exports.searchCandidatesByJobProfile = searchCandidatesByJobProfile;
function retrieve(req, res, next) {
    try {
        var jobProfileService = new JobProfileService();
        var data = {
            'postedJob': req.params.id
        };
        jobProfileService.retrieve(data, function (error, result) {
            if (error) {
                next({
                    reason: CNextMessages.PROBLEM_IN_RETRIEVE_JOB_PROFILE,
                    message: CNextMessages.PROBLEM_IN_RETRIEVE_JOB_PROFILE,
                    stackTrace: new Error(),
                    code: 401
                });
            }
            else {
                var currentDate = Number(new Date());
                var expiringDate = Number(new Date(result.postedJobs[0].expiringDate));
                var daysRemainingForExpiring = Math.round(Number(new Date(expiringDate - currentDate)) / (1000 * 60 * 60 * 24));
                result.postedJobs[0].daysRemainingForExpiring = daysRemainingForExpiring;
                if (daysRemainingForExpiring <= 0) {
                    result.postedJobs[0].isJobPostExpired = true;
                }
                else {
                    result.postedJobs[0].isJobPostExpired = false;
                }
                res.status(200).send({
                    'data': {
                        'industry': result
                    }
                });
            }
        });
    }
    catch (e) {
        next({
            reason: e.message,
            message: e.message,
            stackTrace: new Error(),
            code: 500
        });
    }
}
exports.retrieve = retrieve;
function getCapabilityMatrix(req, res, next) {
    try {
        var jobProfileService = new JobProfileService();
        var data = {
            'postedJob': req.params.id
        };
        jobProfileService.getCapabilityValueKeyMatrix(req.params.id, function (error, result) {
            if (error) {
                next({
                    reason: CNextMessages.PROBLEM_IN_RETRIEVE_JOB_PROFILE,
                    message: CNextMessages.PROBLEM_IN_RETRIEVE_JOB_PROFILE,
                    stackTrace: new Error(),
                    code: 401
                });
            }
            else {
                res.status(200).send({
                    'data': result
                });
            }
        });
    }
    catch (e) {
        next({
            reason: e.message,
            message: e.message,
            stackTrace: new Error(),
            code: 500
        });
    }
}
exports.getCapabilityMatrix = getCapabilityMatrix;
function update(req, res, next) {
    try {
        var jobProfileService = new JobProfileService();
        var data = {
            'recruiterId': req.params.recruiterId,
            'profileId': req.params.profileId,
            'listName': req.params.listName,
            'candidateId': req.params.candidateId,
            'action': req.params.action
        };
        jobProfileService.update(data, function (err, result) {
            if (err) {
                next({
                    reason: Messages.MSG_ERROR_RSN_USER_NOT_FOUND,
                    message: Messages.MSG_ERROR_RSN_USER_NOT_FOUND,
                    stackTrace: new Error(),
                    code: 403
                });
            }
            else {
                res.status(200).send({
                    'status': Messages.STATUS_SUCCESS,
                    'data': result
                });
            }
        });
    }
    catch (e) {
        next({
            reason: e.message,
            message: e.message,
            stackTrace: new Error(),
            code: 500
        });
    }
}
exports.update = update;
function apply(req, res, next) {
    try {
        var jobProfileService = new JobProfileService();
        var data = {
            'candidateId': req.params.id,
            'profileId': req.params.profileId,
            'action': req.params.action,
            'listName': req.params.listName
        };
        jobProfileService.applyJob(data, function (err, result) {
            if (err) {
                next({
                    reason: Messages.MSG_ERROR_RSN_USER_NOT_FOUND,
                    message: Messages.MSG_ERROR_RSN_USER_NOT_FOUND,
                    stackTrace: new Error(),
                    code: 403
                });
            }
            else {
                res.status(200).send({
                    'status': Messages.STATUS_SUCCESS,
                    'data': result
                });
            }
        });
    }
    catch (e) {
        next({
            reason: e.message,
            message: e.message,
            stackTrace: new Error(),
            code: 500
        });
    }
}
exports.apply = apply;
function metchResultForJob(req, res, next) {
    try {
        var searchService = new SearchService();
        var jobId = req.params.jobId;
        var candidateId = req.params.candidateId;
        searchService.getMatchingResult(candidateId, jobId, false, function (error, result) {
            if (error) {
                next({
                    reason: 'Problem in Search Matching Result',
                    message: 'Problem in Search Matching Result',
                    stackTrace: new Error(),
                    code: 401
                });
            }
            else {
                res.send({
                    'status': 'success',
                    'data': result,
                });
            }
        });
    }
    catch (e) {
        next({
            reason: e.message,
            message: e.message,
            stackTrace: new Error(),
            code: 500
        });
    }
}
exports.metchResultForJob = metchResultForJob;
function createUsesTracking(req, res, next) {
    try {
        var data = void 0;
        data = req.body;
        data.timestamp = new Date();
        var obj = new usestracking.MyController();
        obj._controller.create(data);
        res.send({
            'status': 'success',
        });
    }
    catch (e) {
        next({
            reason: e.message,
            message: e.message,
            stackTrace: new Error(),
            code: 500
        });
    }
}
exports.createUsesTracking = createUsesTracking;
function getQCardDetails(req, res, next) {
    try {
        var jobProfileService = new JobProfileService();
        var data = {
            'jobId': req.params.id,
            'candidateIds': req.body.candidateIds
        };
        jobProfileService.getQCardDetails(data, function (error, result) {
            if (error) {
                next(error);
            }
            else {
                res.status(200).send(result);
            }
        });
    }
    catch (e) {
        next({
            reason: e.message,
            message: e.message,
            stackTrace: new Error(),
            code: 500
        });
    }
}
exports.getQCardDetails = getQCardDetails;
function cloneJob(req, res, next) {
    try {
        var newJobTitle = req.query.newJobTitle;
        var jobProfileService = new JobProfileService();
        var data = {
            'postedJob': req.params.id
        };
        jobProfileService.retrieve(data, function (error, result) {
            if (error) {
                next({
                    reason: CNextMessages.PROBLEM_IN_RETRIEVE_JOB_PROFILE,
                    message: CNextMessages.PROBLEM_IN_RETRIEVE_JOB_PROFILE,
                    stackTrace: new Error(),
                    code: 401
                });
            }
            else {
                var newJob = result.postedJobs[0];
                delete newJob._id;
                newJob.jobTitle = newJobTitle;
                newJob.isJobPosted = false;
                newJob.isJobShared = false;
                newJob.sharedLink = '';
                newJob.postingDate = new Date();
                newJob.candidate_list = [];
                newJob.isJobPostClosed = false;
                newJob.jobCloseReason = null;
                newJob.expiringDate = new Date((new Date().getTime() + sharedconstants_1.ConstVariables.JOB__EXPIRIY_PERIOD));
                var recruiterService = new RecruiterService();
                recruiterService.addCloneJob(result.userId, newJob, function (err, result) {
                    if (err) {
                        next({
                            reason: err,
                            message: err.message,
                            stackTrace: new Error(),
                            code: 403
                        });
                    }
                    else {
                        res.status(200).send({
                            'status': Messages.STATUS_SUCCESS,
                            'data': result.postedJobs[0]._id
                        });
                    }
                });
            }
        });
    }
    catch (e) {
        next({
            reason: e.message,
            message: e.message,
            stackTrace: new Error(),
            code: 500
        });
    }
}
exports.cloneJob = cloneJob;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9mcmFtZXdvcmsvY29udHJvbGxlcnMvam9iLXByb2ZpbGUuY29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUVBLDZEQUF5RDtBQUN6RCw2Q0FBZ0Q7QUFFaEQsa0VBQXFFO0FBQ3JFLHdEQUEyRDtBQUMzRCxpRUFBb0U7QUFDcEUsZ0VBQW1FO0FBQ25FLElBQUksWUFBWSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUc1QyxzQ0FBNkMsR0FBb0IsRUFBRSxHQUFxQixFQUFFLElBQVM7SUFDakcsSUFBSSxDQUFDO1FBQ0gsSUFBSSxVQUFVLEdBQXFDLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDNUQsSUFBSSxpQkFBaUIsR0FBc0IsSUFBSSxpQkFBaUIsRUFBRSxDQUFDO1FBQ25FLGlCQUFpQixDQUFDLDRCQUE0QixDQUFDLFVBQVUsRUFBRSxVQUFDLEtBQUssRUFBRSxNQUFNO1lBQ3ZFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ1YsSUFBSSxDQUFDO29CQUNILE1BQU0sRUFBRSxnREFBZ0Q7b0JBQ3hELE9BQU8sRUFBRSxnREFBZ0Q7b0JBQ3pELFVBQVUsRUFBRSxJQUFJLEtBQUssRUFBRTtvQkFDdkIsSUFBSSxFQUFFLEdBQUc7aUJBQ1YsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLEdBQUcsQ0FBQyxJQUFJLENBQUM7b0JBQ1AsUUFBUSxFQUFFLFNBQVM7b0JBQ25CLE1BQU0sRUFBRSxNQUFNO2lCQUNmLENBQUMsQ0FBQztZQUNMLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUVMLENBQUM7SUFBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ1gsSUFBSSxDQUFDO1lBQ0gsTUFBTSxFQUFFLENBQUMsQ0FBQyxPQUFPO1lBQ2pCLE9BQU8sRUFBRSxDQUFDLENBQUMsT0FBTztZQUNsQixVQUFVLEVBQUUsSUFBSSxLQUFL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QUNILENBQUM7QUF4REQsNEJBd0RDIiwiZmlsZSI6ImFwcC9mcmFtZXdvcmsvY29udHJvbGxlcnMvam9iLXByb2ZpbGUuY29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGV4cHJlc3MgZnJvbSBcImV4cHJlc3NcIjtcbmltcG9ydCB7VXNhZ2VUcmFja2luZ30gZnJvbSBcIi4uL2RhdGFhY2Nlc3MvbW9kZWwvdXNhZ2UtdHJhY2tpbmdcIjtcbmltcG9ydCB7Q29uc3RWYXJpYWJsZXN9IGZyb20gXCIuLi9zaGFyZWQvc2hhcmVkY29uc3RhbnRzXCI7XG5pbXBvcnQgTWVzc2FnZXMgPSByZXF1aXJlKCcuLi9zaGFyZWQvbWVzc2FnZXMnKTtcbmltcG9ydCBKb2JQcm9maWxlTW9kZWwgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL21vZGVsL2pvYnByb2ZpbGUubW9kZWwnKTtcbmltcG9ydCBKb2JQcm9maWxlU2VydmljZSA9IHJlcXVpcmUoJy4uL3NlcnZpY2VzL2pvYnByb2ZpbGUuc2VydmljZScpO1xuaW1wb3J0IENOZXh0TWVzc2FnZXMgPSByZXF1aXJlKCcuLi9zaGFyZWQvY25leHQtbWVzc2FnZXMnKTtcbmltcG9ydCBTZWFyY2hTZXJ2aWNlID0gcmVxdWlyZSgnLi4vc2VhcmNoL3NlcnZpY2VzL3NlYXJjaC5zZXJ2aWNlJyk7XG5pbXBvcnQgUmVjcnVpdGVyU2VydmljZSA9IHJlcXVpcmUoJy4uL3NlcnZpY2VzL3JlY3J1aXRlci5zZXJ2aWNlJyk7XG5sZXQgdXNlc3RyYWNraW5nID0gcmVxdWlyZSgndXNlcy10cmFja2luZycpO1xuXG5cbmV4cG9ydCBmdW5jdGlvbiBzZWFyY2hDYW5kaWRhdGVzQnlKb2JQcm9maWxlKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UsIG5leHQ6IGFueSkge1xuICB0cnkge1xuICAgIGxldCBqb2JQcm9maWxlOiBKb2JQcm9maWxlTW9kZWwgPSA8Sm9iUHJvZmlsZU1vZGVsPnJlcS5ib2R5O1xuICAgIGxldCBqb2JQcm9maWxlU2VydmljZTogSm9iUHJvZmlsZVNlcnZpY2UgPSBuZXcgSm9iUHJvZmlsZVNlcnZpY2UoKTtcbiAgICBqb2JQcm9maWxlU2VydmljZS5zZWFyY2hDYW5kaWRhdGVzQnlKb2JQcm9maWxlKGpvYlByb2ZpbGUsIChlcnJvciwgcmVzdWx0KSA9PiB7XG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgbmV4dCh7XG4gICAgICAgICAgcmVhc29uOiAnTm8gY2FuZGlkYXRlcyBhcmUgcHJlc2VudCBmb3IgdGhpcyBKb2IgUHJvZmlsZScsLy9NZXNzYWdlcy5NU0dfRVJST1JfUlNOX0lOVkFMSURfQ1JFREVOVElBTFMsXG4gICAgICAgICAgbWVzc2FnZTogJ05vIGNhbmRpZGF0ZXMgYXJlIHByZXNlbnQgZm9yIHRoaXMgSm9iIFByb2ZpbGUnLFxuICAgICAgICAgIHN0YWNrVHJhY2U6IG5ldyBFcnJvcigpLFxuICAgICAgICAgIGNvZGU6IDQwMVxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcy5zZW5kKHtcbiAgICAgICAgICAnc3RhdHVzJzogJ3N1Y2Nlc3MnLFxuICAgICAgICAgICdkYXRhJzogcmVzdWx0XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuXG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBuZXh0KHtcbiAgICAgIHJlYXNvbjogZS5tZXNzYWdlLFxuICAgICAgbWVzc2FnZTogZS5tZXNzYWdlLFxuICAgICAgc3RhY2tUcmFjZTogbmV3IEVycm9yKCksXG4gICAgICBjb2RlOiA1MDBcbiAgICB9KTtcbiAgfVxuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXRyaWV2ZShyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlLCBuZXh0OiBhbnkpIHtcbiAgdHJ5IHtcbiAgICB2YXIgam9iUHJvZmlsZVNlcnZpY2UgPSBuZXcgSm9iUHJvZmlsZVNlcnZpY2UoKTtcbiAgICBsZXQgZGF0YSA9IHtcbiAgICAgICdwb3N0ZWRKb2InOiByZXEucGFyYW1zLmlkXG4gICAgfTtcbiAgICBqb2JQcm9maWxlU2VydmljZS5yZXRyaWV2ZShkYXRhLCAoZXJyb3IsIHJlc3VsdCkgPT4ge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIG5leHQoe1xuICAgICAgICAgIHJlYXNvbjogQ05leHRNZXNzYWdlcy5QUk9CTEVNX0lOX1JFVFJJRVZFX0pPQl9QUk9GSUxFLFxuICAgICAgICAgIG1lc3NhZ2U6IENOZXh0TWVzc2FnZXMuUFJPQkxFTV9JTl9SRVRSSUVWRV9KT0JfUFJPRklMRSxcbiAgICAgICAgICBzdGFja1RyYWNlOiBuZXcgRXJyb3IoKSxcbiAgICAgICAgICBjb2RlOiA0MDFcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsZXQgY3VycmVudERhdGUgPSBOdW1iZXIobmV3IERhdGUoKSk7XG4gICAgICAgIGxldCBleHBpcmluZ0RhdGUgPSBOdW1iZXIobmV3IERhdGUocmVzdWx0LnBvc3RlZEpvYnNbMF0uZXhwaXJpbmdEYXRlKSk7XG4gICAgICAgIGxldCBkYXlzUmVtYWluaW5nRm9yRXhwaXJpbmcgPSBNYXRoLnJvdW5kKE51bWJlcihuZXcgRGF0ZShleHBpcmluZ0RhdGUgLSBjdXJyZW50RGF0ZSkpIC8gKDEwMDAgKiA2MCAqIDYwICogMjQpKTtcbiAgICAgICAgcmVzdWx0LnBvc3RlZEpvYnNbMF0uZGF5c1JlbWFpbmluZ0ZvckV4cGlyaW5nID0gZGF5c1JlbWFpbmluZ0ZvckV4cGlyaW5nO1xuICAgICAgICBpZiAoZGF5c1JlbWFpbmluZ0ZvckV4cGlyaW5nIDw9IDApIHtcbiAgICAgICAgICByZXN1bHQucG9zdGVkSm9ic1swXS5pc0pvYlBvc3RFeHBpcmVkID0gdHJ1ZTtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdC5wb3N0ZWRKb2JzWzBdLmlzSm9iUG9zdEV4cGlyZWQgPSBmYWxzZTtcblxuICAgICAgICB9XG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5zZW5kKHtcbiAgICAgICAgICAnZGF0YSc6IHtcbiAgICAgICAgICAgICdpbmR1c3RyeSc6IHJlc3VsdFxuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG5cblxuICAgIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbmV4dCh7XG4gICAgICByZWFzb246IGUubWVzc2FnZSxcbiAgICAgIG1lc3NhZ2U6IGUubWVzc2FnZSxcbiAgICAgIHN0YWNrVHJhY2U6IG5ldyBFcnJvcigpLFxuICAgICAgY29kZTogNTAwXG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENhcGFiaWxpdHlNYXRyaXgocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSwgbmV4dDogYW55KSB7XG4gIHRyeSB7XG4gICAgdmFyIGpvYlByb2ZpbGVTZXJ2aWNlID0gbmV3IEpvYlByb2ZpbGVTZXJ2aWNlKCk7XG4gICAgbGV0IGRhdGEgPSB7XG4gICAgICAncG9zdGVkSm9iJzogcmVxLnBhcmFtcy5pZFxuICAgIH07XG4gICAgam9iUHJvZmlsZVNlcnZpY2UuZ2V0Q2FwYWJpbGl0eVZhbHVlS2V5TWF0cml4KHJlcS5wYXJhbXMuaWQsIChlcnJvciwgcmVzdWx0KSA9PiB7XG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgbmV4dCh7XG4gICAgICAgICAgcmVhc29uOiBDTmV4dE1lc3NhZ2VzLlBST0JMRU1fSU5fUkVUUklFVkVfSk9CX1BST0ZJTEUsXG4gICAgICAgICAgbWVzc2FnZTogQ05leHRNZXNzYWdlcy5QUk9CTEVNX0lOX1JFVFJJRVZFX0pPQl9QUk9GSUxFLFxuICAgICAgICAgIHN0YWNrVHJhY2U6IG5ldyBFcnJvcigpLFxuICAgICAgICAgIGNvZGU6IDQwMVxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5zZW5kKHtcbiAgICAgICAgICAnZGF0YSc6IHJlc3VsdFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbmV4dCh7XG4gICAgICByZWFzb246IGUubWVzc2FnZSxcbiAgICAgIG1lc3NhZ2U6IGUubWVzc2FnZSxcbiAgICAgIHN0YWNrVHJhY2U6IG5ldyBFcnJvcigpLFxuICAgICAgY29kZTogNTAwXG4gICAgfSk7XG4gIH1cbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UsIG5leHQ6IGFueSkge1xuICB0cnkge1xuXG4gICAgdmFyIGpvYlByb2ZpbGVTZXJ2aWNlID0gbmV3IEpvYlByb2ZpbGVTZXJ2aWNlKCk7XG4gICAgbGV0IGRhdGEgPSB7XG4gICAgICAncmVjcnVpdGVySWQnOiByZXEucGFyYW1zLnJlY3J1aXRlcklkLFxuICAgICAgJ3Byb2ZpbGVJZCc6IHJlcS5wYXJhbXMucHJvZmlsZUlkLFxuICAgICAgJ2xpc3ROYW1lJzogcmVxLnBhcmFtcy5saXN0TmFtZSxcbiAgICAgICdjYW5kaWRhdGVJZCc6IHJlcS5wYXJhbXMuY2FuZGlkYXRlSWQsXG4gICAgICAnYWN0aW9uJzogcmVxLnBhcmFtcy5hY3Rpb25cbiAgICB9O1xuXG4gICAgam9iUHJvZmlsZVNlcnZpY2UudXBkYXRlKGRhdGEsIChlcnIsIHJlc3VsdCkgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBuZXh0KHtcbiAgICAgICAgICByZWFzb246IE1lc3NhZ2VzLk1TR19FUlJPUl9SU05fVVNFUl9OT1RfRk9VTkQsXG4gICAgICAgICAgbWVzc2FnZTogTWVzc2FnZXMuTVNHX0VSUk9SX1JTTl9VU0VSX05PVF9GT1VORCxcbiAgICAgICAgICBzdGFja1RyYWNlOiBuZXcgRXJyb3IoKSxcbiAgICAgICAgICBjb2RlOiA0MDNcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuc3RhdHVzKDIwMCkuc2VuZCh7XG4gICAgICAgICAgJ3N0YXR1cyc6IE1lc3NhZ2VzLlNUQVRVU19TVUNDRVNTLFxuICAgICAgICAgICdkYXRhJzogcmVzdWx0XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbmV4dCh7XG4gICAgICByZWFzb246IGUubWVzc2FnZSxcbiAgICAgIG1lc3NhZ2U6IGUubWVzc2FnZSxcbiAgICAgIHN0YWNrVHJhY2U6IG5ldyBFcnJvcigpLFxuICAgICAgY29kZTogNTAwXG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFwcGx5KHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UsIG5leHQ6IGFueSkge1xuICB0cnkge1xuICAgIHZhciBqb2JQcm9maWxlU2VydmljZSA9IG5ldyBKb2JQcm9maWxlU2VydmljZSgpO1xuICAgIGxldCBkYXRhID0ge1xuICAgICAgJ2NhbmRpZGF0ZUlkJzogcmVxLnBhcmFtcy5pZCxcbiAgICAgICdwcm9maWxlSWQnOiByZXEucGFyYW1zLnByb2ZpbGVJZCxcbiAgICAgICdhY3Rpb24nOiByZXEucGFyYW1zLmFjdGlvbixcbiAgICAgICdsaXN0TmFtZSc6IHJlcS5wYXJhbXMubGlzdE5hbWVcbiAgICB9O1xuICAgIGpvYlByb2ZpbGVTZXJ2aWNlLmFwcGx5Sm9iKGRhdGEsIChlcnIsIHJlc3VsdCkgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBuZXh0KHtcbiAgICAgICAgICByZWFzb246IE1lc3NhZ2VzLk1TR19FUlJPUl9SU05fVVNFUl9OT1RfRk9VTkQsXG4gICAgICAgICAgbWVzc2FnZTogTWVzc2FnZXMuTVNHX0VSUk9SX1JTTl9VU0VSX05PVF9GT1VORCxcbiAgICAgICAgICBzdGFja1RyYWNlOiBuZXcgRXJyb3IoKSxcbiAgICAgICAgICBjb2RlOiA0MDNcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuc3RhdHVzKDIwMCkuc2VuZCh7XG4gICAgICAgICAgJ3N0YXR1cyc6IE1lc3NhZ2VzLlNUQVRVU19TVUNDRVNTLFxuICAgICAgICAgICdkYXRhJzogcmVzdWx0XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuXG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBuZXh0KHtcbiAgICAgIHJlYXNvbjogZS5tZXNzYWdlLFxuICAgICAgbWVzc2FnZTogZS5tZXNzYWdlLFxuICAgICAgc3RhY2tUcmFjZTogbmV3IEVycm9yKCksXG4gICAgICBjb2RlOiA1MDBcbiAgICB9KTtcbiAgfVxuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtZXRjaFJlc3VsdEZvckpvYihyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlLCBuZXh0OiBhbnkpIHtcbiAgdHJ5IHtcbiAgICB2YXIgc2VhcmNoU2VydmljZSA9IG5ldyBTZWFyY2hTZXJ2aWNlKCk7XG4gICAgbGV0IGpvYklkID0gcmVxLnBhcmFtcy5qb2JJZDtcbiAgICBsZXQgY2FuZGlkYXRlSWQgPSByZXEucGFyYW1zLmNhbmRpZGF0ZUlkO1xuICAgIHNlYXJjaFNlcnZpY2UuZ2V0TWF0Y2hpbmdSZXN1bHQoY2FuZGlkYXRlSWQsIGpvYklkLCBmYWxzZSwgKGVycm9yOiBhbnksIHJlc3VsdDogYW55KSA9PiB7XG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgbmV4dCh7XG4gICAgICAgICAgcmVhc29uOiAnUHJvYmxlbSBpbiBTZWFyY2ggTWF0Y2hpbmcgUmVzdWx0JywvL01lc3NhZ2VzLk1TR19FUlJPUl9SU05fSU5WQUxJRF9DUkVERU5USUFMUyxcbiAgICAgICAgICBtZXNzYWdlOiAnUHJvYmxlbSBpbiBTZWFyY2ggTWF0Y2hpbmcgUmVzdWx0JywvL01lc3NhZ2VzLk1TR19FUlJPUl9XUk9OR19UT0tFTixcbiAgICAgICAgICBzdGFja1RyYWNlOiBuZXcgRXJyb3IoKSxcbiAgICAgICAgICBjb2RlOiA0MDFcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuc2VuZCh7XG4gICAgICAgICAgJ3N0YXR1cyc6ICdzdWNjZXNzJyxcbiAgICAgICAgICAnZGF0YSc6IHJlc3VsdCxcbiAgICAgICAgfSk7XG5cbiAgICAgIH1cbiAgICB9KTtcblxuICB9IGNhdGNoIChlKSB7XG4gICAgbmV4dCh7XG4gICAgICByZWFzb246IGUubWVzc2FnZSxcbiAgICAgIG1lc3NhZ2U6IGUubWVzc2FnZSxcbiAgICAgIHN0YWNrVHJhY2U6IG5ldyBFcnJvcigpLFxuICAgICAgY29kZTogNTAwXG4gICAgfSk7XG4gIH1cbn1cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVVc2VzVHJhY2tpbmcocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSwgbmV4dDogYW55KSB7XG4gIHRyeSB7XG4gICAgbGV0IGRhdGE6IFVzYWdlVHJhY2tpbmc7XG4gICAgZGF0YSA9IHJlcS5ib2R5O1xuICAgIGRhdGEudGltZXN0YW1wID0gbmV3IERhdGUoKTtcbiAgICBsZXQgb2JqOiBhbnkgPSBuZXcgdXNlc3RyYWNraW5nLk15Q29udHJvbGxlcigpO1xuICAgIG9iai5fY29udHJvbGxlci5jcmVhdGUoZGF0YSk7XG4gICAgcmVzLnNlbmQoe1xuICAgICAgJ3N0YXR1cyc6ICdzdWNjZXNzJyxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIG5leHQoe1xuICAgICAgcmVhc29uOiBlLm1lc3NhZ2UsXG4gICAgICBtZXNzYWdlOiBlLm1lc3NhZ2UsXG4gICAgICBzdGFja1RyYWNlOiBuZXcgRXJyb3IoKSxcbiAgICAgIGNvZGU6IDUwMFxuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRRQ2FyZERldGFpbHMocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSwgbmV4dDogYW55KSB7XG4gIHRyeSB7XG4gICAgdmFyIGpvYlByb2ZpbGVTZXJ2aWNlID0gbmV3IEpvYlByb2ZpbGVTZXJ2aWNlKCk7XG4gICAgbGV0IGRhdGEgPSB7XG4gICAgICAnam9iSWQnOiByZXEucGFyYW1zLmlkLFxuICAgICAgJ2NhbmRpZGF0ZUlkcyc6IHJlcS5ib2R5LmNhbmRpZGF0ZUlkc1xuICAgIH07XG4gICAgam9iUHJvZmlsZVNlcnZpY2UuZ2V0UUNhcmREZXRhaWxzKGRhdGEsIChlcnJvcjogRXJyb3IsIHJlc3VsdDogYW55KSA9PiB7XG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgbmV4dChlcnJvcik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuc3RhdHVzKDIwMCkuc2VuZChyZXN1bHQpO1xuICAgICAgfVxuICAgIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbmV4dCh7XG4gICAgICByZWFzb246IGUubWVzc2FnZSxcbiAgICAgIG1lc3NhZ2U6IGUubWVzc2FnZSxcbiAgICAgIHN0YWNrVHJhY2U6IG5ldyBFcnJvcigpLFxuICAgICAgY29kZTogNTAwXG4gICAgfSk7XG4gIH1cbn1cbmV4cG9ydCBmdW5jdGlvbiBjbG9uZUpvYihyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlLCBuZXh0OiBhbnkpIHtcbiAgdHJ5IHtcbiAgICB2YXIgbmV3Sm9iVGl0bGUgPSByZXEucXVlcnkubmV3Sm9iVGl0bGU7XG4gICAgdmFyIGpvYlByb2ZpbGVTZXJ2aWNlID0gbmV3IEpvYlByb2ZpbGVTZXJ2aWNlKCk7XG4gICAgbGV0IGRhdGEgPSB7XG4gICAgICAncG9zdGVkSm9iJzogcmVxLnBhcmFtcy5pZFxuICAgIH07XG4gICAgam9iUHJvZmlsZVNlcnZpY2UucmV0cmlldmUoZGF0YSwgKGVycm9yLCByZXN1bHQpID0+IHtcbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICBuZXh0KHtcbiAgICAgICAgICByZWFzb246IENOZXh0TWVzc2FnZXMuUFJPQkxFTV9JTl9SRVRSSUVWRV9KT0JfUFJPRklMRSxcbiAgICAgICAgICBtZXNzYWdlOiBDTmV4dE1lc3NhZ2VzLlBST0JMRU1fSU5fUkVUUklFVkVfSk9CX1BST0ZJTEUsXG4gICAgICAgICAgc3RhY2tUcmFjZTogbmV3IEVycm9yKCksXG4gICAgICAgICAgY29kZTogNDAxXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIG5ld0pvYjogYW55ID0gcmVzdWx0LnBvc3RlZEpvYnNbMF07XG5cbiAgICAgICAgZGVsZXRlIG5ld0pvYi5faWQ7XG4gICAgICAgIG5ld0pvYi5qb2JUaXRsZSA9IG5ld0pvYlRpdGxlO1xuICAgICAgICBuZXdKb2IuaXNKb2JQb3N0ZWQgPSBmYWxzZTtcbiAgICAgICAgbmV3Sm9iLmlzSm9iU2hhcmVkID0gZmFsc2U7XG4gICAgICAgIG5ld0pvYi5zaGFyZWRMaW5rID0gJyc7XG4gICAgICAgIG5ld0pvYi5wb3N0aW5nRGF0ZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgIG5ld0pvYi5jYW5kaWRhdGVfbGlzdCA9IFtdO1xuICAgICAgICBuZXdKb2IuaXNKb2JQb3N0Q2xvc2VkID0gZmFsc2U7XG4gICAgICAgIG5ld0pvYi5qb2JDbG9zZVJlYXNvbiA9IG51bGw7XG5cbiAgICAgICAgbmV3Sm9iLmV4cGlyaW5nRGF0ZSA9IG5ldyBEYXRlKChuZXcgRGF0ZSgpLmdldFRpbWUoKSArIENvbnN0VmFyaWFibGVzLkpPQl9fRVhQSVJJWV9QRVJJT0QpKTtcbiAgICAgICAgdmFyIHJlY3J1aXRlclNlcnZpY2UgPSBuZXcgUmVjcnVpdGVyU2VydmljZSgpO1xuICAgICAgICByZWNydWl0ZXJTZXJ2aWNlLmFkZENsb25lSm9iKHJlc3VsdC51c2VySWQsIG5ld0pvYiwgKGVyciwgcmVzdWx0KSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgbmV4dCh7XG4gICAgICAgICAgICAgIHJlYXNvbjogZXJyLFxuICAgICAgICAgICAgICBtZXNzYWdlOiBlcnIubWVzc2FnZSxcbiAgICAgICAgICAgICAgc3RhY2tUcmFjZTogbmV3IEVycm9yKCksXG4gICAgICAgICAgICAgIGNvZGU6IDQwM1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoMjAwKS5zZW5kKHtcbiAgICAgICAgICAgICAgJ3N0YXR1cyc6IE1lc3NhZ2VzLlNUQVRVU19TVUNDRVNTLFxuICAgICAgICAgICAgICAnZGF0YSc6IHJlc3VsdC5wb3N0ZWRKb2JzWzBdLl9pZFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbmV4dCh7XG4gICAgICByZWFzb246IGUubWVzc2FnZSxcbiAgICAgIG1lc3NhZ2U6IGUubWVzc2FnZSxcbiAgICAgIHN0YWNrVHJhY2U6IG5ldyBFcnJvcigpLFxuICAgICAgY29kZTogNTAwXG4gICAgfSk7XG4gIH1cbn1cblxuIl19
