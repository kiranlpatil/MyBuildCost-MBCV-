"use strict";
var ProjectRepository = require("../dataaccess/repository/ProjectRepository");
var BuildingRepository = require("../dataaccess/repository/BuildingRepository");
var UserService = require("./../../framework/services/UserService");
var ProjectAsset = require("../../framework/shared/projectasset");
var BuildingReport = require("../dataaccess/model/BuildingReport");
var ThumbRuleReport = require("../dataaccess/model/ThumbRuleReport");
var AuthInterceptor = require("../../framework/interceptor/auth.interceptor");
var EstimateReport = require("../dataaccess/model/EstimateReport");
var ThumbRule = require("../dataaccess/model/ThumbRule");
var Estimated = require("../dataaccess/model/Estimated");
var RateAnalysisService = require("./RateAnalysisService");
var config = require('config');
var log4js = require('log4js');
var logger = log4js.getLogger('Report Service');
var ReportService = (function () {
    function ReportService() {
        this.category = [];
        this.reportThumbrule = [];
        this.projectRepository = new ProjectRepository();
        this.buildingRepository = new BuildingRepository();
        this.APP_NAME = ProjectAsset.APP_NAME;
        this.authInterceptor = new AuthInterceptor();
        this.userService = new UserService();
        this.rateAnalysisService = new RateAnalysisService();
    }
    ReportService.prototype.getReport = function (projectId, reportType, projectRate, areaType, user, callback) {
        var _this = this;
        logger.info('Report Service, getReport has been hit');
        var query = { _id: projectId };
        var populate = { path: 'building' };
        this.projectRepository.findAndPopulate(query, populate, function (error, result) {
            logger.info('Report Service, findAndPopulate has been hit');
            if (error) {
                callback(error, null);
            }
            else {
                var buildings = result[0].building;
                var costHead = [];
                var report = [];
                for (var index = 0; index < buildings.length; index++) {
                    var buildingReport = new BuildingReport;
                    var thumbRuleReport = new ThumbRule();
                    var estimatedReport = new Estimated();
                    buildingReport.name = buildings[index].name;
                    buildingReport._id = buildings[index]._id;
                    if (areaType === 'slabArea') {
                        if (projectRate === 'sqmt') {
                            buildingReport.area = parseFloat((buildings[index].totalSlabArea * config.get('SqureMeter')).toFixed(2));
                        }
                        else {
                            buildingReport.area = parseFloat((buildings[index].totalSlabArea).toFixed(2));
                        }
                    }
                    else {
                        if (projectRate === 'sqmt') {
                            buildingReport.area = parseFloat((buildings[index].totalSaleableAreaOfUnit * config.get('SqureMeter')).toFixed(2));
                        }
                        else {
                            buildingReport.area = parseFloat((buildings[index].totalSaleableAreaOfUnit).toFixed(2));
                        }
                    }
                    var costHeadArray = buildings[index].costHead;
                    for (var costHeadIndex = 0; costHeadIndex < costHeadArray.length; costHeadIndex++) {
                        if (costHeadArray[costHeadIndex].active === true) {
                            var thumbRule = new ThumbRuleReport();
                            var estimateReport = new EstimateReport();
                            thumbRule.name = costHeadArray[costHeadIndex].name;
                            estimateReport.name = costHeadArray[costHeadIndex].name;
                            thumbRule.rateAnalysisId = costHeadArray[costHeadIndex].rateAnalysisId;
                            estimateReport.rateAnalysisId = costHeadArray[costHeadIndex].rateAnalysisId;
                            if (areaType === 'slabArea') {
                                thumbRuleReport.area = buildings[index].totalSlabArea;
                                estimatedReport.area = buildings[index].totalSlabArea;
                                if (projectRate === 'sqft') {
                                    thumbRule.rate = parseFloat((costHeadArray[costHeadIndex].thumbRuleRate.slabArea.sqft).toFixed(2));
                                }
                                else {
                                    thumbRule.rate = parseFloat((costHeadArray[costHeadIndex].thumbRuleRate.slabArea.sqmt).toFixed(2));
                                    thumbRuleReport.area = parseFloat((buildings[index].totalSlabArea * config.get('SqureMeter')).toFixed(2));
                                    estimatedReport.area = parseFloat((buildings[index].totalSlabArea * config.get('SqureMeter')).toFixed(2));
                                }
                            }
                            else {
                                thumbRuleReport.area = buildings[index].totalSaleableAreaOfUnit;
                                estimatedReport.area = buildings[index].totalSaleableAreaOfUnit;
                                if (projectRate === 'sqft') {
                                    thumbRule.rate = parseFloat((costHeadArray[costHeadIndex].thumbRuleRate.saleableArea.sqft).toFixed(2));
                                }
                                else {
                                    thumbRule.rate = parseFloat((costHeadArray[costHeadIndex].thumbRuleRate.saleableArea.sqmt).toFixed(2));
                                    thumbRuleReport.area = parseFloat((buildings[index].totalSaleableAreaOfUnit * config.get('SqureMeter')).toFixed(2));
                                    estimatedReport.area = parseFloat((buildings[index].totalSaleableAreaOfUnit * config.get('SqureMeter')).toFixed(2));
                                }
                            }
                            var subCategory = costHeadArray[costHeadIndex].subCategory;
                            if (subCategory.length !== 0) {
                                for (var subCategoryKey in subCategory) {
                                    var workItem = subCategory[subCategoryKey].workitem;
                                    if (workItem.length !== 0) {
                                        for (var key in workItem) {
                                            if (workItem[key].quantity.total !== null && workItem[key].rate.total !== null
                                                && workItem[key].quantity.total !== 0 && workItem[key].rate.total !== 0) {
                                                estimateReport.total = workItem[key].quantity.total
                                                    * workItem[key].rate.total
                                                    + estimateReport.total;
                                                estimateReport.rate = parseFloat((estimateReport.total / buildingReport.area).toFixed(2));
                                            }
                                            else {
                                                estimateReport.total = 0.0;
                                                estimateReport.rate = 0.0;
                                                break;
                                            }
                                        }
                                    }
                                    else {
                                        estimateReport.total = 0.0;
                                        estimateReport.rate = 0.0;
                                        break;
                                    }
                                }
                            }
                            estimatedReport.totalEstimatedCost = parseFloat((estimateReport.total + estimatedReport.totalEstimatedCost).toFixed(2));
                            estimatedReport.totalRate = parseFloat((estimatedReport.totalRate + estimateReport.rate).toFixed(2));
                            estimatedReport.estimatedCost.push(estimateReport);
                            if (costHeadArray[costHeadIndex].budgetedCostAmount === 0 ||
                                costHeadArray[costHeadIndex].budgetedCostAmount === undefined) {
                                thumbRule.amount = parseFloat((thumbRuleReport.area * thumbRule.rate).toFixed(2));
                            }
                            else {
                                thumbRule.amount = parseFloat((costHeadArray[costHeadIndex].budgetedCostAmount).toFixed(2));
                            }
                            thumbRule.costHeadActive = costHeadArray[costHeadIndex].active;
                            thumbRuleReport.thumbRuleReport.push(thumbRule);
                            thumbRuleReport.totalRate = parseFloat((thumbRuleReport.totalRate + thumbRule.rate).toFixed(2));
                            thumbRuleReport.totalBudgetedCost = parseFloat((thumbRuleReport.totalBudgetedCost + thumbRule.amount).toFixed(2));
                            buildingReport.estimated = estimatedReport;
                            buildingReport.thumbRule = thumbRuleReport;
                        }
                    }
                    report.push(buildingReport);
                }
                callback(null, { data: report, access_token: _this.authInterceptor.issueTokenWithUid(user) });
            }
        });
    };
    ReportService.prototype.getCostHeads = function (user, url, callback) {
        var _this = this;
        logger.info('Report Service, getCostHeads has been hit');
        this.rateAnalysisService.getCostHeads(user, url, function (error, result) {
            if (error) {
                console.log('error : ' + JSON.stringify(error));
                callback(error, null);
            }
            else {
                callback(null, { data: result, access_token: _this.authInterceptor.issueTokenWithUid(user) });
            }
        });
    };
    ReportService.prototype.getWorkItems = function (user, url, callback) {
        var _this = this;
        logger.info('Report Service, getWorkItems has been hit');
        this.rateAnalysisService.getWorkItems(user, url, function (error, result) {
            if (error) {
                console.log('error : ' + JSON.stringify(error));
                callback(error, null);
            }
            else {
                callback(null, { data: result, access_token: _this.authInterceptor.issueTokenWithUid(user) });
            }
        });
    };
    return ReportService;
}());
Object.seal(ReportService);
module.exports = ReportService;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9hcHBsaWNhdGlvblByb2plY3Qvc2VydmljZXMvUmVwb3J0U2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsOEVBQWlGO0FBQ2pGLGdGQUFtRjtBQUVuRixvRUFBdUU7QUFDdkUsa0VBQXFFO0FBSXJFLG1FQUFzRTtBQUN0RSxxRUFBd0U7QUFDeEUsOEVBQWlGO0FBR2pGLG1FQUFzRTtBQUV0RSx5REFBNEQ7QUFDNUQseURBQTREO0FBQzVELDJEQUE4RDtBQUU5RCxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDL0IsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQy9CLElBQUksTUFBTSxHQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUU5QztJQVlFO1FBSFEsYUFBUSxHQUFLLEVBQUUsQ0FBQztRQUNoQixvQkFBZSxHQUFPLEVBQUUsQ0FBQztRQUcvQixJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxpQkFBaUIsRUFBRSxDQUFDO1FBQ2pELElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLGtCQUFrQixFQUFFLENBQUM7UUFDbkQsSUFBSSxDQUFDLFFBQVEsR0FBRyxZQUFZLENBQUMsUUFBUSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxlQUFlLEVBQUUsQ0FBQztRQUM3QyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7UUFDckMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksbUJBQW1CLEVBQUUsQ0FBQztJQUV2RCxDQUFDO0lBRUQsaUNBQVMsR0FBVCxVQUFXLFNBQWUsRUFBQyxVQUFtQixFQUFFLFdBQW9CLEVBQUUsUUFBaUIsRUFBRyxJQUFVLEVBQ3pGLFFBQTJDO1FBRHRELGlCQW1IQztRQWhIQyxNQUFNLENBQUMsSUFBSSxDQUFDLHdDQUF3QyxDQUFDLENBQUM7UUFDdEQsSUFBSSxLQUFLLEdBQUcsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFDLENBQUM7UUFDOUIsSUFBSSxRQUFRLEdBQUcsRUFBQyxJQUFJLEVBQUcsVUFBVSxFQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLFVBQUMsS0FBSyxFQUFFLE1BQU07WUFDcEUsTUFBTSxDQUFDLElBQUksQ0FBQyw4Q0FBOEMsQ0FBQyxDQUFDO1lBQzVELEVBQUUsQ0FBQSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ1QsUUFBUSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztZQUN4QixDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sSUFBSSxTQUFTLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQztnQkFDbkMsSUFBSSxRQUFRLEdBQUcsRUFBRSxDQUFDO2dCQUNsQixJQUFJLE1BQU0sR0FBMkIsRUFBRSxDQUFDO2dCQUN4QyxHQUFHLENBQUEsQ0FBQyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUUsS0FBSyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQztvQkFDckQsSUFBSSxjQUFjLEdBQUcsSUFBSSxjQUFjLENBQUM7b0JBQ3hDLElBQUksZUFBZSxHQUFjLElBQUksU0FBUyxFQUFFLENBQUM7b0JBQ2pELElBQUksZUFBZSxHQUFjLElBQUksU0FBUyxFQUFFLENBQUM7b0JBQ2pELGNBQWMsQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDNUMsY0FBYyxDQUFDLEdBQUcsR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDO29CQUMxQyxFQUFFLENBQUMsQ0FBQyxRQUFRLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQzt3QkFDNUIsRUFBRSxDQUFBLENBQUMsV0FBVyxLQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUM7NEJBQ3hCLGNBQWMsQ0FBQyxJQUFJLEdBQUcsVUFBVSxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLGFBQWEsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQzNHLENBQUM7d0JBQUMsSUFBSSxDQUFDLENBQUM7NEJBQ04sY0FBYyxDQUFDLElBQUksR0FBRyxVQUFVLENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ2hGLENBQUM7b0JBQ0gsQ0FBQztvQkFBQyxJQUFJLENBQUMsQ0FBQzt3QkFDTixFQUFFLENBQUEsQ0FBQyxXQUFXLEtBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQzs0QkFDeEIsY0FBYyxDQUFDLElBQUksR0FBRyxVQUFVLENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsdUJBQXVCLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUNySCxDQUFDO3dCQUFDLElBQUksQ0FBQyxDQUFDOzRCQUNOLGNBQWMsQ0FBQyxJQUFJLEdBQUcsVUFBVSxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLHVCQUF1QixDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQzFGLENBQUM7b0JBQ0gsQ0FBQztvQkFDRCxJQUFJLGFBQWEsR0FBUyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDO29CQUNwRCxHQUFHLENBQUMsQ0FBQyxJQUFJLGFBQWEsR0FBRyxDQUFDLEVBQUUsYUFBYSxHQUFHLGFBQWEsQ0FBQyxNQUFNLEVBQUUsYUFBYSxFQUFFLEVBQUUsQ0FBQzt3QkFFbEYsRUFBRSxDQUFBLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDOzRCQUVoRCxJQUFJLFNBQVMsR0FBb0IsSUFBSSxlQUFlLEVBQUUsQ0FBQzs0QkFDdkQsSUFBSSxjQUFjLEdBQW1CLElBQUksY0FBYyxFQUFFLENBQUM7NEJBQzFELFNBQVMsQ0FBQyxJQUFJLEdBQUcsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDLElBQUksQ0FBQzs0QkFDbkQsY0FBYyxDQUFDLElBQUksR0FBRyxhQUFhLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDOzRCQUN4RCxTQUFTLENBQUMsY0FBYyxHQUFHLGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQyxjQUFjLENBQUM7NEJBQ3ZFLGNBQWMsQ0FBQyxjQUFjLEdBQUcsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDLGNBQWMsQ0FBQzs0QkFDNUUsRUFBRSxDQUFDLENBQUMsUUFBUSxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7Z0NBQzVCLGVBQWUsQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLGFBQWEsQ0FBQztnQ0FDdEQsZUFBZSxDQUFDLElBQUksR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsYUFBYSxDQUFDO2dDQUN0RCxFQUFFLENBQUMsQ0FBQyxXQUFXLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQztvQ0FDM0IsU0FBUyxDQUFDLElBQUksR0FBRyxVQUFVLENBQUMsQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQ0FDckcsQ0FBQztnQ0FBQyxJQUFJLENBQUMsQ0FBQztvQ0FDTixTQUFTLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO29DQUNuRyxlQUFlLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxhQUFhLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO29DQUMxRyxlQUFlLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxhQUFhLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dDQUM1RyxDQUFDOzRCQUNILENBQUM7NEJBQUMsSUFBSSxDQUFDLENBQUM7Z0NBQ04sZUFBZSxDQUFDLElBQUksR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsdUJBQXVCLENBQUM7Z0NBQ2hFLGVBQWUsQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLHVCQUF1QixDQUFDO2dDQUNoRSxFQUFFLENBQUMsQ0FBQyxXQUFXLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQztvQ0FDM0IsU0FBUyxDQUFDLElBQUksR0FBRyxVQUFVLENBQUMsQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQ0FDekcsQ0FBQztnQ0FBQyxJQUFJLENBQUMsQ0FBQztvQ0FDTixTQUFTLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO29DQUN2RyxlQUFlLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyx1QkFBdUIsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0NBQ3BILGVBQWUsQ0FBQyxJQUFJLEdBQUcsVUFBVSxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLHVCQUF1QixHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQ0FDdEgsQ0FBQzs0QkFDSCxDQUFDOzRCQUNELElBQUksV0FBVyxHQUF1QixhQUFhLENBQUMsYUFBYSxDQUFDLENBQUMsV0FBVyxDQUFDOzRCQUMvRSxFQUFFLENBQUEsQ0FBQyxXQUFXLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0NBRTVCLEdBQUcsQ0FBQSxDQUFDLElBQUksY0FBYyxJQUFJLFdBQVcsQ0FBQyxDQUFDLENBQUM7b0NBQ3RDLElBQUksUUFBUSxHQUFHLFdBQVcsQ0FBQyxjQUFjLENBQUMsQ0FBQyxRQUFRLENBQUM7b0NBQ3BELEVBQUUsQ0FBQSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQzt3Q0FDekIsR0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQzs0Q0FDekIsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEtBQUssSUFBSSxJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxLQUFLLElBQUk7bURBQ3pFLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxLQUFLLENBQUMsSUFBSSxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dEQUMxRSxjQUFjLENBQUMsS0FBSyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSztzREFDL0MsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLO3NEQUN4QixjQUFjLENBQUMsS0FBSyxDQUFDO2dEQUN6QixjQUFjLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxLQUFLLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDOzRDQUM1RixDQUFDOzRDQUFDLElBQUksQ0FBQyxDQUFDO2dEQUNOLGNBQWMsQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDO2dEQUMzQixjQUFjLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQztnREFDMUIsS0FBSyxDQUFDOzRDQUNSLENBQUM7d0NBQ0gsQ0FBQztvQ0FDSCxDQUFDO29DQUFDLElBQUksQ0FBQyxDQUFDO3dDQUNOLGNBQWMsQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDO3dDQUMzQixjQUFjLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQzt3Q0FDMUIsS0FBSyxDQUFDO29DQUNSLENBQUM7Z0NBQ0gsQ0FBQzs0QkFFSCxDQUFDOzRCQUNELGVBQWUsQ0FBQyxrQkFBa0IsR0FBRyxVQUFVLENBQUMsQ0FBQyxjQUFjLENBQUMsS0FBSyxHQUFHLGVBQWUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDOzRCQUN4SCxlQUFlLENBQUMsU0FBUyxHQUFHLFVBQVUsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxTQUFTLEdBQUksY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDOzRCQUN0RyxlQUFlLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQzs0QkFDbkQsRUFBRSxDQUFBLENBQUUsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDLGtCQUFrQixLQUFLLENBQUM7Z0NBQ3ZELGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQyxrQkFBa0IsS0FBSyxTQUFVLENBQUMsQ0FBQyxDQUFDO2dDQUNqRSxTQUFTLENBQUMsTUFBTSxHQUFHLFVBQVUsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDOzRCQUNwRixDQUFDOzRCQUFDLElBQUksQ0FBQyxDQUFDO2dDQUNOLFNBQVMsQ0FBQyxNQUFNLEdBQUksVUFBVSxDQUFDLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7NEJBQy9GLENBQUM7NEJBQ0QsU0FBUyxDQUFDLGNBQWMsR0FBRyxhQUFhLENBQUMsYUFBYSxDQUFDLENBQUMsTUFBTSxDQUFDOzRCQUMvRCxlQUFlLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQzs0QkFDaEQsZUFBZSxDQUFDLFNBQVMsR0FBRyxVQUFVLENBQUMsQ0FBQyxlQUFlLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzs0QkFDaEcsZUFBZSxDQUFDLGlCQUFpQixHQUFHLFVBQVUsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxpQkFBaUIsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7NEJBQ2xILGNBQWMsQ0FBQyxTQUFTLEdBQUcsZUFBZSxDQUFDOzRCQUMzQyxjQUFjLENBQUMsU0FBUyxHQUFHLGVBQWUsQ0FBQzt3QkFDN0MsQ0FBQztvQkFDSCxDQUFDO29CQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7Z0JBQzlCLENBQUM7Z0JBRUQsUUFBUSxDQUFDLElBQUksRUFBQyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLEtBQUksQ0FBQyxlQUFlLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEVBQUMsQ0FBQyxDQUFDO1lBQzdGLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxvQ0FBWSxHQUFaLFVBQWMsSUFBVSxFQUFFLEdBQVcsRUFBRSxRQUEyQztRQUFsRixpQkFVQztRQVRDLE1BQU0sQ0FBQyxJQUFJLENBQUMsMkNBQTJDLENBQUMsQ0FBQztRQUN6RCxJQUFJLENBQUMsbUJBQW1CLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUMsVUFBQyxLQUFLLEVBQUUsTUFBTTtZQUM1RCxFQUFFLENBQUEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUNULE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDOUMsUUFBUSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztZQUN4QixDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sUUFBUSxDQUFDLElBQUksRUFBQyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLEtBQUksQ0FBQyxlQUFlLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEVBQUMsQ0FBQyxDQUFDO1lBQzdGLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxvQ0FBWSxHQUFaLFVBQWMsSUFBVSxFQUFFLEdBQVcsRUFBRSxRQUEyQztRQUFsRixpQkFVQztRQVRDLE1BQU0sQ0FBQyxJQUFJLENBQUMsMkNBQTJDLENBQUMsQ0FBQztRQUN6RCxJQUFJLENBQUMsbUJBQW1CLENBQUMsWUFBWSxDQUFFLElBQUksRUFBRSxHQUFHLEVBQUMsVUFBQyxLQUFLLEVBQUUsTUFBTTtZQUM3RCxFQUFFLENBQUEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUNULE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDOUMsUUFBUSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztZQUN4QixDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sUUFBUSxDQUFDLElBQUksRUFBQyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLEtBQUksQ0FBQyxlQUFlLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEVBQUMsQ0FBQyxDQUFDO1lBQzdGLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDSCxvQkFBQztBQUFELENBbEtBLEFBa0tDLElBQUE7QUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQzNCLGlCQUFTLGFBQWEsQ0FBQyIsImZpbGUiOiJhcHAvYXBwbGljYXRpb25Qcm9qZWN0L3NlcnZpY2VzL1JlcG9ydFNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUHJvamVjdFJlcG9zaXRvcnkgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL3JlcG9zaXRvcnkvUHJvamVjdFJlcG9zaXRvcnknKTtcclxuaW1wb3J0IEJ1aWxkaW5nUmVwb3NpdG9yeSA9IHJlcXVpcmUoJy4uL2RhdGFhY2Nlc3MvcmVwb3NpdG9yeS9CdWlsZGluZ1JlcG9zaXRvcnknKTtcclxuaW1wb3J0IE1lc3NhZ2VzID0gcmVxdWlyZSgnLi4vc2hhcmVkL21lc3NhZ2VzJyk7XHJcbmltcG9ydCBVc2VyU2VydmljZSA9IHJlcXVpcmUoJy4vLi4vLi4vZnJhbWV3b3JrL3NlcnZpY2VzL1VzZXJTZXJ2aWNlJyk7XHJcbmltcG9ydCBQcm9qZWN0QXNzZXQgPSByZXF1aXJlKCcuLi8uLi9mcmFtZXdvcmsvc2hhcmVkL3Byb2plY3Rhc3NldCcpO1xyXG5pbXBvcnQgVXNlciA9IHJlcXVpcmUoJy4uLy4uL2ZyYW1ld29yay9kYXRhYWNjZXNzL21vbmdvb3NlL3VzZXInKTtcclxuaW1wb3J0IFByb2plY3QgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL21vbmdvb3NlL1Byb2plY3QnKTtcclxuaW1wb3J0IEJ1aWxkaW5nID0gcmVxdWlyZSgnLi4vZGF0YWFjY2Vzcy9tb25nb29zZS9CdWlsZGluZycpO1xyXG5pbXBvcnQgQnVpbGRpbmdSZXBvcnQgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL21vZGVsL0J1aWxkaW5nUmVwb3J0Jyk7XHJcbmltcG9ydCBUaHVtYlJ1bGVSZXBvcnQgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL21vZGVsL1RodW1iUnVsZVJlcG9ydCcpO1xyXG5pbXBvcnQgQXV0aEludGVyY2VwdG9yID0gcmVxdWlyZSgnLi4vLi4vZnJhbWV3b3JrL2ludGVyY2VwdG9yL2F1dGguaW50ZXJjZXB0b3InKTtcclxuaW1wb3J0IENvc3RDb250cm9sbEV4Y2VwdGlvbiA9IHJlcXVpcmUoJy4uL2V4Y2VwdGlvbi9Db3N0Q29udHJvbGxFeGNlcHRpb24nKTtcclxuaW1wb3J0IENvc3RIZWFkID0gcmVxdWlyZSgnLi4vZGF0YWFjY2Vzcy9tb25nb29zZS9Db3N0SGVhZCcpO1xyXG5pbXBvcnQgRXN0aW1hdGVSZXBvcnQgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL21vZGVsL0VzdGltYXRlUmVwb3J0Jyk7XHJcbmltcG9ydCBXb3JrSXRlbSA9IHJlcXVpcmUoJy4uL2RhdGFhY2Nlc3MvbW9kZWwvV29ya0l0ZW0nKTtcclxuaW1wb3J0IFRodW1iUnVsZSA9IHJlcXVpcmUoJy4uL2RhdGFhY2Nlc3MvbW9kZWwvVGh1bWJSdWxlJyk7XHJcbmltcG9ydCBFc3RpbWF0ZWQgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL21vZGVsL0VzdGltYXRlZCcpO1xyXG5pbXBvcnQgUmF0ZUFuYWx5c2lzU2VydmljZSA9IHJlcXVpcmUoJy4vUmF0ZUFuYWx5c2lzU2VydmljZScpO1xyXG5pbXBvcnQgU3ViQ2F0ZWdvcnkgPSByZXF1aXJlKFwiLi4vZGF0YWFjY2Vzcy9tb2RlbC9TdWJDYXRlZ29yeVwiKTtcclxubGV0IGNvbmZpZyA9IHJlcXVpcmUoJ2NvbmZpZycpO1xyXG52YXIgbG9nNGpzID0gcmVxdWlyZSgnbG9nNGpzJyk7XHJcbnZhciBsb2dnZXI9bG9nNGpzLmdldExvZ2dlcignUmVwb3J0IFNlcnZpY2UnKTtcclxuXHJcbmNsYXNzIFJlcG9ydFNlcnZpY2Uge1xyXG4gIEFQUF9OQU1FOiBzdHJpbmc7XHJcbiAgY29tcGFueV9uYW1lOiBzdHJpbmc7XHJcbiAgcHJpdmF0ZSBwcm9qZWN0UmVwb3NpdG9yeTogUHJvamVjdFJlcG9zaXRvcnk7XHJcbiAgcHJpdmF0ZSBidWlsZGluZ1JlcG9zaXRvcnk6IEJ1aWxkaW5nUmVwb3NpdG9yeTtcclxuICBwcml2YXRlIGF1dGhJbnRlcmNlcHRvcjogQXV0aEludGVyY2VwdG9yO1xyXG4gIHByaXZhdGUgdXNlclNlcnZpY2UgOiBVc2VyU2VydmljZTtcclxuICBwcml2YXRlIHJhdGVBbmFseXNpc1NlcnZpY2UgOiBSYXRlQW5hbHlzaXNTZXJ2aWNlO1xyXG5cclxuICBwcml2YXRlIGNhdGVnb3J5OmFueT1bXTtcclxuICBwcml2YXRlIHJlcG9ydFRodW1icnVsZTphbnkgPSBbXTtcclxuXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICB0aGlzLnByb2plY3RSZXBvc2l0b3J5ID0gbmV3IFByb2plY3RSZXBvc2l0b3J5KCk7XHJcbiAgICB0aGlzLmJ1aWxkaW5nUmVwb3NpdG9yeSA9IG5ldyBCdWlsZGluZ1JlcG9zaXRvcnkoKTtcclxuICAgIHRoaXMuQVBQX05BTUUgPSBQcm9qZWN0QXNzZXQuQVBQX05BTUU7XHJcbiAgICB0aGlzLmF1dGhJbnRlcmNlcHRvciA9IG5ldyBBdXRoSW50ZXJjZXB0b3IoKTtcclxuICAgIHRoaXMudXNlclNlcnZpY2UgPSBuZXcgVXNlclNlcnZpY2UoKTtcclxuICAgIHRoaXMucmF0ZUFuYWx5c2lzU2VydmljZSA9IG5ldyBSYXRlQW5hbHlzaXNTZXJ2aWNlKCk7XHJcbiAgICAvL3RoaXMuY2F0ZWdvcnlEZXRhaWxzID0gbmV3IGNhdGVnb3J5RGV0YWlscygpO1xyXG4gIH1cclxuXHJcbiAgZ2V0UmVwb3J0KCBwcm9qZWN0SWQgOiBhbnkscmVwb3J0VHlwZSA6IHN0cmluZywgcHJvamVjdFJhdGUgOiBzdHJpbmcsIGFyZWFUeXBlIDogc3RyaW5nLOKAguKAgnVzZXI6IFVzZXIsXHJcbiAgICAgICAgICAgICBjYWxsYmFjazogKGVycm9yOiBhbnksIHJlc3VsdDogYW55KSA9PiB2b2lkKSB7XHJcblxyXG4gICAgbG9nZ2VyLmluZm8oJ1JlcG9ydCBTZXJ2aWNlLCBnZXRSZXBvcnQgaGFzIGJlZW4gaGl0Jyk7XHJcbiAgICBsZXQgcXVlcnkgPSB7IF9pZDogcHJvamVjdElkfTtcclxuICAgIGxldCBwb3B1bGF0ZSA9IHtwYXRoIDogJ2J1aWxkaW5nJ307XHJcbiAgICB0aGlzLnByb2plY3RSZXBvc2l0b3J5LmZpbmRBbmRQb3B1bGF0ZShxdWVyeSwgcG9wdWxhdGUsIChlcnJvciwgcmVzdWx0KSA9PiB7XHJcbiAgICAgIGxvZ2dlci5pbmZvKCdSZXBvcnQgU2VydmljZSwgZmluZEFuZFBvcHVsYXRlIGhhcyBiZWVuIGhpdCcpO1xyXG4gICAgICBpZihlcnJvcikge1xyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBsZXQgYnVpbGRpbmdzID0gcmVzdWx0WzBdLmJ1aWxkaW5nO1xyXG4gICAgICAgIGxldCBjb3N0SGVhZCA9IFtdO1xyXG4gICAgICAgIGxldCByZXBvcnQgOiBBcnJheTxCdWlsZGluZ1JlcG9ydD4gPSBbXTtcclxuICAgICAgICBmb3IobGV0IGluZGV4ID0gMDsgaW5kZXggPCBidWlsZGluZ3MubGVuZ3RoOyBpbmRleCsrKSB7XHJcbiAgICAgICAgICBsZXQgYnVpbGRpbmdSZXBvcnQgPSBuZXcgQnVpbGRpbmdSZXBvcnQ7XHJcbiAgICAgICAgICBsZXQgdGh1bWJSdWxlUmVwb3J0OiBUaHVtYlJ1bGUgPSBuZXcgVGh1bWJSdWxlKCk7XHJcbiAgICAgICAgICBsZXQgZXN0aW1hdGVkUmVwb3J0OiBFc3RpbWF0ZWQgPSBuZXcgRXN0aW1hdGVkKCk7XHJcbiAgICAgICAgICBidWlsZGluZ1JlcG9ydC5uYW1lID0gYnVpbGRpbmdzW2luZGV4XS5uYW1lO1xyXG4gICAgICAgICAgYnVpbGRpbmdSZXBvcnQuX2lkID0gYnVpbGRpbmdzW2luZGV4XS5faWQ7XHJcbiAgICAgICAgICBpZiAoYXJlYVR5cGUgPT09ICdzbGFiQXJlYScpIHtcclxuICAgICAgICAgICAgaWYocHJvamVjdFJhdGU9PT0nc3FtdCcpIHtcclxuICAgICAgICAgICAgICBidWlsZGluZ1JlcG9ydC5hcmVhID0gcGFyc2VGbG9hdCgoYnVpbGRpbmdzW2luZGV4XS50b3RhbFNsYWJBcmVhICogY29uZmlnLmdldCgnU3F1cmVNZXRlcicpKS50b0ZpeGVkKDIpKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICBidWlsZGluZ1JlcG9ydC5hcmVhID0gcGFyc2VGbG9hdCgoYnVpbGRpbmdzW2luZGV4XS50b3RhbFNsYWJBcmVhKS50b0ZpeGVkKDIpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYocHJvamVjdFJhdGU9PT0nc3FtdCcpIHtcclxuICAgICAgICAgICAgICBidWlsZGluZ1JlcG9ydC5hcmVhID0gcGFyc2VGbG9hdCgoYnVpbGRpbmdzW2luZGV4XS50b3RhbFNhbGVhYmxlQXJlYU9mVW5pdCAqIGNvbmZpZy5nZXQoJ1NxdXJlTWV0ZXInKSkudG9GaXhlZCgyKSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgYnVpbGRpbmdSZXBvcnQuYXJlYSA9IHBhcnNlRmxvYXQoKGJ1aWxkaW5nc1tpbmRleF0udG90YWxTYWxlYWJsZUFyZWFPZlVuaXQpLnRvRml4ZWQoMikpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBsZXQgY29zdEhlYWRBcnJheSA6IGFueSA9IGJ1aWxkaW5nc1tpbmRleF0uY29zdEhlYWQ7XHJcbiAgICAgICAgICBmb3IgKGxldCBjb3N0SGVhZEluZGV4ID0gMDsgY29zdEhlYWRJbmRleCA8IGNvc3RIZWFkQXJyYXkubGVuZ3RoOyBjb3N0SGVhZEluZGV4KyspIHtcclxuXHJcbiAgICAgICAgICAgIGlmKGNvc3RIZWFkQXJyYXlbY29zdEhlYWRJbmRleF0uYWN0aXZlID09PSB0cnVlKSB7XHJcblxyXG4gICAgICAgICAgICAgIGxldCB0aHVtYlJ1bGU6IFRodW1iUnVsZVJlcG9ydCA9IG5ldyBUaHVtYlJ1bGVSZXBvcnQoKTtcclxuICAgICAgICAgICAgICBsZXQgZXN0aW1hdGVSZXBvcnQ6IEVzdGltYXRlUmVwb3J0ID0gbmV3IEVzdGltYXRlUmVwb3J0KCk7XHJcbiAgICAgICAgICAgICAgdGh1bWJSdWxlLm5hbWUgPSBjb3N0SGVhZEFycmF5W2Nvc3RIZWFkSW5kZXhdLm5hbWU7XHJcbiAgICAgICAgICAgICAgZXN0aW1hdGVSZXBvcnQubmFtZSA9IGNvc3RIZWFkQXJyYXlbY29zdEhlYWRJbmRleF0ubmFtZTtcclxuICAgICAgICAgICAgICB0aHVtYlJ1bGUucmF0ZUFuYWx5c2lzSWQgPSBjb3N0SGVhZEFycmF5W2Nvc3RIZWFkSW5kZXhdLnJhdGVBbmFseXNpc0lkO1xyXG4gICAgICAgICAgICAgIGVzdGltYXRlUmVwb3J0LnJhdGVBbmFseXNpc0lkID0gY29zdEhlYWRBcnJheVtjb3N0SGVhZEluZGV4XS5yYXRlQW5hbHlzaXNJZDtcclxuICAgICAgICAgICAgICBpZiAoYXJlYVR5cGUgPT09ICdzbGFiQXJlYScpIHtcclxuICAgICAgICAgICAgICAgIHRodW1iUnVsZVJlcG9ydC5hcmVhID0gYnVpbGRpbmdzW2luZGV4XS50b3RhbFNsYWJBcmVhO1xyXG4gICAgICAgICAgICAgICAgZXN0aW1hdGVkUmVwb3J0LmFyZWEgPSBidWlsZGluZ3NbaW5kZXhdLnRvdGFsU2xhYkFyZWE7XHJcbiAgICAgICAgICAgICAgICBpZiAocHJvamVjdFJhdGUgPT09ICdzcWZ0Jykge1xyXG4gICAgICAgICAgICAgICAgICB0aHVtYlJ1bGUucmF0ZSA9IHBhcnNlRmxvYXQoKGNvc3RIZWFkQXJyYXlbY29zdEhlYWRJbmRleF0udGh1bWJSdWxlUmF0ZS5zbGFiQXJlYS5zcWZ0KS50b0ZpeGVkKDIpKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgIHRodW1iUnVsZS5yYXRlID0gcGFyc2VGbG9hdCgoY29zdEhlYWRBcnJheVtjb3N0SGVhZEluZGV4XS50aHVtYlJ1bGVSYXRlLnNsYWJBcmVhLnNxbXQpLnRvRml4ZWQoMikpO1xyXG4gICAgICAgICAgICAgICAgICB0aHVtYlJ1bGVSZXBvcnQuYXJlYSA9IHBhcnNlRmxvYXQoKGJ1aWxkaW5nc1tpbmRleF0udG90YWxTbGFiQXJlYSAqIGNvbmZpZy5nZXQoJ1NxdXJlTWV0ZXInKSkudG9GaXhlZCgyKSk7XHJcbiAgICAgICAgICAgICAgICAgIGVzdGltYXRlZFJlcG9ydC5hcmVhID0gcGFyc2VGbG9hdCgoYnVpbGRpbmdzW2luZGV4XS50b3RhbFNsYWJBcmVhICogY29uZmlnLmdldCgnU3F1cmVNZXRlcicpKS50b0ZpeGVkKDIpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGh1bWJSdWxlUmVwb3J0LmFyZWEgPSBidWlsZGluZ3NbaW5kZXhdLnRvdGFsU2FsZWFibGVBcmVhT2ZVbml0O1xyXG4gICAgICAgICAgICAgICAgZXN0aW1hdGVkUmVwb3J0LmFyZWEgPSBidWlsZGluZ3NbaW5kZXhdLnRvdGFsU2FsZWFibGVBcmVhT2ZVbml0O1xyXG4gICAgICAgICAgICAgICAgaWYgKHByb2plY3RSYXRlID09PSAnc3FmdCcpIHtcclxuICAgICAgICAgICAgICAgICAgdGh1bWJSdWxlLnJhdGUgPSBwYXJzZUZsb2F0KChjb3N0SGVhZEFycmF5W2Nvc3RIZWFkSW5kZXhdLnRodW1iUnVsZVJhdGUuc2FsZWFibGVBcmVhLnNxZnQpLnRvRml4ZWQoMikpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgdGh1bWJSdWxlLnJhdGUgPSBwYXJzZUZsb2F0KChjb3N0SGVhZEFycmF5W2Nvc3RIZWFkSW5kZXhdLnRodW1iUnVsZVJhdGUuc2FsZWFibGVBcmVhLnNxbXQpLnRvRml4ZWQoMikpO1xyXG4gICAgICAgICAgICAgICAgICB0aHVtYlJ1bGVSZXBvcnQuYXJlYSA9IHBhcnNlRmxvYXQoKGJ1aWxkaW5nc1tpbmRleF0udG90YWxTYWxlYWJsZUFyZWFPZlVuaXQgKiBjb25maWcuZ2V0KCdTcXVyZU1ldGVyJykpLnRvRml4ZWQoMikpO1xyXG4gICAgICAgICAgICAgICAgICBlc3RpbWF0ZWRSZXBvcnQuYXJlYSA9IHBhcnNlRmxvYXQoKGJ1aWxkaW5nc1tpbmRleF0udG90YWxTYWxlYWJsZUFyZWFPZlVuaXQgKiBjb25maWcuZ2V0KCdTcXVyZU1ldGVyJykpLnRvRml4ZWQoMikpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBsZXQgc3ViQ2F0ZWdvcnk6IEFycmF5PFN1YkNhdGVnb3J5PiA9IGNvc3RIZWFkQXJyYXlbY29zdEhlYWRJbmRleF0uc3ViQ2F0ZWdvcnk7XHJcbiAgICAgICAgICAgICAgaWYoc3ViQ2F0ZWdvcnkubGVuZ3RoICE9PSAwKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgZm9yKGxldCBzdWJDYXRlZ29yeUtleSBpbiBzdWJDYXRlZ29yeSkge1xyXG4gICAgICAgICAgICAgICAgICBsZXQgd29ya0l0ZW0gPSBzdWJDYXRlZ29yeVtzdWJDYXRlZ29yeUtleV0ud29ya2l0ZW07XHJcbiAgICAgICAgICAgICAgICAgIGlmKHdvcmtJdGVtLmxlbmd0aCAhPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGtleSBpbiB3b3JrSXRlbSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJdGVtW2tleV0ucXVhbnRpdHkudG90YWwgIT09IG51bGwgJiYgd29ya0l0ZW1ba2V5XS5yYXRlLnRvdGFsICE9PSBudWxsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICYmIHdvcmtJdGVtW2tleV0ucXVhbnRpdHkudG90YWwgIT09IDAgJiYgd29ya0l0ZW1ba2V5XS5yYXRlLnRvdGFsICE9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVzdGltYXRlUmVwb3J0LnRvdGFsID0gd29ya0l0ZW1ba2V5XS5xdWFudGl0eS50b3RhbFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICogd29ya0l0ZW1ba2V5XS5yYXRlLnRvdGFsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKyBlc3RpbWF0ZVJlcG9ydC50b3RhbDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXN0aW1hdGVSZXBvcnQucmF0ZSA9IHBhcnNlRmxvYXQoKGVzdGltYXRlUmVwb3J0LnRvdGFsIC8gYnVpbGRpbmdSZXBvcnQuYXJlYSkudG9GaXhlZCgyKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlc3RpbWF0ZVJlcG9ydC50b3RhbCA9IDAuMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXN0aW1hdGVSZXBvcnQucmF0ZSA9IDAuMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGVzdGltYXRlUmVwb3J0LnRvdGFsID0gMC4wO1xyXG4gICAgICAgICAgICAgICAgICAgIGVzdGltYXRlUmVwb3J0LnJhdGUgPSAwLjA7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIGVzdGltYXRlZFJlcG9ydC50b3RhbEVzdGltYXRlZENvc3QgPSBwYXJzZUZsb2F0KChlc3RpbWF0ZVJlcG9ydC50b3RhbCArIGVzdGltYXRlZFJlcG9ydC50b3RhbEVzdGltYXRlZENvc3QpLnRvRml4ZWQoMikpO1xyXG4gICAgICAgICAgICAgIGVzdGltYXRlZFJlcG9ydC50b3RhbFJhdGUgPSBwYXJzZUZsb2F0KChlc3RpbWF0ZWRSZXBvcnQudG90YWxSYXRlICsgIGVzdGltYXRlUmVwb3J0LnJhdGUpLnRvRml4ZWQoMikpO1xyXG4gICAgICAgICAgICAgIGVzdGltYXRlZFJlcG9ydC5lc3RpbWF0ZWRDb3N0LnB1c2goZXN0aW1hdGVSZXBvcnQpO1xyXG4gICAgICAgICAgICAgIGlmKCBjb3N0SGVhZEFycmF5W2Nvc3RIZWFkSW5kZXhdLmJ1ZGdldGVkQ29zdEFtb3VudCA9PT0gMCB8fFxyXG4gICAgICAgICAgICAgICAgY29zdEhlYWRBcnJheVtjb3N0SGVhZEluZGV4XS5idWRnZXRlZENvc3RBbW91bnQgPT09IHVuZGVmaW5lZCApIHtcclxuICAgICAgICAgICAgICAgIHRodW1iUnVsZS5hbW91bnQgPSBwYXJzZUZsb2F0KCh0aHVtYlJ1bGVSZXBvcnQuYXJlYSAqIHRodW1iUnVsZS5yYXRlKS50b0ZpeGVkKDIpKTtcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGh1bWJSdWxlLmFtb3VudCA94oCC4oCCcGFyc2VGbG9hdCgoY29zdEhlYWRBcnJheVtjb3N0SGVhZEluZGV4XS5idWRnZXRlZENvc3RBbW91bnQpLnRvRml4ZWQoMikpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB0aHVtYlJ1bGUuY29zdEhlYWRBY3RpdmUgPSBjb3N0SGVhZEFycmF5W2Nvc3RIZWFkSW5kZXhdLmFjdGl2ZTtcclxuICAgICAgICAgICAgICB0aHVtYlJ1bGVSZXBvcnQudGh1bWJSdWxlUmVwb3J0LnB1c2godGh1bWJSdWxlKTtcclxuICAgICAgICAgICAgICB0aHVtYlJ1bGVSZXBvcnQudG90YWxSYXRlID0gcGFyc2VGbG9hdCgodGh1bWJSdWxlUmVwb3J0LnRvdGFsUmF0ZSArIHRodW1iUnVsZS5yYXRlKS50b0ZpeGVkKDIpKTtcclxuICAgICAgICAgICAgICB0aHVtYlJ1bGVSZXBvcnQudG90YWxCdWRnZXRlZENvc3QgPSBwYXJzZUZsb2F0KCh0aHVtYlJ1bGVSZXBvcnQudG90YWxCdWRnZXRlZENvc3QgKyB0aHVtYlJ1bGUuYW1vdW50KS50b0ZpeGVkKDIpKTtcclxuICAgICAgICAgICAgICBidWlsZGluZ1JlcG9ydC5lc3RpbWF0ZWQgPSBlc3RpbWF0ZWRSZXBvcnQ7XHJcbiAgICAgICAgICAgICAgYnVpbGRpbmdSZXBvcnQudGh1bWJSdWxlID0gdGh1bWJSdWxlUmVwb3J0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXBvcnQucHVzaChidWlsZGluZ1JlcG9ydCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjYWxsYmFjayhudWxsLHsgZGF0YTogcmVwb3J0LCBhY2Nlc3NfdG9rZW46IHRoaXMuYXV0aEludGVyY2VwdG9yLmlzc3VlVG9rZW5XaXRoVWlkKHVzZXIpfSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgZ2V0Q29zdEhlYWRzKCB1c2VyOiBVc2VyLCB1cmw6IHN0cmluZyAsY2FsbGJhY2s6IChlcnJvcjogYW55LCByZXN1bHQ6IGFueSkgPT4gdm9pZCkge1xyXG4gICAgbG9nZ2VyLmluZm8oJ1JlcG9ydCBTZXJ2aWNlLCBnZXRDb3N0SGVhZHMgaGFzIGJlZW4gaGl0Jyk7XHJcbiAgICB0aGlzLnJhdGVBbmFseXNpc1NlcnZpY2UuZ2V0Q29zdEhlYWRzKHVzZXIsIHVybCwoZXJyb3IsIHJlc3VsdCkgPT4ge1xyXG4gICAgICBpZihlcnJvcikge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdlcnJvciA6ICcrSlNPTi5zdHJpbmdpZnkoZXJyb3IpKTtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCx7IGRhdGE6IHJlc3VsdCwgYWNjZXNzX3Rva2VuOiB0aGlzLmF1dGhJbnRlcmNlcHRvci5pc3N1ZVRva2VuV2l0aFVpZCh1c2VyKX0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGdldFdvcmtJdGVtcyggdXNlcjogVXNlciwgdXJsOiBzdHJpbmcgLGNhbGxiYWNrOiAoZXJyb3I6IGFueSwgcmVzdWx0OiBhbnkpID0+IHZvaWQpIHtcclxuICAgIGxvZ2dlci5pbmZvKCdSZXBvcnQgU2VydmljZSwgZ2V0V29ya0l0ZW1zIGhhcyBiZWVuIGhpdCcpO1xyXG4gICAgdGhpcy5yYXRlQW5hbHlzaXNTZXJ2aWNlLmdldFdvcmtJdGVtcyggdXNlciwgdXJsLChlcnJvciwgcmVzdWx0KSA9PiB7XHJcbiAgICAgIGlmKGVycm9yKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ2Vycm9yIDogJytKU09OLnN0cmluZ2lmeShlcnJvcikpO1xyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjYWxsYmFjayhudWxsLHsgZGF0YTogcmVzdWx0LCBhY2Nlc3NfdG9rZW46IHRoaXMuYXV0aEludGVyY2VwdG9yLmlzc3VlVG9rZW5XaXRoVWlkKHVzZXIpfSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG5cclxuT2JqZWN0LnNlYWwoUmVwb3J0U2VydmljZSk7XHJcbmV4cG9ydCA9IFJlcG9ydFNlcnZpY2U7XHJcblxyXG4iXX0=
