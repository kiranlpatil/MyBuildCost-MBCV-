"use strict";
var ProjectRepository = require("../dataaccess/repository/ProjectRepository");
var BuildingRepository = require("../dataaccess/repository/BuildingRepository");
var UserService = require("./../../framework/services/UserService");
var ProjectAsset = require("../../framework/shared/projectasset");
var BuildingReport = require("../dataaccess/model/project/reports/BuildingReport");
var ThumbRuleReport = require("../dataaccess/model/project/reports/ThumbRuleReport");
var AuthInterceptor = require("../../framework/interceptor/auth.interceptor");
var EstimateReport = require("../dataaccess/model/project/reports/EstimateReport");
var ProjectReport = require("../dataaccess/model/project/reports/ProjectReport");
var ThumbRule = require("../dataaccess/model/project/building/ThumbRule");
var Estimate = require("../dataaccess/model/project/building/Estimate");
var RateAnalysisService = require("./RateAnalysisService");
var alasql = require("alasql");
var Constants = require("../shared/constants");
var ProjectService = require("./ProjectService");
var config = require('config');
var log4js = require('log4js');
var logger = log4js.getLogger('Report Service');
var ReportService = (function () {
    function ReportService() {
        this.projectRepository = new ProjectRepository();
        this.buildingRepository = new BuildingRepository();
        this.APP_NAME = ProjectAsset.APP_NAME;
        this.authInterceptor = new AuthInterceptor();
        this.userService = new UserService();
        this.rateAnalysisService = new RateAnalysisService();
    }
    ReportService.prototype.getReport = function (projectId, reportType, rateUnit, areaType, user, callback) {
        var _this = this;
        logger.info('Report Service, getReport has been hit');
        var query = { _id: projectId };
        var populate = { path: 'buildings' };
        this.projectRepository.findAndPopulate(query, populate, function (error, result) {
            logger.info('Report Service, findAndPopulate has been hit');
            if (error) {
                callback(error, null);
            }
            else {
                var buildings = result[0].buildings;
                var typeOfArea;
                var choice = areaType;
                switch (choice) {
                    case Constants.SLAB_AREA:
                        {
                            typeOfArea = Constants.TOTAL_SLAB_AREA;
                            break;
                        }
                    case Constants.SALEABLE_AREA:
                        {
                            typeOfArea = Constants.TOTAL_SALEABLE_AREA;
                            break;
                        }
                    case Constants.CARPET_AREA:
                        {
                            typeOfArea = Constants.TOTAL_CARPET_AREA;
                            break;
                        }
                    default: callback(error, null);
                }
                var totalArea = alasql('VALUE OF SELECT SUM(' + typeOfArea + ') FROM ?', [buildings]);
                var projectCostHeads = result[0].projectCostHeads;
                var projectReport = new ProjectReport();
                var buildingReport = new Array();
                _this.generateReportByCostHeads(buildings, typeOfArea, rateUnit, buildingReport);
                projectReport.buildings = buildingReport;
                var commonAmenitiesReport = new Array();
                _this.generateReportForProjectCostHeads(projectCostHeads, totalArea, areaType, rateUnit, commonAmenitiesReport);
                projectReport.commonAmenities = commonAmenitiesReport;
                callback(null, { data: projectReport, access_token: _this.authInterceptor.issueTokenWithUid(user) });
            }
        });
    };
    ReportService.prototype.generateReportByCostHeads = function (buildings, typeOfArea, rateUnit, report) {
        for (var _i = 0, buildings_1 = buildings; _i < buildings_1.length; _i++) {
            var building = buildings_1[_i];
            var buildingReport = new BuildingReport;
            buildingReport.name = building.name;
            buildingReport._id = building._id;
            buildingReport.area = building[typeOfArea];
            var thumbRule = new ThumbRule();
            var estimate = new Estimate();
            var thumbRuleReports = new Array();
            var estimatedReports = new Array();
            this.getThumbRuleAndEstimatedReport(building, buildingReport, thumbRuleReports, estimatedReports, rateUnit);
            var totalRates = alasql('SELECT SUM(amount) AS totalAmount, SUM(rate) AS totalRate FROM ?', [thumbRuleReports]);
            thumbRule.totalRate = totalRates[0].totalRate;
            if (rateUnit === Constants.SQUREMETER_UNIT) {
                thumbRule.totalRate = parseFloat((thumbRule.totalRate * config.get(Constants.SQUARE_METER)).toFixed(2));
            }
            thumbRule.totalBudgetedCost = totalRates[0].totalAmount;
            thumbRule.thumbRuleReports = thumbRuleReports;
            var totalEstimatedRates = alasql('SELECT SUM(total) AS totalAmount, SUM(rate) AS totalRate FROM ?', [estimatedReports]);
            estimate.totalRate = totalEstimatedRates[0].totalRate;
            if (rateUnit === Constants.SQUREMETER_UNIT) {
                estimate.totalRate = parseFloat((estimate.totalRate * config.get(Constants.SQUARE_METER)).toFixed(2));
            }
            estimate.totalEstimatedCost = totalEstimatedRates[0].totalAmount;
            estimate.estimatedCosts = estimatedReports;
            buildingReport.thumbRule = thumbRule;
            buildingReport.estimate = estimate;
            report.push(buildingReport);
        }
    };
    ReportService.prototype.getThumbRuleAndEstimatedReport = function (building, buildingReport, thumbRuleReports, estimatedReports, rateUnit) {
        for (var _i = 0, _a = building.costHeads; _i < _a.length; _i++) {
            var costHead = _a[_i];
            if (costHead.active) {
                var thumbRuleReport = new ThumbRuleReport();
                thumbRuleReport.name = costHead.name;
                thumbRuleReport.rateAnalysisId = costHead.rateAnalysisId;
                thumbRuleReport.amount = costHead.budgetedCostAmount;
                thumbRuleReport.costHeadActive = costHead.active;
                thumbRuleReport.rate = parseFloat((costHead.budgetedCostAmount / buildingReport.area).toFixed(2));
                if (rateUnit === Constants.SQUREMETER_UNIT) {
                    thumbRuleReport.rate = parseFloat((thumbRuleReport.rate * config.get(Constants.SQUARE_METER)).toFixed(2));
                }
                thumbRuleReports.push(thumbRuleReport);
                var estimateReport = new EstimateReport();
                estimateReport = this.getEstimatedReport(building.rates, costHead, buildingReport.area, rateUnit);
                estimatedReports.push(estimateReport);
            }
        }
    };
    ReportService.prototype.getEstimatedReport = function (centralizedRates, costHead, area, rateUnit) {
        var estimateReport = new EstimateReport();
        estimateReport.name = costHead.name;
        estimateReport.rateAnalysisId = costHead.rateAnalysisId;
        var costHeadCategories = costHead.categories;
        var projectService = new ProjectService();
        var categoriesObj = projectService.getCategoriesListWithCentralizedRates(costHeadCategories, centralizedRates);
        estimateReport.total = categoriesObj.categoriesAmount;
        estimateReport.rate = parseFloat((estimateReport.total / area).toFixed(2));
        if (rateUnit === Constants.SQUREMETER_UNIT) {
            estimateReport.rate = parseFloat((estimateReport.rate * config.get(Constants.SQUARE_METER)).toFixed(2));
        }
        return estimateReport;
    };
    ReportService.prototype.generateReportForProjectCostHeads = function (projectCostHeads, totalArea, areaType, rateUnit, report) {
        var projectCostHeadArray = projectCostHeads;
        var projectReport = new BuildingReport;
        for (var projectCostHeadIndex in projectCostHeadArray) {
            var thumbRule = new ThumbRule();
            var estimate = new Estimate();
            if (projectCostHeadArray[projectCostHeadIndex].active) {
                var thumbRuleReport = new ThumbRuleReport();
                var estimateReport = new EstimateReport();
                estimateReport.name = projectCostHeadArray[projectCostHeadIndex].name;
                estimateReport.rateAnalysisId = projectCostHeadArray[projectCostHeadIndex].rateAnalysisId;
                var categoryArray = projectCostHeadArray[projectCostHeadIndex].categories;
                for (var categoryIndex in categoryArray) {
                    if (categoryArray[categoryIndex].active) {
                        var workItemArray = categoryArray[categoryIndex].workItems;
                        if (workItemArray.length !== 0) {
                            for (var workItemIndex in workItemArray) {
                                if (workItemArray[workItemIndex].active) {
                                    if (workItemArray[workItemIndex].quantity.total !== null && workItemArray[workItemIndex].rate.total !== null
                                        && workItemArray[workItemIndex].quantity.total !== 0 && workItemArray[workItemIndex].rate.total !== 0) {
                                        estimateReport.total = parseFloat((workItemArray[workItemIndex].quantity.total *
                                            workItemArray[workItemIndex].rate.total + estimateReport.total).toFixed(2));
                                        estimateReport.rate = parseFloat((estimateReport.total / totalArea).toFixed(2));
                                    }
                                }
                            }
                        }
                    }
                }
                estimate.totalEstimatedCost = parseFloat((estimateReport.total + estimate.totalEstimatedCost).toFixed(2));
                estimate.totalRate = parseFloat((estimate.totalRate + estimateReport.rate).toFixed(2));
                if (rateUnit === Constants.SQUREMETER_UNIT) {
                    estimate.totalRate = parseFloat((estimateReport.rate * config.get(Constants.SQUARE_METER)).toFixed(2));
                }
                estimate.estimatedCosts.push(estimateReport);
                thumbRuleReport.name = projectCostHeadArray[projectCostHeadIndex].name;
                thumbRuleReport.rateAnalysisId = projectCostHeadArray[projectCostHeadIndex].rateAnalysisId;
                thumbRuleReport.amount = parseFloat((projectCostHeadArray[projectCostHeadIndex].budgetedCostAmount).toFixed(2));
                thumbRuleReport.rate = parseFloat((thumbRuleReport.amount / totalArea).toFixed(2));
                if (rateUnit === Constants.SQUREMETER_UNIT) {
                    thumbRuleReport.rate = parseFloat((thumbRuleReport.rate * config.get(Constants.SQUARE_METER)).toFixed(2));
                }
                thumbRule.totalRate = parseFloat((thumbRule.totalRate + thumbRuleReport.rate).toFixed(2));
                thumbRule.totalBudgetedCost = parseFloat((thumbRule.totalBudgetedCost + thumbRuleReport.amount).toFixed(2));
                thumbRule.thumbRuleReports.push(thumbRuleReport);
                projectReport.thumbRule = thumbRule;
                projectReport.estimate = estimate;
            }
        }
        report.push(projectReport);
    };
    ReportService.prototype.getCostHeads = function (url, user, callback) {
        var _this = this;
        logger.info('Report Service, getCostHeads has been hit');
        this.rateAnalysisService.getCostHeads(url, user, function (error, result) {
            if (error) {
                console.log('error : ' + JSON.stringify(error));
                callback(error, null);
            }
            else {
                callback(null, { data: result, access_token: _this.authInterceptor.issueTokenWithUid(user) });
            }
        });
    };
    ReportService.prototype.getWorkItems = function (url, user, callback) {
        var _this = this;
        logger.info('Report Service, getWorkItems has been hit');
        this.rateAnalysisService.getWorkItems(url, user, function (error, result) {
            if (error) {
                console.log('error : ' + JSON.stringify(error));
                callback(error, null);
            }
            else {
                callback(null, { data: result, access_token: _this.authInterceptor.issueTokenWithUid(user) });
            }
        });
    };
    return ReportService;
}());
Object.seal(ReportService);
module.exports = ReportService;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9hcHBsaWNhdGlvblByb2plY3Qvc2VydmljZXMvUmVwb3J0U2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsOEVBQWlGO0FBQ2pGLGdGQUFtRjtBQUNuRixvRUFBdUU7QUFDdkUsa0VBQXFFO0FBR3JFLG1GQUFzRjtBQUN0RixxRkFBd0Y7QUFDeEYsOEVBQWlGO0FBRWpGLG1GQUFzRjtBQUN0RixpRkFBb0Y7QUFDcEYsMEVBQTZFO0FBQzdFLHdFQUEyRTtBQUMzRSwyREFBOEQ7QUFFOUQsK0JBQWtDO0FBQ2xDLCtDQUFrRDtBQUNsRCxpREFBb0Q7QUFDcEQsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQy9CLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMvQixJQUFJLE1BQU0sR0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFFOUM7SUFVRTtRQUNFLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLGlCQUFpQixFQUFFLENBQUM7UUFDakQsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksa0JBQWtCLEVBQUUsQ0FBQztRQUNuRCxJQUFJLENBQUMsUUFBUSxHQUFHLFlBQVksQ0FBQyxRQUFRLENBQUM7UUFDdEMsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLGVBQWUsRUFBRSxDQUFDO1FBQzdDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUNyQyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxtQkFBbUIsRUFBRSxDQUFDO0lBQ3ZELENBQUM7SUFFRCxpQ0FBUyxHQUFULFVBQVcsU0FBZSxFQUFFLFVBQW1CLEVBQUUsUUFBaUIsRUFBRSxRQUFpQixFQUFHLElBQVUsRUFDdkYsUUFBMkM7UUFEdEQsaUJBZ0RDO1FBN0NDLE1BQU0sQ0FBQyxJQUFJLENBQUMsd0NBQXdDLENBQUMsQ0FBQztRQUN0RCxJQUFJ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QyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLEtBQUksQ0FBQyxlQUFlLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEVBQUMsQ0FBQyxDQUFDO1lBQzdGLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFSCxvQkFBQztBQUFELENBN09BLEFBNk9DLElBQUE7QUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQzNCLGlCQUFTLGFBQWEsQ0FBQyIsImZpbGUiOiJhcHAvYXBwbGljYXRpb25Qcm9qZWN0L3NlcnZpY2VzL1JlcG9ydFNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUHJvamVjdFJlcG9zaXRvcnkgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL3JlcG9zaXRvcnkvUHJvamVjdFJlcG9zaXRvcnknKTtcclxuaW1wb3J0IEJ1aWxkaW5nUmVwb3NpdG9yeSA9IHJlcXVpcmUoJy4uL2RhdGFhY2Nlc3MvcmVwb3NpdG9yeS9CdWlsZGluZ1JlcG9zaXRvcnknKTtcclxuaW1wb3J0IFVzZXJTZXJ2aWNlID0gcmVxdWlyZSgnLi8uLi8uLi9mcmFtZXdvcmsvc2VydmljZXMvVXNlclNlcnZpY2UnKTtcclxuaW1wb3J0IFByb2plY3RBc3NldCA9IHJlcXVpcmUoJy4uLy4uL2ZyYW1ld29yay9zaGFyZWQvcHJvamVjdGFzc2V0Jyk7XHJcbmltcG9ydCBVc2VyID0gcmVxdWlyZSgnLi4vLi4vZnJhbWV3b3JrL2RhdGFhY2Nlc3MvbW9uZ29vc2UvdXNlcicpO1xyXG5pbXBvcnQgQnVpbGRpbmcgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL21vbmdvb3NlL0J1aWxkaW5nJyk7XHJcbmltcG9ydCBCdWlsZGluZ1JlcG9ydCA9IHJlcXVpcmUoJy4uL2RhdGFhY2Nlc3MvbW9kZWwvcHJvamVjdC9yZXBvcnRzL0J1aWxkaW5nUmVwb3J0Jyk7XHJcbmltcG9ydCBUaHVtYlJ1bGVSZXBvcnQgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL21vZGVsL3Byb2plY3QvcmVwb3J0cy9UaHVtYlJ1bGVSZXBvcnQnKTtcclxuaW1wb3J0IEF1dGhJbnRlcmNlcHRvciA9IHJlcXVpcmUoJy4uLy4uL2ZyYW1ld29yay9pbnRlcmNlcHRvci9hdXRoLmludGVyY2VwdG9yJyk7XHJcbmltcG9ydCBDb3N0SGVhZCA9IHJlcXVpcmUoJy4uL2RhdGFhY2Nlc3MvbW9uZ29vc2UvQ29zdEhlYWQnKTtcclxuaW1wb3J0IEVzdGltYXRlUmVwb3J0ID0gcmVxdWlyZSgnLi4vZGF0YWFjY2Vzcy9tb2RlbC9wcm9qZWN0L3JlcG9ydHMvRXN0aW1hdGVSZXBvcnQnKTtcclxuaW1wb3J0IFByb2plY3RSZXBvcnQgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL21vZGVsL3Byb2plY3QvcmVwb3J0cy9Qcm9qZWN0UmVwb3J0Jyk7XHJcbmltcG9ydCBUaHVtYlJ1bGUgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL21vZGVsL3Byb2plY3QvYnVpbGRpbmcvVGh1bWJSdWxlJyk7XHJcbmltcG9ydCBFc3RpbWF0ZSA9IHJlcXVpcmUoJy4uL2RhdGFhY2Nlc3MvbW9kZWwvcHJvamVjdC9idWlsZGluZy9Fc3RpbWF0ZScpO1xyXG5pbXBvcnQgUmF0ZUFuYWx5c2lzU2VydmljZSA9IHJlcXVpcmUoJy4vUmF0ZUFuYWx5c2lzU2VydmljZScpO1xyXG5pbXBvcnQgQ2F0ZWdvcnkgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL21vZGVsL3Byb2plY3QvYnVpbGRpbmcvQ2F0ZWdvcnknKTtcclxuaW1wb3J0IGFsYXNxbCA9IHJlcXVpcmUoJ2FsYXNxbCcpO1xyXG5pbXBvcnQgQ29uc3RhbnRzID0gcmVxdWlyZSgnLi4vc2hhcmVkL2NvbnN0YW50cycpO1xyXG5pbXBvcnQgUHJvamVjdFNlcnZpY2UgPSByZXF1aXJlKCcuL1Byb2plY3RTZXJ2aWNlJyk7XHJcbmxldCBjb25maWcgPSByZXF1aXJlKCdjb25maWcnKTtcclxudmFyIGxvZzRqcyA9IHJlcXVpcmUoJ2xvZzRqcycpO1xyXG52YXIgbG9nZ2VyPWxvZzRqcy5nZXRMb2dnZXIoJ1JlcG9ydCBTZXJ2aWNlJyk7XHJcblxyXG5jbGFzcyBSZXBvcnRTZXJ2aWNlIHtcclxuICBBUFBfTkFNRTogc3RyaW5nO1xyXG4gIGNvbXBhbnlfbmFtZTogc3RyaW5nO1xyXG4gIHByaXZhdGUgcHJvamVjdFJlcG9zaXRvcnk6IFByb2plY3RSZXBvc2l0b3J5O1xyXG4gIHByaXZhdGUgYnVpbGRpbmdSZXBvc2l0b3J5OiBCdWlsZGluZ1JlcG9zaXRvcnk7XHJcbiAgcHJpdmF0ZSBhdXRoSW50ZXJjZXB0b3I6IEF1dGhJbnRlcmNlcHRvcjtcclxuICBwcml2YXRlIHVzZXJTZXJ2aWNlIDogVXNlclNlcnZpY2U7XHJcbiAgcHJpdmF0ZSByYXRlQW5hbHlzaXNTZXJ2aWNlIDogUmF0ZUFuYWx5c2lzU2VydmljZTtcclxuICBwcml2YXRlIHByb2plY3RTZXJ2aWNlIDogUHJvamVjdFNlcnZpY2U7XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgdGhpcy5wcm9qZWN0UmVwb3NpdG9yeSA9IG5ldyBQcm9qZWN0UmVwb3NpdG9yeSgpO1xyXG4gICAgdGhpcy5idWlsZGluZ1JlcG9zaXRvcnkgPSBuZXcgQnVpbGRpbmdSZXBvc2l0b3J5KCk7XHJcbiAgICB0aGlzLkFQUF9OQU1FID0gUHJvamVjdEFzc2V0LkFQUF9OQU1FO1xyXG4gICAgdGhpcy5hdXRoSW50ZXJjZXB0b3IgPSBuZXcgQXV0aEludGVyY2VwdG9yKCk7XHJcbiAgICB0aGlzLnVzZXJTZXJ2aWNlID0gbmV3IFVzZXJTZXJ2aWNlKCk7XHJcbiAgICB0aGlzLnJhdGVBbmFseXNpc1NlcnZpY2UgPSBuZXcgUmF0ZUFuYWx5c2lzU2VydmljZSgpO1xyXG4gIH1cclxuXHJcbiAgZ2V0UmVwb3J0KCBwcm9qZWN0SWQgOiBhbnksIHJlcG9ydFR5cGUgOiBzdHJpbmcsIHJhdGVVbml0IDogc3RyaW5nLCBhcmVhVHlwZSA6IHN0cmluZyzigILigIJ1c2VyOiBVc2VyLFxyXG4gICAgICAgICAgICAgY2FsbGJhY2s6IChlcnJvcjogYW55LCByZXN1bHQ6IGFueSkgPT4gdm9pZCkge1xyXG5cclxuICAgIGxvZ2dlci5pbmZvKCdSZXBvcnQgU2VydmljZSwgZ2V0UmVwb3J0IGhhcyBiZWVuIGhpdCcpO1xyXG4gICAgbGV0IHF1ZXJ5ID0geyBfaWQ6IHByb2plY3RJZH07XHJcbiAgICBsZXQgcG9wdWxhdGUgPSB7cGF0aCA6ICdidWlsZGluZ3MnfTtcclxuICAgIHRoaXMucHJvamVjdFJlcG9zaXRvcnkuZmluZEFuZFBvcHVsYXRlKHF1ZXJ5LCBwb3B1bGF0ZSwgKGVycm9yLCByZXN1bHQpID0+IHtcclxuICAgICAgbG9nZ2VyLmluZm8oJ1JlcG9ydCBTZXJ2aWNlLCBmaW5kQW5kUG9wdWxhdGUgaGFzIGJlZW4gaGl0Jyk7XHJcbiAgICAgIGlmKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGxldCBidWlsZGluZ3MgPSByZXN1bHRbMF0uYnVpbGRpbmdzO1xyXG4gICAgICAgIHZhciB0eXBlT2ZBcmVhOiBzdHJpbmc7XHJcbiAgICAgICAgbGV0IGNob2ljZSA9IGFyZWFUeXBlO1xyXG4gICAgICAgIHN3aXRjaCAoY2hvaWNlKSB7XHJcbiAgICAgICAgICBjYXNlIENvbnN0YW50cy5TTEFCX0FSRUE6XHJcbiAgICAgICAgICB7XHJcbiAgICAgICAgICAgIHR5cGVPZkFyZWEgPSBDb25zdGFudHMuVE9UQUxfU0xBQl9BUkVBO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICBjYXNlIENvbnN0YW50cy5TQUxFQUJMRV9BUkVBOlxyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICB0eXBlT2ZBcmVhID0gQ29uc3RhbnRzLlRPVEFMX1NBTEVBQkxFX0FSRUE7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIGNhc2UgIENvbnN0YW50cy5DQVJQRVRfQVJFQSA6XHJcbiAgICAgICAgICB7XHJcbiAgICAgICAgICAgIHR5cGVPZkFyZWEgPSBDb25zdGFudHMuVE9UQUxfQ0FSUEVUX0FSRUE7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgZGVmYXVsdCA6ICBjYWxsYmFjayhlcnJvcixudWxsKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCB0b3RhbEFyZWEgPSBhbGFzcWwoJ1ZBTFVFIE9GIFNFTEVDVCBTVU0oJyt0eXBlT2ZBcmVhKycpIEZST00gPycsW2J1aWxkaW5nc10pO1xyXG4gICAgICAgIGxldCBwcm9qZWN0Q29zdEhlYWRzID0gcmVzdWx0WzBdLnByb2plY3RDb3N0SGVhZHM7XHJcbiAgICAgICAgbGV0IHByb2plY3RSZXBvcnQgOiBQcm9qZWN0UmVwb3J0ID0gbmV3IFByb2plY3RSZXBvcnQoKTtcclxuICAgICAgICBsZXQgYnVpbGRpbmdSZXBvcnQgOiBBcnJheTxCdWlsZGluZ1JlcG9ydD4gPSBuZXcgQXJyYXk8QnVpbGRpbmdSZXBvcnQ+KCk7XHJcbiAgICAgICAgdGhpcy5nZW5lcmF0ZVJlcG9ydEJ5Q29zdEhlYWRzKCAgYnVpbGRpbmdzLCB0eXBlT2ZBcmVhLCByYXRlVW5pdCwgYnVpbGRpbmdSZXBvcnQpO1xyXG4gICAgICAgIHByb2plY3RSZXBvcnQuYnVpbGRpbmdzID0gYnVpbGRpbmdSZXBvcnQ7XHJcbiAgICAgICAgbGV0IGNvbW1vbkFtZW5pdGllc1JlcG9ydCA6IEFycmF5PEJ1aWxkaW5nUmVwb3J0PiA9IG5ldyBBcnJheTxCdWlsZGluZ1JlcG9ydD4oKTtcclxuICAgICAgICB0aGlzLmdlbmVyYXRlUmVwb3J0Rm9yUHJvamVjdENvc3RIZWFkcyhwcm9qZWN0Q29zdEhlYWRzICx0b3RhbEFyZWEsXHJcbiAgICAgICAgICBhcmVhVHlwZSwgcmF0ZVVuaXQsIGNvbW1vbkFtZW5pdGllc1JlcG9ydCk7XHJcbiAgICAgICAgcHJvamVjdFJlcG9ydC5jb21tb25BbWVuaXRpZXMgPSBjb21tb25BbWVuaXRpZXNSZXBvcnQ7XHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCx7IGRhdGE6IHByb2plY3RSZXBvcnQsIGFjY2Vzc190b2tlbjogdGhpcy5hdXRoSW50ZXJjZXB0b3IuaXNzdWVUb2tlbldpdGhVaWQodXNlcil9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBnZW5lcmF0ZVJlcG9ydEJ5Q29zdEhlYWRzKCBidWlsZGluZ3M6ICBBcnJheTxCdWlsZGluZz4gLCB0eXBlT2ZBcmVhOiBzdHJpbmcsIHJhdGVVbml0OiBzdHJpbmcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwb3J0OiBBcnJheTxCdWlsZGluZ1JlcG9ydD4pIHtcclxuICAgIGZvciAobGV0IGJ1aWxkaW5nIG9mIGJ1aWxkaW5ncykge1xyXG4gICAgICBsZXQgYnVpbGRpbmdSZXBvcnQgPSBuZXcgQnVpbGRpbmdSZXBvcnQ7XHJcbiAgICAgIGJ1aWxkaW5nUmVwb3J0Lm5hbWUgPSBidWlsZGluZy5uYW1lO1xyXG4gICAgICBidWlsZGluZ1JlcG9ydC5faWQgPSBidWlsZGluZy5faWQ7XHJcbiAgICAgIGJ1aWxkaW5nUmVwb3J0LmFyZWEgPSBidWlsZGluZ1t0eXBlT2ZBcmVhXTtcclxuXHJcbiAgICAgIGxldCB0aHVtYlJ1bGUgID0gbmV3IFRodW1iUnVsZSgpO1xyXG4gICAgICBsZXQgZXN0aW1hdGUgID0gbmV3IEVzdGltYXRlKCk7XHJcbiAgICAgIGxldCB0aHVtYlJ1bGVSZXBvcnRzID0gbmV3IEFycmF5PFRodW1iUnVsZVJlcG9ydD4oKTtcclxuICAgICAgbGV0IGVzdGltYXRlZFJlcG9ydHMgPSBuZXcgQXJyYXk8RXN0aW1hdGVSZXBvcnQ+KCk7XHJcblxyXG5cclxuICAgICAgdGhpcy5nZXRUaHVtYlJ1bGVBbmRFc3RpbWF0ZWRSZXBvcnQoYnVpbGRpbmcsIGJ1aWxkaW5nUmVwb3J0LCB0aHVtYlJ1bGVSZXBvcnRzLCBlc3RpbWF0ZWRSZXBvcnRzLCByYXRlVW5pdCk7XHJcblxyXG4gICAgICBsZXQgdG90YWxSYXRlcyA9IGFsYXNxbCgnU0VMRUNUIFNVTShhbW91bnQpIEFTIHRvdGFsQW1vdW50LCBTVU0ocmF0ZSkgQVMgdG90YWxSYXRlIEZST00gPycsW3RodW1iUnVsZVJlcG9ydHNdKTtcclxuICAgICAgdGh1bWJSdWxlLnRvdGFsUmF0ZSA9IHRvdGFsUmF0ZXNbMF0udG90YWxSYXRlO1xyXG4gICAgICBpZihyYXRlVW5pdCA9PT0gQ29uc3RhbnRzLlNRVVJFTUVURVJfVU5JVCkge1xyXG4gICAgICAgIHRodW1iUnVsZS50b3RhbFJhdGUgPSAgcGFyc2VGbG9hdCgodGh1bWJSdWxlLnRvdGFsUmF0ZSAqIGNvbmZpZy5nZXQoQ29uc3RhbnRzLlNRVUFSRV9NRVRFUikpLnRvRml4ZWQoMikpO1xyXG4gICAgICB9XHJcbiAgICAgIHRodW1iUnVsZS50b3RhbEJ1ZGdldGVkQ29zdCA9IHRvdGFsUmF0ZXNbMF0udG90YWxBbW91bnQ7XHJcbiAgICAgIHRodW1iUnVsZS50aHVtYlJ1bGVSZXBvcnRzID0gdGh1bWJSdWxlUmVwb3J0cztcclxuXHJcbiAgICAgIGxldCB0b3RhbEVzdGltYXRlZFJhdGVzID0gYWxhc3FsKCdTRUxFQ1QgU1VNKHRvdGFsKSBBUyB0b3RhbEFtb3VudCwgU1VNKHJhdGUpIEFTIHRvdGFsUmF0ZSBGUk9NID8nLFtlc3RpbWF0ZWRSZXBvcnRzXSk7XHJcbiAgICAgIGVzdGltYXRlLnRvdGFsUmF0ZSA9IHRvdGFsRXN0aW1hdGVkUmF0ZXNbMF0udG90YWxSYXRlO1xyXG4gICAgICBpZihyYXRlVW5pdCA9PT0gQ29uc3RhbnRzLlNRVVJFTUVURVJfVU5JVCkge1xyXG4gICAgICAgIGVzdGltYXRlLnRvdGFsUmF0ZSA9ICBwYXJzZUZsb2F0KChlc3RpbWF0ZS50b3RhbFJhdGUgKiBjb25maWcuZ2V0KENvbnN0YW50cy5TUVVBUkVfTUVURVIpKS50b0ZpeGVkKDIpKTtcclxuICAgICAgfVxyXG4gICAgICBlc3RpbWF0ZS50b3RhbEVzdGltYXRlZENvc3QgPSB0b3RhbEVzdGltYXRlZFJhdGVzWzBdLnRvdGFsQW1vdW50O1xyXG4gICAgICBlc3RpbWF0ZS5lc3RpbWF0ZWRDb3N0cyA9IGVzdGltYXRlZFJlcG9ydHM7XHJcblxyXG4gICAgICBidWlsZGluZ1JlcG9ydC50aHVtYlJ1bGUgPSB0aHVtYlJ1bGU7XHJcbiAgICAgIGJ1aWxkaW5nUmVwb3J0LmVzdGltYXRlID0gZXN0aW1hdGU7XHJcbiAgICAgIHJlcG9ydC5wdXNoKGJ1aWxkaW5nUmVwb3J0KTtcclxuICAgIH1cclxuICB9XHJcblxyXG5cclxuICBnZXRUaHVtYlJ1bGVBbmRFc3RpbWF0ZWRSZXBvcnQoYnVpbGRpbmcgOkJ1aWxkaW5nLCBidWlsZGluZ1JlcG9ydDogQnVpbGRpbmdSZXBvcnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRodW1iUnVsZVJlcG9ydHM6IFRodW1iUnVsZVJlcG9ydFtdLCBlc3RpbWF0ZWRSZXBvcnRzOiBFc3RpbWF0ZVJlcG9ydFtdLCByYXRlVW5pdDpzdHJpbmcpIHtcclxuXHJcbiAgICBmb3IgKGxldCBjb3N0SGVhZCBvZiBidWlsZGluZy5jb3N0SGVhZHMpIHtcclxuXHJcbiAgICAgIGlmKGNvc3RIZWFkLmFjdGl2ZSkge1xyXG4gICAgICAgIC8vVGh1bWJSdWxlIFJlcG9ydFxyXG4gICAgICAgIGxldCB0aHVtYlJ1bGVSZXBvcnQgPSBuZXcgVGh1bWJSdWxlUmVwb3J0KCk7XHJcbiAgICAgICAgdGh1bWJSdWxlUmVwb3J0Lm5hbWUgPSBjb3N0SGVhZC5uYW1lO1xyXG4gICAgICAgIHRodW1iUnVsZVJlcG9ydC5yYXRlQW5hbHlzaXNJZCA9IGNvc3RIZWFkLnJhdGVBbmFseXNpc0lkO1xyXG4gICAgICAgIHRodW1iUnVsZVJlcG9ydC5hbW91bnQgPSBjb3N0SGVhZC5idWRnZXRlZENvc3RBbW91bnQ7XHJcbiAgICAgICAgdGh1bWJSdWxlUmVwb3J0LmNvc3RIZWFkQWN0aXZlID0gY29zdEhlYWQuYWN0aXZlO1xyXG4gICAgICAgIHRodW1iUnVsZVJlcG9ydC5yYXRlID0gcGFyc2VGbG9hdCgoY29zdEhlYWQuYnVkZ2V0ZWRDb3N0QW1vdW50IC8gYnVpbGRpbmdSZXBvcnQuYXJlYSkudG9GaXhlZCgyKSk7XHJcbiAgICAgICAgaWYocmF0ZVVuaXQgPT09IENvbnN0YW50cy5TUVVSRU1FVEVSX1VOSVQpIHtcclxuICAgICAgICAgIHRodW1iUnVsZVJlcG9ydC5yYXRlID0gcGFyc2VGbG9hdCgodGh1bWJSdWxlUmVwb3J0LnJhdGUgKiBjb25maWcuZ2V0KENvbnN0YW50cy5TUVVBUkVfTUVURVIpKS50b0ZpeGVkKDIpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGh1bWJSdWxlUmVwb3J0cy5wdXNoKHRodW1iUnVsZVJlcG9ydCk7XHJcblxyXG4gICAgICAgIC8vRXN0aW1hdGVkIGNvc3QgUmVwb3J0XHJcbiAgICAgICAgbGV0IGVzdGltYXRlUmVwb3J0ID0gbmV3IEVzdGltYXRlUmVwb3J0KCk7XHJcbiAgICAgICAgZXN0aW1hdGVSZXBvcnQgPSB0aGlzLmdldEVzdGltYXRlZFJlcG9ydChidWlsZGluZy5yYXRlcywgY29zdEhlYWQsIGJ1aWxkaW5nUmVwb3J0LmFyZWEsIHJhdGVVbml0KTtcclxuICAgICAgICBlc3RpbWF0ZWRSZXBvcnRzLnB1c2goZXN0aW1hdGVSZXBvcnQpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBnZXRFc3RpbWF0ZWRSZXBvcnQoY2VudHJhbGl6ZWRSYXRlczpBcnJheTxhbnk+LCBjb3N0SGVhZDphbnksIGFyZWE6bnVtYmVyLCByYXRlVW5pdDpzdHJpbmcpIHtcclxuXHJcbiAgICBsZXQgZXN0aW1hdGVSZXBvcnQgPSBuZXcgRXN0aW1hdGVSZXBvcnQoKTtcclxuICAgIGVzdGltYXRlUmVwb3J0Lm5hbWUgPSBjb3N0SGVhZC5uYW1lO1xyXG4gICAgZXN0aW1hdGVSZXBvcnQucmF0ZUFuYWx5c2lzSWQgPSBjb3N0SGVhZC5yYXRlQW5hbHlzaXNJZDtcclxuXHJcbiAgICBsZXQgY29zdEhlYWRDYXRlZ29yaWVzOiBBcnJheTxDYXRlZ29yeT4gPSBjb3N0SGVhZC5jYXRlZ29yaWVzO1xyXG4gICAgbGV0IHByb2plY3RTZXJ2aWNlIDogUHJvamVjdFNlcnZpY2UgPSBuZXcgUHJvamVjdFNlcnZpY2UoKTtcclxuICAgIGxldCBjYXRlZ29yaWVzT2JqID0gcHJvamVjdFNlcnZpY2UuZ2V0Q2F0ZWdvcmllc0xpc3RXaXRoQ2VudHJhbGl6ZWRSYXRlcyhjb3N0SGVhZENhdGVnb3JpZXMsIGNlbnRyYWxpemVkUmF0ZXMpO1xyXG4gICAgZXN0aW1hdGVSZXBvcnQudG90YWwgPSBjYXRlZ29yaWVzT2JqLmNhdGVnb3JpZXNBbW91bnQ7XHJcbiAgICBlc3RpbWF0ZVJlcG9ydC5yYXRlID0gcGFyc2VGbG9hdCgoZXN0aW1hdGVSZXBvcnQudG90YWwgLyBhcmVhKS50b0ZpeGVkKDIpKTtcclxuICAgIGlmKHJhdGVVbml0ID09PSBDb25zdGFudHMuU1FVUkVNRVRFUl9VTklUKSB7XHJcbiAgICAgIGVzdGltYXRlUmVwb3J0LnJhdGUgPSBwYXJzZUZsb2F0KChlc3RpbWF0ZVJlcG9ydC5yYXRlICogY29uZmlnLmdldChDb25zdGFudHMuU1FVQVJFX01FVEVSKSkudG9GaXhlZCgyKSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZXN0aW1hdGVSZXBvcnQ7XHJcbiAgfVxyXG5cclxuICBnZW5lcmF0ZVJlcG9ydEZvclByb2plY3RDb3N0SGVhZHMocHJvamVjdENvc3RIZWFkczogIEFycmF5PENvc3RIZWFkPiwgdG90YWxBcmVhOiBudW1iZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmVhVHlwZTogc3RyaW5nLCByYXRlVW5pdDogc3RyaW5nLCByZXBvcnQ6IEFycmF5PEJ1aWxkaW5nUmVwb3J0Pikge1xyXG5cclxuICAgIGxldCBwcm9qZWN0Q29zdEhlYWRBcnJheTogQXJyYXk8Q29zdEhlYWQ+ID0gcHJvamVjdENvc3RIZWFkcztcclxuICAgIGxldCBwcm9qZWN0UmVwb3J0ID0gbmV3IEJ1aWxkaW5nUmVwb3J0O1xyXG4gICAgZm9yIChsZXQgcHJvamVjdENvc3RIZWFkSW5kZXggaW4gcHJvamVjdENvc3RIZWFkQXJyYXkpIHtcclxuXHJcbiAgICAgIGxldCB0aHVtYlJ1bGU6IFRodW1iUnVsZSA9IG5ldyBUaHVtYlJ1bGUoKTtcclxuICAgICAgbGV0IGVzdGltYXRlIDogRXN0aW1hdGUgPSBuZXcgRXN0aW1hdGUoKTtcclxuXHJcbiAgICAgIGlmIChwcm9qZWN0Q29zdEhlYWRBcnJheVtwcm9qZWN0Q29zdEhlYWRJbmRleF0uYWN0aXZlKSB7XHJcblxyXG4gICAgICAgIGxldCB0aHVtYlJ1bGVSZXBvcnQ6IFRodW1iUnVsZVJlcG9ydCA9IG5ldyBUaHVtYlJ1bGVSZXBvcnQoKTtcclxuICAgICAgICBsZXQgZXN0aW1hdGVSZXBvcnQ6IEVzdGltYXRlUmVwb3J0ID0gbmV3IEVzdGltYXRlUmVwb3J0KCk7XHJcblxyXG4gICAgICAgIGVzdGltYXRlUmVwb3J0Lm5hbWUgPSBwcm9qZWN0Q29zdEhlYWRBcnJheVtwcm9qZWN0Q29zdEhlYWRJbmRleF0ubmFtZTtcclxuICAgICAgICBlc3RpbWF0ZVJlcG9ydC5yYXRlQW5hbHlzaXNJZCA9IHByb2plY3RDb3N0SGVhZEFycmF5W3Byb2plY3RDb3N0SGVhZEluZGV4XS5yYXRlQW5hbHlzaXNJZDtcclxuXHJcbiAgICAgICAgbGV0IGNhdGVnb3J5QXJyYXkgOiBBcnJheTxDYXRlZ29yeT4gPSBwcm9qZWN0Q29zdEhlYWRBcnJheVtwcm9qZWN0Q29zdEhlYWRJbmRleF0uY2F0ZWdvcmllcztcclxuICAgICAgICBmb3IgKGxldCBjYXRlZ29yeUluZGV4IGluIGNhdGVnb3J5QXJyYXkpIHtcclxuICAgICAgICAgIGlmIChjYXRlZ29yeUFycmF5W2NhdGVnb3J5SW5kZXhdLmFjdGl2ZSkge1xyXG4gICAgICAgICAgICBsZXQgd29ya0l0ZW1BcnJheSA9IGNhdGVnb3J5QXJyYXlbY2F0ZWdvcnlJbmRleF0ud29ya0l0ZW1zO1xyXG4gICAgICAgICAgICBpZiAod29ya0l0ZW1BcnJheS5sZW5ndGggIT09IDApIHtcclxuICAgICAgICAgICAgICBmb3IgKGxldCB3b3JrSXRlbUluZGV4IGluIHdvcmtJdGVtQXJyYXkpIHtcclxuICAgICAgICAgICAgICAgIGlmICh3b3JrSXRlbUFycmF5W3dvcmtJdGVtSW5kZXhdLmFjdGl2ZSkge1xyXG4gICAgICAgICAgICAgICAgICBpZiAod29ya0l0ZW1BcnJheVt3b3JrSXRlbUluZGV4XS5xdWFudGl0eS50b3RhbCAhPT0gbnVsbCAmJiB3b3JrSXRlbUFycmF5W3dvcmtJdGVtSW5kZXhdLnJhdGUudG90YWwgIT09IG51bGxcclxuICAgICAgICAgICAgICAgICAgICAmJiB3b3JrSXRlbUFycmF5W3dvcmtJdGVtSW5kZXhdLnF1YW50aXR5LnRvdGFsICE9PSAwICYmIHdvcmtJdGVtQXJyYXlbd29ya0l0ZW1JbmRleF0ucmF0ZS50b3RhbCAhPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGVzdGltYXRlUmVwb3J0LnRvdGFsID0gcGFyc2VGbG9hdCgod29ya0l0ZW1BcnJheVt3b3JrSXRlbUluZGV4XS5xdWFudGl0eS50b3RhbCAqXHJcbiAgICAgICAgICAgICAgICAgICAgICB3b3JrSXRlbUFycmF5W3dvcmtJdGVtSW5kZXhdLnJhdGUudG90YWwgKyBlc3RpbWF0ZVJlcG9ydC50b3RhbCkudG9GaXhlZCgyKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXN0aW1hdGVSZXBvcnQucmF0ZSA9IHBhcnNlRmxvYXQoKGVzdGltYXRlUmVwb3J0LnRvdGFsIC8gdG90YWxBcmVhKS50b0ZpeGVkKDIpKTtcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlc3RpbWF0ZS50b3RhbEVzdGltYXRlZENvc3QgPSBwYXJzZUZsb2F0KChlc3RpbWF0ZVJlcG9ydC50b3RhbCArIGVzdGltYXRlLnRvdGFsRXN0aW1hdGVkQ29zdCkudG9GaXhlZCgyKSk7XHJcbiAgICAgICAgZXN0aW1hdGUudG90YWxSYXRlID0gcGFyc2VGbG9hdCgoZXN0aW1hdGUudG90YWxSYXRlICsgZXN0aW1hdGVSZXBvcnQucmF0ZSkudG9GaXhlZCgyKSk7XHJcbiAgICAgICAgaWYocmF0ZVVuaXQgPT09IENvbnN0YW50cy5TUVVSRU1FVEVSX1VOSVQpIHtcclxuICAgICAgICAgIGVzdGltYXRlLnRvdGFsUmF0ZSA9IHBhcnNlRmxvYXQoKGVzdGltYXRlUmVwb3J0LnJhdGUgKiBjb25maWcuZ2V0KENvbnN0YW50cy5TUVVBUkVfTUVURVIpKS50b0ZpeGVkKDIpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZXN0aW1hdGUuZXN0aW1hdGVkQ29zdHMucHVzaChlc3RpbWF0ZVJlcG9ydCk7XHJcblxyXG4gICAgICAgIHRodW1iUnVsZVJlcG9ydC5uYW1lID0gcHJvamVjdENvc3RIZWFkQXJyYXlbcHJvamVjdENvc3RIZWFkSW5kZXhdLm5hbWU7XHJcbiAgICAgICAgdGh1bWJSdWxlUmVwb3J0LnJhdGVBbmFseXNpc0lkID0gcHJvamVjdENvc3RIZWFkQXJyYXlbcHJvamVjdENvc3RIZWFkSW5kZXhdLnJhdGVBbmFseXNpc0lkO1xyXG4gICAgICAgIHRodW1iUnVsZVJlcG9ydC5hbW91bnQgPSBwYXJzZUZsb2F0KChwcm9qZWN0Q29zdEhlYWRBcnJheVtwcm9qZWN0Q29zdEhlYWRJbmRleF0uYnVkZ2V0ZWRDb3N0QW1vdW50KS50b0ZpeGVkKDIpKTtcclxuICAgICAgICB0aHVtYlJ1bGVSZXBvcnQucmF0ZSA9ICBwYXJzZUZsb2F0KCh0aHVtYlJ1bGVSZXBvcnQuYW1vdW50L3RvdGFsQXJlYSkudG9GaXhlZCgyKSk7XHJcblxyXG4gICAgICAgICBpZihyYXRlVW5pdCA9PT0gQ29uc3RhbnRzLlNRVVJFTUVURVJfVU5JVCkge1xyXG4gICAgICAgICAgIHRodW1iUnVsZVJlcG9ydC5yYXRlID0gcGFyc2VGbG9hdCgodGh1bWJSdWxlUmVwb3J0LnJhdGUgKiBjb25maWcuZ2V0KENvbnN0YW50cy5TUVVBUkVfTUVURVIpKS50b0ZpeGVkKDIpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGh1bWJSdWxlLnRvdGFsUmF0ZSA9IHBhcnNlRmxvYXQoKHRodW1iUnVsZS50b3RhbFJhdGUgKyB0aHVtYlJ1bGVSZXBvcnQucmF0ZSkudG9GaXhlZCgyKSk7XHJcbiAgICAgICAgdGh1bWJSdWxlLnRvdGFsQnVkZ2V0ZWRDb3N0ID0gcGFyc2VGbG9hdCgodGh1bWJSdWxlLnRvdGFsQnVkZ2V0ZWRDb3N0ICsgdGh1bWJSdWxlUmVwb3J0LmFtb3VudCkudG9GaXhlZCgyKSk7XHJcbiAgICAgICAgdGh1bWJSdWxlLnRodW1iUnVsZVJlcG9ydHMucHVzaCh0aHVtYlJ1bGVSZXBvcnQpO1xyXG5cclxuICAgICAgICBwcm9qZWN0UmVwb3J0LnRodW1iUnVsZSA9IHRodW1iUnVsZTtcclxuICAgICAgICBwcm9qZWN0UmVwb3J0LmVzdGltYXRlID0gZXN0aW1hdGU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJlcG9ydC5wdXNoKHByb2plY3RSZXBvcnQpO1xyXG4gIH1cclxuXHJcbiAgZ2V0Q29zdEhlYWRzKCAgdXJsOiBzdHJpbmcgLCB1c2VyOiBVc2VyLGNhbGxiYWNrOiAoZXJyb3I6IGFueSwgcmVzdWx0OiBhbnkpID0+IHZvaWQpIHtcclxuICAgIGxvZ2dlci5pbmZvKCdSZXBvcnQgU2VydmljZSwgZ2V0Q29zdEhlYWRzIGhhcyBiZWVuIGhpdCcpO1xyXG4gICAgdGhpcy5yYXRlQW5hbHlzaXNTZXJ2aWNlLmdldENvc3RIZWFkcyggdXJsLCB1c2VyLChlcnJvciwgcmVzdWx0KSA9PiB7XHJcbiAgICAgIGlmKGVycm9yKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ2Vycm9yIDogJytKU09OLnN0cmluZ2lmeShlcnJvcikpO1xyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjYWxsYmFjayhudWxsLHsgZGF0YTogcmVzdWx0LCBhY2Nlc3NfdG9rZW46IHRoaXMuYXV0aEludGVyY2VwdG9yLmlzc3VlVG9rZW5XaXRoVWlkKHVzZXIpfSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgZ2V0V29ya0l0ZW1zKCB1cmw6IHN0cmluZyAsIHVzZXI6IFVzZXIsIGNhbGxiYWNrOiAoZXJyb3I6IGFueSwgcmVzdWx0OiBhbnkpID0+IHZvaWQpIHtcclxuICAgIGxvZ2dlci5pbmZvKCdSZXBvcnQgU2VydmljZSwgZ2V0V29ya0l0ZW1zIGhhcyBiZWVuIGhpdCcpO1xyXG4gICAgdGhpcy5yYXRlQW5hbHlzaXNTZXJ2aWNlLmdldFdvcmtJdGVtcyggdXJsLCB1c2VyLChlcnJvciwgcmVzdWx0KSA9PiB7XHJcbiAgICAgIGlmKGVycm9yKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ2Vycm9yIDogJytKU09OLnN0cmluZ2lmeShlcnJvcikpO1xyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjYWxsYmFjayhudWxsLHsgZGF0YTogcmVzdWx0LCBhY2Nlc3NfdG9rZW46IHRoaXMuYXV0aEludGVyY2VwdG9yLmlzc3VlVG9rZW5XaXRoVWlkKHVzZXIpfSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbn1cclxuXHJcbk9iamVjdC5zZWFsKFJlcG9ydFNlcnZpY2UpO1xyXG5leHBvcnQgPSBSZXBvcnRTZXJ2aWNlO1xyXG5cclxuIl19
