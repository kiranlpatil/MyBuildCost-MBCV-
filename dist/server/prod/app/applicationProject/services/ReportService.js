"use strict";
var ProjectRepository = require("../dataaccess/repository/ProjectRepository");
var BuildingRepository = require("../dataaccess/repository/BuildingRepository");
var UserService = require("./../../framework/services/UserService");
var ProjectAsset = require("../../framework/shared/projectasset");
var BuildingReport = require("../dataaccess/model/project/reports/BuildingReport");
var ThumbRuleReport = require("../dataaccess/model/project/reports/ThumbRuleReport");
var AuthInterceptor = require("../../framework/interceptor/auth.interceptor");
var EstimateReport = require("../dataaccess/model/project/reports/EstimateReport");
var ProjectReport = require("../dataaccess/model/project/reports/ProjectReport");
var ThumbRule = require("../dataaccess/model/project/building/ThumbRule");
var Estimate = require("../dataaccess/model/project/building/Estimate");
var RateAnalysisService = require("./RateAnalysisService");
var alasql = require("alasql");
var Constants = require("../shared/constants");
var ProjectService = require("./ProjectService");
var config = require('config');
var log4js = require('log4js');
var logger = log4js.getLogger('Report Service');
var ReportService = (function () {
    function ReportService() {
        this.projectRepository = new ProjectRepository();
        this.buildingRepository = new BuildingRepository();
        this.APP_NAME = ProjectAsset.APP_NAME;
        this.authInterceptor = new AuthInterceptor();
        this.userService = new UserService();
        this.rateAnalysisService = new RateAnalysisService();
    }
    ReportService.prototype.getReport = function (projectId, reportType, rateUnit, areaType, user, callback) {
        var _this = this;
        logger.info('Report Service, getReport has been hit');
        var query = { _id: projectId };
        var populate = { path: 'buildings' };
        this.projectRepository.findAndPopulate(query, populate, function (error, result) {
            logger.info('Report Service, findAndPopulate has been hit');
            if (error) {
                callback(error, null);
            }
            else {
                var buildings = result[0].buildings;
                var typeOfArea;
                var choice = areaType;
                switch (choice) {
                    case Constants.SLAB_AREA:
                        {
                            typeOfArea = Constants.TOTAL_SLAB_AREA;
                            break;
                        }
                    case Constants.SALEABLE_AREA:
                        {
                            typeOfArea = Constants.TOTAL_SALEABLE_AREA;
                            break;
                        }
                    case Constants.CARPET_AREA:
                        {
                            typeOfArea = Constants.TOTAL_CARPET_AREA;
                            break;
                        }
                    default: callback(error, null);
                }
                var totalArea = alasql('VALUE OF SELECT ROUND(SUM(' + typeOfArea + '),2) FROM ?', [buildings]);
                var projectReport = new ProjectReport();
                projectReport.buildings = _this.generateReportByCostHeads(buildings, typeOfArea, rateUnit);
                var projectCostHeads = result[0].projectCostHeads;
                var projectRates = result[0].rates;
                if (projectCostHeads !== null) {
                    projectReport.commonAmenities = _this.generateReportForProjectCostHeads(projectCostHeads, projectRates, totalArea, rateUnit);
                }
                else {
                    callback(null, error);
                }
                callback(null, { data: projectReport, access_token: _this.authInterceptor.issueTokenWithUid(user) });
            }
        });
    };
    ReportService.prototype.generateReportByCostHeads = function (buildings, typeOfArea, rateUnit) {
        var buildingsReport = new Array();
        for (var _i = 0, buildings_1 = buildings; _i < buildings_1.length; _i++) {
            var building = buildings_1[_i];
            var buildingReport = new BuildingReport;
            buildingReport.name = building.name;
            buildingReport._id = building._id;
            buildingReport.area = building[typeOfArea];
            var thumbRule = new ThumbRule();
            var estimate = new Estimate();
            var thumbRuleReports = new Array();
            var estimatedReports = new Array();
            this.getThumbRuleAndEstimatedReport(building, buildingReport, thumbRuleReports, estimatedReports, rateUnit);
            var totalRates = alasql('SELECT ROUND(SUM(amount),2) AS totalAmount, ROUND(SUM(rate),2) AS totalRate FROM ?', [thumbRuleReports]);
            thumbRule.totalRate = totalRates[0].totalRate;
            if (rateUnit === Constants.SQUREMETER_UNIT) {
                thumbRule.totalRate = parseFloat((thumbRule.totalRate * config.get(Constants.SQUARE_METER)).toFixed(2));
            }
            thumbRule.totalBudgetedCost = Math.round(totalRates[0].totalAmount);
            thumbRule.thumbRuleReports = thumbRuleReports;
            var totalEstimatedRates = alasql('SELECT ROUND(SUM(total),2) AS totalAmount, ROUND(SUM(rate),2) AS totalRate FROM ?', [estimatedReports]);
            estimate.totalRate = totalEstimatedRates[0].totalRate;
            if (rateUnit === Constants.SQUREMETER_UNIT) {
                estimate.totalRate = parseFloat((estimate.totalRate * config.get(Constants.SQUARE_METER)).toFixed(2));
            }
            estimate.totalEstimatedCost = Math.round(totalEstimatedRates[0].totalAmount);
            estimate.estimatedCosts = estimatedReports;
            buildingReport.thumbRule = thumbRule;
            buildingReport.estimate = estimate;
            buildingsReport.push(buildingReport);
        }
        return (buildingsReport);
    };
    ReportService.prototype.getThumbRuleAndEstimatedReport = function (building, buildingReport, thumbRuleReports, estimatedReports, rateUnit) {
        for (var _i = 0, _a = building.costHeads; _i < _a.length; _i++) {
            var costHead = _a[_i];
            if (costHead.active) {
                var thumbRuleReport = new ThumbRuleReport();
                thumbRuleReport.name = costHead.name;
                thumbRuleReport.rateAnalysisId = costHead.rateAnalysisId;
                thumbRuleReport.amount = parseFloat((costHead.budgetedCostAmount).toFixed(Constants.NUMBER_OF_FRACTION_DIGIT));
                thumbRuleReport.costHeadActive = costHead.active;
                thumbRuleReport.rate = parseFloat((thumbRuleReport.amount / buildingReport.area).toFixed(2));
                if (rateUnit === Constants.SQUREMETER_UNIT) {
                    thumbRuleReport.rate = parseFloat((thumbRuleReport.rate * config.get(Constants.SQUARE_METER)).toFixed(2));
                }
                thumbRuleReports.push(thumbRuleReport);
                var estimateReport = new EstimateReport();
                estimateReport = this.getEstimatedReport(building.rates, costHead, buildingReport.area, rateUnit);
                estimatedReports.push(estimateReport);
            }
        }
    };
    ReportService.prototype.getEstimatedReport = function (centralizedRates, costHead, area, rateUnit) {
        var estimateReport = new EstimateReport();
        estimateReport.name = costHead.name;
        estimateReport.rateAnalysisId = costHead.rateAnalysisId;
        var costHeadCategories = costHead.categories;
        var projectService = new ProjectService();
        var categoriesObj = projectService.getCategoriesListWithCentralizedRates(costHeadCategories, centralizedRates);
        estimateReport.total = categoriesObj.categoriesAmount;
        estimateReport.rate = parseFloat((estimateReport.total / area).toFixed(2));
        if (rateUnit === Constants.SQUREMETER_UNIT) {
            estimateReport.rate = parseFloat((estimateReport.rate * config.get(Constants.SQUARE_METER)).toFixed(2));
        }
        return estimateReport;
    };
    ReportService.prototype.generateReportForProjectCostHeads = function (projectCostHeads, projectRates, totalArea, rateUnit) {
        var commonAmenitiesReport = new Array();
        var projectReport = new BuildingReport;
        projectReport.name = Constants.AMENITIES;
        projectReport.area = totalArea;
        var thumbRule = new ThumbRule();
        var estimate = new Estimate();
        var thumbRuleReports = new Array();
        var estimatedReports = new Array();
        this.getThumbRuleAndEstimatedReportForProjectCostHead(projectCostHeads, projectRates, projectReport, thumbRuleReports, estimatedReports, totalArea, rateUnit);
        var totalRates = alasql('SELECT ROUND(SUM(amount),2) AS totalAmount, ROUND(SUM(rate),2) AS totalRate FROM ?', [thumbRuleReports]);
        thumbRule.totalRate = totalRates[0].totalRate;
        if (rateUnit === Constants.SQUREMETER_UNIT) {
            thumbRule.totalRate = parseFloat((thumbRule.totalRate * config.get(Constants.SQUARE_METER)).toFixed(2));
        }
        thumbRule.totalBudgetedCost = Math.round(totalRates[0].totalAmount);
        thumbRule.thumbRuleReports = thumbRuleReports;
        var totalEstimatedRates = alasql('SELECT ROUND(SUM(total),2) AS totalAmount, ROUND(SUM(rate),2) AS totalRate FROM ?', [estimatedReports]);
        estimate.totalRate = totalEstimatedRates[0].totalRate;
        if (rateUnit === Constants.SQUREMETER_UNIT) {
            estimate.totalRate = parseFloat((estimate.totalRate * config.get(Constants.SQUARE_METER)).toFixed(2));
        }
        estimate.totalEstimatedCost = Math.round(totalEstimatedRates[0].totalAmount);
        estimate.estimatedCosts = estimatedReports;
        projectReport.thumbRule = thumbRule;
        projectReport.estimate = estimate;
        commonAmenitiesReport.push(projectReport);
        return (commonAmenitiesReport);
    };
    ReportService.prototype.getThumbRuleAndEstimatedReportForProjectCostHead = function (projectCostHead, projectRates, projectReport, thumbRuleReports, estimatedReports, totalArea, rateUnit) {
        for (var _i = 0, projectCostHead_1 = projectCostHead; _i < projectCostHead_1.length; _i++) {
            var costHead = projectCostHead_1[_i];
            if (costHead.active) {
                var thumbRuleReport = new ThumbRuleReport();
                thumbRuleReport.name = costHead.name;
                thumbRuleReport.rateAnalysisId = costHead.rateAnalysisId;
                thumbRuleReport.amount = costHead.budgetedCostAmount;
                thumbRuleReport.costHeadActive = costHead.active;
                thumbRuleReport.rate = parseFloat((costHead.budgetedCostAmount / totalArea).toFixed(2));
                if (rateUnit === Constants.SQUREMETER_UNIT) {
                    thumbRuleReport.rate = parseFloat((thumbRuleReport.rate * config.get(Constants.SQUARE_METER)).toFixed(2));
                }
                thumbRuleReports.push(thumbRuleReport);
                var estimateReport = new EstimateReport();
                estimateReport = this.getEstimatedReport(projectRates, costHead, totalArea, rateUnit);
                estimatedReports.push(estimateReport);
            }
        }
    };
    ReportService.prototype.getCostHeads = function (url, user, callback) {
        var _this = this;
        logger.info('Report Service, getCostHeads has been hit');
        this.rateAnalysisService.getCostHeads(url, user, function (error, result) {
            if (error) {
                console.log('error : ' + JSON.stringify(error));
                callback(error, null);
            }
            else {
                callback(null, { data: result, access_token: _this.authInterceptor.issueTokenWithUid(user) });
            }
        });
    };
    ReportService.prototype.getWorkItems = function (url, user, callback) {
        var _this = this;
        logger.info('Report Service, getWorkItems has been hit');
        this.rateAnalysisService.getWorkItems(url, user, function (error, result) {
            if (error) {
                console.log('error : ' + JSON.stringify(error));
                callback(error, null);
            }
            else {
                callback(null, { data: result, access_token: _this.authInterceptor.issueTokenWithUid(user) });
            }
        });
    };
    return ReportService;
}());
Object.seal(ReportService);
module.exports = ReportService;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9hcHBsaWNhdGlvblByb2plY3Qvc2VydmljZXMvUmVwb3J0U2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsOEVBQWlGO0FBQ2pGLGdGQUFtRjtBQUNuRixvRUFBdUU7QUFDdkUsa0VBQXFFO0FBR3JFLG1GQUFzRjtBQUN0RixxRkFBd0Y7QUFDeEYsOEVBQWlGO0FBRWpGLG1GQUFzRjtBQUN0RixpRkFBb0Y7QUFDcEYsMEVBQTZFO0FBQzdFLHdFQUEyRTtBQUMzRSwyREFBOEQ7QUFFOUQsK0JBQWtDO0FBQ2xDLCtDQUFrRDtBQUNsRCxpREFBb0Q7QUFFcEQsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQy9CLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMvQixJQUFJLE1BQU0sR0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFFOUM7SUFVRTtRQUNFLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLGlCQUFpQixFQUFFLENBQUM7UUFDakQsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksa0JBQWtCLEVBQUUsQ0FBQztRQUNuRCxJQUFJLENBQUMsUUFBUSxHQUFHLFlBQVksQ0FBQyxRQUFRLENBQUM7UUFDdEMsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLGVBQWUsRUFBRSxDQUFDO1FBQzdDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUNyQyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxtQkFBbUIsRUFBRSxDQUFDO0lBQ3ZELENBQUM7SUFFRCxpQ0FBUyxHQUFULFVBQVcsU0FBZSxFQUFFLFVBQW1CLEVBQUUsUUFBaUIsRUFBRSxRQUFpQixFQUFHLElBQVUsRUFDdkYsUUFBMkM7UUFEdEQsaUJBa0RDO1FBL0NDLE1BQU0sQ0FBQyxJQUFJLENBQUMsd0NBQXdDLENBQUMsQ0FBQztRQUN0RCxJQUFJ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UmVwb3J0U2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQcm9qZWN0UmVwb3NpdG9yeSA9IHJlcXVpcmUoJy4uL2RhdGFhY2Nlc3MvcmVwb3NpdG9yeS9Qcm9qZWN0UmVwb3NpdG9yeScpO1xyXG5pbXBvcnQgQnVpbGRpbmdSZXBvc2l0b3J5ID0gcmVxdWlyZSgnLi4vZGF0YWFjY2Vzcy9yZXBvc2l0b3J5L0J1aWxkaW5nUmVwb3NpdG9yeScpO1xyXG5pbXBvcnQgVXNlclNlcnZpY2UgPSByZXF1aXJlKCcuLy4uLy4uL2ZyYW1ld29yay9zZXJ2aWNlcy9Vc2VyU2VydmljZScpO1xyXG5pbXBvcnQgUHJvamVjdEFzc2V0ID0gcmVxdWlyZSgnLi4vLi4vZnJhbWV3b3JrL3NoYXJlZC9wcm9qZWN0YXNzZXQnKTtcclxuaW1wb3J0IFVzZXIgPSByZXF1aXJlKCcuLi8uLi9mcmFtZXdvcmsvZGF0YWFjY2Vzcy9tb25nb29zZS91c2VyJyk7XHJcbmltcG9ydCBCdWlsZGluZyA9IHJlcXVpcmUoJy4uL2RhdGFhY2Nlc3MvbW9uZ29vc2UvQnVpbGRpbmcnKTtcclxuaW1wb3J0IEJ1aWxkaW5nUmVwb3J0ID0gcmVxdWlyZSgnLi4vZGF0YWFjY2Vzcy9tb2RlbC9wcm9qZWN0L3JlcG9ydHMvQnVpbGRpbmdSZXBvcnQnKTtcclxuaW1wb3J0IFRodW1iUnVsZVJlcG9ydCA9IHJlcXVpcmUoJy4uL2RhdGFhY2Nlc3MvbW9kZWwvcHJvamVjdC9yZXBvcnRzL1RodW1iUnVsZVJlcG9ydCcpO1xyXG5pbXBvcnQgQXV0aEludGVyY2VwdG9yID0gcmVxdWlyZSgnLi4vLi4vZnJhbWV3b3JrL2ludGVyY2VwdG9yL2F1dGguaW50ZXJjZXB0b3InKTtcclxuaW1wb3J0IENvc3RIZWFkID0gcmVxdWlyZSgnLi4vZGF0YWFjY2Vzcy9tb25nb29zZS9Db3N0SGVhZCcpO1xyXG5pbXBvcnQgRXN0aW1hdGVSZXBvcnQgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL21vZGVsL3Byb2plY3QvcmVwb3J0cy9Fc3RpbWF0ZVJlcG9ydCcpO1xyXG5pbXBvcnQgUHJvamVjdFJlcG9ydCA9IHJlcXVpcmUoJy4uL2RhdGFhY2Nlc3MvbW9kZWwvcHJvamVjdC9yZXBvcnRzL1Byb2plY3RSZXBvcnQnKTtcclxuaW1wb3J0IFRodW1iUnVsZSA9IHJlcXVpcmUoJy4uL2RhdGFhY2Nlc3MvbW9kZWwvcHJvamVjdC9idWlsZGluZy9UaHVtYlJ1bGUnKTtcclxuaW1wb3J0IEVzdGltYXRlID0gcmVxdWlyZSgnLi4vZGF0YWFjY2Vzcy9tb2RlbC9wcm9qZWN0L2J1aWxkaW5nL0VzdGltYXRlJyk7XHJcbmltcG9ydCBSYXRlQW5hbHlzaXNTZXJ2aWNlID0gcmVxdWlyZSgnLi9SYXRlQW5hbHlzaXNTZXJ2aWNlJyk7XHJcbmltcG9ydCBDYXRlZ29yeSA9IHJlcXVpcmUoJy4uL2RhdGFhY2Nlc3MvbW9kZWwvcHJvamVjdC9idWlsZGluZy9DYXRlZ29yeScpO1xyXG5pbXBvcnQgYWxhc3FsID0gcmVxdWlyZSgnYWxhc3FsJyk7XHJcbmltcG9ydCBDb25zdGFudHMgPSByZXF1aXJlKCcuLi9zaGFyZWQvY29uc3RhbnRzJyk7XHJcbmltcG9ydCBQcm9qZWN0U2VydmljZSA9IHJlcXVpcmUoJy4vUHJvamVjdFNlcnZpY2UnKTtcclxuaW1wb3J0IENlbnRyYWxpemVkUmF0ZSA9IHJlcXVpcmUoJy4uL2RhdGFhY2Nlc3MvbW9kZWwvcHJvamVjdC9DZW50cmFsaXplZFJhdGUnKTtcclxubGV0IGNvbmZpZyA9IHJlcXVpcmUoJ2NvbmZpZycpO1xyXG52YXIgbG9nNGpzID0gcmVxdWlyZSgnbG9nNGpzJyk7XHJcbnZhciBsb2dnZXI9bG9nNGpzLmdldExvZ2dlcignUmVwb3J0IFNlcnZpY2UnKTtcclxuXHJcbmNsYXNzIFJlcG9ydFNlcnZpY2Uge1xyXG4gIEFQUF9OQU1FOiBzdHJpbmc7XHJcbiAgY29tcGFueV9uYW1lOiBzdHJpbmc7XHJcbiAgcHJpdmF0ZSBwcm9qZWN0UmVwb3NpdG9yeTogUHJvamVjdFJlcG9zaXRvcnk7XHJcbiAgcHJpdmF0ZSBidWlsZGluZ1JlcG9zaXRvcnk6IEJ1aWxkaW5nUmVwb3NpdG9yeTtcclxuICBwcml2YXRlIGF1dGhJbnRlcmNlcHRvcjogQXV0aEludGVyY2VwdG9yO1xyXG4gIHByaXZhdGUgdXNlclNlcnZpY2UgOiBVc2VyU2VydmljZTtcclxuICBwcml2YXRlIHJhdGVBbmFseXNpc1NlcnZpY2UgOiBSYXRlQW5hbHlzaXNTZXJ2aWNlO1xyXG4gIHByaXZhdGUgcHJvamVjdFNlcnZpY2UgOiBQcm9qZWN0U2VydmljZTtcclxuXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICB0aGlzLnByb2plY3RSZXBvc2l0b3J5ID0gbmV3IFByb2plY3RSZXBvc2l0b3J5KCk7XHJcbiAgICB0aGlzLmJ1aWxkaW5nUmVwb3NpdG9yeSA9IG5ldyBCdWlsZGluZ1JlcG9zaXRvcnkoKTtcclxuICAgIHRoaXMuQVBQX05BTUUgPSBQcm9qZWN0QXNzZXQuQVBQX05BTUU7XHJcbiAgICB0aGlzLmF1dGhJbnRlcmNlcHRvciA9IG5ldyBBdXRoSW50ZXJjZXB0b3IoKTtcclxuICAgIHRoaXMudXNlclNlcnZpY2UgPSBuZXcgVXNlclNlcnZpY2UoKTtcclxuICAgIHRoaXMucmF0ZUFuYWx5c2lzU2VydmljZSA9IG5ldyBSYXRlQW5hbHlzaXNTZXJ2aWNlKCk7XHJcbiAgfVxyXG5cclxuICBnZXRSZXBvcnQoIHByb2plY3RJZCA6IGFueSwgcmVwb3J0VHlwZSA6IHN0cmluZywgcmF0ZVVuaXQgOiBzdHJpbmcsIGFyZWFUeXBlIDogc3RyaW5nLOKAguKAgnVzZXI6IFVzZXIsXHJcbiAgICAgICAgICAgICBjYWxsYmFjazogKGVycm9yOiBhbnksIHJlc3VsdDogYW55KSA9PiB2b2lkKSB7XHJcblxyXG4gICAgbG9nZ2VyLmluZm8oJ1JlcG9ydCBTZXJ2aWNlLCBnZXRSZXBvcnQgaGFzIGJlZW4gaGl0Jyk7XHJcbiAgICBsZXQgcXVlcnkgPSB7IF9pZDogcHJvamVjdElkfTtcclxuICAgIGxldCBwb3B1bGF0ZSA9IHtwYXRoIDogJ2J1aWxkaW5ncyd9O1xyXG4gICAgdGhpcy5wcm9qZWN0UmVwb3NpdG9yeS5maW5kQW5kUG9wdWxhdGUocXVlcnksIHBvcHVsYXRlLCAoZXJyb3IsIHJlc3VsdCkgPT4ge1xyXG4gICAgICBsb2dnZXIuaW5mbygnUmVwb3J0IFNlcnZpY2UsIGZpbmRBbmRQb3B1bGF0ZSBoYXMgYmVlbiBoaXQnKTtcclxuICAgICAgaWYoZXJyb3IpIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgbGV0IGJ1aWxkaW5ncyA9IHJlc3VsdFswXS5idWlsZGluZ3M7XHJcbiAgICAgICAgdmFyIHR5cGVPZkFyZWE6IHN0cmluZztcclxuICAgICAgICBsZXQgY2hvaWNlID0gYXJlYVR5cGU7XHJcbiAgICAgICAgc3dpdGNoIChjaG9pY2UpIHtcclxuICAgICAgICAgIGNhc2UgQ29uc3RhbnRzLlNMQUJfQVJFQTpcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgdHlwZU9mQXJlYSA9IENvbnN0YW50cy5UT1RBTF9TTEFCX0FSRUE7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIGNhc2UgQ29uc3RhbnRzLlNBTEVBQkxFX0FSRUE6XHJcbiAgICAgICAgICB7XHJcbiAgICAgICAgICAgIHR5cGVPZkFyZWEgPSBDb25zdGFudHMuVE9UQUxfU0FMRUFCTEVfQVJFQTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgY2FzZSAgQ29uc3RhbnRzLkNBUlBFVF9BUkVBIDpcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgdHlwZU9mQXJlYSA9IENvbnN0YW50cy5UT1RBTF9DQVJQRVRfQVJFQTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBkZWZhdWx0IDogIGNhbGxiYWNrKGVycm9yLG51bGwpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHRvdGFsQXJlYSA9IGFsYXNxbCgnVkFMVUUgT0YgU0VMRUNUIFJPVU5EKFNVTSgnK3R5cGVPZkFyZWErJyksMikgRlJPTSA/JyxbYnVpbGRpbmdzXSk7XHJcbiAgICAgICAgbGV0IHByb2plY3RSZXBvcnQgOiBQcm9qZWN0UmVwb3J0ID0gbmV3IFByb2plY3RSZXBvcnQoKTtcclxuXHJcbiAgICAgICAgcHJvamVjdFJlcG9ydC5idWlsZGluZ3MgPSB0aGlzLmdlbmVyYXRlUmVwb3J0QnlDb3N0SGVhZHMoYnVpbGRpbmdzLCB0eXBlT2ZBcmVhLCByYXRlVW5pdCk7XHJcblxyXG4gICAgICAgIGxldCBwcm9qZWN0Q29zdEhlYWRzID0gcmVzdWx0WzBdLnByb2plY3RDb3N0SGVhZHM7XHJcbiAgICAgICAgbGV0IHByb2plY3RSYXRlcyA9IHJlc3VsdFswXS5yYXRlcztcclxuICAgICAgICBpZihwcm9qZWN0Q29zdEhlYWRzIT09IG51bGwpIHtcclxuICAgICAgICAgIHByb2plY3RSZXBvcnQuY29tbW9uQW1lbml0aWVzID0gdGhpcy5nZW5lcmF0ZVJlcG9ydEZvclByb2plY3RDb3N0SGVhZHMocHJvamVjdENvc3RIZWFkcywgcHJvamVjdFJhdGVzLCB0b3RhbEFyZWEsIHJhdGVVbml0KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgY2FsbGJhY2sobnVsbCxlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhbGxiYWNrKG51bGwseyBkYXRhOiBwcm9qZWN0UmVwb3J0LCBhY2Nlc3NfdG9rZW46IHRoaXMuYXV0aEludGVyY2VwdG9yLmlzc3VlVG9rZW5XaXRoVWlkKHVzZXIpfSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgZ2VuZXJhdGVSZXBvcnRCeUNvc3RIZWFkcyggYnVpbGRpbmdzOiAgQXJyYXk8QnVpbGRpbmc+ICwgdHlwZU9mQXJlYTogc3RyaW5nLCByYXRlVW5pdDogc3RyaW5nKSB7XHJcblxyXG4gICAgbGV0IGJ1aWxkaW5nc1JlcG9ydCA6IEFycmF5PEJ1aWxkaW5nUmVwb3J0PiA9IG5ldyBBcnJheTxCdWlsZGluZ1JlcG9ydD4oKTtcclxuICAgIGZvciAobGV0IGJ1aWxkaW5nIG9mIGJ1aWxkaW5ncykge1xyXG4gICAgICBsZXQgYnVpbGRpbmdSZXBvcnQgPSBuZXcgQnVpbGRpbmdSZXBvcnQ7XHJcbiAgICAgIGJ1aWxkaW5nUmVwb3J0Lm5hbWUgPSBidWlsZGluZy5uYW1lO1xyXG4gICAgICBidWlsZGluZ1JlcG9ydC5faWQgPSBidWlsZGluZy5faWQ7XHJcbiAgICAgIGJ1aWxkaW5nUmVwb3J0LmFyZWEgPSBidWlsZGluZ1t0eXBlT2ZBcmVhXTtcclxuXHJcbiAgICAgIGxldCB0aHVtYlJ1bGUgID0gbmV3IFRodW1iUnVsZSgpO1xyXG4gICAgICBsZXQgZXN0aW1hdGUgID0gbmV3IEVzdGltYXRlKCk7XHJcbiAgICAgIGxldCB0aHVtYlJ1bGVSZXBvcnRzID0gbmV3IEFycmF5PFRodW1iUnVsZVJlcG9ydD4oKTtcclxuICAgICAgbGV0IGVzdGltYXRlZFJlcG9ydHMgPSBuZXcgQXJyYXk8RXN0aW1hdGVSZXBvcnQ+KCk7XHJcblxyXG5cclxuICAgICAgdGhpcy5nZXRUaHVtYlJ1bGVBbmRFc3RpbWF0ZWRSZXBvcnQoYnVpbGRpbmcsIGJ1aWxkaW5nUmVwb3J0LCB0aHVtYlJ1bGVSZXBvcnRzLCBlc3RpbWF0ZWRSZXBvcnRzLCByYXRlVW5pdCk7XHJcblxyXG4gICAgICBsZXQgdG90YWxSYXRlcyA9IGFsYXNxbCgnU0VMRUNUIFJPVU5EKFNVTShhbW91bnQpLDIpIEFTIHRvdGFsQW1vdW50LCBST1VORChTVU0ocmF0ZSksMikgQVMgdG90YWxSYXRlIEZST00gPycsW3RodW1iUnVsZVJlcG9ydHNdKTtcclxuICAgICAgdGh1bWJSdWxlLnRvdGFsUmF0ZSA9IHRvdGFsUmF0ZXNbMF0udG90YWxSYXRlO1xyXG4gICAgICBpZihyYXRlVW5pdCA9PT0gQ29uc3RhbnRzLlNRVVJFTUVURVJfVU5JVCkge1xyXG4gICAgICAgIHRodW1iUnVsZS50b3RhbFJhdGUgPSAgcGFyc2VGbG9hdCgodGh1bWJSdWxlLnRvdGFsUmF0ZSAqIGNvbmZpZy5nZXQoQ29uc3RhbnRzLlNRVUFSRV9NRVRFUikpLnRvRml4ZWQoMikpO1xyXG4gICAgICB9XHJcbiAgICAgIHRodW1iUnVsZS50b3RhbEJ1ZGdldGVkQ29zdCA9IE1hdGgucm91bmQodG90YWxSYXRlc1swXS50b3RhbEFtb3VudCk7XHJcbiAgICAgIHRodW1iUnVsZS50aHVtYlJ1bGVSZXBvcnRzID0gdGh1bWJSdWxlUmVwb3J0cztcclxuXHJcbiAgICAgIGxldCB0b3RhbEVzdGltYXRlZFJhdGVzID0gYWxhc3FsKCdTRUxFQ1QgUk9VTkQoU1VNKHRvdGFsKSwyKSBBUyB0b3RhbEFtb3VudCwgUk9VTkQoU1VNKHJhdGUpLDIpIEFTIHRvdGFsUmF0ZSBGUk9NID8nLFtlc3RpbWF0ZWRSZXBvcnRzXSk7XHJcbiAgICAgIGVzdGltYXRlLnRvdGFsUmF0ZSA9IHRvdGFsRXN0aW1hdGVkUmF0ZXNbMF0udG90YWxSYXRlO1xyXG4gICAgICBpZihyYXRlVW5pdCA9PT0gQ29uc3RhbnRzLlNRVVJFTUVURVJfVU5JVCkge1xyXG4gICAgICAgIGVzdGltYXRlLnRvdGFsUmF0ZSA9ICBwYXJzZUZsb2F0KChlc3RpbWF0ZS50b3RhbFJhdGUgKiBjb25maWcuZ2V0KENvbnN0YW50cy5TUVVBUkVfTUVURVIpKS50b0ZpeGVkKDIpKTtcclxuICAgICAgfVxyXG4gICAgICBlc3RpbWF0ZS50b3RhbEVzdGltYXRlZENvc3QgPSBNYXRoLnJvdW5kKHRvdGFsRXN0aW1hdGVkUmF0ZXNbMF0udG90YWxBbW91bnQpO1xyXG4gICAgICBlc3RpbWF0ZS5lc3RpbWF0ZWRDb3N0cyA9IGVzdGltYXRlZFJlcG9ydHM7XHJcblxyXG4gICAgICBidWlsZGluZ1JlcG9ydC50aHVtYlJ1bGUgPSB0aHVtYlJ1bGU7XHJcbiAgICAgIGJ1aWxkaW5nUmVwb3J0LmVzdGltYXRlID0gZXN0aW1hdGU7XHJcbiAgICAgIGJ1aWxkaW5nc1JlcG9ydC5wdXNoKGJ1aWxkaW5nUmVwb3J0KTtcclxuICAgIH1cclxuICAgIHJldHVybihidWlsZGluZ3NSZXBvcnQpO1xyXG4gIH1cclxuXHJcblxyXG4gIGdldFRodW1iUnVsZUFuZEVzdGltYXRlZFJlcG9ydChidWlsZGluZyA6QnVpbGRpbmcsIGJ1aWxkaW5nUmVwb3J0OiBCdWlsZGluZ1JlcG9ydCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGh1bWJSdWxlUmVwb3J0czogVGh1bWJSdWxlUmVwb3J0W10sIGVzdGltYXRlZFJlcG9ydHM6IEVzdGltYXRlUmVwb3J0W10sIHJhdGVVbml0OnN0cmluZykge1xyXG5cclxuICAgIGZvciAobGV0IGNvc3RIZWFkIG9mIGJ1aWxkaW5nLmNvc3RIZWFkcykge1xyXG5cclxuICAgICAgaWYoY29zdEhlYWQuYWN0aXZlKSB7XHJcbiAgICAgICAgLy9UaHVtYlJ1bGUgUmVwb3J0XHJcbiAgICAgICAgbGV0IHRodW1iUnVsZVJlcG9ydCA9IG5ldyBUaHVtYlJ1bGVSZXBvcnQoKTtcclxuICAgICAgICB0aHVtYlJ1bGVSZXBvcnQubmFtZSA9IGNvc3RIZWFkLm5hbWU7XHJcbiAgICAgICAgdGh1bWJSdWxlUmVwb3J0LnJhdGVBbmFseXNpc0lkID0gY29zdEhlYWQucmF0ZUFuYWx5c2lzSWQ7XHJcbiAgICAgICAgdGh1bWJSdWxlUmVwb3J0LmFtb3VudCA9IHBhcnNlRmxvYXQoKGNvc3RIZWFkLmJ1ZGdldGVkQ29zdEFtb3VudCkudG9GaXhlZChDb25zdGFudHMuTlVNQkVSX09GX0ZSQUNUSU9OX0RJR0lUKSk7XHJcbiAgICAgICAgdGh1bWJSdWxlUmVwb3J0LmNvc3RIZWFkQWN0aXZlID0gY29zdEhlYWQuYWN0aXZlO1xyXG4gICAgICAgIHRodW1iUnVsZVJlcG9ydC5yYXRlID0gcGFyc2VGbG9hdCgodGh1bWJSdWxlUmVwb3J0LmFtb3VudCAvIGJ1aWxkaW5nUmVwb3J0LmFyZWEpLnRvRml4ZWQoMikpO1xyXG4gICAgICAgIGlmKHJhdGVVbml0ID09PSBDb25zdGFudHMuU1FVUkVNRVRFUl9VTklUKSB7XHJcbiAgICAgICAgICB0aHVtYlJ1bGVSZXBvcnQucmF0ZSA9IHBhcnNlRmxvYXQoKHRodW1iUnVsZVJlcG9ydC5yYXRlICogY29uZmlnLmdldChDb25zdGFudHMuU1FVQVJFX01FVEVSKSkudG9GaXhlZCgyKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRodW1iUnVsZVJlcG9ydHMucHVzaCh0aHVtYlJ1bGVSZXBvcnQpO1xyXG5cclxuICAgICAgICAvL0VzdGltYXRlZCBjb3N0IFJlcG9ydFxyXG4gICAgICAgIGxldCBlc3RpbWF0ZVJlcG9ydCA9IG5ldyBFc3RpbWF0ZVJlcG9ydCgpO1xyXG4gICAgICAgIGVzdGltYXRlUmVwb3J0ID0gdGhpcy5nZXRFc3RpbWF0ZWRSZXBvcnQoYnVpbGRpbmcucmF0ZXMsIGNvc3RIZWFkLCBidWlsZGluZ1JlcG9ydC5hcmVhLCByYXRlVW5pdCk7XHJcbiAgICAgICAgZXN0aW1hdGVkUmVwb3J0cy5wdXNoKGVzdGltYXRlUmVwb3J0KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0RXN0aW1hdGVkUmVwb3J0KGNlbnRyYWxpemVkUmF0ZXM6QXJyYXk8Q2VudHJhbGl6ZWRSYXRlPiwgY29zdEhlYWQ6IGFueSwgYXJlYTpudW1iZXIsIHJhdGVVbml0OnN0cmluZykge1xyXG5cclxuICAgIGxldCBlc3RpbWF0ZVJlcG9ydCA9IG5ldyBFc3RpbWF0ZVJlcG9ydCgpO1xyXG4gICAgZXN0aW1hdGVSZXBvcnQubmFtZSA9IGNvc3RIZWFkLm5hbWU7XHJcbiAgICBlc3RpbWF0ZVJlcG9ydC5yYXRlQW5hbHlzaXNJZCA9IGNvc3RIZWFkLnJhdGVBbmFseXNpc0lkO1xyXG5cclxuICAgIGxldCBjb3N0SGVhZENhdGVnb3JpZXM6IEFycmF5PENhdGVnb3J5PiA9IGNvc3RIZWFkLmNhdGVnb3JpZXM7XHJcbiAgICBsZXQgcHJvamVjdFNlcnZpY2UgOiBQcm9qZWN0U2VydmljZSA9IG5ldyBQcm9qZWN0U2VydmljZSgpO1xyXG4gICAgbGV0IGNhdGVnb3JpZXNPYmogPSBwcm9qZWN0U2VydmljZS5nZXRDYXRlZ29yaWVzTGlzdFdpdGhDZW50cmFsaXplZFJhdGVzKGNvc3RIZWFkQ2F0ZWdvcmllcywgY2VudHJhbGl6ZWRSYXRlcyk7XHJcbiAgICBlc3RpbWF0ZVJlcG9ydC50b3RhbCA9IGNhdGVnb3JpZXNPYmouY2F0ZWdvcmllc0Ftb3VudDtcclxuICAgIGVzdGltYXRlUmVwb3J0LnJhdGUgPSBwYXJzZUZsb2F0KChlc3RpbWF0ZVJlcG9ydC50b3RhbCAvIGFyZWEpLnRvRml4ZWQoMikpO1xyXG4gICAgaWYocmF0ZVVuaXQgPT09IENvbnN0YW50cy5TUVVSRU1FVEVSX1VOSVQpIHtcclxuICAgICAgZXN0aW1hdGVSZXBvcnQucmF0ZSA9IHBhcnNlRmxvYXQoKGVzdGltYXRlUmVwb3J0LnJhdGUgKiBjb25maWcuZ2V0KENvbnN0YW50cy5TUVVBUkVfTUVURVIpKS50b0ZpeGVkKDIpKTtcclxuICAgIH1cclxuICAgIHJldHVybiBlc3RpbWF0ZVJlcG9ydDtcclxuICB9XHJcblxyXG4gIGdlbmVyYXRlUmVwb3J0Rm9yUHJvamVjdENvc3RIZWFkcyhwcm9qZWN0Q29zdEhlYWRzOiAgQXJyYXk8Q29zdEhlYWQ+LCBwcm9qZWN0UmF0ZXM6IEFycmF5PENlbnRyYWxpemVkUmF0ZT4sIHRvdGFsQXJlYTogbnVtYmVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmF0ZVVuaXQ6IHN0cmluZykge1xyXG4gICAgbGV0IGNvbW1vbkFtZW5pdGllc1JlcG9ydCA6IEFycmF5PEJ1aWxkaW5nUmVwb3J0PiA9IG5ldyBBcnJheTxCdWlsZGluZ1JlcG9ydD4oKTtcclxuICAgICAgbGV0IHByb2plY3RSZXBvcnQgPSBuZXcgQnVpbGRpbmdSZXBvcnQ7XHJcbiAgICAgIHByb2plY3RSZXBvcnQubmFtZSA9IENvbnN0YW50cy5BTUVOSVRJRVM7XHJcbiAgICAgIHByb2plY3RSZXBvcnQuYXJlYSA9IHRvdGFsQXJlYTtcclxuXHJcbiAgICAgIGxldCB0aHVtYlJ1bGUgID0gbmV3IFRodW1iUnVsZSgpO1xyXG4gICAgICBsZXQgZXN0aW1hdGUgID0gbmV3IEVzdGltYXRlKCk7XHJcbiAgICAgIGxldCB0aHVtYlJ1bGVSZXBvcnRzID0gbmV3IEFycmF5PFRodW1iUnVsZVJlcG9ydD4oKTtcclxuICAgICAgbGV0IGVzdGltYXRlZFJlcG9ydHMgPSBuZXcgQXJyYXk8RXN0aW1hdGVSZXBvcnQ+KCk7XHJcblxyXG5cclxuICAgICAgdGhpcy5nZXRUaHVtYlJ1bGVBbmRFc3RpbWF0ZWRSZXBvcnRGb3JQcm9qZWN0Q29zdEhlYWQocHJvamVjdENvc3RIZWFkcywgcHJvamVjdFJhdGVzLFxyXG4gICAgICAgIHByb2plY3RSZXBvcnQsIHRodW1iUnVsZVJlcG9ydHMsIGVzdGltYXRlZFJlcG9ydHMsIHRvdGFsQXJlYSwgcmF0ZVVuaXQpO1xyXG5cclxuICAgIGxldCB0b3RhbFJhdGVzID0gYWxhc3FsKCdTRUxFQ1QgUk9VTkQoU1VNKGFtb3VudCksMikgQVMgdG90YWxBbW91bnQsIFJPVU5EKFNVTShyYXRlKSwyKSBBUyB0b3RhbFJhdGUgRlJPTSA/JyxbdGh1bWJSdWxlUmVwb3J0c10pO1xyXG4gICAgICB0aHVtYlJ1bGUudG90YWxSYXRlID0gdG90YWxSYXRlc1swXS50b3RhbFJhdGU7XHJcbiAgICAgIGlmKHJhdGVVbml0ID09PSBDb25zdGFudHMuU1FVUkVNRVRFUl9VTklUKSB7XHJcbiAgICAgICAgdGh1bWJSdWxlLnRvdGFsUmF0ZSA9ICBwYXJzZUZsb2F0KCh0aHVtYlJ1bGUudG90YWxSYXRlICogY29uZmlnLmdldChDb25zdGFudHMuU1FVQVJFX01FVEVSKSkudG9GaXhlZCgyKSk7XHJcbiAgICAgIH1cclxuICAgICAgdGh1bWJSdWxlLnRvdGFsQnVkZ2V0ZWRDb3N0ID0gTWF0aC5yb3VuZCh0b3RhbFJhdGVzWzBdLnRvdGFsQW1vdW50KTtcclxuICAgICAgdGh1bWJSdWxlLnRodW1iUnVsZVJlcG9ydHMgPSB0aHVtYlJ1bGVSZXBvcnRzO1xyXG5cclxuICAgIGxldCB0b3RhbEVzdGltYXRlZFJhdGVzID0gYWxhc3FsKCdTRUxFQ1QgUk9VTkQoU1VNKHRvdGFsKSwyKSBBUyB0b3RhbEFtb3VudCwgUk9VTkQoU1VNKHJhdGUpLDIpIEFTIHRvdGFsUmF0ZSBGUk9NID8nLFtlc3RpbWF0ZWRSZXBvcnRzXSk7XHJcbiAgICAgIGVzdGltYXRlLnRvdGFsUmF0ZSA9IHRvdGFsRXN0aW1hdGVkUmF0ZXNbMF0udG90YWxSYXRlO1xyXG4gICAgICBpZihyYXRlVW5pdCA9PT0gQ29uc3RhbnRzLlNRVVJFTUVURVJfVU5JVCkge1xyXG4gICAgICAgIGVzdGltYXRlLnRvdGFsUmF0ZSA9ICBwYXJzZUZsb2F0KChlc3RpbWF0ZS50b3RhbFJhdGUgKiBjb25maWcuZ2V0KENvbnN0YW50cy5TUVVBUkVfTUVURVIpKS50b0ZpeGVkKDIpKTtcclxuICAgICAgfVxyXG4gICAgICBlc3RpbWF0ZS50b3RhbEVzdGltYXRlZENvc3QgPSAgTWF0aC5yb3VuZCh0b3RhbEVzdGltYXRlZFJhdGVzWzBdLnRvdGFsQW1vdW50KTtcclxuICAgICAgZXN0aW1hdGUuZXN0aW1hdGVkQ29zdHMgPSBlc3RpbWF0ZWRSZXBvcnRzO1xyXG5cclxuICAgICAgcHJvamVjdFJlcG9ydC50aHVtYlJ1bGUgPSB0aHVtYlJ1bGU7XHJcbiAgICAgIHByb2plY3RSZXBvcnQuZXN0aW1hdGUgPSBlc3RpbWF0ZTtcclxuICAgIGNvbW1vbkFtZW5pdGllc1JlcG9ydC5wdXNoKHByb2plY3RSZXBvcnQpO1xyXG4gICAgcmV0dXJuKGNvbW1vbkFtZW5pdGllc1JlcG9ydCk7XHJcbiAgfVxyXG5cclxuICBnZXRUaHVtYlJ1bGVBbmRFc3RpbWF0ZWRSZXBvcnRGb3JQcm9qZWN0Q29zdEhlYWQocHJvamVjdENvc3RIZWFkOiBBcnJheTxDb3N0SGVhZD4sIHByb2plY3RSYXRlczogQXJyYXk8Q2VudHJhbGl6ZWRSYXRlPiwgcHJvamVjdFJlcG9ydDogQnVpbGRpbmdSZXBvcnQsIHRodW1iUnVsZVJlcG9ydHM6IFRodW1iUnVsZVJlcG9ydFtdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlc3RpbWF0ZWRSZXBvcnRzOiBFc3RpbWF0ZVJlcG9ydFtdLCB0b3RhbEFyZWE6bnVtYmVyLCByYXRlVW5pdDpzdHJpbmcpIHtcclxuICBmb3IgKGxldCBjb3N0SGVhZCAgb2YgcHJvamVjdENvc3RIZWFkKSB7XHJcbiAgICBpZiAoY29zdEhlYWQuYWN0aXZlKSB7XHJcbiAgICAgIC8vVGh1bWJSdWxlIFJlcG9ydFxyXG4gICAgICBsZXQgdGh1bWJSdWxlUmVwb3J0ID0gbmV3IFRodW1iUnVsZVJlcG9ydCgpO1xyXG4gICAgICB0aHVtYlJ1bGVSZXBvcnQubmFtZSA9IGNvc3RIZWFkLm5hbWU7XHJcbiAgICAgIHRodW1iUnVsZVJlcG9ydC5yYXRlQW5hbHlzaXNJZCA9IGNvc3RIZWFkLnJhdGVBbmFseXNpc0lkO1xyXG4gICAgICB0aHVtYlJ1bGVSZXBvcnQuYW1vdW50ID0gY29zdEhlYWQuYnVkZ2V0ZWRDb3N0QW1vdW50O1xyXG4gICAgICB0aHVtYlJ1bGVSZXBvcnQuY29zdEhlYWRBY3RpdmUgPSBjb3N0SGVhZC5hY3RpdmU7XHJcbiAgICAgIHRodW1iUnVsZVJlcG9ydC5yYXRlID0gcGFyc2VGbG9hdCgoY29zdEhlYWQuYnVkZ2V0ZWRDb3N0QW1vdW50IC8gdG90YWxBcmVhKS50b0ZpeGVkKDIpKTtcclxuICAgICAgaWYgKHJhdGVVbml0ID09PSBDb25zdGFudHMuU1FVUkVNRVRFUl9VTklUKSB7XHJcbiAgICAgICAgdGh1bWJSdWxlUmVwb3J0LnJhdGUgPSBwYXJzZUZsb2F0KCh0aHVtYlJ1bGVSZXBvcnQucmF0ZSAqIGNvbmZpZy5nZXQoQ29uc3RhbnRzLlNRVUFSRV9NRVRFUikpLnRvRml4ZWQoMikpO1xyXG4gICAgICB9XHJcbiAgICAgIHRodW1iUnVsZVJlcG9ydHMucHVzaCh0aHVtYlJ1bGVSZXBvcnQpO1xyXG5cclxuICAgICAgLy9Fc3RpbWF0ZWQgY29zdCBSZXBvcnRcclxuICAgICAgbGV0IGVzdGltYXRlUmVwb3J0ID0gbmV3IEVzdGltYXRlUmVwb3J0KCk7XHJcbiAgICAgIGVzdGltYXRlUmVwb3J0ID0gdGhpcy5nZXRFc3RpbWF0ZWRSZXBvcnQocHJvamVjdFJhdGVzLCBjb3N0SGVhZCwgdG90YWxBcmVhLCByYXRlVW5pdCk7XHJcbiAgICAgIGVzdGltYXRlZFJlcG9ydHMucHVzaChlc3RpbWF0ZVJlcG9ydCk7XHJcbiAgICB9XHJcbiAgIH1cclxuICB9XHJcblxyXG5cclxuICBnZXRDb3N0SGVhZHMoICB1cmw6IHN0cmluZyAsIHVzZXI6IFVzZXIsY2FsbGJhY2s6IChlcnJvcjogYW55LCByZXN1bHQ6IGFueSkgPT4gdm9pZCkge1xyXG4gICAgbG9nZ2VyLmluZm8oJ1JlcG9ydCBTZXJ2aWNlLCBnZXRDb3N0SGVhZHMgaGFzIGJlZW4gaGl0Jyk7XHJcbiAgICB0aGlzLnJhdGVBbmFseXNpc1NlcnZpY2UuZ2V0Q29zdEhlYWRzKCB1cmwsIHVzZXIsKGVycm9yLCByZXN1bHQpID0+IHtcclxuICAgICAgaWYoZXJyb3IpIHtcclxuICAgICAgICBjb25zb2xlLmxvZygnZXJyb3IgOiAnK0pTT04uc3RyaW5naWZ5KGVycm9yKSk7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNhbGxiYWNrKG51bGwseyBkYXRhOiByZXN1bHQsIGFjY2Vzc190b2tlbjogdGhpcy5hdXRoSW50ZXJjZXB0b3IuaXNzdWVUb2tlbldpdGhVaWQodXNlcil9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBnZXRXb3JrSXRlbXMoIHVybDogc3RyaW5nICwgdXNlcjogVXNlciwgY2FsbGJhY2s6IChlcnJvcjogYW55LCByZXN1bHQ6IGFueSkgPT4gdm9pZCkge1xyXG4gICAgbG9nZ2VyLmluZm8oJ1JlcG9ydCBTZXJ2aWNlLCBnZXRXb3JrSXRlbXMgaGFzIGJlZW4gaGl0Jyk7XHJcbiAgICB0aGlzLnJhdGVBbmFseXNpc1NlcnZpY2UuZ2V0V29ya0l0ZW1zKCB1cmwsIHVzZXIsKGVycm9yLCByZXN1bHQpID0+IHtcclxuICAgICAgaWYoZXJyb3IpIHtcclxuICAgICAgICBjb25zb2xlLmxvZygnZXJyb3IgOiAnK0pTT04uc3RyaW5naWZ5KGVycm9yKSk7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNhbGxiYWNrKG51bGwseyBkYXRhOiByZXN1bHQsIGFjY2Vzc190b2tlbjogdGhpcy5hdXRoSW50ZXJjZXB0b3IuaXNzdWVUb2tlbldpdGhVaWQodXNlcil9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxufVxyXG5cclxuT2JqZWN0LnNlYWwoUmVwb3J0U2VydmljZSk7XHJcbmV4cG9ydCA9IFJlcG9ydFNlcnZpY2U7XHJcblxyXG4iXX0=
