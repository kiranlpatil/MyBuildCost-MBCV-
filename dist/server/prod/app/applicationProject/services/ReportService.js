"use strict";
var ProjectRepository = require("../dataaccess/repository/ProjectRepository");
var BuildingRepository = require("../dataaccess/repository/BuildingRepository");
var UserService = require("./../../framework/services/UserService");
var ProjectAsset = require("../../framework/shared/projectasset");
var BuildingReport = require("../dataaccess/model/project/reports/BuildingReport");
var ThumbRuleReport = require("../dataaccess/model/project/reports/ThumbRuleReport");
var AuthInterceptor = require("../../framework/interceptor/auth.interceptor");
var EstimateReport = require("../dataaccess/model/project/reports/EstimateReport");
var ProjectReport = require("../dataaccess/model/project/reports/ProjectReport");
var ThumbRule = require("../dataaccess/model/project/building/ThumbRule");
var Estimate = require("../dataaccess/model/project/building/Estimate");
var RateAnalysisService = require("./RateAnalysisService");
var alasql = require("alasql");
var Constants = require("../shared/constants");
var ProjectService = require("./ProjectService");
var config = require('config');
var log4js = require('log4js');
var logger = log4js.getLogger('Report Service');
var ReportService = (function () {
    function ReportService() {
        this.projectRepository = new ProjectRepository();
        this.buildingRepository = new BuildingRepository();
        this.APP_NAME = ProjectAsset.APP_NAME;
        this.authInterceptor = new AuthInterceptor();
        this.userService = new UserService();
        this.rateAnalysisService = new RateAnalysisService();
    }
    ReportService.prototype.getReport = function (projectId, reportType, rateUnit, areaType, user, callback) {
        var _this = this;
        logger.info('Report Service, getReport has been hit');
        var query = { _id: projectId };
        var populate = { path: 'buildings' };
        this.projectRepository.findAndPopulate(query, populate, function (error, result) {
            logger.info('Report Service, findAndPopulate has been hit');
            if (error) {
                callback(error, null);
            }
            else {
                var buildings = result[0].buildings;
                var typeOfArea;
                var choice = areaType;
                switch (choice) {
                    case Constants.SLAB_AREA:
                        {
                            typeOfArea = Constants.TOTAL_SLAB_AREA;
                            break;
                        }
                    case Constants.SALEABLE_AREA:
                        {
                            typeOfArea = Constants.TOTAL_SALEABLE_AREA;
                            break;
                        }
                    case Constants.CARPET_AREA:
                        {
                            typeOfArea = Constants.TOTAL_CARPET_AREA;
                            break;
                        }
                    default: callback(error, null);
                }
                var totalArea = alasql('VALUE OF SELECT ROUND(SUM(' + typeOfArea + '),2) FROM ?', [buildings]);
                var projectReport = new ProjectReport();
                projectReport.buildings = _this.generateReportByCostHeads(buildings, typeOfArea, rateUnit);
                var projectCostHeads = result[0].projectCostHeads;
                var projectRates = result[0].rates;
                if (projectCostHeads !== null) {
                    projectReport.commonAmenities = _this.generateReportForProjectCostHeads(projectCostHeads, projectRates, totalArea, rateUnit);
                }
                else {
                    callback(null, error);
                }
                callback(null, { data: projectReport, access_token: _this.authInterceptor.issueTokenWithUid(user) });
            }
        });
    };
    ReportService.prototype.generateReportByCostHeads = function (buildings, typeOfArea, rateUnit) {
        var buildingsReport = new Array();
        for (var _i = 0, buildings_1 = buildings; _i < buildings_1.length; _i++) {
            var building = buildings_1[_i];
            var buildingReport = new BuildingReport;
            buildingReport.name = building.name;
            buildingReport._id = building._id;
            buildingReport.area = building[typeOfArea];
            var thumbRule = new ThumbRule();
            var estimate = new Estimate();
            var thumbRuleReports = new Array();
            var estimatedReports = new Array();
            this.getThumbRuleAndEstimatedReport(building, buildingReport, thumbRuleReports, estimatedReports, rateUnit);
            var totalRates = alasql('SELECT ROUND(SUM(amount),2) AS totalAmount, ROUND(SUM(rate),2) AS totalRate FROM ?', [thumbRuleReports]);
            thumbRule.totalRate = totalRates[0].totalRate;
            if (rateUnit === Constants.SQUREMETER_UNIT) {
                thumbRule.totalRate = parseFloat((thumbRule.totalRate * config.get(Constants.SQUARE_METER)).toFixed(2));
            }
            thumbRule.totalBudgetedCost = totalRates[0].totalAmount;
            thumbRule.thumbRuleReports = thumbRuleReports;
            var totalEstimatedRates = alasql('SELECT ROUND(SUM(total),2) AS totalAmount, ROUND(SUM(rate),2) AS totalRate FROM ?', [estimatedReports]);
            estimate.totalRate = totalEstimatedRates[0].totalRate;
            if (rateUnit === Constants.SQUREMETER_UNIT) {
                estimate.totalRate = parseFloat((estimate.totalRate * config.get(Constants.SQUARE_METER)).toFixed(2));
            }
            estimate.totalEstimatedCost = totalEstimatedRates[0].totalAmount;
            estimate.estimatedCosts = estimatedReports;
            buildingReport.thumbRule = thumbRule;
            buildingReport.estimate = estimate;
            buildingsReport.push(buildingReport);
        }
        return (buildingsReport);
    };
    ReportService.prototype.getThumbRuleAndEstimatedReport = function (building, buildingReport, thumbRuleReports, estimatedReports, rateUnit) {
        for (var _i = 0, _a = building.costHeads; _i < _a.length; _i++) {
            var costHead = _a[_i];
            if (costHead.active) {
                var thumbRuleReport = new ThumbRuleReport();
                thumbRuleReport.name = costHead.name;
                thumbRuleReport.rateAnalysisId = costHead.rateAnalysisId;
                thumbRuleReport.amount = parseFloat((costHead.budgetedCostAmount).toFixed(Constants.NUMBER_OF_FRACTION_DIGIT));
                thumbRuleReport.costHeadActive = costHead.active;
                thumbRuleReport.rate = parseFloat((thumbRuleReport.amount / buildingReport.area).toFixed(2));
                if (rateUnit === Constants.SQUREMETER_UNIT) {
                    thumbRuleReport.rate = parseFloat((thumbRuleReport.rate * config.get(Constants.SQUARE_METER)).toFixed(2));
                }
                thumbRuleReports.push(thumbRuleReport);
                var estimateReport = new EstimateReport();
                estimateReport = this.getEstimatedReport(building.rates, costHead, buildingReport.area, rateUnit);
                estimatedReports.push(estimateReport);
            }
        }
    };
    ReportService.prototype.getEstimatedReport = function (centralizedRates, costHead, area, rateUnit) {
        var estimateReport = new EstimateReport();
        estimateReport.name = costHead.name;
        estimateReport.rateAnalysisId = costHead.rateAnalysisId;
        var costHeadCategories = costHead.categories;
        var projectService = new ProjectService();
        var categoriesObj = projectService.getCategoriesListWithCentralizedRates(costHeadCategories, centralizedRates);
        estimateReport.total = categoriesObj.categoriesAmount;
        estimateReport.rate = parseFloat((estimateReport.total / area).toFixed(2));
        if (rateUnit === Constants.SQUREMETER_UNIT) {
            estimateReport.rate = parseFloat((estimateReport.rate * config.get(Constants.SQUARE_METER)).toFixed(2));
        }
        return estimateReport;
    };
    ReportService.prototype.generateReportForProjectCostHeads = function (projectCostHeads, projectRates, totalArea, rateUnit) {
        var commonAmenitiesReport = new Array();
        var projectReport = new BuildingReport;
        projectReport.name = Constants.AMENITIES;
        projectReport.area = totalArea;
        var thumbRule = new ThumbRule();
        var estimate = new Estimate();
        var thumbRuleReports = new Array();
        var estimatedReports = new Array();
        this.getThumbRuleAndEstimatedReportForProjectCostHead(projectCostHeads, projectRates, projectReport, thumbRuleReports, estimatedReports, totalArea, rateUnit);
        var totalRates = alasql('SELECT SUM(amount) AS totalAmount, SUM(rate) AS totalRate FROM ?', [thumbRuleReports]);
        thumbRule.totalRate = totalRates[0].totalRate;
        if (rateUnit === Constants.SQUREMETER_UNIT) {
            thumbRule.totalRate = parseFloat((thumbRule.totalRate * config.get(Constants.SQUARE_METER)).toFixed(2));
        }
        thumbRule.totalBudgetedCost = totalRates[0].totalAmount;
        thumbRule.thumbRuleReports = thumbRuleReports;
        var totalEstimatedRates = alasql('SELECT SUM(total) AS totalAmount, SUM(rate) AS totalRate FROM ?', [estimatedReports]);
        estimate.totalRate = totalEstimatedRates[0].totalRate;
        if (rateUnit === Constants.SQUREMETER_UNIT) {
            estimate.totalRate = parseFloat((estimate.totalRate * config.get(Constants.SQUARE_METER)).toFixed(2));
        }
        estimate.totalEstimatedCost = totalEstimatedRates[0].totalAmount;
        estimate.estimatedCosts = estimatedReports;
        projectReport.thumbRule = thumbRule;
        projectReport.estimate = estimate;
        commonAmenitiesReport.push(projectReport);
        return (commonAmenitiesReport);
    };
    ReportService.prototype.getThumbRuleAndEstimatedReportForProjectCostHead = function (projectCostHead, projectRates, projectReport, thumbRuleReports, estimatedReports, totalArea, rateUnit) {
        for (var _i = 0, projectCostHead_1 = projectCostHead; _i < projectCostHead_1.length; _i++) {
            var costHead = projectCostHead_1[_i];
            if (costHead.active) {
                var thumbRuleReport = new ThumbRuleReport();
                thumbRuleReport.name = costHead.name;
                thumbRuleReport.rateAnalysisId = costHead.rateAnalysisId;
                thumbRuleReport.amount = costHead.budgetedCostAmount;
                thumbRuleReport.costHeadActive = costHead.active;
                thumbRuleReport.rate = parseFloat((costHead.budgetedCostAmount / totalArea).toFixed(2));
                if (rateUnit === Constants.SQUREMETER_UNIT) {
                    thumbRuleReport.rate = parseFloat((thumbRuleReport.rate * config.get(Constants.SQUARE_METER)).toFixed(2));
                }
                thumbRuleReports.push(thumbRuleReport);
                var estimateReport = new EstimateReport();
                estimateReport = this.getEstimatedReport(projectRates, costHead, totalArea, rateUnit);
                estimatedReports.push(estimateReport);
            }
        }
    };
    ReportService.prototype.getCostHeads = function (url, user, callback) {
        var _this = this;
        logger.info('Report Service, getCostHeads has been hit');
        this.rateAnalysisService.getCostHeads(url, user, function (error, result) {
            if (error) {
                console.log('error : ' + JSON.stringify(error));
                callback(error, null);
            }
            else {
                callback(null, { data: result, access_token: _this.authInterceptor.issueTokenWithUid(user) });
            }
        });
    };
    ReportService.prototype.getWorkItems = function (url, user, callback) {
        var _this = this;
        logger.info('Report Service, getWorkItems has been hit');
        this.rateAnalysisService.getWorkItems(url, user, function (error, result) {
            if (error) {
                console.log('error : ' + JSON.stringify(error));
                callback(error, null);
            }
            else {
                callback(null, { data: result, access_token: _this.authInterceptor.issueTokenWithUid(user) });
            }
        });
    };
    return ReportService;
}());
Object.seal(ReportService);
module.exports = ReportService;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9hcHBsaWNhdGlvblByb2plY3Qvc2VydmljZXMvUmVwb3J0U2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsOEVBQWlGO0FBQ2pGLGdGQUFtRjtBQUNuRixvRUFBdUU7QUFDdkUsa0VBQXFFO0FBR3JFLG1GQUFzRjtBQUN0RixxRkFBd0Y7QUFDeEYsOEVBQWlGO0FBRWpGLG1GQUFzRjtBQUN0RixpRkFBb0Y7QUFDcEYsMEVBQTZFO0FBQzdFLHdFQUEyRTtBQUMzRSwyREFBOEQ7QUFFOUQsK0JBQWtDO0FBQ2xDLCtDQUFrRDtBQUNsRCxpREFBb0Q7QUFFcEQsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQy9CLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMvQixJQUFJLE1BQU0sR0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFFOUM7SUFVRTtRQUNFLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLGlCQUFpQixFQUFFLENBQUM7UUFDakQsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksa0JBQWtCLEVBQUUsQ0FBQztRQUNuRCxJQUFJLENBQUMsUUFBUSxHQUFHLFlBQVksQ0FBQyxRQUFRLENBQUM7UUFDdEMsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLGVBQWUsRUFBRSxDQUFDO1FBQzdDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUNyQyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxtQkFBbUIsRUFBRSxDQUFDO0lBQ3ZELENBQUM7SUFFRCxpQ0FBUyxHQUFULFVBQVcsU0FBZSxFQUFFLFVBQW1CLEVBQUUsUUFBaUIsRUFBRSxRQUFpQixFQUFHLElBQVUsRUFDdkYsUUFBMkM7UUFEdEQsaUJBa0RDO1FBL0NDLE1BQU0sQ0FBQyxJQUFJLENBQUMsd0NBQXdDLENBQUMsQ0FBQztRQUN0RCxJQUFJ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QUMsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSxLQUFJLENBQUMsZUFBZSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxFQUFDLENBQUMsQ0FBQztZQUM3RixDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsb0NBQVksR0FBWixVQUFjLEdBQVcsRUFBRyxJQUFVLEVBQUUsUUFBMkM7UUFBbkYsaUJBVUM7UUFUQyxNQUFNLENBQUMsSUFBSSxDQUFDLDJDQUEyQyxDQUFDLENBQUM7UUFDekQsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFlBQVksQ0FBRSxHQUFHLEVBQUUsSUFBSSxFQUFDLFVBQUMsS0FBSyxFQUFFLE1BQU07WUFDN0QsRUFBRSxDQUFBLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDVCxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsR0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQzlDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDeEIsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLFFBQVEsQ0FBQyxJQUFJLEVBQUMsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSxLQUFJLENBQUMsZUFBZSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxFQUFDLENBQUMsQ0FBQztZQUM3RixDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUgsb0JBQUM7QUFBRCxDQWxQQSxBQWtQQyxJQUFBO0FBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUMzQixpQkFBUyxhQUFhLENBQUMiLCJmaWxlIjoiYXBwL2FwcGxpY2F0aW9uUHJvamVjdC9zZXJ2aWNlcy9SZXBvcnRTZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb2plY3RSZXBvc2l0b3J5ID0gcmVxdWlyZSgnLi4vZGF0YWFjY2Vzcy9yZXBvc2l0b3J5L1Byb2plY3RSZXBvc2l0b3J5Jyk7XHJcbmltcG9ydCBCdWlsZGluZ1JlcG9zaXRvcnkgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL3JlcG9zaXRvcnkvQnVpbGRpbmdSZXBvc2l0b3J5Jyk7XHJcbmltcG9ydCBVc2VyU2VydmljZSA9IHJlcXVpcmUoJy4vLi4vLi4vZnJhbWV3b3JrL3NlcnZpY2VzL1VzZXJTZXJ2aWNlJyk7XHJcbmltcG9ydCBQcm9qZWN0QXNzZXQgPSByZXF1aXJlKCcuLi8uLi9mcmFtZXdvcmsvc2hhcmVkL3Byb2plY3Rhc3NldCcpO1xyXG5pbXBvcnQgVXNlciA9IHJlcXVpcmUoJy4uLy4uL2ZyYW1ld29yay9kYXRhYWNjZXNzL21vbmdvb3NlL3VzZXInKTtcclxuaW1wb3J0IEJ1aWxkaW5nID0gcmVxdWlyZSgnLi4vZGF0YWFjY2Vzcy9tb25nb29zZS9CdWlsZGluZycpO1xyXG5pbXBvcnQgQnVpbGRpbmdSZXBvcnQgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL21vZGVsL3Byb2plY3QvcmVwb3J0cy9CdWlsZGluZ1JlcG9ydCcpO1xyXG5pbXBvcnQgVGh1bWJSdWxlUmVwb3J0ID0gcmVxdWlyZSgnLi4vZGF0YWFjY2Vzcy9tb2RlbC9wcm9qZWN0L3JlcG9ydHMvVGh1bWJSdWxlUmVwb3J0Jyk7XHJcbmltcG9ydCBBdXRoSW50ZXJjZXB0b3IgPSByZXF1aXJlKCcuLi8uLi9mcmFtZXdvcmsvaW50ZXJjZXB0b3IvYXV0aC5pbnRlcmNlcHRvcicpO1xyXG5pbXBvcnQgQ29zdEhlYWQgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL21vbmdvb3NlL0Nvc3RIZWFkJyk7XHJcbmltcG9ydCBFc3RpbWF0ZVJlcG9ydCA9IHJlcXVpcmUoJy4uL2RhdGFhY2Nlc3MvbW9kZWwvcHJvamVjdC9yZXBvcnRzL0VzdGltYXRlUmVwb3J0Jyk7XHJcbmltcG9ydCBQcm9qZWN0UmVwb3J0ID0gcmVxdWlyZSgnLi4vZGF0YWFjY2Vzcy9tb2RlbC9wcm9qZWN0L3JlcG9ydHMvUHJvamVjdFJlcG9ydCcpO1xyXG5pbXBvcnQgVGh1bWJSdWxlID0gcmVxdWlyZSgnLi4vZGF0YWFjY2Vzcy9tb2RlbC9wcm9qZWN0L2J1aWxkaW5nL1RodW1iUnVsZScpO1xyXG5pbXBvcnQgRXN0aW1hdGUgPSByZXF1aXJlKCcuLi9kYXRhYWNjZXNzL21vZGVsL3Byb2plY3QvYnVpbGRpbmcvRXN0aW1hdGUnKTtcclxuaW1wb3J0IFJhdGVBbmFseXNpc1NlcnZpY2UgPSByZXF1aXJlKCcuL1JhdGVBbmFseXNpc1NlcnZpY2UnKTtcclxuaW1wb3J0IENhdGVnb3J5ID0gcmVxdWlyZSgnLi4vZGF0YWFjY2Vzcy9tb2RlbC9wcm9qZWN0L2J1aWxkaW5nL0NhdGVnb3J5Jyk7XHJcbmltcG9ydCBhbGFzcWwgPSByZXF1aXJlKCdhbGFzcWwnKTtcclxuaW1wb3J0IENvbnN0YW50cyA9IHJlcXVpcmUoJy4uL3NoYXJlZC9jb25zdGFudHMnKTtcclxuaW1wb3J0IFByb2plY3RTZXJ2aWNlID0gcmVxdWlyZSgnLi9Qcm9qZWN0U2VydmljZScpO1xyXG5pbXBvcnQgQ2VudHJhbGl6ZWRSYXRlID0gcmVxdWlyZSgnLi4vZGF0YWFjY2Vzcy9tb2RlbC9wcm9qZWN0L0NlbnRyYWxpemVkUmF0ZScpO1xyXG5sZXQgY29uZmlnID0gcmVxdWlyZSgnY29uZmlnJyk7XHJcbnZhciBsb2c0anMgPSByZXF1aXJlKCdsb2c0anMnKTtcclxudmFyIGxvZ2dlcj1sb2c0anMuZ2V0TG9nZ2VyKCdSZXBvcnQgU2VydmljZScpO1xyXG5cclxuY2xhc3MgUmVwb3J0U2VydmljZSB7XHJcbiAgQVBQX05BTUU6IHN0cmluZztcclxuICBjb21wYW55X25hbWU6IHN0cmluZztcclxuICBwcml2YXRlIHByb2plY3RSZXBvc2l0b3J5OiBQcm9qZWN0UmVwb3NpdG9yeTtcclxuICBwcml2YXRlIGJ1aWxkaW5nUmVwb3NpdG9yeTogQnVpbGRpbmdSZXBvc2l0b3J5O1xyXG4gIHByaXZhdGUgYXV0aEludGVyY2VwdG9yOiBBdXRoSW50ZXJjZXB0b3I7XHJcbiAgcHJpdmF0ZSB1c2VyU2VydmljZSA6IFVzZXJTZXJ2aWNlO1xyXG4gIHByaXZhdGUgcmF0ZUFuYWx5c2lzU2VydmljZSA6IFJhdGVBbmFseXNpc1NlcnZpY2U7XHJcbiAgcHJpdmF0ZSBwcm9qZWN0U2VydmljZSA6IFByb2plY3RTZXJ2aWNlO1xyXG5cclxuICBjb25zdHJ1Y3RvcigpIHtcclxuICAgIHRoaXMucHJvamVjdFJlcG9zaXRvcnkgPSBuZXcgUHJvamVjdFJlcG9zaXRvcnkoKTtcclxuICAgIHRoaXMuYnVpbGRpbmdSZXBvc2l0b3J5ID0gbmV3IEJ1aWxkaW5nUmVwb3NpdG9yeSgpO1xyXG4gICAgdGhpcy5BUFBfTkFNRSA9IFByb2plY3RBc3NldC5BUFBfTkFNRTtcclxuICAgIHRoaXMuYXV0aEludGVyY2VwdG9yID0gbmV3IEF1dGhJbnRlcmNlcHRvcigpO1xyXG4gICAgdGhpcy51c2VyU2VydmljZSA9IG5ldyBVc2VyU2VydmljZSgpO1xyXG4gICAgdGhpcy5yYXRlQW5hbHlzaXNTZXJ2aWNlID0gbmV3IFJhdGVBbmFseXNpc1NlcnZpY2UoKTtcclxuICB9XHJcblxyXG4gIGdldFJlcG9ydCggcHJvamVjdElkIDogYW55LCByZXBvcnRUeXBlIDogc3RyaW5nLCByYXRlVW5pdCA6IHN0cmluZywgYXJlYVR5cGUgOiBzdHJpbmcs4oCC4oCCdXNlcjogVXNlcixcclxuICAgICAgICAgICAgIGNhbGxiYWNrOiAoZXJyb3I6IGFueSwgcmVzdWx0OiBhbnkpID0+IHZvaWQpIHtcclxuXHJcbiAgICBsb2dnZXIuaW5mbygnUmVwb3J0IFNlcnZpY2UsIGdldFJlcG9ydCBoYXMgYmVlbiBoaXQnKTtcclxuICAgIGxldCBxdWVyeSA9IHsgX2lkOiBwcm9qZWN0SWR9O1xyXG4gICAgbGV0IHBvcHVsYXRlID0ge3BhdGggOiAnYnVpbGRpbmdzJ307XHJcbiAgICB0aGlzLnByb2plY3RSZXBvc2l0b3J5LmZpbmRBbmRQb3B1bGF0ZShxdWVyeSwgcG9wdWxhdGUsIChlcnJvciwgcmVzdWx0KSA9PiB7XHJcbiAgICAgIGxvZ2dlci5pbmZvKCdSZXBvcnQgU2VydmljZSwgZmluZEFuZFBvcHVsYXRlIGhhcyBiZWVuIGhpdCcpO1xyXG4gICAgICBpZihlcnJvcikge1xyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBsZXQgYnVpbGRpbmdzID0gcmVzdWx0WzBdLmJ1aWxkaW5ncztcclxuICAgICAgICB2YXIgdHlwZU9mQXJlYTogc3RyaW5nO1xyXG4gICAgICAgIGxldCBjaG9pY2UgPSBhcmVhVHlwZTtcclxuICAgICAgICBzd2l0Y2ggKGNob2ljZSkge1xyXG4gICAgICAgICAgY2FzZSBDb25zdGFudHMuU0xBQl9BUkVBOlxyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICB0eXBlT2ZBcmVhID0gQ29uc3RhbnRzLlRPVEFMX1NMQUJfQVJFQTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgY2FzZSBDb25zdGFudHMuU0FMRUFCTEVfQVJFQTpcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgdHlwZU9mQXJlYSA9IENvbnN0YW50cy5UT1RBTF9TQUxFQUJMRV9BUkVBO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICBjYXNlICBDb25zdGFudHMuQ0FSUEVUX0FSRUEgOlxyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICB0eXBlT2ZBcmVhID0gQ29uc3RhbnRzLlRPVEFMX0NBUlBFVF9BUkVBO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGRlZmF1bHQgOiAgY2FsbGJhY2soZXJyb3IsbnVsbCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgdG90YWxBcmVhID0gYWxhc3FsKCdWQUxVRSBPRiBTRUxFQ1QgUk9VTkQoU1VNKCcrdHlwZU9mQXJlYSsnKSwyKSBGUk9NID8nLFtidWlsZGluZ3NdKTtcclxuICAgICAgICBsZXQgcHJvamVjdFJlcG9ydCA6IFByb2plY3RSZXBvcnQgPSBuZXcgUHJvamVjdFJlcG9ydCgpO1xyXG5cclxuICAgICAgICBwcm9qZWN0UmVwb3J0LmJ1aWxkaW5ncyA9IHRoaXMuZ2VuZXJhdGVSZXBvcnRCeUNvc3RIZWFkcyhidWlsZGluZ3MsIHR5cGVPZkFyZWEsIHJhdGVVbml0KTtcclxuXHJcbiAgICAgICAgbGV0IHByb2plY3RDb3N0SGVhZHMgPSByZXN1bHRbMF0ucHJvamVjdENvc3RIZWFkcztcclxuICAgICAgICBsZXQgcHJvamVjdFJhdGVzID0gcmVzdWx0WzBdLnJhdGVzO1xyXG4gICAgICAgIGlmKHByb2plY3RDb3N0SGVhZHMhPT0gbnVsbCkge1xyXG4gICAgICAgICAgcHJvamVjdFJlcG9ydC5jb21tb25BbWVuaXRpZXMgPSB0aGlzLmdlbmVyYXRlUmVwb3J0Rm9yUHJvamVjdENvc3RIZWFkcyhwcm9qZWN0Q29zdEhlYWRzLCBwcm9qZWN0UmF0ZXMsIHRvdGFsQXJlYSwgcmF0ZVVuaXQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBjYWxsYmFjayhudWxsLGVycm9yKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCx7IGRhdGE6IHByb2plY3RSZXBvcnQsIGFjY2Vzc190b2tlbjogdGhpcy5hdXRoSW50ZXJjZXB0b3IuaXNzdWVUb2tlbldpdGhVaWQodXNlcil9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBnZW5lcmF0ZVJlcG9ydEJ5Q29zdEhlYWRzKCBidWlsZGluZ3M6ICBBcnJheTxCdWlsZGluZz4gLCB0eXBlT2ZBcmVhOiBzdHJpbmcsIHJhdGVVbml0OiBzdHJpbmcpIHtcclxuXHJcbiAgICBsZXQgYnVpbGRpbmdzUmVwb3J0IDogQXJyYXk8QnVpbGRpbmdSZXBvcnQ+ID0gbmV3IEFycmF5PEJ1aWxkaW5nUmVwb3J0PigpO1xyXG4gICAgZm9yIChsZXQgYnVpbGRpbmcgb2YgYnVpbGRpbmdzKSB7XHJcbiAgICAgIGxldCBidWlsZGluZ1JlcG9ydCA9IG5ldyBCdWlsZGluZ1JlcG9ydDtcclxuICAgICAgYnVpbGRpbmdSZXBvcnQubmFtZSA9IGJ1aWxkaW5nLm5hbWU7XHJcbiAgICAgIGJ1aWxkaW5nUmVwb3J0Ll9pZCA9IGJ1aWxkaW5nLl9pZDtcclxuICAgICAgYnVpbGRpbmdSZXBvcnQuYXJlYSA9IGJ1aWxkaW5nW3R5cGVPZkFyZWFdO1xyXG5cclxuICAgICAgbGV0IHRodW1iUnVsZSAgPSBuZXcgVGh1bWJSdWxlKCk7XHJcbiAgICAgIGxldCBlc3RpbWF0ZSAgPSBuZXcgRXN0aW1hdGUoKTtcclxuICAgICAgbGV0IHRodW1iUnVsZVJlcG9ydHMgPSBuZXcgQXJyYXk8VGh1bWJSdWxlUmVwb3J0PigpO1xyXG4gICAgICBsZXQgZXN0aW1hdGVkUmVwb3J0cyA9IG5ldyBBcnJheTxFc3RpbWF0ZVJlcG9ydD4oKTtcclxuXHJcblxyXG4gICAgICB0aGlzLmdldFRodW1iUnVsZUFuZEVzdGltYXRlZFJlcG9ydChidWlsZGluZywgYnVpbGRpbmdSZXBvcnQsIHRodW1iUnVsZVJlcG9ydHMsIGVzdGltYXRlZFJlcG9ydHMsIHJhdGVVbml0KTtcclxuXHJcbiAgICAgIGxldCB0b3RhbFJhdGVzID0gYWxhc3FsKCdTRUxFQ1QgUk9VTkQoU1VNKGFtb3VudCksMikgQVMgdG90YWxBbW91bnQsIFJPVU5EKFNVTShyYXRlKSwyKSBBUyB0b3RhbFJhdGUgRlJPTSA/JyxbdGh1bWJSdWxlUmVwb3J0c10pO1xyXG4gICAgICB0aHVtYlJ1bGUudG90YWxSYXRlID0gdG90YWxSYXRlc1swXS50b3RhbFJhdGU7XHJcbiAgICAgIGlmKHJhdGVVbml0ID09PSBDb25zdGFudHMuU1FVUkVNRVRFUl9VTklUKSB7XHJcbiAgICAgICAgdGh1bWJSdWxlLnRvdGFsUmF0ZSA9ICBwYXJzZUZsb2F0KCh0aHVtYlJ1bGUudG90YWxSYXRlICogY29uZmlnLmdldChDb25zdGFudHMuU1FVQVJFX01FVEVSKSkudG9GaXhlZCgyKSk7XHJcbiAgICAgIH1cclxuICAgICAgdGh1bWJSdWxlLnRvdGFsQnVkZ2V0ZWRDb3N0ID0gdG90YWxSYXRlc1swXS50b3RhbEFtb3VudDtcclxuICAgICAgdGh1bWJSdWxlLnRodW1iUnVsZVJlcG9ydHMgPSB0aHVtYlJ1bGVSZXBvcnRzO1xyXG5cclxuICAgICAgbGV0IHRvdGFsRXN0aW1hdGVkUmF0ZXMgPSBhbGFzcWwoJ1NFTEVDVCBST1VORChTVU0odG90YWwpLDIpIEFTIHRvdGFsQW1vdW50LCBST1VORChTVU0ocmF0ZSksMikgQVMgdG90YWxSYXRlIEZST00gPycsW2VzdGltYXRlZFJlcG9ydHNdKTtcclxuICAgICAgZXN0aW1hdGUudG90YWxSYXRlID0gdG90YWxFc3RpbWF0ZWRSYXRlc1swXS50b3RhbFJhdGU7XHJcbiAgICAgIGlmKHJhdGVVbml0ID09PSBDb25zdGFudHMuU1FVUkVNRVRFUl9VTklUKSB7XHJcbiAgICAgICAgZXN0aW1hdGUudG90YWxSYXRlID0gIHBhcnNlRmxvYXQoKGVzdGltYXRlLnRvdGFsUmF0ZSAqIGNvbmZpZy5nZXQoQ29uc3RhbnRzLlNRVUFSRV9NRVRFUikpLnRvRml4ZWQoMikpO1xyXG4gICAgICB9XHJcbiAgICAgIGVzdGltYXRlLnRvdGFsRXN0aW1hdGVkQ29zdCA9IHRvdGFsRXN0aW1hdGVkUmF0ZXNbMF0udG90YWxBbW91bnQ7XHJcbiAgICAgIGVzdGltYXRlLmVzdGltYXRlZENvc3RzID0gZXN0aW1hdGVkUmVwb3J0cztcclxuXHJcbiAgICAgIGJ1aWxkaW5nUmVwb3J0LnRodW1iUnVsZSA9IHRodW1iUnVsZTtcclxuICAgICAgYnVpbGRpbmdSZXBvcnQuZXN0aW1hdGUgPSBlc3RpbWF0ZTtcclxuICAgICAgYnVpbGRpbmdzUmVwb3J0LnB1c2goYnVpbGRpbmdSZXBvcnQpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuKGJ1aWxkaW5nc1JlcG9ydCk7XHJcbiAgfVxyXG5cclxuXHJcbiAgZ2V0VGh1bWJSdWxlQW5kRXN0aW1hdGVkUmVwb3J0KGJ1aWxkaW5nIDpCdWlsZGluZywgYnVpbGRpbmdSZXBvcnQ6IEJ1aWxkaW5nUmVwb3J0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHVtYlJ1bGVSZXBvcnRzOiBUaHVtYlJ1bGVSZXBvcnRbXSwgZXN0aW1hdGVkUmVwb3J0czogRXN0aW1hdGVSZXBvcnRbXSwgcmF0ZVVuaXQ6c3RyaW5nKSB7XHJcblxyXG4gICAgZm9yIChsZXQgY29zdEhlYWQgb2YgYnVpbGRpbmcuY29zdEhlYWRzKSB7XHJcblxyXG4gICAgICBpZihjb3N0SGVhZC5hY3RpdmUpIHtcclxuICAgICAgICAvL1RodW1iUnVsZSBSZXBvcnRcclxuICAgICAgICBsZXQgdGh1bWJSdWxlUmVwb3J0ID0gbmV3IFRodW1iUnVsZVJlcG9ydCgpO1xyXG4gICAgICAgIHRodW1iUnVsZVJlcG9ydC5uYW1lID0gY29zdEhlYWQubmFtZTtcclxuICAgICAgICB0aHVtYlJ1bGVSZXBvcnQucmF0ZUFuYWx5c2lzSWQgPSBjb3N0SGVhZC5yYXRlQW5hbHlzaXNJZDtcclxuICAgICAgICB0aHVtYlJ1bGVSZXBvcnQuYW1vdW50ID0gcGFyc2VGbG9hdCgoY29zdEhlYWQuYnVkZ2V0ZWRDb3N0QW1vdW50KS50b0ZpeGVkKENvbnN0YW50cy5OVU1CRVJfT0ZfRlJBQ1RJT05fRElHSVQpKTtcclxuICAgICAgICB0aHVtYlJ1bGVSZXBvcnQuY29zdEhlYWRBY3RpdmUgPSBjb3N0SGVhZC5hY3RpdmU7XHJcbiAgICAgICAgdGh1bWJSdWxlUmVwb3J0LnJhdGUgPSBwYXJzZUZsb2F0KCh0aHVtYlJ1bGVSZXBvcnQuYW1vdW50IC8gYnVpbGRpbmdSZXBvcnQuYXJlYSkudG9GaXhlZCgyKSk7XHJcbiAgICAgICAgaWYocmF0ZVVuaXQgPT09IENvbnN0YW50cy5TUVVSRU1FVEVSX1VOSVQpIHtcclxuICAgICAgICAgIHRodW1iUnVsZVJlcG9ydC5yYXRlID0gcGFyc2VGbG9hdCgodGh1bWJSdWxlUmVwb3J0LnJhdGUgKiBjb25maWcuZ2V0KENvbnN0YW50cy5TUVVBUkVfTUVURVIpKS50b0ZpeGVkKDIpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGh1bWJSdWxlUmVwb3J0cy5wdXNoKHRodW1iUnVsZVJlcG9ydCk7XHJcblxyXG4gICAgICAgIC8vRXN0aW1hdGVkIGNvc3QgUmVwb3J0XHJcbiAgICAgICAgbGV0IGVzdGltYXRlUmVwb3J0ID0gbmV3IEVzdGltYXRlUmVwb3J0KCk7XHJcbiAgICAgICAgZXN0aW1hdGVSZXBvcnQgPSB0aGlzLmdldEVzdGltYXRlZFJlcG9ydChidWlsZGluZy5yYXRlcywgY29zdEhlYWQsIGJ1aWxkaW5nUmVwb3J0LmFyZWEsIHJhdGVVbml0KTtcclxuICAgICAgICBlc3RpbWF0ZWRSZXBvcnRzLnB1c2goZXN0aW1hdGVSZXBvcnQpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBnZXRFc3RpbWF0ZWRSZXBvcnQoY2VudHJhbGl6ZWRSYXRlczpBcnJheTxDZW50cmFsaXplZFJhdGU+LCBjb3N0SGVhZDogYW55LCBhcmVhOm51bWJlciwgcmF0ZVVuaXQ6c3RyaW5nKSB7XHJcblxyXG4gICAgbGV0IGVzdGltYXRlUmVwb3J0ID0gbmV3IEVzdGltYXRlUmVwb3J0KCk7XHJcbiAgICBlc3RpbWF0ZVJlcG9ydC5uYW1lID0gY29zdEhlYWQubmFtZTtcclxuICAgIGVzdGltYXRlUmVwb3J0LnJhdGVBbmFseXNpc0lkID0gY29zdEhlYWQucmF0ZUFuYWx5c2lzSWQ7XHJcblxyXG4gICAgbGV0IGNvc3RIZWFkQ2F0ZWdvcmllczogQXJyYXk8Q2F0ZWdvcnk+ID0gY29zdEhlYWQuY2F0ZWdvcmllcztcclxuICAgIGxldCBwcm9qZWN0U2VydmljZSA6IFByb2plY3RTZXJ2aWNlID0gbmV3IFByb2plY3RTZXJ2aWNlKCk7XHJcbiAgICBsZXQgY2F0ZWdvcmllc09iaiA9IHByb2plY3RTZXJ2aWNlLmdldENhdGVnb3JpZXNMaXN0V2l0aENlbnRyYWxpemVkUmF0ZXMoY29zdEhlYWRDYXRlZ29yaWVzLCBjZW50cmFsaXplZFJhdGVzKTtcclxuICAgIGVzdGltYXRlUmVwb3J0LnRvdGFsID0gY2F0ZWdvcmllc09iai5jYXRlZ29yaWVzQW1vdW50O1xyXG4gICAgZXN0aW1hdGVSZXBvcnQucmF0ZSA9IHBhcnNlRmxvYXQoKGVzdGltYXRlUmVwb3J0LnRvdGFsIC8gYXJlYSkudG9GaXhlZCgyKSk7XHJcbiAgICBpZihyYXRlVW5pdCA9PT0gQ29uc3RhbnRzLlNRVVJFTUVURVJfVU5JVCkge1xyXG4gICAgICBlc3RpbWF0ZVJlcG9ydC5yYXRlID0gcGFyc2VGbG9hdCgoZXN0aW1hdGVSZXBvcnQucmF0ZSAqIGNvbmZpZy5nZXQoQ29uc3RhbnRzLlNRVUFSRV9NRVRFUikpLnRvRml4ZWQoMikpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGVzdGltYXRlUmVwb3J0O1xyXG4gIH1cclxuXHJcbiAgZ2VuZXJhdGVSZXBvcnRGb3JQcm9qZWN0Q29zdEhlYWRzKHByb2plY3RDb3N0SGVhZHM6ICBBcnJheTxDb3N0SGVhZD4sIHByb2plY3RSYXRlczogQXJyYXk8Q2VudHJhbGl6ZWRSYXRlPiwgdG90YWxBcmVhOiBudW1iZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXRlVW5pdDogc3RyaW5nKSB7XHJcbiAgICBsZXQgY29tbW9uQW1lbml0aWVzUmVwb3J0IDogQXJyYXk8QnVpbGRpbmdSZXBvcnQ+ID0gbmV3IEFycmF5PEJ1aWxkaW5nUmVwb3J0PigpO1xyXG4gICAgICBsZXQgcHJvamVjdFJlcG9ydCA9IG5ldyBCdWlsZGluZ1JlcG9ydDtcclxuICAgICAgcHJvamVjdFJlcG9ydC5uYW1lID0gQ29uc3RhbnRzLkFNRU5JVElFUztcclxuICAgICAgcHJvamVjdFJlcG9ydC5hcmVhID0gdG90YWxBcmVhO1xyXG5cclxuICAgICAgbGV0IHRodW1iUnVsZSAgPSBuZXcgVGh1bWJSdWxlKCk7XHJcbiAgICAgIGxldCBlc3RpbWF0ZSAgPSBuZXcgRXN0aW1hdGUoKTtcclxuICAgICAgbGV0IHRodW1iUnVsZVJlcG9ydHMgPSBuZXcgQXJyYXk8VGh1bWJSdWxlUmVwb3J0PigpO1xyXG4gICAgICBsZXQgZXN0aW1hdGVkUmVwb3J0cyA9IG5ldyBBcnJheTxFc3RpbWF0ZVJlcG9ydD4oKTtcclxuXHJcblxyXG4gICAgICB0aGlzLmdldFRodW1iUnVsZUFuZEVzdGltYXRlZFJlcG9ydEZvclByb2plY3RDb3N0SGVhZChwcm9qZWN0Q29zdEhlYWRzLCBwcm9qZWN0UmF0ZXMsXHJcbiAgICAgICAgcHJvamVjdFJlcG9ydCwgdGh1bWJSdWxlUmVwb3J0cywgZXN0aW1hdGVkUmVwb3J0cywgdG90YWxBcmVhLCByYXRlVW5pdCk7XHJcblxyXG4gICAgICBsZXQgdG90YWxSYXRlcyA9IGFsYXNxbCgnU0VMRUNUIFNVTShhbW91bnQpIEFTIHRvdGFsQW1vdW50LCBTVU0ocmF0ZSkgQVMgdG90YWxSYXRlIEZST00gPycsW3RodW1iUnVsZVJlcG9ydHNdKTtcclxuICAgICAgdGh1bWJSdWxlLnRvdGFsUmF0ZSA9IHRvdGFsUmF0ZXNbMF0udG90YWxSYXRlO1xyXG4gICAgICBpZihyYXRlVW5pdCA9PT0gQ29uc3RhbnRzLlNRVVJFTUVURVJfVU5JVCkge1xyXG4gICAgICAgIHRodW1iUnVsZS50b3RhbFJhdGUgPSAgcGFyc2VGbG9hdCgodGh1bWJSdWxlLnRvdGFsUmF0ZSAqIGNvbmZpZy5nZXQoQ29uc3RhbnRzLlNRVUFSRV9NRVRFUikpLnRvRml4ZWQoMikpO1xyXG4gICAgICB9XHJcbiAgICAgIHRodW1iUnVsZS50b3RhbEJ1ZGdldGVkQ29zdCA9IHRvdGFsUmF0ZXNbMF0udG90YWxBbW91bnQ7XHJcbiAgICAgIHRodW1iUnVsZS50aHVtYlJ1bGVSZXBvcnRzID0gdGh1bWJSdWxlUmVwb3J0cztcclxuXHJcbiAgICAgIGxldCB0b3RhbEVzdGltYXRlZFJhdGVzID0gYWxhc3FsKCdTRUxFQ1QgU1VNKHRvdGFsKSBBUyB0b3RhbEFtb3VudCwgU1VNKHJhdGUpIEFTIHRvdGFsUmF0ZSBGUk9NID8nLFtlc3RpbWF0ZWRSZXBvcnRzXSk7XHJcbiAgICAgIGVzdGltYXRlLnRvdGFsUmF0ZSA9IHRvdGFsRXN0aW1hdGVkUmF0ZXNbMF0udG90YWxSYXRlO1xyXG4gICAgICBpZihyYXRlVW5pdCA9PT0gQ29uc3RhbnRzLlNRVVJFTUVURVJfVU5JVCkge1xyXG4gICAgICAgIGVzdGltYXRlLnRvdGFsUmF0ZSA9ICBwYXJzZUZsb2F0KChlc3RpbWF0ZS50b3RhbFJhdGUgKiBjb25maWcuZ2V0KENvbnN0YW50cy5TUVVBUkVfTUVURVIpKS50b0ZpeGVkKDIpKTtcclxuICAgICAgfVxyXG4gICAgICBlc3RpbWF0ZS50b3RhbEVzdGltYXRlZENvc3QgPSB0b3RhbEVzdGltYXRlZFJhdGVzWzBdLnRvdGFsQW1vdW50O1xyXG4gICAgICBlc3RpbWF0ZS5lc3RpbWF0ZWRDb3N0cyA9IGVzdGltYXRlZFJlcG9ydHM7XHJcblxyXG4gICAgICBwcm9qZWN0UmVwb3J0LnRodW1iUnVsZSA9IHRodW1iUnVsZTtcclxuICAgICAgcHJvamVjdFJlcG9ydC5lc3RpbWF0ZSA9IGVzdGltYXRlO1xyXG4gICAgY29tbW9uQW1lbml0aWVzUmVwb3J0LnB1c2gocHJvamVjdFJlcG9ydCk7XHJcbiAgICByZXR1cm4oY29tbW9uQW1lbml0aWVzUmVwb3J0KTtcclxuICB9XHJcblxyXG4gIGdldFRodW1iUnVsZUFuZEVzdGltYXRlZFJlcG9ydEZvclByb2plY3RDb3N0SGVhZChwcm9qZWN0Q29zdEhlYWQ6IEFycmF5PENvc3RIZWFkPiwgcHJvamVjdFJhdGVzOiBBcnJheTxDZW50cmFsaXplZFJhdGU+LCBwcm9qZWN0UmVwb3J0OiBCdWlsZGluZ1JlcG9ydCwgdGh1bWJSdWxlUmVwb3J0czogVGh1bWJSdWxlUmVwb3J0W10sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVzdGltYXRlZFJlcG9ydHM6IEVzdGltYXRlUmVwb3J0W10sIHRvdGFsQXJlYTpudW1iZXIsIHJhdGVVbml0OnN0cmluZykge1xyXG4gIGZvciAobGV0IGNvc3RIZWFkICBvZiBwcm9qZWN0Q29zdEhlYWQpIHtcclxuICAgIGlmIChjb3N0SGVhZC5hY3RpdmUpIHtcclxuICAgICAgLy9UaHVtYlJ1bGUgUmVwb3J0XHJcbiAgICAgIGxldCB0aHVtYlJ1bGVSZXBvcnQgPSBuZXcgVGh1bWJSdWxlUmVwb3J0KCk7XHJcbiAgICAgIHRodW1iUnVsZVJlcG9ydC5uYW1lID0gY29zdEhlYWQubmFtZTtcclxuICAgICAgdGh1bWJSdWxlUmVwb3J0LnJhdGVBbmFseXNpc0lkID0gY29zdEhlYWQucmF0ZUFuYWx5c2lzSWQ7XHJcbiAgICAgIHRodW1iUnVsZVJlcG9ydC5hbW91bnQgPSBjb3N0SGVhZC5idWRnZXRlZENvc3RBbW91bnQ7XHJcbiAgICAgIHRodW1iUnVsZVJlcG9ydC5jb3N0SGVhZEFjdGl2ZSA9IGNvc3RIZWFkLmFjdGl2ZTtcclxuICAgICAgdGh1bWJSdWxlUmVwb3J0LnJhdGUgPSBwYXJzZUZsb2F0KChjb3N0SGVhZC5idWRnZXRlZENvc3RBbW91bnQgLyB0b3RhbEFyZWEpLnRvRml4ZWQoMikpO1xyXG4gICAgICBpZiAocmF0ZVVuaXQgPT09IENvbnN0YW50cy5TUVVSRU1FVEVSX1VOSVQpIHtcclxuICAgICAgICB0aHVtYlJ1bGVSZXBvcnQucmF0ZSA9IHBhcnNlRmxvYXQoKHRodW1iUnVsZVJlcG9ydC5yYXRlICogY29uZmlnLmdldChDb25zdGFudHMuU1FVQVJFX01FVEVSKSkudG9GaXhlZCgyKSk7XHJcbiAgICAgIH1cclxuICAgICAgdGh1bWJSdWxlUmVwb3J0cy5wdXNoKHRodW1iUnVsZVJlcG9ydCk7XHJcblxyXG4gICAgICAvL0VzdGltYXRlZCBjb3N0IFJlcG9ydFxyXG4gICAgICBsZXQgZXN0aW1hdGVSZXBvcnQgPSBuZXcgRXN0aW1hdGVSZXBvcnQoKTtcclxuICAgICAgZXN0aW1hdGVSZXBvcnQgPSB0aGlzLmdldEVzdGltYXRlZFJlcG9ydChwcm9qZWN0UmF0ZXMsIGNvc3RIZWFkLCB0b3RhbEFyZWEsIHJhdGVVbml0KTtcclxuICAgICAgZXN0aW1hdGVkUmVwb3J0cy5wdXNoKGVzdGltYXRlUmVwb3J0KTtcclxuICAgIH1cclxuICAgfVxyXG4gIH1cclxuXHJcblxyXG4gIGdldENvc3RIZWFkcyggIHVybDogc3RyaW5nICwgdXNlcjogVXNlcixjYWxsYmFjazogKGVycm9yOiBhbnksIHJlc3VsdDogYW55KSA9PiB2b2lkKSB7XHJcbiAgICBsb2dnZXIuaW5mbygnUmVwb3J0IFNlcnZpY2UsIGdldENvc3RIZWFkcyBoYXMgYmVlbiBoaXQnKTtcclxuICAgIHRoaXMucmF0ZUFuYWx5c2lzU2VydmljZS5nZXRDb3N0SGVhZHMoIHVybCwgdXNlciwoZXJyb3IsIHJlc3VsdCkgPT4ge1xyXG4gICAgICBpZihlcnJvcikge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdlcnJvciA6ICcrSlNPTi5zdHJpbmdpZnkoZXJyb3IpKTtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCx7IGRhdGE6IHJlc3VsdCwgYWNjZXNzX3Rva2VuOiB0aGlzLmF1dGhJbnRlcmNlcHRvci5pc3N1ZVRva2VuV2l0aFVpZCh1c2VyKX0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGdldFdvcmtJdGVtcyggdXJsOiBzdHJpbmcgLCB1c2VyOiBVc2VyLCBjYWxsYmFjazogKGVycm9yOiBhbnksIHJlc3VsdDogYW55KSA9PiB2b2lkKSB7XHJcbiAgICBsb2dnZXIuaW5mbygnUmVwb3J0IFNlcnZpY2UsIGdldFdvcmtJdGVtcyBoYXMgYmVlbiBoaXQnKTtcclxuICAgIHRoaXMucmF0ZUFuYWx5c2lzU2VydmljZS5nZXRXb3JrSXRlbXMoIHVybCwgdXNlciwoZXJyb3IsIHJlc3VsdCkgPT4ge1xyXG4gICAgICBpZihlcnJvcikge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdlcnJvciA6ICcrSlNPTi5zdHJpbmdpZnkoZXJyb3IpKTtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCx7IGRhdGE6IHJlc3VsdCwgYWNjZXNzX3Rva2VuOiB0aGlzLmF1dGhJbnRlcmNlcHRvci5pc3N1ZVRva2VuV2l0aFVpZCh1c2VyKX0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG59XHJcblxyXG5PYmplY3Quc2VhbChSZXBvcnRTZXJ2aWNlKTtcclxuZXhwb3J0ID0gUmVwb3J0U2VydmljZTtcclxuXHJcbiJdfQ==
