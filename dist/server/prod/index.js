"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var express = require("express");
var path = require("path");
var LoggerService = require("./app/framework/shared/logger/LoggerService");
var sharedService = require("./app/framework/shared/logger/shared.service");
var Middlewares = require("./app/framework/middlewares/base/MiddlewaresBase");
var RateAnalysisService = require("./app/applicationProject/services/RateAnalysisService");
var UserService = require("./app/framework/services/UserService");
var log4js = require('log4js');
var config = require('config');
var spdy = require('spdy');
__dirname = './';
var _clientDir = '/dist/client/dev';
var _serverDir = '/dist/server/dev';
var app = express();
var CronJob = require('cron').CronJob;
function init(port, mode, protocol, dist_runner) {
    var loggerConfig = config.get('logger');
    log4js.configure(loggerConfig);
    var loggerCategory = config.get('logger.levels.[all]');
    var logger = log4js.getLogger('User Controller');
    logger.info('Initialization info');
    logger.error('Initialization error');
    logger.debug('Initialization debug');
    process.on('uncaughtException', function (err) {
        var _loggerService = new LoggerService('uncaught exception Handler');
        var error = {
            reason: 'uncaught exception',
            message: err,
            stack: err.stack,
            code: 500
        };
        console.error(error);
        _loggerService.logError('Catching uncaught Exceptions. : ' + err);
        _loggerService.logError('Catching uncaught Exceptions stack : ' + err.stack);
        sharedService.mailToAdmin(error);
    });
    var syncAtEveryFifteenMinute = new CronJob('00 */5 * * * *', function () {
        var rateAnalysisServices = new RateAnalysisService();
    }, function () {
        console.log('restart server');
    }, true);
    syncAtEveryFifteenMinute.start();
    var sendProjectExpiryWarningMail = new CronJob('00 */2 0 * * *', function () {
        var userService = new UserService();
        var _loggerService = new LoggerService('sendProjectExpiryWarningMail');
        _loggerService.logDebug('ProjectExpiryWarningMail started.');
        userService.sendProjectExpiryWarningMails(function (error, success) {
            if (error) {
                _loggerService.logError('Error in sendProjectExpiryWarningMail for users : ' + error);
            }
            else {
                _loggerService.logDebug('ProjectExpiryWarningMail send successfully to all users.');
            }
        });
    }, function () {
        console.log('restart server');
    }, true);
    sendProjectExpiryWarningMail.start();
    if (mode === 'dev') {
        if (dist_runner === 'dist') {
            app.all('/*', function (req, res, next) {
                res.header('Access-Control-Allow-Origin', '*');
                res.header('Access-Control-Allow-Headers', 'X-Requested-With');
                next();
            });
            app.use(Middlewares.configuration);
            var root = path.resolve(process.cwd());
            var clientRoot = path.resolve(process.cwd(), './client/dev');
            app.use(express.static(root));
            app.use(express.static(clientRoot));
            _serverDir = '/dist/server/dev';
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/client/dev';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
        else {
            app.all('/*', function (req, res, next) {
                res.header('Access-Control-Allow-Origin', '*');
                res.header('Access-Control-Allow-Headers', 'X-Requested-With');
                next();
            });
            app.use(Middlewares.configuration);
            var root = path.resolve(process.cwd());
            var clientRoot = path.resolve(process.cwd(), './dist/client/dev');
            app.use(express.static(root));
            app.use(express.static(clientRoot));
            _serverDir = '/dist/server/dev';
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex_1 = function (req, res) {
                _clientDir = '/dist/client/dev';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex_1);
        }
    }
    else {
        if (dist_runner === 'dist') {
            _clientDir = './client/prod';
            _serverDir = '/server/prod';
            app.use('/js', express.static(path.resolve(__dirname, _clientDir + '/js')));
            app.use('/css', express.static(path.resolve(__dirname, _clientDir + '/css')));
            app.use('/assets', express.static(path.resolve(__dirname, _clientDir + '/assets')));
            app.use('/banners', express.static(path.resolve(__dirname, _clientDir + '/banners')));
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/client/prod';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
        else {
            app.use(Middlewares.configuration);
            _clientDir = './dist/client/prod';
            _serverDir = '/dist/server/prod';
            app.use('/js', express.static(path.resolve(__dirname, _clientDir + '/js')));
            app.use('/css', express.static(path.resolve(__dirname, _clientDir + '/css')));
            app.use('/assets', express.static(path.resolve(__dirname, _clientDir + '/assets')));
            app.use('/banners', express.static(path.resolve(__dirname, _clientDir + '/banners')));
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/dist/client/prod';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
    }
    if (protocol === 'http') {
        return new Promise(function (resolve, reject) {
            var server = app.listen(port, function () {
                var port = server.address().port;
                console.log('App is listening on port:' + port);
                resolve(server);
            });
            server.timeout = 600000;
        });
    }
    else {
        var options = {
            handshakeTimeout: 600000,
            passphrase: 'tpl123',
            spdy: {
                protocols: ['h2']
            }
        };
        return spdy.createServer(options, app)
            .listen(port, function (error) {
            if (error) {
                console.error(error);
                process.exit(1);
            }
            else {
                console.log('http2 Listening on port: ' + port + '.');
            }
        });
    }
}
exports.init = init;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q0FBQyxNQUFNLENBQUMsQ0FBQztZQUNsQixDQUFDLENBQUMsQ0FBQztZQUNILE1BQU0sQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1FBQzFCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sSUFBTSxPQUFPLEdBQUc7WUFHZCxnQkFBZ0IsRUFBRSxNQUFNO1lBQ3hCLFVBQVUsRUFBRSxRQUFRO1lBQ3BCLElBQUksRUFBRTtnQkFDSixTQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUM7YUFDbEI7U0FDRixDQUFDO1FBRUYsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQzthQUNuQyxNQUFNLENBQUMsSUFBSSxFQUFFLFVBQUMsS0FBVTtZQUN2QixFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUNWLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUE7Z0JBRXBCLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbEIsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLE9BQU8sQ0FBQyxHQUFHLENBQUMsMkJBQTJCLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDO1lBQ3hELENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7QUFDSCxDQUFDO0FBcFJELG9CQW9SQyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGh0dHAgZnJvbSAnaHR0cCc7XG5pbXBvcnQgKiBhcyBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbi8qaW1wb3J0ICogYXMgcm91dGVzIGZyb20gXCIuL3JvdXRlc1wiOyovXG4vKmltcG9ydCAqIGFzIGNuZXh0Um91dGVzIGZyb20gXCIuL2NuZXh0LXJvdXRlc1wiOyovXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgTG9nZ2VyU2VydmljZSA9IHJlcXVpcmUoJy4vYXBwL2ZyYW1ld29yay9zaGFyZWQvbG9nZ2VyL0xvZ2dlclNlcnZpY2UnKTtcbmltcG9ydCAqIGFzIHNoYXJlZFNlcnZpY2UgZnJvbSAnLi9hcHAvZnJhbWV3b3JrL3NoYXJlZC9sb2dnZXIvc2hhcmVkLnNlcnZpY2UnO1xuaW1wb3J0IE1pZGRsZXdhcmVzID0gcmVxdWlyZSgnLi9hcHAvZnJhbWV3b3JrL21pZGRsZXdhcmVzL2Jhc2UvTWlkZGxld2FyZXNCYXNlJyk7XG5pbXBvcnQgUmF0ZUFuYWx5c2lzID0gcmVxdWlyZSgnLi9hcHAvYXBwbGljYXRpb25Qcm9qZWN0L2RhdGFhY2Nlc3MvbW9kZWwvUmF0ZUFuYWx5c2lzL1JhdGVBbmFseXNpcycpO1xuaW1wb3J0IFJhdGVBbmFseXNpc1NlcnZpY2UgPSByZXF1aXJlKCcuL2FwcC9hcHBsaWNhdGlvblByb2plY3Qvc2VydmljZXMvUmF0ZUFuYWx5c2lzU2VydmljZScpO1xuaW1wb3J0IFVzZXJTZXJ2aWNlID0gcmVxdWlyZSgnLi9hcHAvZnJhbWV3b3JrL3NlcnZpY2VzL1VzZXJTZXJ2aWNlJyk7XG52YXIgbG9nNGpzID0gcmVxdWlyZSgnbG9nNGpzJyk7XG52YXIgY29uZmlnID0gcmVxdWlyZSgnY29uZmlnJyk7XG4vKnZhciBsb2dEaXIgPSAnTG9ncyc7Ki9cblxudmFyIHNwZHkgPSByZXF1aXJlKCdzcGR5Jyk7XG5fX2Rpcm5hbWUgPSAnLi8nO1xudmFyIF9jbGllbnREaXIgPSAnL2Rpc3QvY2xpZW50L2Rldic7XG52YXIgX3NlcnZlckRpciA9ICcvZGlzdC9zZXJ2ZXIvZGV2JztcbnZhciBhcHAgPSBleHByZXNzKCk7XG52YXIgQ3JvbkpvYiA9IHJlcXVpcmUoJ2Nyb24nKS5Dcm9uSm9iO1xuXG5leHBvcnQgZnVuY3Rpb24gaW5pdChwb3J0OiBudW1iZXIsIG1vZGU6IHN0cmluZywgcHJvdG9jb2w6IHN0cmluZywgZGlzdF9ydW5uZXI6IHN0cmluZykge1xuXG5cblxuXG5cbiAgdmFyIGxvZ2dlckNvbmZpZz1jb25maWcuZ2V0KCdsb2dnZXInKTtcblxuICBsb2c0anMuY29uZmlndXJlKGxvZ2dlckNvbmZpZyk7XG4gIHZhciBsb2dnZXJDYXRlZ29yeSA9Y29uZmlnLmdldCgnbG9nZ2VyLmxldmVscy5bYWxsXScpXG4gIHZhciBsb2dnZXI9bG9nNGpzLmdldExvZ2dlcignVXNlciBDb250cm9sbGVyJyk7XG4gIGxvZ2dlci5pbmZvKCdJbml0aWFsaXphdGlvbiBpbmZvJyk7XG4gIGxvZ2dlci5lcnJvcignSW5pdGlhbGl6YXRpb24gZXJyb3InKTtcbiAgbG9nZ2VyLmRlYnVnKCdJbml0aWFsaXphdGlvbiBkZWJ1ZycpO1xuXG5cblxuICBwcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIGZ1bmN0aW9uIChlcnI6YW55KSB7XG4gICAgbGV0IF9sb2dnZXJTZXJ2aWNlOiBMb2dnZXJTZXJ2aWNlID0gbmV3IExvZ2dlclNlcnZpY2UoJ3VuY2F1Z2h0IGV4Y2VwdGlvbiBIYW5kbGVyJyk7XG4gICAgbGV0IGVycm9yPSB7XG4gICAgICByZWFzb246ICd1bmNhdWdodCBleGNlcHRpb24nLFxuICAgICAgbWVzc2FnZTogZXJyLFxuICAgICAgc3RhY2s6IGVyci5zdGFjayxcbiAgICAgIGNvZGU6IDUwMFxuICAgIH07XG4gICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgX2xvZ2dlclNlcnZpY2UubG9nRXJyb3IoJ0NhdGNoaW5nIHVuY2F1Z2h0IEV4Y2VwdGlvbnMuIDogJyArZXJyKTtcbiAgICBfbG9nZ2VyU2VydmljZS5sb2dFcnJvcignQ2F0Y2hpbmcgdW5jYXVnaHQgRXhjZXB0aW9ucyBzdGFjayA6ICcgK2Vyci5zdGFjayk7XG4gICAgLy9zaGFyZWRTZXJ2aWNlLmVycm9ySGFuZGxlcihlcnJvcik7XG4gICAgc2hhcmVkU2VydmljZS5tYWlsVG9BZG1pbihlcnJvcik7XG4gIH0pO1xuXG4gIGxldCBzeW5jQXRFdmVyeUZpZnRlZW5NaW51dGUgPSBuZXcgQ3JvbkpvYignMDAgKi81ICogKiAqIConLCBmdW5jdGlvbigpIHtcblxuICAgICAgbGV0IHJhdGVBbmFseXNpc1NlcnZpY2VzOiBSYXRlQW5hbHlzaXNTZXJ2aWNlID0gbmV3IFJhdGVBbmFseXNpc1NlcnZpY2UoKTtcbiAgICAgIC8vcmF0ZUFuYWx5c2lzU2VydmljZXMuU3luY1JhdGVBbmFseXNpcygpO1xuXG4gICAgICAvKmxldCB1c2VyU2VydmljZSA6IFVzZXJTZXJ2aWNlID0gbmV3IFVzZXJTZXJ2aWNlKCk7XG4gICAgICBsZXQgX2xvZ2dlclNlcnZpY2U6IExvZ2dlclNlcnZpY2UgPSBuZXcgTG9nZ2VyU2VydmljZSgndW5jYXVnaHQgZXhjZXB0aW9uIEhhbmRsZXInKTtcbiAgICAgIHVzZXJTZXJ2aWNlLnNlbmRQcm9qZWN0RXhwaXJ5V2FybmluZ01haWxzKChlcnJvciwgc3VjY2VzcykgPT4ge1xuICAgICAgICBpZihlcnJvcikge1xuICAgICAgICAgIF9sb2dnZXJTZXJ2aWNlLmxvZ0Vycm9yKCdFcnJvciBpbiBzZW5kUHJvamVjdEV4cGlyeVdhcm5pbmdNYWlsIGZvciB1c2VycyA6ICcgK2Vycm9yKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBfbG9nZ2VyU2VydmljZS5sb2dEZWJ1ZygnUHJvamVjdEV4cGlyeVdhcm5pbmdNYWlsIHNlbmQgc3VjY2Vzc2Z1bGx5IHRvIGFsbCB1c2Vycy4nKTtcbiAgICAgICAgfVxuICAgICAgfSk7Ki9cblxuICAgIH0sIGZ1bmN0aW9uICgpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdyZXN0YXJ0IHNlcnZlcicpO1xuICAgIH0sXG4gICAgdHJ1ZVxuICApO1xuICBzeW5jQXRFdmVyeUZpZnRlZW5NaW51dGUuc3RhcnQoKTtcblxuXG4gIGxldCBzZW5kUHJvamVjdEV4cGlyeVdhcm5pbmdNYWlsID0gbmV3IENyb25Kb2IoJzAwICovMiAwICogKiAqJywgZnVuY3Rpb24oKSB7XG4gIC8vbGV0IHNlbmRQcm9qZWN0RXhwaXJ5V2FybmluZ01haWwgPSBuZXcgQ3JvbkpvYignMDAgMDAgMDEgKiAqIConLCBmdW5jdGlvbigpIHtcbiAgICAgIGxldCB1c2VyU2VydmljZSA6IFVzZXJTZXJ2aWNlID0gbmV3IFVzZXJTZXJ2aWNlKCk7XG4gICAgICBsZXQgX2xvZ2dlclNlcnZpY2U6IExvZ2dlclNlcnZpY2UgPSBuZXcgTG9nZ2VyU2VydmljZSgnc2VuZFByb2plY3RFeHBpcnlXYXJuaW5nTWFpbCcpO1xuICAgICAgX2xvZ2dlclNlcnZpY2UubG9nRGVidWcoJ1Byb2plY3RFeHBpcnlXYXJuaW5nTWFpbCBzdGFydGVkLicpO1xuICAgICAgdXNlclNlcnZpY2Uuc2VuZFByb2plY3RFeHBpcnlXYXJuaW5nTWFpbHMoKGVycm9yLCBzdWNjZXNzKSA9PiB7XG4gICAgICAgIGlmKGVycm9yKSB7XG4gICAgICAgICAgX2xvZ2dlclNlcnZpY2UubG9nRXJyb3IoJ0Vycm9yIGluIHNlbmRQcm9qZWN0RXhwaXJ5V2FybmluZ01haWwgZm9yIHVzZXJzIDogJyArZXJyb3IpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIF9sb2dnZXJTZXJ2aWNlLmxvZ0RlYnVnKCdQcm9qZWN0RXhwaXJ5V2FybmluZ01haWwgc2VuZCBzdWNjZXNzZnVsbHkgdG8gYWxsIHVzZXJzLicpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9LCBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zb2xlLmxvZygncmVzdGFydCBzZXJ2ZXInKTtcbiAgICB9LFxuICAgIHRydWVcbiAgKTtcblxuICBzZW5kUHJvamVjdEV4cGlyeVdhcm5pbmdNYWlsLnN0YXJ0KCk7XG4gIC8vbG9nZ2VyIGxvZzRqcyBpbml0aWFsaXphdGlvblxuICAvKlxuICAgIGNvbnNvbGUubG9nKCdMb2dnZXIgSW5pdGlhbGl6YXRpb24nKTtcblxuICAgdmFyIGxvZ0NvbmZpZz1jb25maWcuZ2V0KCdsb2dnZXInKTtcblxuICAgIGNvbnNvbGUubG9nKCdMb2dnZXIgSW5pdGlhbGl6YXRpb24gMScpO1xuXG4gICB2YXIgbG9nZ2VyTGV2ZWw9Y29uZmlnLmdldCgnbG9nZ2VyLmxldmVscy5bYWxsXScpO1xuXG4gICAgY29uc29sZS5sb2coJ0xvZ2dlciBJbml0aWFsaXphdGlvbiAyJyk7XG5cbiAgICB2YXIgbG9nZ2VyID0gbG9nNGpzLmdldExvZ2dlcihsb2dnZXJMZXZlbCk7IC8vIGluaXRpYWxpemUgdGhlIHZhciB0byB1c2UuXG5cbiAgICBjb25zb2xlLmxvZygnTG9nZ2VyIEluaXRpYWxpemF0aW9uIGNvbXBsZXRlZCcpO1xuXG4gICAgbG9nZ2VyLmluZm8oJ1RoaXMgaXMgSW5mb3JtYXRpb24gTG9nZ2VyJyk7XG4gICAgbG9nZ2VyLmVycm9yKCdUaGlzIGlzIEVycm9yIExvZ2dlcicpO1xuICAgIGxvZ2dlci5kZWJ1ZygnVGhpcyBpcyBEZWJ1Z2dlcicpO1xuXG4gICAgY29uc29sZS5sb2coJ0xvZ2dlciBhcHBlbmRlZCBpbiBmaWxlJyk7Ki9cbiAgLyoqXG4gICAqIERldiBNb2RlLlxuICAgKiBAbm90ZSBEZXYgc2VydmVyIHdpbGwgb25seSBnaXZlIGZvciB5b3UgbWlkZGxld2FyZS5cbiAgICovXG4gIGlmIChtb2RlID09PSAnZGV2Jykge1xuICAgIGlmIChkaXN0X3J1bm5lciA9PT0gJ2Rpc3QnKSB7XG4gICAgICBhcHAuYWxsKCcvKicsIGZ1bmN0aW9uIChyZXEsIHJlcywgbmV4dCkge1xuICAgICAgICByZXMuaGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nLCAnKicpO1xuICAgICAgICByZXMuaGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJywgJ1gtUmVxdWVzdGVkLVdpdGgnKTtcbiAgICAgICAgbmV4dCgpO1xuICAgICAgfSk7XG5cbiAgICAgIGFwcC51c2UoTWlkZGxld2FyZXMuY29uZmlndXJhdGlvbik7XG5cbiAgICAgIGxldCByb290ID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCkpO1xuICAgICAgbGV0IGNsaWVudFJvb3QgPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgJy4vY2xpZW50L2RldicpO1xuICAgICAgYXBwLnVzZShleHByZXNzLnN0YXRpYyhyb290KSk7XG4gICAgICBhcHAudXNlKGV4cHJlc3Muc3RhdGljKGNsaWVudFJvb3QpKTtcbiAgICAgIF9zZXJ2ZXJEaXIgPSAnL2Rpc3Qvc2VydmVyL2Rldic7XG4gICAgICBhcHAudXNlKCcvcHVibGljJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSArIF9zZXJ2ZXJEaXIgKycvcHVibGljJykpKTtcbiAgICAgIHZhciByZW5kZXJJbmRleCA9IChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSA9PiB7XG4gICAgICAgIF9jbGllbnREaXIgPSAnL2NsaWVudC9kZXYnO1xuICAgICAgICByZXMuc2VuZEZpbGUocGF0aC5yZXNvbHZlKF9fZGlybmFtZSArIF9jbGllbnREaXIgKyAnL2luZGV4Lmh0bWwnKSk7XG4gICAgICB9O1xuICAgICAgYXBwLmdldCgnLyonLCByZW5kZXJJbmRleCk7XG4gICAgICAvKipcbiAgICAgICAqIEFwaSBSb3V0ZXMgZm9yIGBEZXZlbG9wbWVudGAuXG4gICAgICAgKi9cbiAgICB9IGVsc2Uge1xuICAgICAgYXBwLmFsbCgnLyonLCBmdW5jdGlvbiAocmVxLCByZXMsIG5leHQpIHtcbiAgICAgICAgcmVzLmhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJywgJyonKTtcbiAgICAgICAgcmVzLmhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycycsICdYLVJlcXVlc3RlZC1XaXRoJyk7XG4gICAgICAgIG5leHQoKTtcbiAgICAgIH0pO1xuXG4gICAgICAvKnJvdXRlcy5pbml0KGFwcCk7Ki9cbiAgICAgIGFwcC51c2UoTWlkZGxld2FyZXMuY29uZmlndXJhdGlvbik7XG4gICAgICAvL2NuZXh0Um91dGVzLmNuZXh0SW5pdChhcHApO1xuXG4gICAgICBsZXQgcm9vdCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpKTtcbiAgICAgIGxldCBjbGllbnRSb290ID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksICcuL2Rpc3QvY2xpZW50L2RldicpO1xuICAgICAgYXBwLnVzZShleHByZXNzLnN0YXRpYyhyb290KSk7XG4gICAgICBhcHAudXNlKGV4cHJlc3Muc3RhdGljKGNsaWVudFJvb3QpKTtcbiAgICAgIF9zZXJ2ZXJEaXIgPSAnL2Rpc3Qvc2VydmVyL2Rldic7XG4gICAgICBhcHAudXNlKCcvcHVibGljJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSsgX3NlcnZlckRpciArJy9wdWJsaWMnKSkpO1xuICAgICAgbGV0IHJlbmRlckluZGV4ID0gKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpID0+IHtcbiAgICAgICAgX2NsaWVudERpciA9ICcvZGlzdC9jbGllbnQvZGV2JztcbiAgICAgICAgcmVzLnNlbmRGaWxlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUgKyBfY2xpZW50RGlyICsgJy9pbmRleC5odG1sJykpO1xuICAgICAgfTtcbiAgICAgIGFwcC5nZXQoJy8qJywgcmVuZGVySW5kZXgpO1xuICAgICAgLyoqXG4gICAgICAgKiBBcGkgUm91dGVzIGZvciBgRGV2ZWxvcG1lbnRgLlxuICAgICAgICovXG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGlmKGRpc3RfcnVubmVyID09PSAnZGlzdCcpIHtcbiAgICAgIC8qKlxuICAgICAgICogUHJvZCBNb2RlLlxuICAgICAgICogQG5vdGUgUHJvZCBtb2Qgd2lsbCBnaXZlIHlvdSBzdGF0aWMgKyBtaWRkbGV3YXJlLlxuICAgICAgICovXG5cbiAgICAgIC8qKlxuICAgICAgICogQXBpIFJvdXRlcyBmb3IgYFByb2R1Y3Rpb25gLlxuICAgICAgICovXG4gICAgICAvKnJvdXRlcy5pbml0KGFwcCk7Ki9cbiAgICAgIC8qY25leHRSb3V0ZXMuY25leHRJbml0KGFwcCk7Ki9cbiAgICAgIC8qKlxuICAgICAgICogQ2xpZW50IERpclxuICAgICAgICovXG4gICAgICBfY2xpZW50RGlyID0gJy4vY2xpZW50L3Byb2QnO1xuICAgICAgX3NlcnZlckRpciA9ICcvc2VydmVyL3Byb2QnO1xuXG4gICAgICAvKipcbiAgICAgICAqIFN0YXRpYy5cbiAgICAgICAqL1xuICAgICAgYXBwLnVzZSgnL2pzJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgX2NsaWVudERpciArICcvanMnKSkpO1xuICAgICAgYXBwLnVzZSgnL2NzcycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIF9jbGllbnREaXIgKyAnL2NzcycpKSk7XG4gICAgICBhcHAudXNlKCcvYXNzZXRzJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgX2NsaWVudERpciArICcvYXNzZXRzJykpKTtcbiAgICAgIGFwcC51c2UoJy9iYW5uZXJzJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgX2NsaWVudERpciArICcvYmFubmVycycpKSk7XG4gICAgICBhcHAudXNlKCcvcHVibGljJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSsgX3NlcnZlckRpciArICcvcHVibGljJykpKTtcblxuXG4gICAgICAvKipcbiAgICAgICAqIFNwYSBSZXMgU2VuZGVyLlxuICAgICAgICogQHBhcmFtIHJlcSB7YW55fVxuICAgICAgICogQHBhcmFtIHJlcyB7YW55fVxuICAgICAgICovXG4gICAgICB2YXIgcmVuZGVySW5kZXggPSBmdW5jdGlvbiAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkge1xuICAgICAgICBfY2xpZW50RGlyID0gJy9jbGllbnQvcHJvZCc7XG4gICAgICAgIHJlcy5zZW5kRmlsZShwYXRoLnJlc29sdmUoX19kaXJuYW1lICsgX2NsaWVudERpciArICcvaW5kZXguaHRtbCcpKTtcbiAgICAgIH07XG5cbiAgICAgIC8vYXBwLmdldCgnKicsIGZ1bmN0aW9uKHJlcSxyZXMpIHtcbiAgICAgIC8vICByZXMuc2VuZEZpbGUocHJvY2Vzcy5jd2QoKSArICcvZGlzdC9wcm9kL2NsaWVudC9pbmRleC5odG1sJyk7XG4gICAgICAvL30pO1xuXG4gICAgICAvKipcbiAgICAgICAqIFByZXZlbnQgc2VydmVyIHJvdXRpbmcgYW5kIHVzZSBAbmcyLXJvdXRlci5cbiAgICAgICAqL1xuICAgICAgYXBwLmdldCgnLyonLCByZW5kZXJJbmRleCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8qKlxuICAgICAgICogUHJvZCBNb2RlLlxuICAgICAgICogQG5vdGUgUHJvZCBtb2Qgd2lsbCBnaXZlIHlvdSBzdGF0aWMgKyBtaWRkbGV3YXJlLlxuICAgICAgICovXG5cbiAgICAgIC8qKlxuICAgICAgICogQXBpIFJvdXRlcyBmb3IgYFByb2R1Y3Rpb25gLlxuICAgICAgICovXG4gICAgICBhcHAudXNlKE1pZGRsZXdhcmVzLmNvbmZpZ3VyYXRpb24pO1xuICAgICAgLyoqXG4gICAgICAgKiBDbGllbnQgRGlyXG4gICAgICAgKi9cbiAgICAgIF9jbGllbnREaXIgPSAnLi9kaXN0L2NsaWVudC9wcm9kJztcbiAgICAgIF9zZXJ2ZXJEaXIgPSAnL2Rpc3Qvc2VydmVyL3Byb2QnO1xuXG4gICAgICAvKipcbiAgICAgICAqIFN0YXRpYy5cbiAgICAgICAqL1xuICAgICAgYXBwLnVzZSgnL2pzJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgX2NsaWVudERpciArICcvanMnKSkpO1xuICAgICAgYXBwLnVzZSgnL2NzcycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIF9jbGllbnREaXIgKyAnL2NzcycpKSk7XG4gICAgICBhcHAudXNlKCcvYXNzZXRzJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgX2NsaWVudERpciArICcvYXNzZXRzJykpKTtcbiAgICAgIGFwcC51c2UoJy9iYW5uZXJzJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgX2NsaWVudERpciArICcvYmFubmVycycpKSk7XG4gICAgICBhcHAudXNlKCcvcHVibGljJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSsgX3NlcnZlckRpcisnL3B1YmxpYycpKSk7XG5cbiAgICAgIC8qKlxuICAgICAgICogU3BhIFJlcyBTZW5kZXIuXG4gICAgICAgKiBAcGFyYW0gcmVxIHthbnl9XG4gICAgICAgKiBAcGFyYW0gcmVzIHthbnl9XG4gICAgICAgKi9cbiAgICAgIHZhciByZW5kZXJJbmRleCA9IGZ1bmN0aW9uIChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSB7XG4gICAgICAgIF9jbGllbnREaXIgPSAnL2Rpc3QvY2xpZW50L3Byb2QnO1xuICAgICAgICByZXMuc2VuZEZpbGUocGF0aC5yZXNvbHZlKF9fZGlybmFtZSArIF9jbGllbnREaXIgKyAnL2luZGV4Lmh0bWwnKSk7XG4gICAgICB9O1xuXG4gICAgICAvL2FwcC5nZXQoJyonLCBmdW5jdGlvbihyZXEscmVzKSB7XG4gICAgICAvLyAgcmVzLnNlbmRGaWxlKHByb2Nlc3MuY3dkKCkgKyAnL2Rpc3QvcHJvZC9jbGllbnQvaW5kZXguaHRtbCcpO1xuICAgICAgLy99KTtcblxuICAgICAgLyoqXG4gICAgICAgKiBQcmV2ZW50IHNlcnZlciByb3V0aW5nIGFuZCB1c2UgQG5nMi1yb3V0ZXIuXG4gICAgICAgKi9cbiAgICAgIGFwcC5nZXQoJy8qJywgcmVuZGVySW5kZXgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZXJ2ZXIgd2l0aCBnemlwIGNvbXByZXNzaW9uLlxuICAgKi9cbiAgLy9IVFRQIFNUQVJUOlxuICBpZiAocHJvdG9jb2wgPT09ICdodHRwJykge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxodHRwLlNlcnZlcj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgbGV0IHNlcnZlciA9IGFwcC5saXN0ZW4ocG9ydCwgKCkgPT4ge1xuICAgICAgICB2YXIgcG9ydCA9IHNlcnZlci5hZGRyZXNzKCkucG9ydDtcbiAgICAgICAgY29uc29sZS5sb2coJ0FwcCBpcyBsaXN0ZW5pbmcgb24gcG9ydDonICsgcG9ydCk7XG4gICAgICAgIHJlc29sdmUoc2VydmVyKTtcbiAgICAgIH0pO1xuICAgICAgc2VydmVyLnRpbWVvdXQgPSA2MDAwMDA7IC8vYnkgZGVmYXVsdCB0aW1lb3V0IHNldCB0byAxMCBtaW4gZm9yIGV4cG9ydCBmdW5jdGlvbmFsaXR5XG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIC8vIGtleTogZnMucmVhZEZpbGVTeW5jKCcuL3N0YWdpbmcuam9ibW9zaXMuY29tLmtleScpLFxuICAgICAgLy8gY2VydDogZnMucmVhZEZpbGVTeW5jKCcuL3N0YWdpbmcuam9ibW9zaXMuY29tLmNydCcpLFxuICAgICAgaGFuZHNoYWtlVGltZW91dDogNjAwMDAwLCAvL2J5IGRlZmF1bHQgdGltZW91dCBzZXQgdG8gMTAgbWluIGZvciBleHBvcnQgZnVuY3Rpb25hbGl0eSwgTmVlZCB0byB0ZXN0IHRoaXNcbiAgICAgIHBhc3NwaHJhc2U6ICd0cGwxMjMnLFxuICAgICAgc3BkeToge1xuICAgICAgICBwcm90b2NvbHM6IFsnaDInXVxuICAgICAgfVxuICAgIH07XG5cbiAgICByZXR1cm4gc3BkeS5jcmVhdGVTZXJ2ZXIob3B0aW9ucywgYXBwKVxuICAgICAgLmxpc3Rlbihwb3J0LCAoZXJyb3I6IGFueSkgPT4ge1xuICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKVxuICAgICAgICAgIC8vIHJldHVybiBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdodHRwMiBMaXN0ZW5pbmcgb24gcG9ydDogJyArIHBvcnQgKyAnLicpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfVxufVxuIl19
