"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var express = require("express");
var path = require("path");
var LoggerService = require("./app/framework/shared/logger/LoggerService");
var sharedService = require("./app/framework/shared/logger/shared.service");
var Middlewares = require("./app/framework/middlewares/base/MiddlewaresBase");
var RateAnalysisService = require("./app/applicationProject/services/RateAnalysisService");
var UserService = require("./app/framework/services/UserService");
var log4js = require('log4js');
var config = require('config');
var spdy = require('spdy');
__dirname = './';
var _clientDir = '/dist/client/dev';
var _serverDir = '/dist/server/dev';
var app = express();
var CronJob = require('cron').CronJob;
function init(port, mode, protocol, dist_runner) {
    var loggerConfig = config.get('logger');
    log4js.configure(loggerConfig);
    var loggerCategory = config.get('logger.levels.[all]');
    var logger = log4js.getLogger('User Controller');
    logger.info('Initialization info');
    logger.error('Initialization error');
    logger.debug('Initialization debug');
    process.on('uncaughtException', function (err) {
        var _loggerService = new LoggerService('uncaught exception Handler');
        var error = {
            reason: 'uncaught exception',
            message: err,
            stack: err.stack,
            code: 500
        };
        console.error(error);
        _loggerService.logError('Catching uncaught Exceptions. : ' + err);
        _loggerService.logError('Catching uncaught Exceptions stack : ' + err.stack);
        sharedService.mailToAdmin(error);
    });
    var syncAtEveryFifteenMinute = new CronJob('00 */15 * * * *', function () {
        var rateAnalysisServices = new RateAnalysisService();
        rateAnalysisServices.syncAllRegions();
    }, function () {
        console.log('restart server');
    }, true);
    syncAtEveryFifteenMinute.start();
    var sendProjectExpiryWarningMail = new CronJob('00 55 23 * * *', function () {
        logger.debug('sendProjectExpiryWarningMail in debug mode');
        var userService = new UserService();
        var _loggerService = new LoggerService('sendProjectExpiryWarningMail');
        _loggerService.logDebug('ProjectExpiryWarningMail started.');
        userService.sendProjectExpiryWarningMails(function (error, success) {
            if (error) {
                _loggerService.logError('Error in sendProjectExpiryWarningMail for users : ' + error);
            }
            else {
                _loggerService.logDebug('ProjectExpiryWarningMail send successfully to all users.');
            }
        });
    }, function () {
        console.log('restart server');
    }, true);
    console.log('sendProjectExpiryWarningMail status : before :', sendProjectExpiryWarningMail.running);
    sendProjectExpiryWarningMail.start();
    console.log('sendProjectExpiryWarningMail status : after :', sendProjectExpiryWarningMail.running);
    if (mode === 'dev') {
        if (dist_runner === 'dist') {
            app.all('/*', function (req, res, next) {
                res.header('Access-Control-Allow-Origin', '*');
                res.header('Access-Control-Allow-Headers', 'X-Requested-With');
                next();
            });
            app.use(Middlewares.configuration);
            var root = path.resolve(process.cwd());
            var clientRoot = path.resolve(process.cwd(), './client/dev');
            app.use(express.static(root));
            app.use(express.static(clientRoot));
            _serverDir = '/dist/server/dev';
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/client/dev';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
        else {
            app.all('/*', function (req, res, next) {
                res.header('Access-Control-Allow-Origin', '*');
                res.header('Access-Control-Allow-Headers', 'X-Requested-With');
                next();
            });
            app.use(Middlewares.configuration);
            var root = path.resolve(process.cwd());
            var clientRoot = path.resolve(process.cwd(), './dist/client/dev');
            app.use(express.static(root));
            app.use(express.static(clientRoot));
            _serverDir = '/dist/server/dev';
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex_1 = function (req, res) {
                _clientDir = '/dist/client/dev';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex_1);
        }
    }
    else {
        if (dist_runner === 'dist') {
            _clientDir = './client/prod';
            _serverDir = '/server/prod';
            app.use('/js', express.static(path.resolve(__dirname, _clientDir + '/js')));
            app.use('/css', express.static(path.resolve(__dirname, _clientDir + '/css')));
            app.use('/assets', express.static(path.resolve(__dirname, _clientDir + '/assets')));
            app.use('/banners', express.static(path.resolve(__dirname, _clientDir + '/banners')));
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/client/prod';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
        else {
            app.use(Middlewares.configuration);
            _clientDir = './dist/client/prod';
            _serverDir = '/dist/server/prod';
            app.use('/js', express.static(path.resolve(__dirname, _clientDir + '/js')));
            app.use('/css', express.static(path.resolve(__dirname, _clientDir + '/css')));
            app.use('/assets', express.static(path.resolve(__dirname, _clientDir + '/assets')));
            app.use('/banners', express.static(path.resolve(__dirname, _clientDir + '/banners')));
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/dist/client/prod';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
    }
    if (protocol === 'http') {
        return new Promise(function (resolve, reject) {
            var server = app.listen(port, function () {
                var port = server.address().port;
                console.log('App is listening on port:' + port);
                resolve(server);
            });
            server.timeout = 600000;
        });
    }
    else {
        var options = {
            handshakeTimeout: 600000,
            passphrase: 'tpl123',
            spdy: {
                protocols: ['h2']
            }
        };
        return spdy.createServer(options, app)
            .listen(port, function (error) {
            if (error) {
                console.error(error);
                process.exit(1);
            }
            else {
                console.log('http2 Listening on port: ' + port + '.');
            }
        });
    }
}
exports.init = init;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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bmltcG9ydCAqIGFzIGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IExvZ2dlclNlcnZpY2UgPSByZXF1aXJlKCcuL2FwcC9mcmFtZXdvcmsvc2hhcmVkL2xvZ2dlci9Mb2dnZXJTZXJ2aWNlJyk7XG5pbXBvcnQgKiBhcyBzaGFyZWRTZXJ2aWNlIGZyb20gJy4vYXBwL2ZyYW1ld29yay9zaGFyZWQvbG9nZ2VyL3NoYXJlZC5zZXJ2aWNlJztcbmltcG9ydCBNaWRkbGV3YXJlcyA9IHJlcXVpcmUoJy4vYXBwL2ZyYW1ld29yay9taWRkbGV3YXJlcy9iYXNlL01pZGRsZXdhcmVzQmFzZScpO1xuaW1wb3J0IFJhdGVBbmFseXNpc1NlcnZpY2UgPSByZXF1aXJlKCcuL2FwcC9hcHBsaWNhdGlvblByb2plY3Qvc2VydmljZXMvUmF0ZUFuYWx5c2lzU2VydmljZScpO1xuaW1wb3J0IFVzZXJTZXJ2aWNlID0gcmVxdWlyZSgnLi9hcHAvZnJhbWV3b3JrL3NlcnZpY2VzL1VzZXJTZXJ2aWNlJyk7XG52YXIgbG9nNGpzID0gcmVxdWlyZSgnbG9nNGpzJyk7XG52YXIgY29uZmlnID0gcmVxdWlyZSgnY29uZmlnJyk7XG5cbnZhciBzcGR5ID0gcmVxdWlyZSgnc3BkeScpO1xuX19kaXJuYW1lID0gJy4vJztcbnZhciBfY2xpZW50RGlyID0gJy9kaXN0L2NsaWVudC9kZXYnO1xudmFyIF9zZXJ2ZXJEaXIgPSAnL2Rpc3Qvc2VydmVyL2Rldic7XG52YXIgYXBwID0gZXhwcmVzcygpO1xudmFyIENyb25Kb2IgPSByZXF1aXJlKCdjcm9uJykuQ3JvbkpvYjtcblxuZXhwb3J0IGZ1bmN0aW9uIGluaXQocG9ydDogbnVtYmVyLCBtb2RlOiBzdHJpbmcsIHByb3RvY29sOiBzdHJpbmcsIGRpc3RfcnVubmVyOiBzdHJpbmcpIHtcblxuXG5cblxuXG4gIHZhciBsb2dnZXJDb25maWc9Y29uZmlnLmdldCgnbG9nZ2VyJyk7XG5cbiAgbG9nNGpzLmNvbmZpZ3VyZShsb2dnZXJDb25maWcpO1xuICB2YXIgbG9nZ2VyQ2F0ZWdvcnkgPWNvbmZpZy5nZXQoJ2xvZ2dlci5sZXZlbHMuW2FsbF0nKVxuICB2YXIgbG9nZ2VyPWxvZzRqcy5nZXRMb2dnZXIoJ1VzZXIgQ29udHJvbGxlcicpO1xuICBsb2dnZXIuaW5mbygnSW5pdGlhbGl6YXRpb24gaW5mbycpO1xuICBsb2dnZXIuZXJyb3IoJ0luaXRpYWxpemF0aW9uIGVycm9yJyk7XG4gIGxvZ2dlci5kZWJ1ZygnSW5pdGlhbGl6YXRpb24gZGVidWcnKTtcblxuXG5cbiAgcHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb24nLCBmdW5jdGlvbiAoZXJyOmFueSkge1xuICAgIGxldCBfbG9nZ2VyU2VydmljZTogTG9nZ2VyU2VydmljZSA9IG5ldyBMb2dnZXJTZXJ2aWNlKCd1bmNhdWdodCBleGNlcHRpb24gSGFuZGxlcicpO1xuICAgIGxldCBlcnJvcj0ge1xuICAgICAgcmVhc29uOiAndW5jYXVnaHQgZXhjZXB0aW9uJyxcbiAgICAgIG1lc3NhZ2U6IGVycixcbiAgICAgIHN0YWNrOiBlcnIuc3RhY2ssXG4gICAgICBjb2RlOiA1MDBcbiAgICB9O1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgIF9sb2dnZXJTZXJ2aWNlLmxvZ0Vycm9yKCdDYXRjaGluZyB1bmNhdWdodCBFeGNlcHRpb25zLiA6ICcgK2Vycik7XG4gICAgX2xvZ2dlclNlcnZpY2UubG9nRXJyb3IoJ0NhdGNoaW5nIHVuY2F1Z2h0IEV4Y2VwdGlvbnMgc3RhY2sgOiAnICtlcnIuc3RhY2spO1xuICAgIC8vc2hhcmVkU2VydmljZS5lcnJvckhhbmRsZXIoZXJyb3IpO1xuICAgIHNoYXJlZFNlcnZpY2UubWFpbFRvQWRtaW4oZXJyb3IpO1xuICB9KTtcblxuICBsZXQgc3luY0F0RXZlcnlGaWZ0ZWVuTWludXRlID0gbmV3IENyb25Kb2IoJzAwICovMTUgKiAqICogKicsIGZ1bmN0aW9uKCkge1xuXG4gICAgICBsZXQgcmF0ZUFuYWx5c2lzU2VydmljZXM6IFJhdGVBbmFseXNpc1NlcnZpY2UgPSBuZXcgUmF0ZUFuYWx5c2lzU2VydmljZSgpO1xuICAgICAgcmF0ZUFuYWx5c2lzU2VydmljZXMuc3luY0FsbFJlZ2lvbnMoKTtcblxuICAgIH0sIGZ1bmN0aW9uICgpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdyZXN0YXJ0IHNlcnZlcicpO1xuICAgIH0sXG4gICAgdHJ1ZVxuICApO1xuICBzeW5jQXRFdmVyeUZpZnRlZW5NaW51dGUuc3RhcnQoKTtcblxuXG4gIGxldCBzZW5kUHJvamVjdEV4cGlyeVdhcm5pbmdNYWlsID0gbmV3IENyb25Kb2IoJzAwIDU1IDIzICogKiAqJywgZnVuY3Rpb24oKSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ3NlbmRQcm9qZWN0RXhwaXJ5V2FybmluZ01haWwgaW4gZGVidWcgbW9kZScpO1xuICAgICAgbGV0IHVzZXJTZXJ2aWNlIDogVXNlclNlcnZpY2UgPSBuZXcgVXNlclNlcnZpY2UoKTtcbiAgICAgIGxldCBfbG9nZ2VyU2VydmljZTogTG9nZ2VyU2VydmljZSA9IG5ldyBMb2dnZXJTZXJ2aWNlKCdzZW5kUHJvamVjdEV4cGlyeVdhcm5pbmdNYWlsJyk7XG4gICAgICBfbG9nZ2VyU2VydmljZS5sb2dEZWJ1ZygnUHJvamVjdEV4cGlyeVdhcm5pbmdNYWlsIHN0YXJ0ZWQuJyk7XG4gICAgICB1c2VyU2VydmljZS5zZW5kUHJvamVjdEV4cGlyeVdhcm5pbmdNYWlscygoZXJyb3IsIHN1Y2Nlc3MpID0+IHtcbiAgICAgICAgaWYoZXJyb3IpIHtcbiAgICAgICAgICBfbG9nZ2VyU2VydmljZS5sb2dFcnJvcignRXJyb3IgaW4gc2VuZFByb2plY3RFeHBpcnlXYXJuaW5nTWFpbCBmb3IgdXNlcnMgOiAnICtlcnJvcik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgX2xvZ2dlclNlcnZpY2UubG9nRGVidWcoJ1Byb2plY3RFeHBpcnlXYXJuaW5nTWFpbCBzZW5kIHN1Y2Nlc3NmdWxseSB0byBhbGwgdXNlcnMuJyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0sIGZ1bmN0aW9uICgpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdyZXN0YXJ0IHNlcnZlcicpO1xuICAgIH0sXG4gICAgdHJ1ZVxuICApO1xuXG4gIGNvbnNvbGUubG9nKCdzZW5kUHJvamVjdEV4cGlyeVdhcm5pbmdNYWlsIHN0YXR1cyA6IGJlZm9yZSA6Jywgc2VuZFByb2plY3RFeHBpcnlXYXJuaW5nTWFpbC5ydW5uaW5nKTtcbiAgc2VuZFByb2plY3RFeHBpcnlXYXJuaW5nTWFpbC5zdGFydCgpO1xuICBjb25zb2xlLmxvZygnc2VuZFByb2plY3RFeHBpcnlXYXJuaW5nTWFpbCBzdGF0dXMgOiBhZnRlciA6Jywgc2VuZFByb2plY3RFeHBpcnlXYXJuaW5nTWFpbC5ydW5uaW5nKTtcbiAgLy9sb2dnZXIgbG9nNGpzIGluaXRpYWxpemF0aW9uXG4gIC8qXG4gICAgY29uc29sZS5sb2coJ0xvZ2dlciBJbml0aWFsaXphdGlvbicpO1xuXG4gICB2YXIgbG9nQ29uZmlnPWNvbmZpZy5nZXQoJ2xvZ2dlcicpO1xuXG4gICAgY29uc29sZS5sb2coJ0xvZ2dlciBJbml0aWFsaXphdGlvbiAxJyk7XG5cbiAgIHZhciBsb2dnZXJMZXZlbD1jb25maWcuZ2V0KCdsb2dnZXIubGV2ZWxzLlthbGxdJyk7XG5cbiAgICBjb25zb2xlLmxvZygnTG9nZ2VyIEluaXRpYWxpemF0aW9uIDInKTtcblxuICAgIHZhciBsb2dnZXIgPSBsb2c0anMuZ2V0TG9nZ2VyKGxvZ2dlckxldmVsKTsgLy8gaW5pdGlhbGl6ZSB0aGUgdmFyIHRvIHVzZS5cblxuICAgIGNvbnNvbGUubG9nKCdMb2dnZXIgSW5pdGlhbGl6YXRpb24gY29tcGxldGVkJyk7XG5cbiAgICBsb2dnZXIuaW5mbygnVGhpcyBpcyBJbmZvcm1hdGlvbiBMb2dnZXInKTtcbiAgICBsb2dnZXIuZXJyb3IoJ1RoaXMgaXMgRXJyb3IgTG9nZ2VyJyk7XG4gICAgbG9nZ2VyLmRlYnVnKCdUaGlzIGlzIERlYnVnZ2VyJyk7XG5cbiAgICBjb25zb2xlLmxvZygnTG9nZ2VyIGFwcGVuZGVkIGluIGZpbGUnKTsqL1xuICAvKipcbiAgICogRGV2IE1vZGUuXG4gICAqIEBub3RlIERldiBzZXJ2ZXIgd2lsbCBvbmx5IGdpdmUgZm9yIHlvdSBtaWRkbGV3YXJlLlxuICAgKi9cbiAgaWYgKG1vZGUgPT09ICdkZXYnKSB7XG4gICAgaWYgKGRpc3RfcnVubmVyID09PSAnZGlzdCcpIHtcbiAgICAgIGFwcC5hbGwoJy8qJywgZnVuY3Rpb24gKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgICAgIHJlcy5oZWFkZXIoJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicsICcqJyk7XG4gICAgICAgIHJlcy5oZWFkZXIoJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnLCAnWC1SZXF1ZXN0ZWQtV2l0aCcpO1xuICAgICAgICBuZXh0KCk7XG4gICAgICB9KTtcblxuICAgICAgYXBwLnVzZShNaWRkbGV3YXJlcy5jb25maWd1cmF0aW9uKTtcblxuICAgICAgbGV0IHJvb3QgPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSk7XG4gICAgICBsZXQgY2xpZW50Um9vdCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCAnLi9jbGllbnQvZGV2Jyk7XG4gICAgICBhcHAudXNlKGV4cHJlc3Muc3RhdGljKHJvb3QpKTtcbiAgICAgIGFwcC51c2UoZXhwcmVzcy5zdGF0aWMoY2xpZW50Um9vdCkpO1xuICAgICAgX3NlcnZlckRpciA9ICcvZGlzdC9zZXJ2ZXIvZGV2JztcbiAgICAgIGFwcC51c2UoJy9wdWJsaWMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lICsgX3NlcnZlckRpciArJy9wdWJsaWMnKSkpO1xuICAgICAgdmFyIHJlbmRlckluZGV4ID0gKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpID0+IHtcbiAgICAgICAgX2NsaWVudERpciA9ICcvY2xpZW50L2Rldic7XG4gICAgICAgIHJlcy5zZW5kRmlsZShwYXRoLnJlc29sdmUoX19kaXJuYW1lICsgX2NsaWVudERpciArICcvaW5kZXguaHRtbCcpKTtcbiAgICAgIH07XG4gICAgICBhcHAuZ2V0KCcvKicsIHJlbmRlckluZGV4KTtcbiAgICAgIC8qKlxuICAgICAgICogQXBpIFJvdXRlcyBmb3IgYERldmVsb3BtZW50YC5cbiAgICAgICAqL1xuICAgIH0gZWxzZSB7XG4gICAgICBhcHAuYWxsKCcvKicsIGZ1bmN0aW9uIChyZXEsIHJlcywgbmV4dCkge1xuICAgICAgICByZXMuaGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nLCAnKicpO1xuICAgICAgICByZXMuaGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJywgJ1gtUmVxdWVzdGVkLVdpdGgnKTtcbiAgICAgICAgbmV4dCgpO1xuICAgICAgfSk7XG5cbiAgICAgIC8qcm91dGVzLmluaXQoYXBwKTsqL1xuICAgICAgYXBwLnVzZShNaWRkbGV3YXJlcy5jb25maWd1cmF0aW9uKTtcbiAgICAgIC8vY25leHRSb3V0ZXMuY25leHRJbml0KGFwcCk7XG5cbiAgICAgIGxldCByb290ID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCkpO1xuICAgICAgbGV0IGNsaWVudFJvb3QgPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgJy4vZGlzdC9jbGllbnQvZGV2Jyk7XG4gICAgICBhcHAudXNlKGV4cHJlc3Muc3RhdGljKHJvb3QpKTtcbiAgICAgIGFwcC51c2UoZXhwcmVzcy5zdGF0aWMoY2xpZW50Um9vdCkpO1xuICAgICAgX3NlcnZlckRpciA9ICcvZGlzdC9zZXJ2ZXIvZGV2JztcbiAgICAgIGFwcC51c2UoJy9wdWJsaWMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lKyBfc2VydmVyRGlyICsnL3B1YmxpYycpKSk7XG4gICAgICBsZXQgcmVuZGVySW5kZXggPSAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuICAgICAgICBfY2xpZW50RGlyID0gJy9kaXN0L2NsaWVudC9kZXYnO1xuICAgICAgICByZXMuc2VuZEZpbGUocGF0aC5yZXNvbHZlKF9fZGlybmFtZSArIF9jbGllbnREaXIgKyAnL2luZGV4Lmh0bWwnKSk7XG4gICAgICB9O1xuICAgICAgYXBwLmdldCgnLyonLCByZW5kZXJJbmRleCk7XG4gICAgICAvKipcbiAgICAgICAqIEFwaSBSb3V0ZXMgZm9yIGBEZXZlbG9wbWVudGAuXG4gICAgICAgKi9cbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgaWYoZGlzdF9ydW5uZXIgPT09ICdkaXN0Jykge1xuICAgICAgLyoqXG4gICAgICAgKiBQcm9kIE1vZGUuXG4gICAgICAgKiBAbm90ZSBQcm9kIG1vZCB3aWxsIGdpdmUgeW91IHN0YXRpYyArIG1pZGRsZXdhcmUuXG4gICAgICAgKi9cblxuICAgICAgLyoqXG4gICAgICAgKiBBcGkgUm91dGVzIGZvciBgUHJvZHVjdGlvbmAuXG4gICAgICAgKi9cbiAgICAgIC8qcm91dGVzLmluaXQoYXBwKTsqL1xuICAgICAgLypjbmV4dFJvdXRlcy5jbmV4dEluaXQoYXBwKTsqL1xuICAgICAgLyoqXG4gICAgICAgKiBDbGllbnQgRGlyXG4gICAgICAgKi9cbiAgICAgIF9jbGllbnREaXIgPSAnLi9jbGllbnQvcHJvZCc7XG4gICAgICBfc2VydmVyRGlyID0gJy9zZXJ2ZXIvcHJvZCc7XG5cbiAgICAgIC8qKlxuICAgICAgICogU3RhdGljLlxuICAgICAgICovXG4gICAgICBhcHAudXNlKCcvanMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9qcycpKSk7XG4gICAgICBhcHAudXNlKCcvY3NzJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgX2NsaWVudERpciArICcvY3NzJykpKTtcbiAgICAgIGFwcC51c2UoJy9hc3NldHMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9hc3NldHMnKSkpO1xuICAgICAgYXBwLnVzZSgnL2Jhbm5lcnMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9iYW5uZXJzJykpKTtcbiAgICAgIGFwcC51c2UoJy9wdWJsaWMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lKyBfc2VydmVyRGlyICsgJy9wdWJsaWMnKSkpO1xuXG5cbiAgICAgIC8qKlxuICAgICAgICogU3BhIFJlcyBTZW5kZXIuXG4gICAgICAgKiBAcGFyYW0gcmVxIHthbnl9XG4gICAgICAgKiBAcGFyYW0gcmVzIHthbnl9XG4gICAgICAgKi9cbiAgICAgIHZhciByZW5kZXJJbmRleCA9IGZ1bmN0aW9uIChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSB7XG4gICAgICAgIF9jbGllbnREaXIgPSAnL2NsaWVudC9wcm9kJztcbiAgICAgICAgcmVzLnNlbmRGaWxlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUgKyBfY2xpZW50RGlyICsgJy9pbmRleC5odG1sJykpO1xuICAgICAgfTtcblxuICAgICAgLy9hcHAuZ2V0KCcqJywgZnVuY3Rpb24ocmVxLHJlcykge1xuICAgICAgLy8gIHJlcy5zZW5kRmlsZShwcm9jZXNzLmN3ZCgpICsgJy9kaXN0L3Byb2QvY2xpZW50L2luZGV4Lmh0bWwnKTtcbiAgICAgIC8vfSk7XG5cbiAgICAgIC8qKlxuICAgICAgICogUHJldmVudCBzZXJ2ZXIgcm91dGluZyBhbmQgdXNlIEBuZzItcm91dGVyLlxuICAgICAgICovXG4gICAgICBhcHAuZ2V0KCcvKicsIHJlbmRlckluZGV4KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLyoqXG4gICAgICAgKiBQcm9kIE1vZGUuXG4gICAgICAgKiBAbm90ZSBQcm9kIG1vZCB3aWxsIGdpdmUgeW91IHN0YXRpYyArIG1pZGRsZXdhcmUuXG4gICAgICAgKi9cblxuICAgICAgLyoqXG4gICAgICAgKiBBcGkgUm91dGVzIGZvciBgUHJvZHVjdGlvbmAuXG4gICAgICAgKi9cbiAgICAgIGFwcC51c2UoTWlkZGxld2FyZXMuY29uZmlndXJhdGlvbik7XG4gICAgICAvKipcbiAgICAgICAqIENsaWVudCBEaXJcbiAgICAgICAqL1xuICAgICAgX2NsaWVudERpciA9ICcuL2Rpc3QvY2xpZW50L3Byb2QnO1xuICAgICAgX3NlcnZlckRpciA9ICcvZGlzdC9zZXJ2ZXIvcHJvZCc7XG5cbiAgICAgIC8qKlxuICAgICAgICogU3RhdGljLlxuICAgICAgICovXG4gICAgICBhcHAudXNlKCcvanMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9qcycpKSk7XG4gICAgICBhcHAudXNlKCcvY3NzJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgX2NsaWVudERpciArICcvY3NzJykpKTtcbiAgICAgIGFwcC51c2UoJy9hc3NldHMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9hc3NldHMnKSkpO1xuICAgICAgYXBwLnVzZSgnL2Jhbm5lcnMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9iYW5uZXJzJykpKTtcbiAgICAgIGFwcC51c2UoJy9wdWJsaWMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lKyBfc2VydmVyRGlyKycvcHVibGljJykpKTtcblxuICAgICAgLyoqXG4gICAgICAgKiBTcGEgUmVzIFNlbmRlci5cbiAgICAgICAqIEBwYXJhbSByZXEge2FueX1cbiAgICAgICAqIEBwYXJhbSByZXMge2FueX1cbiAgICAgICAqL1xuICAgICAgdmFyIHJlbmRlckluZGV4ID0gZnVuY3Rpb24gKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpIHtcbiAgICAgICAgX2NsaWVudERpciA9ICcvZGlzdC9jbGllbnQvcHJvZCc7XG4gICAgICAgIHJlcy5zZW5kRmlsZShwYXRoLnJlc29sdmUoX19kaXJuYW1lICsgX2NsaWVudERpciArICcvaW5kZXguaHRtbCcpKTtcbiAgICAgIH07XG5cbiAgICAgIC8vYXBwLmdldCgnKicsIGZ1bmN0aW9uKHJlcSxyZXMpIHtcbiAgICAgIC8vICByZXMuc2VuZEZpbGUocHJvY2Vzcy5jd2QoKSArICcvZGlzdC9wcm9kL2NsaWVudC9pbmRleC5odG1sJyk7XG4gICAgICAvL30pO1xuXG4gICAgICAvKipcbiAgICAgICAqIFByZXZlbnQgc2VydmVyIHJvdXRpbmcgYW5kIHVzZSBAbmcyLXJvdXRlci5cbiAgICAgICAqL1xuICAgICAgYXBwLmdldCgnLyonLCByZW5kZXJJbmRleCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNlcnZlciB3aXRoIGd6aXAgY29tcHJlc3Npb24uXG4gICAqL1xuICAvL0hUVFAgU1RBUlQ6XG4gIGlmIChwcm90b2NvbCA9PT0gJ2h0dHAnKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGh0dHAuU2VydmVyPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBsZXQgc2VydmVyID0gYXBwLmxpc3Rlbihwb3J0LCAoKSA9PiB7XG4gICAgICAgIHZhciBwb3J0ID0gc2VydmVyLmFkZHJlc3MoKS5wb3J0O1xuICAgICAgICBjb25zb2xlLmxvZygnQXBwIGlzIGxpc3RlbmluZyBvbiBwb3J0OicgKyBwb3J0KTtcbiAgICAgICAgcmVzb2x2ZShzZXJ2ZXIpO1xuICAgICAgfSk7XG4gICAgICBzZXJ2ZXIudGltZW91dCA9IDYwMDAwMDsgLy9ieSBkZWZhdWx0IHRpbWVvdXQgc2V0IHRvIDEwIG1pbiBmb3IgZXhwb3J0IGZ1bmN0aW9uYWxpdHlcbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgLy8ga2V5OiBmcy5yZWFkRmlsZVN5bmMoJy4vc3RhZ2luZy5qb2Jtb3Npcy5jb20ua2V5JyksXG4gICAgICAvLyBjZXJ0OiBmcy5yZWFkRmlsZVN5bmMoJy4vc3RhZ2luZy5qb2Jtb3Npcy5jb20uY3J0JyksXG4gICAgICBoYW5kc2hha2VUaW1lb3V0OiA2MDAwMDAsIC8vYnkgZGVmYXVsdCB0aW1lb3V0IHNldCB0byAxMCBtaW4gZm9yIGV4cG9ydCBmdW5jdGlvbmFsaXR5LCBOZWVkIHRvIHRlc3QgdGhpc1xuICAgICAgcGFzc3BocmFzZTogJ3RwbDEyMycsXG4gICAgICBzcGR5OiB7XG4gICAgICAgIHByb3RvY29sczogWydoMiddXG4gICAgICB9XG4gICAgfTtcblxuICAgIHJldHVybiBzcGR5LmNyZWF0ZVNlcnZlcihvcHRpb25zLCBhcHApXG4gICAgICAubGlzdGVuKHBvcnQsIChlcnJvcjogYW55KSA9PiB7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpXG4gICAgICAgICAgLy8gcmV0dXJuIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ2h0dHAyIExpc3RlbmluZyBvbiBwb3J0OiAnICsgcG9ydCArICcuJyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG59XG4iXX0=
