"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var express = require("express");
var bodyParser = require("body-parser");
var path = require("path");
var compression = require("compression");
var routes = require("./routes");
var cnextRoutes = require("./cnext-routes");
var methodOverride = require("method-override");
var cors = require("cors");
var fs = require("fs");
var spdy = require('spdy');
__dirname = './';
var _clientDir = '/dist/client/dev';
var _serverDir = '/dist/server/dev';
var app = express();
function init(port, mode, protocol, dist_runner) {
    app.use(bodyParser.urlencoded({ extended: false }));
    app.use(bodyParser.json({ limit: '40mb' }));
    app.use(bodyParser.urlencoded({ limit: '40mb', extended: true }));
    app.use(bodyParser.text());
    app.use(compression());
    app.use(cors());
    app.use(bodyParser.json());
    app.use(methodOverride("X-HTTP-Method"));
    app.use(methodOverride("X-HTTP-Method-Override"));
    app.use(methodOverride("X-Method-Override"));
    app.use(methodOverride("_method"));
    app.use(express.static('src/'));
    if (mode == 'dev') {
        if (dist_runner == 'dist') {
            app.all('/*', function (req, res, next) {
                res.header('Access-Control-Allow-Origin', '*');
                res.header('Access-Control-Allow-Headers', 'X-Requested-With');
                next();
            });
            routes.init(app);
            cnextRoutes.cnextInit(app);
            var root = path.resolve(process.cwd());
            var clientRoot = path.resolve(process.cwd(), './client/dev');
            app.use(express.static(root));
            app.use(express.static(clientRoot));
            _serverDir = '/dist/server/dev';
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/client/dev';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
        else {
            app.all('/*', function (req, res, next) {
                res.header('Access-Control-Allow-Origin', '*');
                res.header('Access-Control-Allow-Headers', 'X-Requested-With');
                next();
            });
            routes.init(app);
            cnextRoutes.cnextInit(app);
            var root = path.resolve(process.cwd());
            var clientRoot = path.resolve(process.cwd(), './dist/client/dev');
            app.use(express.static(root));
            app.use(express.static(clientRoot));
            _serverDir = '/dist/server/dev';
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/dist/client/dev';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
    }
    else {
        if (dist_runner == 'dist') {
            routes.init(app);
            cnextRoutes.cnextInit(app);
            _clientDir = './client/prod';
            _serverDir = '/server/prod';
            app.use('/js', express.static(path.resolve(__dirname, _clientDir + '/js')));
            app.use('/css', express.static(path.resolve(__dirname, _clientDir + '/css')));
            app.use('/assets', express.static(path.resolve(__dirname, _clientDir + '/assets')));
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/client/prod';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
        else {
            routes.init(app);
            cnextRoutes.cnextInit(app);
            _clientDir = './dist/client/prod';
            _serverDir = '/dist/server/prod';
            app.use('/js', express.static(path.resolve(__dirname, _clientDir + '/js')));
            app.use('/css', express.static(path.resolve(__dirname, _clientDir + '/css')));
            app.use('/assets', express.static(path.resolve(__dirname, _clientDir + '/assets')));
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/dist/client/prod';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
    }
    if (protocol == 'http') {
        return new Promise(function (resolve, reject) {
            var server = app.listen(port, function () {
                var port = server.address().port;
                console.log('App is listening on port:' + port);
                resolve(server);
            });
        });
    }
    else {
        var options = {
            key: fs.readFileSync("./staging.jobmosis.com.key"),
            cert: fs.readFileSync("./staging.jobmosis.com.crt"),
            passphrase: 'tpl123',
            spdy: {
                protocols: ['h2']
            }
        };
        return spdy.createServer(options, app)
            .listen(port, function (error) {
            if (error) {
                console.error(error);
                return process.exit(1);
            }
            else {
                console.log('http2 Listening on port: ' + port + '.');
            }
        });
    }
}
exports.init = init;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUMsSUFBSSxDQUFDLENBQUM7UUFDTixJQUFNLE9BQU8sR0FBRztZQUNkLEdBQUcsRUFBRSxFQUFFLENBQUMsWUFBWSxDQUFDLDRCQUE0QixDQUFDO1lBQ2xELElBQUksRUFBRSxFQUFFLENBQUMsWUFBWSxDQUFDLDRCQUE0QixDQUFDO1lBQ25ELFVBQVUsRUFBRSxRQUFRO1lBRXBCLElBQUksRUFBRTtnQkFDSixTQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUM7YUFDbEI7U0FDRixDQUFDO1FBRUYsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQzthQUNuQyxNQUFNLENBQUMsSUFBSSxFQUFFLFVBQUMsS0FBVTtZQUN2QixFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUNWLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUE7Z0JBQ3BCLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixPQUFPLENBQUMsR0FBRyxDQUFDLDJCQUEyQixHQUFHLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQztZQUN4RCxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDO0FBQ0gsQ0FBQztBQXBNRCxvQkFvTUM7QUFBQSxDQUFDIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgaHR0cCBmcm9tIFwiaHR0cFwiO1xyXG5pbXBvcnQgKiBhcyBleHByZXNzIGZyb20gXCJleHByZXNzXCI7XHJcbmltcG9ydCAqIGFzIGJvZHlQYXJzZXIgZnJvbSBcImJvZHktcGFyc2VyXCI7XHJcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcclxuaW1wb3J0ICogYXMgY29tcHJlc3Npb24gZnJvbSBcImNvbXByZXNzaW9uXCI7XHJcbmltcG9ydCAqIGFzIHJvdXRlcyBmcm9tIFwiLi9yb3V0ZXNcIjtcclxuaW1wb3J0ICogYXMgY25leHRSb3V0ZXMgZnJvbSBcIi4vY25leHQtcm91dGVzXCI7XHJcbmltcG9ydCAqIGFzIG1ldGhvZE92ZXJyaWRlIGZyb20gXCJtZXRob2Qtb3ZlcnJpZGVcIjtcclxuaW1wb3J0ICogYXMgY29ycyBmcm9tIFwiY29yc1wiO1xyXG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnNcIjtcclxudmFyIHNwZHkgPSByZXF1aXJlKCdzcGR5Jyk7XHJcblxyXG4gX19kaXJuYW1lID0gJy4vJztcclxudmFyIF9jbGllbnREaXIgPSAnL2Rpc3QvY2xpZW50L2Rldic7XHJcbnZhciBfc2VydmVyRGlyID0gJy9kaXN0L3NlcnZlci9kZXYnO1xyXG52YXIgYXBwID0gZXhwcmVzcygpO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGluaXQocG9ydDogbnVtYmVyLCBtb2RlOiBzdHJpbmcsIHByb3RvY29sOiBzdHJpbmcsIGRpc3RfcnVubmVyOiBzdHJpbmcpIHtcclxuXHJcbiAgYXBwLnVzZShib2R5UGFyc2VyLnVybGVuY29kZWQoe2V4dGVuZGVkOiBmYWxzZX0pKTtcclxuICBhcHAudXNlKGJvZHlQYXJzZXIuanNvbih7bGltaXQ6ICc0MG1iJ30pKTtcclxuICBhcHAudXNlKGJvZHlQYXJzZXIudXJsZW5jb2RlZCh7bGltaXQ6ICc0MG1iJywgZXh0ZW5kZWQ6IHRydWV9KSk7XHJcbiAgYXBwLnVzZShib2R5UGFyc2VyLnRleHQoKSk7XHJcbiAgYXBwLnVzZShjb21wcmVzc2lvbigpKTtcclxuICBhcHAudXNlKGNvcnMoKSk7XHJcbiAgYXBwLnVzZShib2R5UGFyc2VyLmpzb24oKSk7XHJcbiAgYXBwLnVzZShtZXRob2RPdmVycmlkZShcIlgtSFRUUC1NZXRob2RcIikpO1xyXG4gIGFwcC51c2UobWV0aG9kT3ZlcnJpZGUoXCJYLUhUVFAtTWV0aG9kLU92ZXJyaWRlXCIpKTtcclxuICBhcHAudXNlKG1ldGhvZE92ZXJyaWRlKFwiWC1NZXRob2QtT3ZlcnJpZGVcIikpO1xyXG4gIGFwcC51c2UobWV0aG9kT3ZlcnJpZGUoXCJfbWV0aG9kXCIpKTtcclxuICBhcHAudXNlKGV4cHJlc3Muc3RhdGljKCdzcmMvJykpO1xyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogRGV2IE1vZGUuXHJcbiAgICogQG5vdGUgRGV2IHNlcnZlciB3aWxsIG9ubHkgZ2l2ZSBmb3IgeW91IG1pZGRsZXdhcmUuXHJcbiAgICovXHJcbiAgaWYgKG1vZGUgPT0gJ2RldicpIHtcclxuICAgIGlmIChkaXN0X3J1bm5lciA9PSAnZGlzdCcpIHtcclxuICAgICAgYXBwLmFsbCgnLyonLCBmdW5jdGlvbiAocmVxLCByZXMsIG5leHQpIHtcclxuICAgICAgICByZXMuaGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nLCAnKicpO1xyXG4gICAgICAgIHJlcy5oZWFkZXIoJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnLCAnWC1SZXF1ZXN0ZWQtV2l0aCcpO1xyXG4gICAgICAgIG5leHQoKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICByb3V0ZXMuaW5pdChhcHApO1xyXG4gICAgICBjbmV4dFJvdXRlcy5jbmV4dEluaXQoYXBwKTtcclxuXHJcbiAgICAgIGxldCByb290ID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCkpO1xyXG4gICAgICBsZXQgY2xpZW50Um9vdCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCAnLi9jbGllbnQvZGV2Jyk7XHJcbiAgICAgIGFwcC51c2UoZXhwcmVzcy5zdGF0aWMocm9vdCkpO1xyXG4gICAgICBhcHAudXNlKGV4cHJlc3Muc3RhdGljKGNsaWVudFJvb3QpKTtcclxuICAgICAgX3NlcnZlckRpciA9ICcvZGlzdC9zZXJ2ZXIvZGV2JztcclxuICAgICAgYXBwLnVzZSgnL3B1YmxpYycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUgKyBfc2VydmVyRGlyICsnL3B1YmxpYycpKSk7XHJcbiAgICAgIHZhciByZW5kZXJJbmRleCA9IChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgX2NsaWVudERpciA9ICcvY2xpZW50L2Rldic7XHJcbiAgICAgICAgcmVzLnNlbmRGaWxlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUgKyBfY2xpZW50RGlyICsgJy9pbmRleC5odG1sJykpO1xyXG4gICAgICB9O1xyXG4gICAgICBhcHAuZ2V0KCcvKicsIHJlbmRlckluZGV4KTtcclxuICAgICAgLyoqXHJcbiAgICAgICAqIEFwaSBSb3V0ZXMgZm9yIGBEZXZlbG9wbWVudGAuXHJcbiAgICAgICAqL1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIGFwcC5hbGwoJy8qJywgZnVuY3Rpb24gKHJlcSwgcmVzLCBuZXh0KSB7XHJcbiAgICAgICAgcmVzLmhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJywgJyonKTtcclxuICAgICAgICByZXMuaGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJywgJ1gtUmVxdWVzdGVkLVdpdGgnKTtcclxuICAgICAgICBuZXh0KCk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgcm91dGVzLmluaXQoYXBwKTtcclxuICAgICAgY25leHRSb3V0ZXMuY25leHRJbml0KGFwcCk7XHJcblxyXG4gICAgICBsZXQgcm9vdCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpKTtcclxuICAgICAgbGV0IGNsaWVudFJvb3QgPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgJy4vZGlzdC9jbGllbnQvZGV2Jyk7XHJcbiAgICAgIGFwcC51c2UoZXhwcmVzcy5zdGF0aWMocm9vdCkpO1xyXG4gICAgICBhcHAudXNlKGV4cHJlc3Muc3RhdGljKGNsaWVudFJvb3QpKTtcclxuICAgICAgX3NlcnZlckRpciA9ICcvZGlzdC9zZXJ2ZXIvZGV2JztcclxuICAgICAgYXBwLnVzZSgnL3B1YmxpYycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUrIF9zZXJ2ZXJEaXIgKycvcHVibGljJykpKTtcclxuICAgICAgdmFyIHJlbmRlckluZGV4ID0gKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpID0+IHtcclxuICAgICAgICBfY2xpZW50RGlyID0gJy9kaXN0L2NsaWVudC9kZXYnO1xyXG4gICAgICAgIHJlcy5zZW5kRmlsZShwYXRoLnJlc29sdmUoX19kaXJuYW1lICsgX2NsaWVudERpciArICcvaW5kZXguaHRtbCcpKTtcclxuICAgICAgfTtcclxuICAgICAgYXBwLmdldCgnLyonLCByZW5kZXJJbmRleCk7XHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBBcGkgUm91dGVzIGZvciBgRGV2ZWxvcG1lbnRgLlxyXG4gICAgICAgKi9cclxuICAgIH1cclxuICB9XHJcbiAgZWxzZSB7XHJcbiAgICBpZihkaXN0X3J1bm5lciA9PSAnZGlzdCcpIHtcclxuICAgICAgLyoqXHJcbiAgICAgICAqIFByb2QgTW9kZS5cclxuICAgICAgICogQG5vdGUgUHJvZCBtb2Qgd2lsbCBnaXZlIHlvdSBzdGF0aWMgKyBtaWRkbGV3YXJlLlxyXG4gICAgICAgKi9cclxuXHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBBcGkgUm91dGVzIGZvciBgUHJvZHVjdGlvbmAuXHJcbiAgICAgICAqL1xyXG4gICAgICByb3V0ZXMuaW5pdChhcHApO1xyXG4gICAgICBjbmV4dFJvdXRlcy5jbmV4dEluaXQoYXBwKTtcclxuICAgICAgLyoqXHJcbiAgICAgICAqIENsaWVudCBEaXJcclxuICAgICAgICovXHJcbiAgICAgIF9jbGllbnREaXIgPSAnLi9jbGllbnQvcHJvZCc7XHJcbiAgICAgIF9zZXJ2ZXJEaXIgPSAnL3NlcnZlci9wcm9kJztcclxuXHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBTdGF0aWMuXHJcbiAgICAgICAqL1xyXG4gICAgICBhcHAudXNlKCcvanMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9qcycpKSk7XHJcbiAgICAgIGFwcC51c2UoJy9jc3MnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9jc3MnKSkpO1xyXG4gICAgICBhcHAudXNlKCcvYXNzZXRzJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgX2NsaWVudERpciArICcvYXNzZXRzJykpKTtcclxuICAgICAgYXBwLnVzZSgnL3B1YmxpYycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUrIF9zZXJ2ZXJEaXIgKyAnL3B1YmxpYycpKSk7XHJcblxyXG4gICAgICAvKipcclxuICAgICAgICogU3BhIFJlcyBTZW5kZXIuXHJcbiAgICAgICAqIEBwYXJhbSByZXEge2FueX1cclxuICAgICAgICogQHBhcmFtIHJlcyB7YW55fVxyXG4gICAgICAgKi9cclxuICAgICAgdmFyIHJlbmRlckluZGV4ID0gZnVuY3Rpb24gKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpIHtcclxuICAgICAgICBfY2xpZW50RGlyID0gJy9jbGllbnQvcHJvZCc7XHJcbiAgICAgICAgcmVzLnNlbmRGaWxlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUgKyBfY2xpZW50RGlyICsgJy9pbmRleC5odG1sJykpO1xyXG4gICAgICB9O1xyXG5cclxuICAgICAgLy9hcHAuZ2V0KCcqJywgZnVuY3Rpb24ocmVxLHJlcykge1xyXG4gICAgICAvLyAgcmVzLnNlbmRGaWxlKHByb2Nlc3MuY3dkKCkgKyAnL2Rpc3QvcHJvZC9jbGllbnQvaW5kZXguaHRtbCcpO1xyXG4gICAgICAvL30pO1xyXG5cclxuICAgICAgLyoqXHJcbiAgICAgICAqIFByZXZlbnQgc2VydmVyIHJvdXRpbmcgYW5kIHVzZSBAbmcyLXJvdXRlci5cclxuICAgICAgICovXHJcbiAgICAgIGFwcC5nZXQoJy8qJywgcmVuZGVySW5kZXgpO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBQcm9kIE1vZGUuXHJcbiAgICAgICAqIEBub3RlIFByb2QgbW9kIHdpbGwgZ2l2ZSB5b3Ugc3RhdGljICsgbWlkZGxld2FyZS5cclxuICAgICAgICovXHJcblxyXG4gICAgICAvKipcclxuICAgICAgICogQXBpIFJvdXRlcyBmb3IgYFByb2R1Y3Rpb25gLlxyXG4gICAgICAgKi9cclxuICAgICAgcm91dGVzLmluaXQoYXBwKTtcclxuICAgICAgY25leHRSb3V0ZXMuY25leHRJbml0KGFwcCk7XHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBDbGllbnQgRGlyXHJcbiAgICAgICAqL1xyXG4gICAgICBfY2xpZW50RGlyID0gJy4vZGlzdC9jbGllbnQvcHJvZCc7XHJcbiAgICAgIF9zZXJ2ZXJEaXIgPSAnL2Rpc3Qvc2VydmVyL3Byb2QnO1xyXG5cclxuICAgICAgLyoqXHJcbiAgICAgICAqIFN0YXRpYy5cclxuICAgICAgICovXHJcbiAgICAgIGFwcC51c2UoJy9qcycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIF9jbGllbnREaXIgKyAnL2pzJykpKTtcclxuICAgICAgYXBwLnVzZSgnL2NzcycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIF9jbGllbnREaXIgKyAnL2NzcycpKSk7XHJcbiAgICAgIGFwcC51c2UoJy9hc3NldHMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9hc3NldHMnKSkpO1xyXG4gICAgICBhcHAudXNlKCcvcHVibGljJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSsgX3NlcnZlckRpcisnL3B1YmxpYycpKSk7XHJcblxyXG4gICAgICAvKipcclxuICAgICAgICogU3BhIFJlcyBTZW5kZXIuXHJcbiAgICAgICAqIEBwYXJhbSByZXEge2FueX1cclxuICAgICAgICogQHBhcmFtIHJlcyB7YW55fVxyXG4gICAgICAgKi9cclxuICAgICAgdmFyIHJlbmRlckluZGV4ID0gZnVuY3Rpb24gKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpIHtcclxuICAgICAgICBfY2xpZW50RGlyID0gJy9kaXN0L2NsaWVudC9wcm9kJztcclxuICAgICAgICByZXMuc2VuZEZpbGUocGF0aC5yZXNvbHZlKF9fZGlybmFtZSArIF9jbGllbnREaXIgKyAnL2luZGV4Lmh0bWwnKSk7XHJcbiAgICAgIH07XHJcblxyXG4gICAgICAvL2FwcC5nZXQoJyonLCBmdW5jdGlvbihyZXEscmVzKSB7XHJcbiAgICAgIC8vICByZXMuc2VuZEZpbGUocHJvY2Vzcy5jd2QoKSArICcvZGlzdC9wcm9kL2NsaWVudC9pbmRleC5odG1sJyk7XHJcbiAgICAgIC8vfSk7XHJcblxyXG4gICAgICAvKipcclxuICAgICAgICogUHJldmVudCBzZXJ2ZXIgcm91dGluZyBhbmQgdXNlIEBuZzItcm91dGVyLlxyXG4gICAgICAgKi9cclxuICAgICAgYXBwLmdldCgnLyonLCByZW5kZXJJbmRleCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZXJ2ZXIgd2l0aCBnemlwIGNvbXByZXNzaW9uLlxyXG4gICAqL1xyXG4gIC8vSFRUUCBTVEFSVDpcclxuICBpZiAocHJvdG9jb2wgPT0gJ2h0dHAnKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2U8aHR0cC5TZXJ2ZXI+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgbGV0IHNlcnZlciA9IGFwcC5saXN0ZW4ocG9ydCwgKCkgPT4ge1xyXG4gICAgICAgIHZhciBwb3J0ID0gc2VydmVyLmFkZHJlc3MoKS5wb3J0O1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdBcHAgaXMgbGlzdGVuaW5nIG9uIHBvcnQ6JyArIHBvcnQpO1xyXG4gICAgICAgIHJlc29sdmUoc2VydmVyKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9IGVsc2Uge1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAga2V5OiBmcy5yZWFkRmlsZVN5bmMoXCIuL3N0YWdpbmcuam9ibW9zaXMuY29tLmtleVwiKSxcclxuICAgICAgY2VydDogZnMucmVhZEZpbGVTeW5jKFwiLi9zdGFnaW5nLmpvYm1vc2lzLmNvbS5jcnRcIiksXHJcbiAgICAgIHBhc3NwaHJhc2U6ICd0cGwxMjMnLFxyXG5cclxuICAgICAgc3BkeToge1xyXG4gICAgICAgIHByb3RvY29sczogWydoMiddXHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgcmV0dXJuIHNwZHkuY3JlYXRlU2VydmVyKG9wdGlvbnMsIGFwcClcclxuICAgICAgLmxpc3Rlbihwb3J0LCAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcilcclxuICAgICAgICAgIHJldHVybiBwcm9jZXNzLmV4aXQoMSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKCdodHRwMiBMaXN0ZW5pbmcgb24gcG9ydDogJyArIHBvcnQgKyAnLicpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICB9XHJcbn07XHJcbiJdfQ==
