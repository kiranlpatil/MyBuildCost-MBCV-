"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var express = require("express");
var path = require("path");
var LoggerService = require("./app/framework/shared/logger/LoggerService");
var sharedService = require("./app/framework/shared/logger/shared.service");
var Middlewares = require("./app/framework/middlewares/base/MiddlewaresBase");
var RateAnalysisService = require("./app/applicationProject/services/RateAnalysisService");
var UserService = require("./app/framework/services/UserService");
var log4js = require('log4js');
var config = require('config');
var spdy = require('spdy');
__dirname = './';
var _clientDir = '/dist/client/dev';
var _serverDir = '/dist/server/dev';
var app = express();
var CronJob = require('cron').CronJob;
function init(port, mode, protocol, dist_runner) {
    var loggerConfig = config.get('logger');
    log4js.configure(loggerConfig);
    var loggerCategory = config.get('logger.levels.[all]');
    var logger = log4js.getLogger('User Controller');
    logger.info('Initialization info');
    logger.error('Initialization error');
    logger.debug('Initialization debug');
    process.on('uncaughtException', function (err) {
        var _loggerService = new LoggerService('uncaught exception Handler');
        var error = {
            reason: 'uncaught exception',
            message: err,
            stack: err.stack,
            code: 500
        };
        console.error(error);
        _loggerService.logError('Catching uncaught Exceptions. : ' + err);
        _loggerService.logError('Catching uncaught Exceptions stack : ' + err.stack);
        sharedService.mailToAdmin(error);
    });
    var syncAtEveryFifteenMinute = new CronJob('00 */5 * * * *', function () {
        var rateAnalysisServices = new RateAnalysisService();
        rateAnalysisServices.SyncRateAnalysis();
    }, function () {
        console.log('restart server');
    }, true);
    syncAtEveryFifteenMinute.start();
    var sendProjectExpiryWarningMail = new CronJob('00 55 23 * * *', function () {
        logger.debug('sendProjectExpiryWarningMail in debug mode');
        var userService = new UserService();
        var _loggerService = new LoggerService('sendProjectExpiryWarningMail');
        _loggerService.logDebug('ProjectExpiryWarningMail started.');
        userService.sendProjectExpiryWarningMails(function (error, success) {
            if (error) {
                _loggerService.logError('Error in sendProjectExpiryWarningMail for users : ' + error);
            }
            else {
                _loggerService.logDebug('ProjectExpiryWarningMail send successfully to all users.');
            }
        });
    }, function () {
        console.log('restart server');
    }, true);
    console.log('sendProjectExpiryWarningMail status : before :', sendProjectExpiryWarningMail.running);
    sendProjectExpiryWarningMail.start();
    console.log('sendProjectExpiryWarningMail status : after :', sendProjectExpiryWarningMail.running);
    if (mode === 'dev') {
        if (dist_runner === 'dist') {
            app.all('/*', function (req, res, next) {
                res.header('Access-Control-Allow-Origin', '*');
                res.header('Access-Control-Allow-Headers', 'X-Requested-With');
                next();
            });
            app.use(Middlewares.configuration);
            var root = path.resolve(process.cwd());
            var clientRoot = path.resolve(process.cwd(), './client/dev');
            app.use(express.static(root));
            app.use(express.static(clientRoot));
            _serverDir = '/dist/server/dev';
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/client/dev';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
        else {
            app.all('/*', function (req, res, next) {
                res.header('Access-Control-Allow-Origin', '*');
                res.header('Access-Control-Allow-Headers', 'X-Requested-With');
                next();
            });
            app.use(Middlewares.configuration);
            var root = path.resolve(process.cwd());
            var clientRoot = path.resolve(process.cwd(), './dist/client/dev');
            app.use(express.static(root));
            app.use(express.static(clientRoot));
            _serverDir = '/dist/server/dev';
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex_1 = function (req, res) {
                _clientDir = '/dist/client/dev';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex_1);
        }
    }
    else {
        if (dist_runner === 'dist') {
            _clientDir = './client/prod';
            _serverDir = '/server/prod';
            app.use('/js', express.static(path.resolve(__dirname, _clientDir + '/js')));
            app.use('/css', express.static(path.resolve(__dirname, _clientDir + '/css')));
            app.use('/assets', express.static(path.resolve(__dirname, _clientDir + '/assets')));
            app.use('/banners', express.static(path.resolve(__dirname, _clientDir + '/banners')));
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/client/prod';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
        else {
            app.use(Middlewares.configuration);
            _clientDir = './dist/client/prod';
            _serverDir = '/dist/server/prod';
            app.use('/js', express.static(path.resolve(__dirname, _clientDir + '/js')));
            app.use('/css', express.static(path.resolve(__dirname, _clientDir + '/css')));
            app.use('/assets', express.static(path.resolve(__dirname, _clientDir + '/assets')));
            app.use('/banners', express.static(path.resolve(__dirname, _clientDir + '/banners')));
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/dist/client/prod';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
    }
    if (protocol === 'http') {
        return new Promise(function (resolve, reject) {
            var server = app.listen(port, function () {
                var port = server.address().port;
                console.log('App is listening on port:' + port);
                resolve(server);
            });
            server.timeout = 600000;
        });
    }
    else {
        var options = {
            handshakeTimeout: 600000,
            passphrase: 'tpl123',
            spdy: {
                protocols: ['h2']
            }
        };
        return spdy.createServer(options, app)
            .listen(port, function (error) {
            if (error) {
                console.error(error);
                process.exit(1);
            }
            else {
                console.log('http2 Listening on port: ' + port + '.');
            }
        });
    }
}
exports.init = init;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFJLE9BQU8sQ0FBYyxVQUFDLE9BQU8sRUFBRSxNQUFNO1lBQzlDLElBQUksTUFBTSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFO2dCQUM1QixJQUFJLElBQUksR0FBRyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDO2dCQUNqQyxPQUFPLENBQUMsR0FBRyxDQUFDLDJCQUEyQixHQUFHLElBQUksQ0FBQyxDQUFDO2dCQUNoRCxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDbEIsQ0FBQyxDQUFDLENBQUM7WUFDSCxNQUFNLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztRQUMxQixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLElBQU0sT0FBTyxHQUFHO1lBR2QsZ0JBQWdCLEVBQUUsTUFBTTtZQUN4QixVQUFVLEVBQUUsUUFBUTtZQUNwQixJQUFJLEVBQUU7Z0JBQ0osU0FBUyxFQUFFLENBQUMsSUFBSSxDQUFDO2FBQ2xCO1NBQ0YsQ0FBQztRQUVGLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUM7YUFDbkMsTUFBTSxDQUFDLElBQUksRUFBRSxVQUFDLEtBQVU7WUFDdkIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDVixPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFBO2dCQUVwQixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2xCLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixPQUFPLENBQUMsR0FBRyxDQUFDLDJCQUEyQixHQUFHLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQztZQUN4RCxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0FBQ0gsQ0FBQztBQTNRRCxvQkEyUUMiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBodHRwIGZyb20gJ2h0dHAnO1xuaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG4vKmltcG9ydCAqIGFzIHJvdXRlcyBmcm9tIFwiLi9yb3V0ZXNcIjsqL1xuLyppbXBvcnQgKiBhcyBjbmV4dFJvdXRlcyBmcm9tIFwiLi9jbmV4dC1yb3V0ZXNcIjsqL1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IExvZ2dlclNlcnZpY2UgPSByZXF1aXJlKCcuL2FwcC9mcmFtZXdvcmsvc2hhcmVkL2xvZ2dlci9Mb2dnZXJTZXJ2aWNlJyk7XG5pbXBvcnQgKiBhcyBzaGFyZWRTZXJ2aWNlIGZyb20gJy4vYXBwL2ZyYW1ld29yay9zaGFyZWQvbG9nZ2VyL3NoYXJlZC5zZXJ2aWNlJztcbmltcG9ydCBNaWRkbGV3YXJlcyA9IHJlcXVpcmUoJy4vYXBwL2ZyYW1ld29yay9taWRkbGV3YXJlcy9iYXNlL01pZGRsZXdhcmVzQmFzZScpO1xuaW1wb3J0IFJhdGVBbmFseXNpcyA9IHJlcXVpcmUoJy4vYXBwL2FwcGxpY2F0aW9uUHJvamVjdC9kYXRhYWNjZXNzL21vZGVsL1JhdGVBbmFseXNpcy9SYXRlQW5hbHlzaXMnKTtcbmltcG9ydCBSYXRlQW5hbHlzaXNTZXJ2aWNlID0gcmVxdWlyZSgnLi9hcHAvYXBwbGljYXRpb25Qcm9qZWN0L3NlcnZpY2VzL1JhdGVBbmFseXNpc1NlcnZpY2UnKTtcbmltcG9ydCBVc2VyU2VydmljZSA9IHJlcXVpcmUoJy4vYXBwL2ZyYW1ld29yay9zZXJ2aWNlcy9Vc2VyU2VydmljZScpO1xudmFyIGxvZzRqcyA9IHJlcXVpcmUoJ2xvZzRqcycpO1xudmFyIGNvbmZpZyA9IHJlcXVpcmUoJ2NvbmZpZycpO1xuLyp2YXIgbG9nRGlyID0gJ0xvZ3MnOyovXG5cbnZhciBzcGR5ID0gcmVxdWlyZSgnc3BkeScpO1xuX19kaXJuYW1lID0gJy4vJztcbnZhciBfY2xpZW50RGlyID0gJy9kaXN0L2NsaWVudC9kZXYnO1xudmFyIF9zZXJ2ZXJEaXIgPSAnL2Rpc3Qvc2VydmVyL2Rldic7XG52YXIgYXBwID0gZXhwcmVzcygpO1xudmFyIENyb25Kb2IgPSByZXF1aXJlKCdjcm9uJykuQ3JvbkpvYjtcblxuZXhwb3J0IGZ1bmN0aW9uIGluaXQocG9ydDogbnVtYmVyLCBtb2RlOiBzdHJpbmcsIHByb3RvY29sOiBzdHJpbmcsIGRpc3RfcnVubmVyOiBzdHJpbmcpIHtcblxuXG5cblxuXG4gIHZhciBsb2dnZXJDb25maWc9Y29uZmlnLmdldCgnbG9nZ2VyJyk7XG5cbiAgbG9nNGpzLmNvbmZpZ3VyZShsb2dnZXJDb25maWcpO1xuICB2YXIgbG9nZ2VyQ2F0ZWdvcnkgPWNvbmZpZy5nZXQoJ2xvZ2dlci5sZXZlbHMuW2FsbF0nKVxuICB2YXIgbG9nZ2VyPWxvZzRqcy5nZXRMb2dnZXIoJ1VzZXIgQ29udHJvbGxlcicpO1xuICBsb2dnZXIuaW5mbygnSW5pdGlhbGl6YXRpb24gaW5mbycpO1xuICBsb2dnZXIuZXJyb3IoJ0luaXRpYWxpemF0aW9uIGVycm9yJyk7XG4gIGxvZ2dlci5kZWJ1ZygnSW5pdGlhbGl6YXRpb24gZGVidWcnKTtcblxuXG5cbiAgcHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb24nLCBmdW5jdGlvbiAoZXJyOmFueSkge1xuICAgIGxldCBfbG9nZ2VyU2VydmljZTogTG9nZ2VyU2VydmljZSA9IG5ldyBMb2dnZXJTZXJ2aWNlKCd1bmNhdWdodCBleGNlcHRpb24gSGFuZGxlcicpO1xuICAgIGxldCBlcnJvcj0ge1xuICAgICAgcmVhc29uOiAndW5jYXVnaHQgZXhjZXB0aW9uJyxcbiAgICAgIG1lc3NhZ2U6IGVycixcbiAgICAgIHN0YWNrOiBlcnIuc3RhY2ssXG4gICAgICBjb2RlOiA1MDBcbiAgICB9O1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgIF9sb2dnZXJTZXJ2aWNlLmxvZ0Vycm9yKCdDYXRjaGluZyB1bmNhdWdodCBFeGNlcHRpb25zLiA6ICcgK2Vycik7XG4gICAgX2xvZ2dlclNlcnZpY2UubG9nRXJyb3IoJ0NhdGNoaW5nIHVuY2F1Z2h0IEV4Y2VwdGlvbnMgc3RhY2sgOiAnICtlcnIuc3RhY2spO1xuICAgIC8vc2hhcmVkU2VydmljZS5lcnJvckhhbmRsZXIoZXJyb3IpO1xuICAgIHNoYXJlZFNlcnZpY2UubWFpbFRvQWRtaW4oZXJyb3IpO1xuICB9KTtcblxuICBsZXQgc3luY0F0RXZlcnlGaWZ0ZWVuTWludXRlID0gbmV3IENyb25Kb2IoJzAwICovNSAqICogKiAqJywgZnVuY3Rpb24oKSB7XG5cbiAgICAgIGxldCByYXRlQW5hbHlzaXNTZXJ2aWNlczogUmF0ZUFuYWx5c2lzU2VydmljZSA9IG5ldyBSYXRlQW5hbHlzaXNTZXJ2aWNlKCk7XG4gICAgICByYXRlQW5hbHlzaXNTZXJ2aWNlcy5TeW5jUmF0ZUFuYWx5c2lzKCk7XG4gICAgfSwgZnVuY3Rpb24gKCkge1xuICAgICAgY29uc29sZS5sb2coJ3Jlc3RhcnQgc2VydmVyJyk7XG4gICAgfSxcbiAgICB0cnVlXG4gICk7XG4gIHN5bmNBdEV2ZXJ5RmlmdGVlbk1pbnV0ZS5zdGFydCgpO1xuXG5cbiAgbGV0IHNlbmRQcm9qZWN0RXhwaXJ5V2FybmluZ01haWwgPSBuZXcgQ3JvbkpvYignMDAgNTUgMjMgKiAqIConLCBmdW5jdGlvbigpIHtcbiAgICAgIGxvZ2dlci5kZWJ1Zygnc2VuZFByb2plY3RFeHBpcnlXYXJuaW5nTWFpbCBpbiBkZWJ1ZyBtb2RlJyk7XG4gICAgICBsZXQgdXNlclNlcnZpY2UgOiBVc2VyU2VydmljZSA9IG5ldyBVc2VyU2VydmljZSgpO1xuICAgICAgbGV0IF9sb2dnZXJTZXJ2aWNlOiBMb2dnZXJTZXJ2aWNlID0gbmV3IExvZ2dlclNlcnZpY2UoJ3NlbmRQcm9qZWN0RXhwaXJ5V2FybmluZ01haWwnKTtcbiAgICAgIF9sb2dnZXJTZXJ2aWNlLmxvZ0RlYnVnKCdQcm9qZWN0RXhwaXJ5V2FybmluZ01haWwgc3RhcnRlZC4nKTtcbiAgICAgIHVzZXJTZXJ2aWNlLnNlbmRQcm9qZWN0RXhwaXJ5V2FybmluZ01haWxzKChlcnJvciwgc3VjY2VzcykgPT4ge1xuICAgICAgICBpZihlcnJvcikge1xuICAgICAgICAgIF9sb2dnZXJTZXJ2aWNlLmxvZ0Vycm9yKCdFcnJvciBpbiBzZW5kUHJvamVjdEV4cGlyeVdhcm5pbmdNYWlsIGZvciB1c2VycyA6ICcgK2Vycm9yKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBfbG9nZ2VyU2VydmljZS5sb2dEZWJ1ZygnUHJvamVjdEV4cGlyeVdhcm5pbmdNYWlsIHNlbmQgc3VjY2Vzc2Z1bGx5IHRvIGFsbCB1c2Vycy4nKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSwgZnVuY3Rpb24gKCkge1xuICAgICAgY29uc29sZS5sb2coJ3Jlc3RhcnQgc2VydmVyJyk7XG4gICAgfSxcbiAgICB0cnVlXG4gICk7XG5cbiAgY29uc29sZS5sb2coJ3NlbmRQcm9qZWN0RXhwaXJ5V2FybmluZ01haWwgc3RhdHVzIDogYmVmb3JlIDonLCBzZW5kUHJvamVjdEV4cGlyeVdhcm5pbmdNYWlsLnJ1bm5pbmcpO1xuICBzZW5kUHJvamVjdEV4cGlyeVdhcm5pbmdNYWlsLnN0YXJ0KCk7XG4gIGNvbnNvbGUubG9nKCdzZW5kUHJvamVjdEV4cGlyeVdhcm5pbmdNYWlsIHN0YXR1cyA6IGFmdGVyIDonLCBzZW5kUHJvamVjdEV4cGlyeVdhcm5pbmdNYWlsLnJ1bm5pbmcpO1xuICAvL2xvZ2dlciBsb2c0anMgaW5pdGlhbGl6YXRpb25cbiAgLypcbiAgICBjb25zb2xlLmxvZygnTG9nZ2VyIEluaXRpYWxpemF0aW9uJyk7XG5cbiAgIHZhciBsb2dDb25maWc9Y29uZmlnLmdldCgnbG9nZ2VyJyk7XG5cbiAgICBjb25zb2xlLmxvZygnTG9nZ2VyIEluaXRpYWxpemF0aW9uIDEnKTtcblxuICAgdmFyIGxvZ2dlckxldmVsPWNvbmZpZy5nZXQoJ2xvZ2dlci5sZXZlbHMuW2FsbF0nKTtcblxuICAgIGNvbnNvbGUubG9nKCdMb2dnZXIgSW5pdGlhbGl6YXRpb24gMicpO1xuXG4gICAgdmFyIGxvZ2dlciA9IGxvZzRqcy5nZXRMb2dnZXIobG9nZ2VyTGV2ZWwpOyAvLyBpbml0aWFsaXplIHRoZSB2YXIgdG8gdXNlLlxuXG4gICAgY29uc29sZS5sb2coJ0xvZ2dlciBJbml0aWFsaXphdGlvbiBjb21wbGV0ZWQnKTtcblxuICAgIGxvZ2dlci5pbmZvKCdUaGlzIGlzIEluZm9ybWF0aW9uIExvZ2dlcicpO1xuICAgIGxvZ2dlci5lcnJvcignVGhpcyBpcyBFcnJvciBMb2dnZXInKTtcbiAgICBsb2dnZXIuZGVidWcoJ1RoaXMgaXMgRGVidWdnZXInKTtcblxuICAgIGNvbnNvbGUubG9nKCdMb2dnZXIgYXBwZW5kZWQgaW4gZmlsZScpOyovXG4gIC8qKlxuICAgKiBEZXYgTW9kZS5cbiAgICogQG5vdGUgRGV2IHNlcnZlciB3aWxsIG9ubHkgZ2l2ZSBmb3IgeW91IG1pZGRsZXdhcmUuXG4gICAqL1xuICBpZiAobW9kZSA9PT0gJ2RldicpIHtcbiAgICBpZiAoZGlzdF9ydW5uZXIgPT09ICdkaXN0Jykge1xuICAgICAgYXBwLmFsbCgnLyonLCBmdW5jdGlvbiAocmVxLCByZXMsIG5leHQpIHtcbiAgICAgICAgcmVzLmhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJywgJyonKTtcbiAgICAgICAgcmVzLmhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycycsICdYLVJlcXVlc3RlZC1XaXRoJyk7XG4gICAgICAgIG5leHQoKTtcbiAgICAgIH0pO1xuXG4gICAgICBhcHAudXNlKE1pZGRsZXdhcmVzLmNvbmZpZ3VyYXRpb24pO1xuXG4gICAgICBsZXQgcm9vdCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpKTtcbiAgICAgIGxldCBjbGllbnRSb290ID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksICcuL2NsaWVudC9kZXYnKTtcbiAgICAgIGFwcC51c2UoZXhwcmVzcy5zdGF0aWMocm9vdCkpO1xuICAgICAgYXBwLnVzZShleHByZXNzLnN0YXRpYyhjbGllbnRSb290KSk7XG4gICAgICBfc2VydmVyRGlyID0gJy9kaXN0L3NlcnZlci9kZXYnO1xuICAgICAgYXBwLnVzZSgnL3B1YmxpYycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUgKyBfc2VydmVyRGlyICsnL3B1YmxpYycpKSk7XG4gICAgICB2YXIgcmVuZGVySW5kZXggPSAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuICAgICAgICBfY2xpZW50RGlyID0gJy9jbGllbnQvZGV2JztcbiAgICAgICAgcmVzLnNlbmRGaWxlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUgKyBfY2xpZW50RGlyICsgJy9pbmRleC5odG1sJykpO1xuICAgICAgfTtcbiAgICAgIGFwcC5nZXQoJy8qJywgcmVuZGVySW5kZXgpO1xuICAgICAgLyoqXG4gICAgICAgKiBBcGkgUm91dGVzIGZvciBgRGV2ZWxvcG1lbnRgLlxuICAgICAgICovXG4gICAgfSBlbHNlIHtcbiAgICAgIGFwcC5hbGwoJy8qJywgZnVuY3Rpb24gKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgICAgIHJlcy5oZWFkZXIoJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicsICcqJyk7XG4gICAgICAgIHJlcy5oZWFkZXIoJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnLCAnWC1SZXF1ZXN0ZWQtV2l0aCcpO1xuICAgICAgICBuZXh0KCk7XG4gICAgICB9KTtcblxuICAgICAgLypyb3V0ZXMuaW5pdChhcHApOyovXG4gICAgICBhcHAudXNlKE1pZGRsZXdhcmVzLmNvbmZpZ3VyYXRpb24pO1xuICAgICAgLy9jbmV4dFJvdXRlcy5jbmV4dEluaXQoYXBwKTtcblxuICAgICAgbGV0IHJvb3QgPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSk7XG4gICAgICBsZXQgY2xpZW50Um9vdCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCAnLi9kaXN0L2NsaWVudC9kZXYnKTtcbiAgICAgIGFwcC51c2UoZXhwcmVzcy5zdGF0aWMocm9vdCkpO1xuICAgICAgYXBwLnVzZShleHByZXNzLnN0YXRpYyhjbGllbnRSb290KSk7XG4gICAgICBfc2VydmVyRGlyID0gJy9kaXN0L3NlcnZlci9kZXYnO1xuICAgICAgYXBwLnVzZSgnL3B1YmxpYycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUrIF9zZXJ2ZXJEaXIgKycvcHVibGljJykpKTtcbiAgICAgIGxldCByZW5kZXJJbmRleCA9IChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSA9PiB7XG4gICAgICAgIF9jbGllbnREaXIgPSAnL2Rpc3QvY2xpZW50L2Rldic7XG4gICAgICAgIHJlcy5zZW5kRmlsZShwYXRoLnJlc29sdmUoX19kaXJuYW1lICsgX2NsaWVudERpciArICcvaW5kZXguaHRtbCcpKTtcbiAgICAgIH07XG4gICAgICBhcHAuZ2V0KCcvKicsIHJlbmRlckluZGV4KTtcbiAgICAgIC8qKlxuICAgICAgICogQXBpIFJvdXRlcyBmb3IgYERldmVsb3BtZW50YC5cbiAgICAgICAqL1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBpZihkaXN0X3J1bm5lciA9PT0gJ2Rpc3QnKSB7XG4gICAgICAvKipcbiAgICAgICAqIFByb2QgTW9kZS5cbiAgICAgICAqIEBub3RlIFByb2QgbW9kIHdpbGwgZ2l2ZSB5b3Ugc3RhdGljICsgbWlkZGxld2FyZS5cbiAgICAgICAqL1xuXG4gICAgICAvKipcbiAgICAgICAqIEFwaSBSb3V0ZXMgZm9yIGBQcm9kdWN0aW9uYC5cbiAgICAgICAqL1xuICAgICAgLypyb3V0ZXMuaW5pdChhcHApOyovXG4gICAgICAvKmNuZXh0Um91dGVzLmNuZXh0SW5pdChhcHApOyovXG4gICAgICAvKipcbiAgICAgICAqIENsaWVudCBEaXJcbiAgICAgICAqL1xuICAgICAgX2NsaWVudERpciA9ICcuL2NsaWVudC9wcm9kJztcbiAgICAgIF9zZXJ2ZXJEaXIgPSAnL3NlcnZlci9wcm9kJztcblxuICAgICAgLyoqXG4gICAgICAgKiBTdGF0aWMuXG4gICAgICAgKi9cbiAgICAgIGFwcC51c2UoJy9qcycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIF9jbGllbnREaXIgKyAnL2pzJykpKTtcbiAgICAgIGFwcC51c2UoJy9jc3MnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9jc3MnKSkpO1xuICAgICAgYXBwLnVzZSgnL2Fzc2V0cycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIF9jbGllbnREaXIgKyAnL2Fzc2V0cycpKSk7XG4gICAgICBhcHAudXNlKCcvYmFubmVycycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIF9jbGllbnREaXIgKyAnL2Jhbm5lcnMnKSkpO1xuICAgICAgYXBwLnVzZSgnL3B1YmxpYycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUrIF9zZXJ2ZXJEaXIgKyAnL3B1YmxpYycpKSk7XG5cblxuICAgICAgLyoqXG4gICAgICAgKiBTcGEgUmVzIFNlbmRlci5cbiAgICAgICAqIEBwYXJhbSByZXEge2FueX1cbiAgICAgICAqIEBwYXJhbSByZXMge2FueX1cbiAgICAgICAqL1xuICAgICAgdmFyIHJlbmRlckluZGV4ID0gZnVuY3Rpb24gKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpIHtcbiAgICAgICAgX2NsaWVudERpciA9ICcvY2xpZW50L3Byb2QnO1xuICAgICAgICByZXMuc2VuZEZpbGUocGF0aC5yZXNvbHZlKF9fZGlybmFtZSArIF9jbGllbnREaXIgKyAnL2luZGV4Lmh0bWwnKSk7XG4gICAgICB9O1xuXG4gICAgICAvL2FwcC5nZXQoJyonLCBmdW5jdGlvbihyZXEscmVzKSB7XG4gICAgICAvLyAgcmVzLnNlbmRGaWxlKHByb2Nlc3MuY3dkKCkgKyAnL2Rpc3QvcHJvZC9jbGllbnQvaW5kZXguaHRtbCcpO1xuICAgICAgLy99KTtcblxuICAgICAgLyoqXG4gICAgICAgKiBQcmV2ZW50IHNlcnZlciByb3V0aW5nIGFuZCB1c2UgQG5nMi1yb3V0ZXIuXG4gICAgICAgKi9cbiAgICAgIGFwcC5nZXQoJy8qJywgcmVuZGVySW5kZXgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvKipcbiAgICAgICAqIFByb2QgTW9kZS5cbiAgICAgICAqIEBub3RlIFByb2QgbW9kIHdpbGwgZ2l2ZSB5b3Ugc3RhdGljICsgbWlkZGxld2FyZS5cbiAgICAgICAqL1xuXG4gICAgICAvKipcbiAgICAgICAqIEFwaSBSb3V0ZXMgZm9yIGBQcm9kdWN0aW9uYC5cbiAgICAgICAqL1xuICAgICAgYXBwLnVzZShNaWRkbGV3YXJlcy5jb25maWd1cmF0aW9uKTtcbiAgICAgIC8qKlxuICAgICAgICogQ2xpZW50IERpclxuICAgICAgICovXG4gICAgICBfY2xpZW50RGlyID0gJy4vZGlzdC9jbGllbnQvcHJvZCc7XG4gICAgICBfc2VydmVyRGlyID0gJy9kaXN0L3NlcnZlci9wcm9kJztcblxuICAgICAgLyoqXG4gICAgICAgKiBTdGF0aWMuXG4gICAgICAgKi9cbiAgICAgIGFwcC51c2UoJy9qcycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIF9jbGllbnREaXIgKyAnL2pzJykpKTtcbiAgICAgIGFwcC51c2UoJy9jc3MnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9jc3MnKSkpO1xuICAgICAgYXBwLnVzZSgnL2Fzc2V0cycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIF9jbGllbnREaXIgKyAnL2Fzc2V0cycpKSk7XG4gICAgICBhcHAudXNlKCcvYmFubmVycycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIF9jbGllbnREaXIgKyAnL2Jhbm5lcnMnKSkpO1xuICAgICAgYXBwLnVzZSgnL3B1YmxpYycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUrIF9zZXJ2ZXJEaXIrJy9wdWJsaWMnKSkpO1xuXG4gICAgICAvKipcbiAgICAgICAqIFNwYSBSZXMgU2VuZGVyLlxuICAgICAgICogQHBhcmFtIHJlcSB7YW55fVxuICAgICAgICogQHBhcmFtIHJlcyB7YW55fVxuICAgICAgICovXG4gICAgICB2YXIgcmVuZGVySW5kZXggPSBmdW5jdGlvbiAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkge1xuICAgICAgICBfY2xpZW50RGlyID0gJy9kaXN0L2NsaWVudC9wcm9kJztcbiAgICAgICAgcmVzLnNlbmRGaWxlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUgKyBfY2xpZW50RGlyICsgJy9pbmRleC5odG1sJykpO1xuICAgICAgfTtcblxuICAgICAgLy9hcHAuZ2V0KCcqJywgZnVuY3Rpb24ocmVxLHJlcykge1xuICAgICAgLy8gIHJlcy5zZW5kRmlsZShwcm9jZXNzLmN3ZCgpICsgJy9kaXN0L3Byb2QvY2xpZW50L2luZGV4Lmh0bWwnKTtcbiAgICAgIC8vfSk7XG5cbiAgICAgIC8qKlxuICAgICAgICogUHJldmVudCBzZXJ2ZXIgcm91dGluZyBhbmQgdXNlIEBuZzItcm91dGVyLlxuICAgICAgICovXG4gICAgICBhcHAuZ2V0KCcvKicsIHJlbmRlckluZGV4KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2VydmVyIHdpdGggZ3ppcCBjb21wcmVzc2lvbi5cbiAgICovXG4gIC8vSFRUUCBTVEFSVDpcbiAgaWYgKHByb3RvY29sID09PSAnaHR0cCcpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8aHR0cC5TZXJ2ZXI+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGxldCBzZXJ2ZXIgPSBhcHAubGlzdGVuKHBvcnQsICgpID0+IHtcbiAgICAgICAgdmFyIHBvcnQgPSBzZXJ2ZXIuYWRkcmVzcygpLnBvcnQ7XG4gICAgICAgIGNvbnNvbGUubG9nKCdBcHAgaXMgbGlzdGVuaW5nIG9uIHBvcnQ6JyArIHBvcnQpO1xuICAgICAgICByZXNvbHZlKHNlcnZlcik7XG4gICAgICB9KTtcbiAgICAgIHNlcnZlci50aW1lb3V0ID0gNjAwMDAwOyAvL2J5IGRlZmF1bHQgdGltZW91dCBzZXQgdG8gMTAgbWluIGZvciBleHBvcnQgZnVuY3Rpb25hbGl0eVxuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICAvLyBrZXk6IGZzLnJlYWRGaWxlU3luYygnLi9zdGFnaW5nLmpvYm1vc2lzLmNvbS5rZXknKSxcbiAgICAgIC8vIGNlcnQ6IGZzLnJlYWRGaWxlU3luYygnLi9zdGFnaW5nLmpvYm1vc2lzLmNvbS5jcnQnKSxcbiAgICAgIGhhbmRzaGFrZVRpbWVvdXQ6IDYwMDAwMCwgLy9ieSBkZWZhdWx0IHRpbWVvdXQgc2V0IHRvIDEwIG1pbiBmb3IgZXhwb3J0IGZ1bmN0aW9uYWxpdHksIE5lZWQgdG8gdGVzdCB0aGlzXG4gICAgICBwYXNzcGhyYXNlOiAndHBsMTIzJyxcbiAgICAgIHNwZHk6IHtcbiAgICAgICAgcHJvdG9jb2xzOiBbJ2gyJ11cbiAgICAgIH1cbiAgICB9O1xuXG4gICAgcmV0dXJuIHNwZHkuY3JlYXRlU2VydmVyKG9wdGlvbnMsIGFwcClcbiAgICAgIC5saXN0ZW4ocG9ydCwgKGVycm9yOiBhbnkpID0+IHtcbiAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcilcbiAgICAgICAgICAvLyByZXR1cm4gcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnaHR0cDIgTGlzdGVuaW5nIG9uIHBvcnQ6ICcgKyBwb3J0ICsgJy4nKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cbn1cbiJdfQ==
