"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var express = require("express");
var bodyParser = require("body-parser");
var path = require("path");
var compression = require("compression");
var routes = require("./routes");
var cnextRoutes = require("./cnext-routes");
var methodOverride = require("method-override");
var cors = require("cors");
var fs = require("fs");
var spdy = require('spdy');
__dirname = './';
var _clientDir = '/dist/client/dev';
var app = express();
function init(port, mode, protocol, dist_runner) {
    app.use(bodyParser.urlencoded({ extended: false }));
    app.use(bodyParser.json({ limit: '40mb' }));
    app.use(bodyParser.urlencoded({ limit: '40mb', extended: true }));
    app.use(bodyParser.text());
    app.use(compression());
    app.use(cors());
    app.use(bodyParser.json());
    app.use(methodOverride("X-HTTP-Method"));
    app.use(methodOverride("X-HTTP-Method-Override"));
    app.use(methodOverride("X-Method-Override"));
    app.use(methodOverride("_method"));
    app.use(express.static('src/'));
    if (mode == 'dev') {
        if (dist_runner == 'dist') {
            app.all('/*', function (req, res, next) {
                res.header('Access-Control-Allow-Origin', '*');
                res.header('Access-Control-Allow-Headers', 'X-Requested-With');
                next();
            });
            routes.init(app);
            cnextRoutes.cnextInit(app);
            var root = path.resolve(process.cwd());
            var clientRoot = path.resolve(process.cwd(), './client/dev');
            app.use(express.static(root));
            app.use(express.static(clientRoot));
            app.use('/public', express.static(path.resolve(__dirname + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/client/dev';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
        else {
            app.all('/*', function (req, res, next) {
                res.header('Access-Control-Allow-Origin', '*');
                res.header('Access-Control-Allow-Headers', 'X-Requested-With');
                next();
            });
            routes.init(app);
            cnextRoutes.cnextInit(app);
            var root = path.resolve(process.cwd());
            var clientRoot = path.resolve(process.cwd(), './dist/client/dev');
            app.use(express.static(root));
            app.use(express.static(clientRoot));
            app.use('/public', express.static(path.resolve(__dirname + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/dist/client/dev';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
    }
    else {
        if (dist_runner == 'dist') {
            routes.init(app);
            cnextRoutes.cnextInit(app);
            _clientDir = './client/prod';
            app.use('/js', express.static(path.resolve(__dirname, _clientDir + '/js')));
            app.use('/css', express.static(path.resolve(__dirname, _clientDir + '/css')));
            app.use('/assets', express.static(path.resolve(__dirname, _clientDir + '/assets')));
            app.use('/public', express.static(path.resolve(__dirname + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/client/prod';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
        else {
            routes.init(app);
            cnextRoutes.cnextInit(app);
            _clientDir = './dist/client/prod';
            app.use('/js', express.static(path.resolve(__dirname, _clientDir + '/js')));
            app.use('/css', express.static(path.resolve(__dirname, _clientDir + '/css')));
            app.use('/assets', express.static(path.resolve(__dirname, _clientDir + '/assets')));
            app.use('/public', express.static(path.resolve(__dirname + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/dist/client/prod';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
    }
    if (protocol == 'http') {
        return new Promise(function (resolve, reject) {
            var server = app.listen(port, function () {
                var port = server.address().port;
                console.log('App is listening on port:' + port);
                resolve(server);
            });
        });
    }
    else {
        var options = {
            key: fs.readFileSync("./server.key"),
            cert: fs.readFileSync("./server.crt"),
            spdy: {
                protocols: ['h2']
            }
        };
        return spdy.createServer(options, app)
            .listen(port, function (error) {
            if (error) {
                console.error(error);
                return process.exit(1);
            }
            else {
                console.log('http2 Listening on port: ' + port + '.');
            }
        });
    }
}
exports.init = init;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUNGLENBQUM7UUFFRixNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDO2FBQ25DLE1BQU0sQ0FBQyxJQUFJLEVBQUUsVUFBQyxLQUFVO1lBQ3ZCLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ1YsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQTtnQkFDcEIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDekIsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLE9BQU8sQ0FBQyxHQUFHLENBQUMsMkJBQTJCLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDO1lBQ3hELENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQTtJQUNOLENBQUM7QUFDSCxDQUFDO0FBL0xELG9CQStMQztBQUFBLENBQUMiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBodHRwIGZyb20gXCJodHRwXCI7XG5pbXBvcnQgKiBhcyBleHByZXNzIGZyb20gXCJleHByZXNzXCI7XG5pbXBvcnQgKiBhcyBib2R5UGFyc2VyIGZyb20gXCJib2R5LXBhcnNlclwiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgY29tcHJlc3Npb24gZnJvbSBcImNvbXByZXNzaW9uXCI7XG5pbXBvcnQgKiBhcyByb3V0ZXMgZnJvbSBcIi4vcm91dGVzXCI7XG5pbXBvcnQgKiBhcyBjbmV4dFJvdXRlcyBmcm9tIFwiLi9jbmV4dC1yb3V0ZXNcIjtcbmltcG9ydCAqIGFzIG1ldGhvZE92ZXJyaWRlIGZyb20gXCJtZXRob2Qtb3ZlcnJpZGVcIjtcbmltcG9ydCAqIGFzIGNvcnMgZnJvbSBcImNvcnNcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xudmFyIHNwZHkgPSByZXF1aXJlKCdzcGR5Jyk7XG5cbiBfX2Rpcm5hbWUgPSAnLi8nO1xudmFyIF9jbGllbnREaXIgPSAnL2Rpc3QvY2xpZW50L2Rldic7XG52YXIgYXBwID0gZXhwcmVzcygpO1xuXG5leHBvcnQgZnVuY3Rpb24gaW5pdChwb3J0OiBudW1iZXIsIG1vZGU6IHN0cmluZywgcHJvdG9jb2w6IHN0cmluZywgZGlzdF9ydW5uZXI6IHN0cmluZykge1xuXG4gIGFwcC51c2UoYm9keVBhcnNlci51cmxlbmNvZGVkKHtleHRlbmRlZDogZmFsc2V9KSk7XG4gIGFwcC51c2UoYm9keVBhcnNlci5qc29uKHtsaW1pdDogJzQwbWInfSkpO1xuICBhcHAudXNlKGJvZHlQYXJzZXIudXJsZW5jb2RlZCh7bGltaXQ6ICc0MG1iJywgZXh0ZW5kZWQ6IHRydWV9KSk7XG4gIGFwcC51c2UoYm9keVBhcnNlci50ZXh0KCkpO1xuICBhcHAudXNlKGNvbXByZXNzaW9uKCkpO1xuICBhcHAudXNlKGNvcnMoKSk7XG4gIGFwcC51c2UoYm9keVBhcnNlci5qc29uKCkpO1xuICBhcHAudXNlKG1ldGhvZE92ZXJyaWRlKFwiWC1IVFRQLU1ldGhvZFwiKSk7XG4gIGFwcC51c2UobWV0aG9kT3ZlcnJpZGUoXCJYLUhUVFAtTWV0aG9kLU92ZXJyaWRlXCIpKTtcbiAgYXBwLnVzZShtZXRob2RPdmVycmlkZShcIlgtTWV0aG9kLU92ZXJyaWRlXCIpKTtcbiAgYXBwLnVzZShtZXRob2RPdmVycmlkZShcIl9tZXRob2RcIikpO1xuICBhcHAudXNlKGV4cHJlc3Muc3RhdGljKCdzcmMvJykpO1xuXG5cbiAgLyoqXG4gICAqIERldiBNb2RlLlxuICAgKiBAbm90ZSBEZXYgc2VydmVyIHdpbGwgb25seSBnaXZlIGZvciB5b3UgbWlkZGxld2FyZS5cbiAgICovXG4gIGlmIChtb2RlID09ICdkZXYnKSB7XG4gICAgaWYgKGRpc3RfcnVubmVyID09ICdkaXN0Jykge1xuICAgICAgYXBwLmFsbCgnLyonLCBmdW5jdGlvbiAocmVxLCByZXMsIG5leHQpIHtcbiAgICAgICAgcmVzLmhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJywgJyonKTtcbiAgICAgICAgcmVzLmhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycycsICdYLVJlcXVlc3RlZC1XaXRoJyk7XG4gICAgICAgIG5leHQoKTtcbiAgICAgIH0pO1xuXG4gICAgICByb3V0ZXMuaW5pdChhcHApO1xuICAgICAgY25leHRSb3V0ZXMuY25leHRJbml0KGFwcCk7XG5cbiAgICAgIGxldCByb290ID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCkpO1xuICAgICAgbGV0IGNsaWVudFJvb3QgPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgJy4vY2xpZW50L2RldicpO1xuICAgICAgYXBwLnVzZShleHByZXNzLnN0YXRpYyhyb290KSk7XG4gICAgICBhcHAudXNlKGV4cHJlc3Muc3RhdGljKGNsaWVudFJvb3QpKTtcbiAgICAgIGFwcC51c2UoJy9wdWJsaWMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lICsgJy9wdWJsaWMnKSkpO1xuICAgICAgdmFyIHJlbmRlckluZGV4ID0gKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpID0+IHtcbiAgICAgICAgX2NsaWVudERpciA9ICcvY2xpZW50L2Rldic7XG4gICAgICAgIHJlcy5zZW5kRmlsZShwYXRoLnJlc29sdmUoX19kaXJuYW1lICsgX2NsaWVudERpciArICcvaW5kZXguaHRtbCcpKTtcbiAgICAgIH07XG4gICAgICBhcHAuZ2V0KCcvKicsIHJlbmRlckluZGV4KTtcbiAgICAgIC8qKlxuICAgICAgICogQXBpIFJvdXRlcyBmb3IgYERldmVsb3BtZW50YC5cbiAgICAgICAqL1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGFwcC5hbGwoJy8qJywgZnVuY3Rpb24gKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgICAgIHJlcy5oZWFkZXIoJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicsICcqJyk7XG4gICAgICAgIHJlcy5oZWFkZXIoJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnLCAnWC1SZXF1ZXN0ZWQtV2l0aCcpO1xuICAgICAgICBuZXh0KCk7XG4gICAgICB9KTtcblxuICAgICAgcm91dGVzLmluaXQoYXBwKTtcbiAgICAgIGNuZXh0Um91dGVzLmNuZXh0SW5pdChhcHApO1xuXG4gICAgICBsZXQgcm9vdCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpKTtcbiAgICAgIGxldCBjbGllbnRSb290ID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksICcuL2Rpc3QvY2xpZW50L2RldicpO1xuICAgICAgYXBwLnVzZShleHByZXNzLnN0YXRpYyhyb290KSk7XG4gICAgICBhcHAudXNlKGV4cHJlc3Muc3RhdGljKGNsaWVudFJvb3QpKTtcbiAgICAgIGFwcC51c2UoJy9wdWJsaWMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lKycvcHVibGljJykpKTtcbiAgICAgIHZhciByZW5kZXJJbmRleCA9IChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSA9PiB7XG4gICAgICAgIF9jbGllbnREaXIgPSAnL2Rpc3QvY2xpZW50L2Rldic7XG4gICAgICAgIHJlcy5zZW5kRmlsZShwYXRoLnJlc29sdmUoX19kaXJuYW1lICsgX2NsaWVudERpciArICcvaW5kZXguaHRtbCcpKTtcbiAgICAgIH07XG4gICAgICBhcHAuZ2V0KCcvKicsIHJlbmRlckluZGV4KTtcbiAgICAgIC8qKlxuICAgICAgICogQXBpIFJvdXRlcyBmb3IgYERldmVsb3BtZW50YC5cbiAgICAgICAqL1xuICAgIH1cbiAgfVxuICBlbHNlIHtcbiAgICBpZihkaXN0X3J1bm5lciA9PSAnZGlzdCcpIHtcbiAgICAgIC8qKlxuICAgICAgICogUHJvZCBNb2RlLlxuICAgICAgICogQG5vdGUgUHJvZCBtb2Qgd2lsbCBnaXZlIHlvdSBzdGF0aWMgKyBtaWRkbGV3YXJlLlxuICAgICAgICovXG5cbiAgICAgIC8qKlxuICAgICAgICogQXBpIFJvdXRlcyBmb3IgYFByb2R1Y3Rpb25gLlxuICAgICAgICovXG4gICAgICByb3V0ZXMuaW5pdChhcHApO1xuICAgICAgY25leHRSb3V0ZXMuY25leHRJbml0KGFwcCk7XG4gICAgICAvKipcbiAgICAgICAqIENsaWVudCBEaXJcbiAgICAgICAqL1xuICAgICAgX2NsaWVudERpciA9ICcuL2NsaWVudC9wcm9kJztcblxuICAgICAgLyoqXG4gICAgICAgKiBTdGF0aWMuXG4gICAgICAgKi9cbiAgICAgIGFwcC51c2UoJy9qcycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIF9jbGllbnREaXIgKyAnL2pzJykpKTtcbiAgICAgIGFwcC51c2UoJy9jc3MnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9jc3MnKSkpO1xuICAgICAgYXBwLnVzZSgnL2Fzc2V0cycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIF9jbGllbnREaXIgKyAnL2Fzc2V0cycpKSk7XG4gICAgICBhcHAudXNlKCcvcHVibGljJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSsnL3B1YmxpYycpKSk7XG5cbiAgICAgIC8qKlxuICAgICAgICogU3BhIFJlcyBTZW5kZXIuXG4gICAgICAgKiBAcGFyYW0gcmVxIHthbnl9XG4gICAgICAgKiBAcGFyYW0gcmVzIHthbnl9XG4gICAgICAgKi9cbiAgICAgIHZhciByZW5kZXJJbmRleCA9IGZ1bmN0aW9uIChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSB7XG4gICAgICAgIF9jbGllbnREaXIgPSAnL2NsaWVudC9wcm9kJztcbiAgICAgICAgcmVzLnNlbmRGaWxlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUgKyBfY2xpZW50RGlyICsgJy9pbmRleC5odG1sJykpO1xuICAgICAgfTtcblxuICAgICAgLy9hcHAuZ2V0KCcqJywgZnVuY3Rpb24ocmVxLHJlcykge1xuICAgICAgLy8gIHJlcy5zZW5kRmlsZShwcm9jZXNzLmN3ZCgpICsgJy9kaXN0L3Byb2QvY2xpZW50L2luZGV4Lmh0bWwnKTtcbiAgICAgIC8vfSk7XG5cbiAgICAgIC8qKlxuICAgICAgICogUHJldmVudCBzZXJ2ZXIgcm91dGluZyBhbmQgdXNlIEBuZzItcm91dGVyLlxuICAgICAgICovXG4gICAgICBhcHAuZ2V0KCcvKicsIHJlbmRlckluZGV4KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAvKipcbiAgICAgICAqIFByb2QgTW9kZS5cbiAgICAgICAqIEBub3RlIFByb2QgbW9kIHdpbGwgZ2l2ZSB5b3Ugc3RhdGljICsgbWlkZGxld2FyZS5cbiAgICAgICAqL1xuXG4gICAgICAvKipcbiAgICAgICAqIEFwaSBSb3V0ZXMgZm9yIGBQcm9kdWN0aW9uYC5cbiAgICAgICAqL1xuICAgICAgcm91dGVzLmluaXQoYXBwKTtcbiAgICAgIGNuZXh0Um91dGVzLmNuZXh0SW5pdChhcHApO1xuICAgICAgLyoqXG4gICAgICAgKiBDbGllbnQgRGlyXG4gICAgICAgKi9cbiAgICAgIF9jbGllbnREaXIgPSAnLi9kaXN0L2NsaWVudC9wcm9kJztcblxuICAgICAgLyoqXG4gICAgICAgKiBTdGF0aWMuXG4gICAgICAgKi9cbiAgICAgIGFwcC51c2UoJy9qcycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIF9jbGllbnREaXIgKyAnL2pzJykpKTtcbiAgICAgIGFwcC51c2UoJy9jc3MnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9jc3MnKSkpO1xuICAgICAgYXBwLnVzZSgnL2Fzc2V0cycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIF9jbGllbnREaXIgKyAnL2Fzc2V0cycpKSk7XG4gICAgICBhcHAudXNlKCcvcHVibGljJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSsnL3B1YmxpYycpKSk7XG5cbiAgICAgIC8qKlxuICAgICAgICogU3BhIFJlcyBTZW5kZXIuXG4gICAgICAgKiBAcGFyYW0gcmVxIHthbnl9XG4gICAgICAgKiBAcGFyYW0gcmVzIHthbnl9XG4gICAgICAgKi9cbiAgICAgIHZhciByZW5kZXJJbmRleCA9IGZ1bmN0aW9uIChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSB7XG4gICAgICAgIF9jbGllbnREaXIgPSAnL2Rpc3QvY2xpZW50L3Byb2QnO1xuICAgICAgICByZXMuc2VuZEZpbGUocGF0aC5yZXNvbHZlKF9fZGlybmFtZSArIF9jbGllbnREaXIgKyAnL2luZGV4Lmh0bWwnKSk7XG4gICAgICB9O1xuXG4gICAgICAvL2FwcC5nZXQoJyonLCBmdW5jdGlvbihyZXEscmVzKSB7XG4gICAgICAvLyAgcmVzLnNlbmRGaWxlKHByb2Nlc3MuY3dkKCkgKyAnL2Rpc3QvcHJvZC9jbGllbnQvaW5kZXguaHRtbCcpO1xuICAgICAgLy99KTtcblxuICAgICAgLyoqXG4gICAgICAgKiBQcmV2ZW50IHNlcnZlciByb3V0aW5nIGFuZCB1c2UgQG5nMi1yb3V0ZXIuXG4gICAgICAgKi9cbiAgICAgIGFwcC5nZXQoJy8qJywgcmVuZGVySW5kZXgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZXJ2ZXIgd2l0aCBnemlwIGNvbXByZXNzaW9uLlxuICAgKi9cbiAgLy9IVFRQIFNUQVJUOlxuICBpZiAocHJvdG9jb2wgPT0gJ2h0dHAnKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGh0dHAuU2VydmVyPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBsZXQgc2VydmVyID0gYXBwLmxpc3Rlbihwb3J0LCAoKSA9PiB7XG4gICAgICAgIHZhciBwb3J0ID0gc2VydmVyLmFkZHJlc3MoKS5wb3J0O1xuICAgICAgICBjb25zb2xlLmxvZygnQXBwIGlzIGxpc3RlbmluZyBvbiBwb3J0OicgKyBwb3J0KTtcbiAgICAgICAgcmVzb2x2ZShzZXJ2ZXIpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIGtleTogZnMucmVhZEZpbGVTeW5jKFwiLi9zZXJ2ZXIua2V5XCIpLFxuICAgICAgY2VydDogZnMucmVhZEZpbGVTeW5jKFwiLi9zZXJ2ZXIuY3J0XCIpLFxuXG4gICAgICBzcGR5OiB7XG4gICAgICAgIHByb3RvY29sczogWydoMiddXG4gICAgICB9XG4gICAgfTtcblxuICAgIHJldHVybiBzcGR5LmNyZWF0ZVNlcnZlcihvcHRpb25zLCBhcHApXG4gICAgICAubGlzdGVuKHBvcnQsIChlcnJvcjogYW55KSA9PiB7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpXG4gICAgICAgICAgcmV0dXJuIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnaHR0cDIgTGlzdGVuaW5nIG9uIHBvcnQ6ICcgKyBwb3J0ICsgJy4nKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgfVxufTtcbiJdfQ==
