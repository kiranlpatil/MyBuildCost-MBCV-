"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var express = require("express");
var bodyParser = require("body-parser");
var path = require("path");
var compression = require("compression");
var routes = require("./routes");
var cnextRoutes = require("./cnext-routes");
var methodOverride = require("method-override");
var cors = require("cors");
var fs = require("fs");
var LoggerService = require("./app/framework/shared/logger/LoggerService");
var sharedService = require("./app/framework/shared/logger/shared.service");
var spdy = require('spdy');
__dirname = './';
var _clientDir = '/dist/client/dev';
var _serverDir = '/dist/server/dev';
var app = express();
function init(port, mode, protocol, dist_runner) {
    app.use(bodyParser.urlencoded({ extended: false }));
    app.use(bodyParser.json({ limit: '40mb' }));
    app.use(bodyParser.urlencoded({ limit: '40mb', extended: true }));
    app.use(bodyParser.text());
    app.use(compression());
    app.use(cors());
    app.use(bodyParser.json());
    app.use(methodOverride("X-HTTP-Method"));
    app.use(methodOverride("X-HTTP-Method-Override"));
    app.use(methodOverride("X-Method-Override"));
    app.use(methodOverride("_method"));
    app.use(express.static('src/'));
    process.on('uncaughtException', function (err) {
        var _loggerService = new LoggerService('uncaught exception Handler');
        console.error(err);
        _loggerService.logError("Catching uncaught Exceptions. : " + err);
        _loggerService.logError("Catching uncaught Exceptions stack : " + err.stack);
        sharedService.mailToAdmin(err);
    });
    if (mode == 'dev') {
        if (dist_runner == 'dist') {
            app.all('/*', function (req, res, next) {
                res.header('Access-Control-Allow-Origin', '*');
                res.header('Access-Control-Allow-Headers', 'X-Requested-With');
                next();
            });
            routes.init(app);
            cnextRoutes.cnextInit(app);
            var root = path.resolve(process.cwd());
            var clientRoot = path.resolve(process.cwd(), './client/dev');
            app.use(express.static(root));
            app.use(express.static(clientRoot));
            _serverDir = '/dist/server/dev';
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/client/dev';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
        else {
            app.all('/*', function (req, res, next) {
                res.header('Access-Control-Allow-Origin', '*');
                res.header('Access-Control-Allow-Headers', 'X-Requested-With');
                next();
            });
            routes.init(app);
            cnextRoutes.cnextInit(app);
            var root = path.resolve(process.cwd());
            var clientRoot = path.resolve(process.cwd(), './dist/client/dev');
            app.use(express.static(root));
            app.use(express.static(clientRoot));
            _serverDir = '/dist/server/dev';
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/dist/client/dev';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
    }
    else {
        if (dist_runner == 'dist') {
            routes.init(app);
            cnextRoutes.cnextInit(app);
            _clientDir = './client/prod';
            _serverDir = '/server/prod';
            app.use('/js', express.static(path.resolve(__dirname, _clientDir + '/js')));
            app.use('/css', express.static(path.resolve(__dirname, _clientDir + '/css')));
            app.use('/assets', express.static(path.resolve(__dirname, _clientDir + '/assets')));
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/client/prod';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
        else {
            routes.init(app);
            cnextRoutes.cnextInit(app);
            _clientDir = './dist/client/prod';
            _serverDir = '/dist/server/prod';
            app.use('/js', express.static(path.resolve(__dirname, _clientDir + '/js')));
            app.use('/css', express.static(path.resolve(__dirname, _clientDir + '/css')));
            app.use('/assets', express.static(path.resolve(__dirname, _clientDir + '/assets')));
            app.use('/public', express.static(path.resolve(__dirname + _serverDir + '/public')));
            var renderIndex = function (req, res) {
                _clientDir = '/dist/client/prod';
                res.sendFile(path.resolve(__dirname + _clientDir + '/index.html'));
            };
            app.get('/*', renderIndex);
        }
    }
    if (protocol == 'http') {
        return new Promise(function (resolve, reject) {
            var server = app.listen(port, function () {
                var port = server.address().port;
                console.log('App is listening on port:' + port);
                resolve(server);
            });
        });
    }
    else {
        var options = {
            key: fs.readFileSync("./staging.jobmosis.com.key"),
            cert: fs.readFileSync("./staging.jobmosis.com.crt"),
            passphrase: 'tpl123',
            spdy: {
                protocols: ['h2']
            }
        };
        return spdy.createServer(options, app)
            .listen(port, function (error) {
            if (error) {
                console.error(error);
                return process.exit(1);
            }
            else {
                console.log('http2 Listening on port: ' + port + '.');
            }
        });
    }
}
exports.init = init;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQztBQUNILENBQUM7QUExTUQsb0JBME1DO0FBQUEsQ0FBQyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGh0dHAgZnJvbSBcImh0dHBcIjtcclxuaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tIFwiZXhwcmVzc1wiO1xyXG5pbXBvcnQgKiBhcyBib2R5UGFyc2VyIGZyb20gXCJib2R5LXBhcnNlclwiO1xyXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XHJcbmltcG9ydCAqIGFzIGNvbXByZXNzaW9uIGZyb20gXCJjb21wcmVzc2lvblwiO1xyXG5pbXBvcnQgKiBhcyByb3V0ZXMgZnJvbSBcIi4vcm91dGVzXCI7XHJcbmltcG9ydCAqIGFzIGNuZXh0Um91dGVzIGZyb20gXCIuL2NuZXh0LXJvdXRlc1wiO1xyXG5pbXBvcnQgKiBhcyBtZXRob2RPdmVycmlkZSBmcm9tIFwibWV0aG9kLW92ZXJyaWRlXCI7XHJcbmltcG9ydCAqIGFzIGNvcnMgZnJvbSBcImNvcnNcIjtcclxuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzXCI7XHJcbmltcG9ydCBMb2dnZXJTZXJ2aWNlID0gcmVxdWlyZShcIi4vYXBwL2ZyYW1ld29yay9zaGFyZWQvbG9nZ2VyL0xvZ2dlclNlcnZpY2VcIik7XHJcbmltcG9ydCAqIGFzIHNoYXJlZFNlcnZpY2UgZnJvbSBcIi4vYXBwL2ZyYW1ld29yay9zaGFyZWQvbG9nZ2VyL3NoYXJlZC5zZXJ2aWNlXCI7XHJcblxyXG52YXIgc3BkeSA9IHJlcXVpcmUoJ3NwZHknKTtcclxuXHJcbiBfX2Rpcm5hbWUgPSAnLi8nO1xyXG52YXIgX2NsaWVudERpciA9ICcvZGlzdC9jbGllbnQvZGV2JztcclxudmFyIF9zZXJ2ZXJEaXIgPSAnL2Rpc3Qvc2VydmVyL2Rldic7XHJcbnZhciBhcHAgPSBleHByZXNzKCk7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5pdChwb3J0OiBudW1iZXIsIG1vZGU6IHN0cmluZywgcHJvdG9jb2w6IHN0cmluZywgZGlzdF9ydW5uZXI6IHN0cmluZykge1xyXG5cclxuICBhcHAudXNlKGJvZHlQYXJzZXIudXJsZW5jb2RlZCh7ZXh0ZW5kZWQ6IGZhbHNlfSkpO1xyXG4gIGFwcC51c2UoYm9keVBhcnNlci5qc29uKHtsaW1pdDogJzQwbWInfSkpO1xyXG4gIGFwcC51c2UoYm9keVBhcnNlci51cmxlbmNvZGVkKHtsaW1pdDogJzQwbWInLCBleHRlbmRlZDogdHJ1ZX0pKTtcclxuICBhcHAudXNlKGJvZHlQYXJzZXIudGV4dCgpKTtcclxuICBhcHAudXNlKGNvbXByZXNzaW9uKCkpO1xyXG4gIGFwcC51c2UoY29ycygpKTtcclxuICBhcHAudXNlKGJvZHlQYXJzZXIuanNvbigpKTtcclxuICBhcHAudXNlKG1ldGhvZE92ZXJyaWRlKFwiWC1IVFRQLU1ldGhvZFwiKSk7XHJcbiAgYXBwLnVzZShtZXRob2RPdmVycmlkZShcIlgtSFRUUC1NZXRob2QtT3ZlcnJpZGVcIikpO1xyXG4gIGFwcC51c2UobWV0aG9kT3ZlcnJpZGUoXCJYLU1ldGhvZC1PdmVycmlkZVwiKSk7XHJcbiAgYXBwLnVzZShtZXRob2RPdmVycmlkZShcIl9tZXRob2RcIikpO1xyXG4gIGFwcC51c2UoZXhwcmVzcy5zdGF0aWMoJ3NyYy8nKSk7XHJcbiAgcHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb24nLCBmdW5jdGlvbiAoZXJyOmFueSkge1xyXG4gICAgbGV0IF9sb2dnZXJTZXJ2aWNlOiBMb2dnZXJTZXJ2aWNlID0gbmV3IExvZ2dlclNlcnZpY2UoJ3VuY2F1Z2h0IGV4Y2VwdGlvbiBIYW5kbGVyJyk7XHJcbiAgICAgY29uc29sZS5lcnJvcihlcnIpO1xyXG4gICAgX2xvZ2dlclNlcnZpY2UubG9nRXJyb3IoXCJDYXRjaGluZyB1bmNhdWdodCBFeGNlcHRpb25zLiA6IFwiICtlcnIpO1xyXG4gICAgX2xvZ2dlclNlcnZpY2UubG9nRXJyb3IoXCJDYXRjaGluZyB1bmNhdWdodCBFeGNlcHRpb25zIHN0YWNrIDogXCIgK2Vyci5zdGFjayk7XHJcbiAgICBzaGFyZWRTZXJ2aWNlLm1haWxUb0FkbWluKGVycik7XHJcbiAgfSk7XHJcblxyXG4gIC8qKlxyXG4gICAqIERldiBNb2RlLlxyXG4gICAqIEBub3RlIERldiBzZXJ2ZXIgd2lsbCBvbmx5IGdpdmUgZm9yIHlvdSBtaWRkbGV3YXJlLlxyXG4gICAqL1xyXG4gIGlmIChtb2RlID09ICdkZXYnKSB7XHJcbiAgICBpZiAoZGlzdF9ydW5uZXIgPT0gJ2Rpc3QnKSB7XHJcbiAgICAgIGFwcC5hbGwoJy8qJywgZnVuY3Rpb24gKHJlcSwgcmVzLCBuZXh0KSB7XHJcbiAgICAgICAgcmVzLmhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJywgJyonKTtcclxuICAgICAgICByZXMuaGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJywgJ1gtUmVxdWVzdGVkLVdpdGgnKTtcclxuICAgICAgICBuZXh0KCk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgcm91dGVzLmluaXQoYXBwKTtcclxuICAgICAgY25leHRSb3V0ZXMuY25leHRJbml0KGFwcCk7XHJcblxyXG4gICAgICBsZXQgcm9vdCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpKTtcclxuICAgICAgbGV0IGNsaWVudFJvb3QgPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgJy4vY2xpZW50L2RldicpO1xyXG4gICAgICBhcHAudXNlKGV4cHJlc3Muc3RhdGljKHJvb3QpKTtcclxuICAgICAgYXBwLnVzZShleHByZXNzLnN0YXRpYyhjbGllbnRSb290KSk7XHJcbiAgICAgIF9zZXJ2ZXJEaXIgPSAnL2Rpc3Qvc2VydmVyL2Rldic7XHJcbiAgICAgIGFwcC51c2UoJy9wdWJsaWMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lICsgX3NlcnZlckRpciArJy9wdWJsaWMnKSkpO1xyXG4gICAgICB2YXIgcmVuZGVySW5kZXggPSAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xyXG4gICAgICAgIF9jbGllbnREaXIgPSAnL2NsaWVudC9kZXYnO1xyXG4gICAgICAgIHJlcy5zZW5kRmlsZShwYXRoLnJlc29sdmUoX19kaXJuYW1lICsgX2NsaWVudERpciArICcvaW5kZXguaHRtbCcpKTtcclxuICAgICAgfTtcclxuICAgICAgYXBwLmdldCgnLyonLCByZW5kZXJJbmRleCk7XHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBBcGkgUm91dGVzIGZvciBgRGV2ZWxvcG1lbnRgLlxyXG4gICAgICAgKi9cclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICBhcHAuYWxsKCcvKicsIGZ1bmN0aW9uIChyZXEsIHJlcywgbmV4dCkge1xyXG4gICAgICAgIHJlcy5oZWFkZXIoJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicsICcqJyk7XHJcbiAgICAgICAgcmVzLmhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycycsICdYLVJlcXVlc3RlZC1XaXRoJyk7XHJcbiAgICAgICAgbmV4dCgpO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHJvdXRlcy5pbml0KGFwcCk7XHJcbiAgICAgIGNuZXh0Um91dGVzLmNuZXh0SW5pdChhcHApO1xyXG5cclxuICAgICAgbGV0IHJvb3QgPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSk7XHJcbiAgICAgIGxldCBjbGllbnRSb290ID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksICcuL2Rpc3QvY2xpZW50L2RldicpO1xyXG4gICAgICBhcHAudXNlKGV4cHJlc3Muc3RhdGljKHJvb3QpKTtcclxuICAgICAgYXBwLnVzZShleHByZXNzLnN0YXRpYyhjbGllbnRSb290KSk7XHJcbiAgICAgIF9zZXJ2ZXJEaXIgPSAnL2Rpc3Qvc2VydmVyL2Rldic7XHJcbiAgICAgIGFwcC51c2UoJy9wdWJsaWMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lKyBfc2VydmVyRGlyICsnL3B1YmxpYycpKSk7XHJcbiAgICAgIHZhciByZW5kZXJJbmRleCA9IChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgX2NsaWVudERpciA9ICcvZGlzdC9jbGllbnQvZGV2JztcclxuICAgICAgICByZXMuc2VuZEZpbGUocGF0aC5yZXNvbHZlKF9fZGlybmFtZSArIF9jbGllbnREaXIgKyAnL2luZGV4Lmh0bWwnKSk7XHJcbiAgICAgIH07XHJcbiAgICAgIGFwcC5nZXQoJy8qJywgcmVuZGVySW5kZXgpO1xyXG4gICAgICAvKipcclxuICAgICAgICogQXBpIFJvdXRlcyBmb3IgYERldmVsb3BtZW50YC5cclxuICAgICAgICovXHJcbiAgICB9XHJcbiAgfVxyXG4gIGVsc2Uge1xyXG4gICAgaWYoZGlzdF9ydW5uZXIgPT0gJ2Rpc3QnKSB7XHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBQcm9kIE1vZGUuXHJcbiAgICAgICAqIEBub3RlIFByb2QgbW9kIHdpbGwgZ2l2ZSB5b3Ugc3RhdGljICsgbWlkZGxld2FyZS5cclxuICAgICAgICovXHJcblxyXG4gICAgICAvKipcclxuICAgICAgICogQXBpIFJvdXRlcyBmb3IgYFByb2R1Y3Rpb25gLlxyXG4gICAgICAgKi9cclxuICAgICAgcm91dGVzLmluaXQoYXBwKTtcclxuICAgICAgY25leHRSb3V0ZXMuY25leHRJbml0KGFwcCk7XHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBDbGllbnQgRGlyXHJcbiAgICAgICAqL1xyXG4gICAgICBfY2xpZW50RGlyID0gJy4vY2xpZW50L3Byb2QnO1xyXG4gICAgICBfc2VydmVyRGlyID0gJy9zZXJ2ZXIvcHJvZCc7XHJcblxyXG4gICAgICAvKipcclxuICAgICAgICogU3RhdGljLlxyXG4gICAgICAgKi9cclxuICAgICAgYXBwLnVzZSgnL2pzJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgX2NsaWVudERpciArICcvanMnKSkpO1xyXG4gICAgICBhcHAudXNlKCcvY3NzJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgX2NsaWVudERpciArICcvY3NzJykpKTtcclxuICAgICAgYXBwLnVzZSgnL2Fzc2V0cycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIF9jbGllbnREaXIgKyAnL2Fzc2V0cycpKSk7XHJcbiAgICAgIGFwcC51c2UoJy9wdWJsaWMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lKyBfc2VydmVyRGlyICsgJy9wdWJsaWMnKSkpO1xyXG5cclxuICAgICAgLyoqXHJcbiAgICAgICAqIFNwYSBSZXMgU2VuZGVyLlxyXG4gICAgICAgKiBAcGFyYW0gcmVxIHthbnl9XHJcbiAgICAgICAqIEBwYXJhbSByZXMge2FueX1cclxuICAgICAgICovXHJcbiAgICAgIHZhciByZW5kZXJJbmRleCA9IGZ1bmN0aW9uIChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSB7XHJcbiAgICAgICAgX2NsaWVudERpciA9ICcvY2xpZW50L3Byb2QnO1xyXG4gICAgICAgIHJlcy5zZW5kRmlsZShwYXRoLnJlc29sdmUoX19kaXJuYW1lICsgX2NsaWVudERpciArICcvaW5kZXguaHRtbCcpKTtcclxuICAgICAgfTtcclxuXHJcbiAgICAgIC8vYXBwLmdldCgnKicsIGZ1bmN0aW9uKHJlcSxyZXMpIHtcclxuICAgICAgLy8gIHJlcy5zZW5kRmlsZShwcm9jZXNzLmN3ZCgpICsgJy9kaXN0L3Byb2QvY2xpZW50L2luZGV4Lmh0bWwnKTtcclxuICAgICAgLy99KTtcclxuXHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBQcmV2ZW50IHNlcnZlciByb3V0aW5nIGFuZCB1c2UgQG5nMi1yb3V0ZXIuXHJcbiAgICAgICAqL1xyXG4gICAgICBhcHAuZ2V0KCcvKicsIHJlbmRlckluZGV4KTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAvKipcclxuICAgICAgICogUHJvZCBNb2RlLlxyXG4gICAgICAgKiBAbm90ZSBQcm9kIG1vZCB3aWxsIGdpdmUgeW91IHN0YXRpYyArIG1pZGRsZXdhcmUuXHJcbiAgICAgICAqL1xyXG5cclxuICAgICAgLyoqXHJcbiAgICAgICAqIEFwaSBSb3V0ZXMgZm9yIGBQcm9kdWN0aW9uYC5cclxuICAgICAgICovXHJcbiAgICAgIHJvdXRlcy5pbml0KGFwcCk7XHJcbiAgICAgIGNuZXh0Um91dGVzLmNuZXh0SW5pdChhcHApO1xyXG4gICAgICAvKipcclxuICAgICAgICogQ2xpZW50IERpclxyXG4gICAgICAgKi9cclxuICAgICAgX2NsaWVudERpciA9ICcuL2Rpc3QvY2xpZW50L3Byb2QnO1xyXG4gICAgICBfc2VydmVyRGlyID0gJy9kaXN0L3NlcnZlci9wcm9kJztcclxuXHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBTdGF0aWMuXHJcbiAgICAgICAqL1xyXG4gICAgICBhcHAudXNlKCcvanMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9qcycpKSk7XHJcbiAgICAgIGFwcC51c2UoJy9jc3MnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfY2xpZW50RGlyICsgJy9jc3MnKSkpO1xyXG4gICAgICBhcHAudXNlKCcvYXNzZXRzJywgZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgX2NsaWVudERpciArICcvYXNzZXRzJykpKTtcclxuICAgICAgYXBwLnVzZSgnL3B1YmxpYycsIGV4cHJlc3Muc3RhdGljKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUrIF9zZXJ2ZXJEaXIrJy9wdWJsaWMnKSkpO1xyXG5cclxuICAgICAgLyoqXHJcbiAgICAgICAqIFNwYSBSZXMgU2VuZGVyLlxyXG4gICAgICAgKiBAcGFyYW0gcmVxIHthbnl9XHJcbiAgICAgICAqIEBwYXJhbSByZXMge2FueX1cclxuICAgICAgICovXHJcbiAgICAgIHZhciByZW5kZXJJbmRleCA9IGZ1bmN0aW9uIChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSB7XHJcbiAgICAgICAgX2NsaWVudERpciA9ICcvZGlzdC9jbGllbnQvcHJvZCc7XHJcbiAgICAgICAgcmVzLnNlbmRGaWxlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUgKyBfY2xpZW50RGlyICsgJy9pbmRleC5odG1sJykpO1xyXG4gICAgICB9O1xyXG5cclxuICAgICAgLy9hcHAuZ2V0KCcqJywgZnVuY3Rpb24ocmVxLHJlcykge1xyXG4gICAgICAvLyAgcmVzLnNlbmRGaWxlKHByb2Nlc3MuY3dkKCkgKyAnL2Rpc3QvcHJvZC9jbGllbnQvaW5kZXguaHRtbCcpO1xyXG4gICAgICAvL30pO1xyXG5cclxuICAgICAgLyoqXHJcbiAgICAgICAqIFByZXZlbnQgc2VydmVyIHJvdXRpbmcgYW5kIHVzZSBAbmcyLXJvdXRlci5cclxuICAgICAgICovXHJcbiAgICAgIGFwcC5nZXQoJy8qJywgcmVuZGVySW5kZXgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2VydmVyIHdpdGggZ3ppcCBjb21wcmVzc2lvbi5cclxuICAgKi9cclxuICAvL0hUVFAgU1RBUlQ6XHJcbiAgaWYgKHByb3RvY29sID09ICdodHRwJykge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGh0dHAuU2VydmVyPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGxldCBzZXJ2ZXIgPSBhcHAubGlzdGVuKHBvcnQsICgpID0+IHtcclxuICAgICAgICB2YXIgcG9ydCA9IHNlcnZlci5hZGRyZXNzKCkucG9ydDtcclxuICAgICAgICBjb25zb2xlLmxvZygnQXBwIGlzIGxpc3RlbmluZyBvbiBwb3J0OicgKyBwb3J0KTtcclxuICAgICAgICByZXNvbHZlKHNlcnZlcik7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfSBlbHNlIHtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgIGtleTogZnMucmVhZEZpbGVTeW5jKFwiLi9zdGFnaW5nLmpvYm1vc2lzLmNvbS5rZXlcIiksXHJcbiAgICAgIGNlcnQ6IGZzLnJlYWRGaWxlU3luYyhcIi4vc3RhZ2luZy5qb2Jtb3Npcy5jb20uY3J0XCIpLFxyXG4gICAgICBwYXNzcGhyYXNlOiAndHBsMTIzJyxcclxuXHJcbiAgICAgIHNwZHk6IHtcclxuICAgICAgICBwcm90b2NvbHM6IFsnaDInXVxyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIHJldHVybiBzcGR5LmNyZWF0ZVNlcnZlcihvcHRpb25zLCBhcHApXHJcbiAgICAgIC5saXN0ZW4ocG9ydCwgKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpXHJcbiAgICAgICAgICByZXR1cm4gcHJvY2Vzcy5leGl0KDEpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnaHR0cDIgTGlzdGVuaW5nIG9uIHBvcnQ6ICcgKyBwb3J0ICsgJy4nKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgfVxyXG59O1xyXG4iXX0=
